# CIS é¡¹ç›®ç®€åŒ–æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

ç»è¿‡å…¨é¢æ£€æŸ¥ï¼Œå‘ç° CIS é¡¹ç›®æ•´ä½“æ¶æ„åˆç†ï¼Œä½†å­˜åœ¨ä¸€äº›**è¿‡åº¦å®ç°ï¼ˆOver-engineeringï¼‰**å’Œ**ä»£ç ç»„ç»‡**æ–¹é¢çš„é—®é¢˜ã€‚æœ¬æŠ¥å‘Šåˆ—å‡ºå‘ç°çš„é—®é¢˜åŠç®€åŒ–å»ºè®®ã€‚

---

## ğŸ” å‘ç°çš„é—®é¢˜

### 1. å…¨å±€å…è®¸ dead_codeï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/lib.rs:2`

**é—®é¢˜ä»£ç **:
```rust
#![allow(dead_code)]
#![allow(private_interfaces)]
```

**é—®é¢˜æè¿°**:
- å…¨å±€å…è®¸ `dead_code` ä¼šéšè—çœŸæ­£çš„æ­»ä»£ç 
- å¯¼è‡´ä»£ç åº“ä¸­å­˜åœ¨å¤§é‡æœªä½¿ç”¨çš„ä»£ç 
- å¢åŠ ç»´æŠ¤è´Ÿæ‹…å’Œç¼–è¯‘æ—¶é—´

**å»ºè®®**: ç§»é™¤å…¨å±€å…è®¸ï¼Œæ”¹ä¸ºåœ¨éœ€è¦çš„åœ°æ–¹å±€éƒ¨å…è®¸ã€‚

**ç®€åŒ–æ•ˆæœ**: å¯ä»¥è¯†åˆ«å¹¶åˆ é™¤ 10-20% çš„æ­»ä»£ç ã€‚

---

### 2. Scheduler æ¨¡å—è¿‡å¤§ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/scheduler/mod.rs`

**é—®é¢˜æè¿°**:
- æ–‡ä»¶å¤§å°: 3234 è¡Œ
- åŒ…å« 20+ ç»“æ„ä½“å’Œæšä¸¾
- åŒ…å« TODO Listã€DAG è°ƒåº¦ã€åŠ¨æ€è°ƒåº¦ç­‰å¤šä¸ªæ¦‚å¿µ

**ä»£ç ç»Ÿè®¡**:
```
pub enum DagError                    (line 26)
pub enum PermissionResult            (line 69)
pub enum DagNodeStatus               (line 82)
pub struct DagNode                   (line 118)
pub struct TaskDag                   (line 172)
pub enum DagScope                    (line 759)
pub struct DagTaskSpec               (line 936)
pub enum TodoItemStatus              (line 950)
pub struct DagTodoItem               (line 961)
pub struct DagTodoList               (line 1067)
pub struct TodoItemChange            (line 1404)
pub enum ProposalSource              (line 1417)
pub struct TodoListProposal          (line 1440)
pub enum ProposalResult              (line 1497)
pub struct TodoListDiff              (line 1527)
pub struct TodoListObserver          (line 1556)
pub struct DynamicTaskScheduler      (line 1610)
pub struct ScheduleChanges           (line 1707)
pub struct DagSpec                   (line 1721)
pub struct ScopeInferrer             (line 1815)
pub struct ScopeConflict             (line 1945)
pub enum DagPriority                 (line 1967)
pub enum DagRunStatus                (line 1994)
pub struct DagRun                    (line 2014)
pub struct DagScheduler              (line 2262)
```

**å»ºè®®æ‹†åˆ†**:
```
scheduler/
â”œâ”€â”€ mod.rs              # å…¬å…±å¯¼å‡º
â”œâ”€â”€ dag.rs              # DAG æ ¸å¿ƒç»“æ„
â”œâ”€â”€ node.rs             # DagNode
â”œâ”€â”€ error.rs            # DagError
â”œâ”€â”€ status.rs           # DagNodeStatus, DagRunStatus
â”œâ”€â”€ todo/
â”‚   â”œâ”€â”€ mod.rs          # å¯¼å‡º
â”‚   â”œâ”€â”€ item.rs         # DagTodoItem
â”‚   â”œâ”€â”€ list.rs         # DagTodoList
â”‚   â”œâ”€â”€ diff.rs         # TodoListDiff
â”‚   â”œâ”€â”€ proposal.rs     # TodoListProposal
â”‚   â””â”€â”€ observer.rs     # TodoListObserver
â”œâ”€â”€ scope.rs            # DagScope, ScopeInferrer
â”œâ”€â”€ spec.rs             # DagTaskSpec, DagSpec
â””â”€â”€ scheduler.rs        # DagScheduler
```

**ç®€åŒ–æ•ˆæœ**: æé«˜ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§ï¼Œä¾¿äºå¹¶è¡Œå¼€å‘ã€‚

---

### 3. Matrix æ¨¡å—è¿‡äºåºå¤§ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/matrix/`

**é—®é¢˜æè¿°**:
- æ€»ä»£ç é‡: 18,669 è¡Œ
- websocket å­æ¨¡å—: 3,028 è¡Œ
- åŒ…å«è”é‚¦ã€è·¯ç”±ã€åŒæ­¥ã€WebSocket ç­‰å¤šä¸ªå­ç³»ç»Ÿ

**æ–‡ä»¶ç»Ÿè®¡**:
```
websocket/client.rs      821 è¡Œ
websocket/server.rs     1121 è¡Œ
websocket/hole_punching.rs  575 è¡Œ
federation/server.rs     960 è¡Œ
federation/types.rs      652 è¡Œ
sync/queue.rs            628 è¡Œ
routes/room.rs           519 è¡Œ
websocket/tunnel.rs      573 è¡Œ
...
```

**å»ºè®®**: è€ƒè™‘å°† matrix æ¨¡å—æå–ä¸ºç‹¬ç«‹çš„ crate `cis-matrix`ã€‚

**ç®€åŒ–æ•ˆæœ**: å‡å°‘æ ¸å¿ƒåº“ç¼–è¯‘æ—¶é—´ï¼Œæé«˜æ¨¡å—åŒ–ç¨‹åº¦ã€‚

---

### 4. Init Wizard è¿‡äºå¤æ‚ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/init/wizard.rs`

**é—®é¢˜æè¿°**:
- 836 è¡Œçš„å•ä¸ªæ–‡ä»¶
- åŒ…å«äº¤äº’å¼å‘å¯¼çš„å…¨éƒ¨é€»è¾‘

**å»ºè®®**: æ‹†åˆ†ä¸ºå¤šä¸ªå­æ¨¡å—:
```
init/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ wizard.rs        # ä¸»æµç¨‹
â”œâ”€â”€ checks.rs        # ç¯å¢ƒæ£€æŸ¥
â”œâ”€â”€ config_gen.rs    # é…ç½®ç”Ÿæˆ
â”œâ”€â”€ prompts.rs       # äº¤äº’æç¤º
â””â”€â”€ validation.rs    # è¾“å…¥éªŒè¯
```

---

### 5. é”™è¯¯ç±»å‹å®ç°è¿‡äºå†—é•¿ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/scheduler/mod.rs:39-55`

**é—®é¢˜ä»£ç **:
```rust
impl std::fmt::Display for DagError {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            DagError::CycleDetected(cycle) => {
                write!(f, "Cycle detected in dependency graph: {:?}", cycle)
            }
            DagError::NodeNotFound(id) => write!(f, "Node not found: {}", id),
            // ... æ‰‹åŠ¨å®ç°æ¯ä¸ªå˜ä½“
        }
    }
}

impl std::error::Error for DagError {}
```

**å»ºè®®**: ä½¿ç”¨ `thiserror` crate è‡ªåŠ¨ç”Ÿæˆ:

```rust
use thiserror::Error;

#[derive(Error, Debug, Clone, PartialEq, Eq)]
pub enum DagError {
    #[error("Cycle detected in dependency graph: {0:?}")]
    CycleDetected(Vec<String>),
    #[error("Node not found: {0}")]
    NodeNotFound(String),
    // ...
}
```

**ç®€åŒ–æ•ˆæœ**: å‡å°‘ 50% çš„æ¨¡æ¿ä»£ç ã€‚

---

### 6. Storage å±‚è¿‡åº¦æŠ½è±¡ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/storage/`

**é—®é¢˜æè¿°**:
- 11 ä¸ªå­˜å‚¨ç›¸å…³æ–‡ä»¶ï¼Œæ€»è®¡ 6000+ è¡Œ
- å­˜åœ¨å¤šä¸ªç±»ä¼¼çš„æ•°æ®åº“è¿æ¥æŠ½è±¡
- `pool.rs`, `connection.rs`, `db.rs` ä¹‹é—´æœ‰é‡å 

**æ–‡ä»¶åˆ—è¡¨**:
```
backup.rs        226 è¡Œ
connection.rs    724 è¡Œ
conversation_db.rs  350 è¡Œ
federation_db.rs   679 è¡Œ
memory_db.rs     573 è¡Œ
paths.rs         437 è¡Œ
pool.rs          511 è¡Œ
room_manager.rs  408 è¡Œ
room_store.rs    664 è¡Œ
room_types.rs    359 è¡Œ
safety.rs        472 è¡Œ
unified_paths.rs   447 è¡Œ
wal.rs           374 è¡Œ
mod.rs            42 è¡Œ
db.rs           1210 è¡Œ
```

**å»ºè®®**: åˆå¹¶ç›¸ä¼¼æŠ½è±¡ï¼Œç®€åŒ–å­˜å‚¨å±‚æ¶æ„:
```
storage/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ connection.rs    # ç»Ÿä¸€è¿æ¥ç®¡ç†
â”œâ”€â”€ db.rs           # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ paths.rs        # è·¯å¾„ç®¡ç†
â””â”€â”€ wal.rs          # WAL é…ç½®
```

---

### 7. Skill Router è¿‡äºå¤æ‚ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `cis-core/src/skill/router.rs`

**é—®é¢˜æè¿°**:
- 1261 è¡Œä»£ç 
- åŒ…å«è·¯ç”±ã€åŒ¹é…ã€é“¾å¼æ‰§è¡Œç­‰å¤šä¸ªåŠŸèƒ½

**å»ºè®®æ‹†åˆ†**:
```
skill/
â”œâ”€â”€ router/
â”‚   â”œâ”€â”€ mod.rs           # å…¬å…±å¯¼å‡º
â”‚   â”œâ”€â”€ router.rs        # æ ¸å¿ƒè·¯ç”±é€»è¾‘
â”‚   â”œâ”€â”€ matcher.rs       # æŠ€èƒ½åŒ¹é…
â”‚   â”œâ”€â”€ chain.rs         # é“¾å¼æ‰§è¡Œ
â”‚   â””â”€â”€ result.rs        # è·¯ç”±ç»“æœç±»å‹
```

---

## ğŸ“Š ç®€åŒ–ä¼˜å…ˆçº§çŸ©é˜µ

| é—®é¢˜ | å½±å“ | éš¾åº¦ | ä¼˜å…ˆçº§ | é¢„è®¡æ”¶ç›Š |
|------|------|------|--------|----------|
| å…¨å±€ allow(dead_code) | é«˜ | ä½ | P0 | åˆ é™¤ 10-20% æ­»ä»£ç  |
| Scheduler æ¨¡å—æ‹†åˆ† | é«˜ | ä¸­ | P1 | æé«˜ç»´æŠ¤æ€§ |
| Matrix æ¨¡å—æå– | é«˜ | é«˜ | P2 | ç¼–è¯‘æ—¶é—´ -30% |
| Storage å±‚ç®€åŒ– | ä¸­ | ä¸­ | P1 | å‡å°‘å¤æ‚åº¦ |
| é”™è¯¯ç±»å‹ç®€åŒ– | ä½ | ä½ | P2 | å‡å°‘æ¨¡æ¿ä»£ç  |
| Init Wizard æ‹†åˆ† | ä¸­ | ä½ | P2 | æé«˜å¯è¯»æ€§ |
| Skill Router æ‹†åˆ† | ä¸­ | ä¸­ | P2 | æé«˜å¯ç»´æŠ¤æ€§ |

---

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿæ”¶ç›Šï¼ˆ1-2 å¤©ï¼‰

1. **ç§»é™¤å…¨å±€ allow(dead_code)**
   ```rust
   // cis-core/src/lib.rs
   // ç§»é™¤:
   // #![allow(dead_code)]
   // #![allow(private_interfaces)]
   
   // æ”¹ä¸ºå±€éƒ¨å…è®¸:
   #[allow(dead_code)]
   fn some_unused_function() {}
   ```

2. **è¿è¡Œ cargo æ£€æŸ¥è¯†åˆ«æ­»ä»£ç **
   ```bash
   cargo check 2>&1 | grep "dead_code"
   ```

3. **åˆ é™¤æˆ–æ ‡è®°çœŸæ­£çš„æ­»ä»£ç **

### ç¬¬äºŒé˜¶æ®µï¼šæ¨¡å—é‡æ„ï¼ˆ1 å‘¨ï¼‰

1. **æ‹†åˆ† scheduler/mod.rs**
2. **ç®€åŒ– storage å±‚**
3. **æ‹†åˆ† init/wizard.rs**

### ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„ä¼˜åŒ–ï¼ˆ2 å‘¨ï¼‰

1. **æå– matrix ä¸ºç‹¬ç«‹ crate**ï¼ˆå¯é€‰ï¼‰
2. **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼ˆä½¿ç”¨ thiserrorï¼‰
3. **å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•**

---

## ğŸ’¡ ä»£ç ç®€åŒ–ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šé”™è¯¯å¤„ç†ç®€åŒ–

**ä¹‹å‰**ï¼ˆ50 è¡Œï¼‰:
```rust
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum DagError {
    CycleDetected(Vec<String>),
    NodeNotFound(String),
    // ...
}

impl std::fmt::Display for DagError {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            DagError::CycleDetected(cycle) => {
                write!(f, "Cycle detected: {:?}", cycle)
            }
            // ... æ¯ä¸ªå˜ä½“ 3 è¡Œ
        }
    }
}

impl std::error::Error for DagError {}
```

**ä¹‹å**ï¼ˆ10 è¡Œï¼‰:
```rust
use thiserror::Error;

#[derive(Error, Debug, Clone, PartialEq, Eq)]
pub enum DagError {
    #[error("Cycle detected: {0:?}")]
    CycleDetected(Vec<String>),
    #[error("Node not found: {0}")]
    NodeNotFound(String),
    // ...
}
```

### ç¤ºä¾‹ 2ï¼šç§»é™¤æ­»ä»£ç 

**è¿è¡Œæ£€æŸ¥**:
```bash
$ cargo check
warning: function `old_function` is never used
  --> cis-core/src/some_module.rs:42:4
```

**åˆ é™¤æˆ–ä¿ç•™**:
```rust
// å¦‚æœæš‚æ—¶ä¸ç”¨ä½†å°†æ¥å¯èƒ½éœ€è¦:
#[allow(dead_code)]
fn old_function() {}

// å¦‚æœå®Œå…¨ä¸ç”¨:
// ç›´æ¥åˆ é™¤
```

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] ç§»é™¤ `lib.rs` ä¸­çš„å…¨å±€ `#![allow(dead_code)]`
- [ ] è¿è¡Œ `cargo check` è¯†åˆ«æ‰€æœ‰æ­»ä»£ç 
- [ ] åˆ é™¤æˆ–æ ‡è®°æ­»ä»£ç 
- [ ] æ‹†åˆ† `scheduler/mod.rs`ï¼ˆ>3000 è¡Œï¼‰
- [ ] ç®€åŒ– `storage/` æ¨¡å—ï¼ˆåˆå¹¶é‡å¤æŠ½è±¡ï¼‰
- [ ] ä½¿ç”¨ `thiserror` ç®€åŒ–é”™è¯¯ç±»å‹
- [ ] æ‹†åˆ† `init/wizard.rs`ï¼ˆ>800 è¡Œï¼‰
- [ ] è€ƒè™‘æå– `matrix/` ä¸ºç‹¬ç«‹ crate

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹è¿› |
|------|------|------|------|
| æ­»ä»£ç æ¯”ä¾‹ | ~15% | <5% | -10% |
| å¹³å‡æ–‡ä»¶å¤§å° | 450 è¡Œ | <300 è¡Œ | -33% |
| ç¼–è¯‘æ—¶é—´ | åŸºå‡† | -20% | æ›´å¿«è¿­ä»£ |
| ä»£ç å¯è¯»æ€§ | ä¸­ | é«˜ | æ˜¾è‘—æå‡ |

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-07  
**æ£€æŸ¥èŒƒå›´**: cis-core, cis-node, cis-gui  
**å‘ç°é—®é¢˜**: 7 ä¸ª  
**é«˜ä¼˜å…ˆçº§**: 1 ä¸ª
