# Matrix 用户注册 Skill 化设计方案

## 当前方案的问题

### 现状
```
cis-core/src/matrix/
├── routes/register.rs      # 内嵌注册逻辑
├── store.rs                # 直接操作数据库
└── ...
```

### 问题
1. **违反关注点分离** - 用户管理是业务逻辑，不是核心协议
2. **难以扩展** - 无法灵活替换不同的注册策略（邀请码、付费、审核等）
3. **数据库耦合** - 直接操作 `matrix_users` 表，schema 变更影响核心
4. **无法热更新** - 修改注册逻辑需要重新编译核心
5. **权限管理混乱** - 无法利用现有的 Skill 权限系统

---

## 更好的方案：Skill 化

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     CIS Core                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Matrix API  │  │ Skill Router│  │  Scheduler  │         │
│  │   Routes    │──┤             │  │             │         │
│  └─────────────┘  └──────┬──────┘  └─────────────┘         │
│                          │                                  │
│                          ▼                                  │
│                 ┌─────────────────┐                         │
│                 │  Matrix Register│  WASM/Native Skill      │
│                 │     Skill       │  - User creation        │
│                 │                 │  - DID validation       │
│                 └─────────────────┘                         │
│                          │                                  │
│                          ▼                                  │
│                 ┌─────────────────┐                         │
│                 │   Identity      │                         │
│                 │   Service       │                         │
│                 └─────────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 模块设置方案

### 方案一：独立 WASM Skill（推荐）

```
skills/
└── matrix-register/
    ├── Cargo.toml
    ├── skill.toml          # Skill 元数据
    ├── src/
    │   ├── lib.rs
    │   ├── register.rs     # 注册逻辑
    │   ├── did_verify.rs   # DID 验证
    │   └── policy.rs       # 注册策略（邀请码等）
    └── tests/
```

**核心修改**:
```rust
// cis-core/src/matrix/routes/register.rs
// 不再直接处理注册，而是调用 Skill

pub async fn register(
    State(skill_router): State<Arc<SkillRouter>>,
    Json(request): Json<RegisterRequest>,
) -> MatrixResult<Json<RegisterResponse>> {
    // 构建 Skill 调用请求
    let skill_request = SkillRequest {
        skill: "matrix-register".to_string(),
        action: "register_user".to_string(),
        params: json!({
            "username": request.username,
            "did": extract_did(&request.username)?,
            "device_id": request.device_id,
        }),
    };
    
    // 通过 Skill Router 调用
    let response = skill_router.invoke(skill_request).await
        .map_err(|e| MatrixError::Skill(e.to_string()))?;
    
    Ok(Json(response.into()))
}
```

**Skill 实现**:
```rust
// skills/matrix-register/src/lib.rs

#[skill_api]
pub trait MatrixRegister {
    /// 注册用户
    async fn register_user(&self, req: RegisterRequest) -> Result<RegisterResponse>;
    
    /// 验证 DID
    async fn verify_did(&self, did: &str) -> Result<bool>;
    
    /// 检查注册策略
    async fn check_policy(&self, req: &RegisterRequest) -> Result<PolicyResult>;
}

#[skill_impl]
pub struct MatrixRegisterSkill {
    identity_service: Arc<dyn IdentityService>,
    policy: RegistrationPolicy,
}

#[skill_handler]
async fn register_user(req: RegisterRequest) -> Result<RegisterResponse> {
    // 1. 验证 DID 格式
    // 2. 检查注册策略（邀请码、白名单等）
    // 3. 调用 Identity Service 创建用户
    // 4. 返回 Matrix 格式的响应
}
```

---

### 方案二：Native Skill（过渡方案）

```
crates/
└── cis-matrix-register-skill/
    ├── Cargo.toml
    └── src/
        ├── lib.rs
        ├── register.rs
        └── policy/
            ├── mod.rs
            ├── invite_code.rs
            └── whitelist.rs
```

**优点**:
- 与核心在同一仓库，便于开发
- 可直接访问核心服务
- 性能更好（无 WASM 开销）

**缺点**:
- 不如 WASM Skill 灵活
- 需要重新编译才能更新

---

### 方案三：Core Service + Skill Hook（混合方案）

```
服务层（cis-core/src/service/）
├── mod.rs
├── identity_service.rs     # 用户身份管理
├── matrix_service.rs       # Matrix 协议服务
└── skill_hook_service.rs   # Skill 钩子服务

Skills/
└── matrix-register-hooks/  # 仅包含策略钩子
    ├── src/
    │   ├── pre_register.rs  # 注册前验证
    │   └── post_register.rs # 注册后处理
```

**流程**:
```
Matrix API → MatrixService → Skill Hook (验证) → IdentityService → 存储
```

**优点**:
- 核心保持简洁
- Skill 只处理业务逻辑
- 易于测试和扩展

---

## 推荐：方案一 + 方案三 结合

### 核心层（精简）

```rust
// cis-core/src/matrix/routes/register.rs
pub async fn register(
    State(matrix_service): State<Arc<MatrixService>>,
    Json(req): Json<RegisterRequest>,
) -> Result<Json<RegisterResponse>> {
    // 只处理协议层，业务逻辑委托给服务
    let result = matrix_service.register_user(req).await?;
    Ok(Json(result))
}
```

### 服务层

```rust
// cis-core/src/service/matrix_service.rs
pub async fn register_user(&self, req: RegisterRequest) -> Result<RegisterResponse> {
    // 1. 调用 Skill Hook 进行前置验证
    let hook_result = self.skill_hook
        .call("matrix-register", "pre_register", &req)
        .await?;
    
    if !hook_result.allowed {
        return Err(Error::Rejected(hook_result.reason));
    }
    
    // 2. 调用 Identity Service 创建用户
    let user = self.identity.create_user(&req.did).await?;
    
    // 3. 生成 Matrix 格式的令牌
    let access_token = self.generate_token(&user);
    
    // 4. 调用 Skill Hook 进行后置处理
    self.skill_hook
        .call("matrix-register", "post_register", &user)
        .await?;
    
    Ok(RegisterResponse {
        user_id: req.username,
        access_token,
        ...
    })
}
```

### Skill 层（独立仓库）

```rust
// github.com/MoSiYuan/cis-matrix-register-skill
// 独立开发、独立版本、可热更新

#[skill_manifest]
struct MatrixRegisterSkill {
    name: "matrix-register",
    version: "1.0.0",
    hooks: ["pre_register", "post_register"],
}

#[hook_handler]
async fn pre_register(req: &RegisterRequest) -> HookResult {
    // 实现邀请码验证
    // 实现邮箱验证
    // 实现白名单检查
    // 等等...
}
```

---

## 迁移路径

### 阶段一：当前（内嵌）
✅ 已完成，作为临时方案

### 阶段二：Service 层拆分（短期）
```
1. 创建 MatrixService
2. 将 register.rs 逻辑移到 service
3. 路由只负责协议转换
```

### 阶段三：Skill 化（中期）
```
1. 定义 Skill API 接口
2. 创建 matrix-register Skill
3. 添加 Skill Hook 机制
4. 迁移注册逻辑到 Skill
```

### 阶段四：独立仓库（长期）
```
1. 将 Skill 移到独立仓库
2. 通过 Skill Registry 分发
3. 支持热更新和版本管理
```

---

## 为什么这样更好？

| 维度 | 内嵌方案 | Skill 方案 |
|------|----------|------------|
| **关注点分离** | ❌ 混乱 | ✅ 清晰 |
| **可扩展性** | ❌ 需改核心 | ✅ 插件化 |
| **可测试性** | ❌ 难单元测试 | ✅ 独立测试 |
| **热更新** | ❌ 需重启 | ✅ 可运行时更新 |
| **多租户** | ❌ 难支持 | ✅ 不同策略不同租户 |
| **安全性** | ⚠️ 核心风险 | ✅ 沙箱隔离 |

---

## 具体实现建议

### 1. 立即行动（本周）
- 创建 `MatrixService` 层
- 将注册逻辑从路由移到 service
- 保持接口不变

### 2. 短期（本月）
- 定义 `RegisterSkill` trait
- 创建本地 `NativeSkill` 实现
- 添加配置切换机制

### 3. 中期（本季度）
- 实现 WASM Skill 支持
- 创建独立仓库
- 添加 Skill Registry

### 4. 长期（下半年）
- 支持 Skill 市场
- 多版本共存
- A/B 测试支持

---

## 总结

您的判断完全正确：
1. **Matrix 注册应该 Skill 化** - 不是核心职责
2. **核心应该精简** - 只保留协议路由
3. **业务逻辑可插拔** - 通过 Skill 实现

推荐路径：**先 Service 化，再 Skill 化，最后独立化**
