# WebSocket Concurrent Connections Test DAG
#
# This DAG tests concurrent WebSocket connection handling including:
# - Multiple simultaneous connections
# - Message ordering
# - Resource cleanup
#
dag_id = "websocket_concurrent_test"
version = "1.0.0"
description = "Concurrent WebSocket connections test suite"

# Connection 1
[[nodes]]
id = "ws_connect_1"
name = "WebSocket Connect 1"
type = "websocket_client"
action = "connect"
config = { url = "ws://localhost:6768", connection_id = "conn-1" }

# Connection 2
[[nodes]]
id = "ws_connect_2"
name = "WebSocket Connect 2"
type = "websocket_client"
action = "connect"
config = { url = "ws://localhost:6768", connection_id = "conn-2" }

# Connection 3
[[nodes]]
id = "ws_connect_3"
name = "WebSocket Connect 3"
type = "websocket_client"
action = "connect"
config = { url = "ws://localhost:6768", connection_id = "conn-3" }

# Send messages concurrently from all connections
[[nodes]]
id = "ws_send_1"
name = "Send from Connection 1"
type = "websocket_message"
action = "send"
dependencies = ["ws_connect_1", "ws_connect_2", "ws_connect_3"]
config = { connection_id = "conn-1", message_type = "data", payload = "Message from conn-1", sequence = 1 }

[[nodes]]
id = "ws_send_2"
name = "Send from Connection 2"
type = "websocket_message"
action = "send"
dependencies = ["ws_connect_1", "ws_connect_2", "ws_connect_3"]
config = { connection_id = "conn-2", message_type = "data", payload = "Message from conn-2", sequence = 1 }

[[nodes]]
id = "ws_send_3"
name = "Send from Connection 3"
type = "websocket_message"
action = "send"
dependencies = ["ws_connect_1", "ws_connect_2", "ws_connect_3"]
config = { connection_id = "conn-3", message_type = "data", payload = "Message from conn-3", sequence = 1 }

# Receive responses
[[nodes]]
id = "ws_receive_1"
name = "Receive on Connection 1"
type = "websocket_message"
action = "receive"
dependencies = ["ws_send_1"]
config = { connection_id = "conn-1", timeout = 5 }

[[nodes]]
id = "ws_receive_2"
name = "Receive on Connection 2"
type = "websocket_message"
action = "receive"
dependencies = ["ws_send_2"]
config = { connection_id = "conn-2", timeout = 5 }

[[nodes]]
id = "ws_receive_3"
name = "Receive on Connection 3"
type = "websocket_message"
action = "receive"
dependencies = ["ws_send_3"]
config = { connection_id = "conn-3", timeout = 5 }

# Verify all connections are still active
[[nodes]]
id = "ws_verify_all_active"
name = "Verify All Connections Active"
type = "websocket_assert"
action = "assert_connections"
dependencies = ["ws_receive_1", "ws_receive_2", "ws_receive_3"]
config = { active_connections = ["conn-1", "conn-2", "conn-3"] }

# Send concurrent pings
[[nodes]]
id = "ws_ping_1"
name = "Ping from Connection 1"
type = "websocket_message"
action = "send"
dependencies = ["ws_verify_all_active"]
config = { connection_id = "conn-1", message_type = "ping", ping_id = 1 }

[[nodes]]
id = "ws_ping_2"
name = "Ping from Connection 2"
type = "websocket_message"
action = "send"
dependencies = ["ws_verify_all_active"]
config = { connection_id = "conn-2", message_type = "ping", ping_id = 1 }

[[nodes]]
id = "ws_ping_3"
name = "Ping from Connection 3"
type = "websocket_message"
action = "send"
dependencies = ["ws_verify_all_active"]
config = { connection_id = "conn-3", message_type = "ping", ping_id = 1 }

# Wait for all pongs
[[nodes]]
id = "ws_wait_pongs"
name = "Wait for All Pongs"
type = "websocket_wait"
action = "wait_for_messages"
dependencies = ["ws_ping_1", "ws_ping_2", "ws_ping_3"]
config = { message_type = "pong", count = 3, timeout = 10 }

# Close all connections
[[nodes]]
id = "ws_close_1"
name = "Close Connection 1"
type = "websocket_client"
action = "close"
dependencies = ["ws_wait_pongs"]
config = { connection_id = "conn-1", graceful = true }

[[nodes]]
id = "ws_close_2"
name = "Close Connection 2"
type = "websocket_client"
action = "close"
dependencies = ["ws_wait_pongs"]
config = { connection_id = "conn-2", graceful = true }

[[nodes]]
id = "ws_close_3"
name = "Close Connection 3"
type = "websocket_client"
action = "close"
dependencies = ["ws_wait_pongs"]
config = { connection_id = "conn-3", graceful = true }

# Verify all connections closed
[[nodes]]
id = "ws_verify_all_closed"
name = "Verify All Connections Closed"
type = "websocket_assert"
action = "assert_connections"
dependencies = ["ws_close_1", "ws_close_2", "ws_close_3"]
config = { no_active_connections = true }

[metadata]
test_suite = "websocket_concurrent"
priority = "P0"
created_at = "2026-02-07"
author = "CIS Test Framework"
