# WebSocket Error Handling Test DAG
#
# This DAG tests WebSocket error handling including:
# - Connection failures
# - Invalid message handling
# - Timeout scenarios
# - Authentication failures
#
dag_id = "websocket_error_test"
version = "1.0.0"
description = "WebSocket error handling test suite"

[[nodes]]
id = "ws_connect_invalid_url"
name = "Connect to Invalid URL"
type = "websocket_client"
action = "connect"
config = { url = "not-a-valid-url", expect_failure = true, timeout = 5 }

[[nodes]]
id = "ws_verify_invalid_url_fails"
name = "Verify Invalid URL Fails"
type = "websocket_assert"
action = "assert_error"
dependencies = ["ws_connect_invalid_url"]
config = { error_type = "connection_failed" }

[[nodes]]
id = "ws_connect_refused"
name = "Connect to Non-existent Server"
type = "websocket_client"
action = "connect"
dependencies = ["ws_verify_invalid_url_fails"]
config = { url = "ws://localhost:59999", expect_failure = true, timeout = 3 }

[[nodes]]
id = "ws_verify_refused_fails"
name = "Verify Connection Refused"
type = "websocket_assert"
action = "assert_error"
dependencies = ["ws_connect_refused"]
config = { error_type = "connection_refused" }

[[nodes]]
id = "ws_connect_valid"
name = "Connect to Valid Server"
type = "websocket_client"
action = "connect"
dependencies = ["ws_verify_refused_fails"]
config = { url = "ws://localhost:6768", timeout = 10 }

[[nodes]]
id = "ws_send_invalid_json"
name = "Send Invalid JSON"
type = "websocket_message"
action = "send_raw"
dependencies = ["ws_connect_valid"]
config = { raw_data = "{not valid json}", expect_error = true }

[[nodes]]
id = "ws_send_malformed_message"
name = "Send Malformed Message"
type = "websocket_message"
action = "send"
dependencies = ["ws_send_invalid_json"]
config = { 
    message_type = "unknown_type", 
    invalid_payload = true,
    expect_error = true 
}

[[nodes]]
id = "ws_test_timeout"
name = "Test Receive Timeout"
type = "websocket_message"
action = "receive"
dependencies = ["ws_send_malformed_message"]
config = { timeout = 1, expect_timeout = true }

[[nodes]]
id = "ws_send_auth_with_invalid_did"
name = "Send Auth with Invalid DID"
type = "websocket_message"
action = "send"
dependencies = ["ws_test_timeout"]
config = { 
    message_type = "auth", 
    did = "invalid-did-format",
    expect_failure = true 
}

[[nodes]]
id = "ws_send_auth_without_did"
name = "Send Auth without DID"
type = "websocket_message"
action = "send"
dependencies = ["ws_send_auth_with_invalid_did"]
config = { 
    message_type = "auth", 
    did = "",
    expect_failure = true 
}

[[nodes]]
id = "ws_simulate_network_error"
name = "Simulate Network Error"
type = "websocket_simulate"
action = "network_partition"
dependencies = ["ws_send_auth_without_did"]
config = { duration = 2 }

[[nodes]]
id = "ws_verify_error_state"
name = "Verify Error State"
type = "websocket_assert"
action = "assert_state"
dependencies = ["ws_simulate_network_error"]
config = { expected_state = "error" }

[[nodes]]
id = "ws_verify_reconnect_after_error"
name = "Verify Auto Reconnect"
type = "websocket_wait"
action = "wait_for_state"
dependencies = ["ws_verify_error_state"]
config = { target_state = "connected", timeout = 15 }

[[nodes]]
id = "ws_final_cleanup"
name = "Final Cleanup"
type = "websocket_client"
action = "close_all"
dependencies = ["ws_verify_reconnect_after_error"]
config = { graceful = false }

[metadata]
test_suite = "websocket_error"
priority = "P0"
created_at = "2026-02-07"
author = "CIS Test Framework"
