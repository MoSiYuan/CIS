# CIS 测试节点 - 真实构建版本
# 使用已缓存的 rust 镜像进行构建

FROM rust:1.75-slim-bookworm AS builder

WORKDIR /build

# 只复制必要文件以减少层数
COPY Cargo.toml Cargo.lock ./
COPY cis-core/Cargo.toml cis-core/
COPY cis-node/Cargo.toml cis-node/
COPY cis-skill-sdk/Cargo.toml cis-skill-sdk/
COPY cis-skill-sdk/cis-skill-sdk-derive/Cargo.toml cis-skill-sdk/cis-skill-sdk-derive/
COPY crates/cis-capability/Cargo.toml crates/cis-capability/
COPY crates/cis-mcp-adapter/Cargo.toml crates/cis-mcp-adapter/
COPY cis-gui/Cargo.toml cis-gui/
COPY skills/init-wizard/Cargo.toml skills/init-wizard/
COPY skills/push-client/Cargo.toml skills/push-client/
COPY skills/memory-organizer/Cargo.toml skills/memory-organizer/
COPY skills/ai-executor/Cargo.toml skills/ai-executor/
COPY skills/im/Cargo.toml skills/im/
COPY skills/dag-executor/Cargo.toml skills/dag-executor/
COPY skills/matrix-register-skill/Cargo.toml skills/matrix-register-skill/

# 创建虚拟源文件用于依赖缓存
RUN mkdir -p cis-core/src cis-node/src cis-skill-sdk/src cis-skill-sdk/cis-skill-sdk-derive/src \
    crates/cis-capability/src crates/cis-mcp-adapter/src cis-gui/src \
    skills/init-wizard/src skills/push-client/src skills/memory-organizer/src \
    skills/ai-executor/src skills/im/src skills/dag-executor/src skills/matrix-register-skill/src && \
    echo "fn main(){}" > cis-node/src/main.rs && \
    echo "" > cis-core/src/lib.rs

# 预编译依赖（使用离线模式避免网络问题）
RUN cargo build --release -p cis-node --offline 2>/dev/null || \
    cargo build --release -p cis-node 2>/dev/null || \
    true

# 复制真实源码
COPY cis-core/src cis-core/src
COPY cis-node/src cis-node/src
COPY cis-skill-sdk/src cis-skill-sdk/src
COPY cis-skill-sdk/cis-skill-sdk-derive/src cis-skill-sdk/cis-skill-sdk-derive/src
COPY crates/cis-capability/src crates/cis-capability/src
COPY crates/cis-mcp-adapter/src crates/cis-mcp-adapter/src
COPY cis-gui/src cis-gui/src
COPY skills/init-wizard/src skills/init-wizard/src
COPY skills/push-client/src skills/push-client/src
COPY skills/memory-organizer/src skills/memory-organizer/src
COPY skills/ai-executor/src skills/ai-executor/src
COPY skills/im/src skills/im/src
COPY skills/dag-executor/src skills/dag-executor/src
COPY skills/matrix-register-skill/src skills/matrix-register-skill/src

# 构建真实二进制
RUN touch cis-node/src/main.rs && \
    cargo build --release -p cis-node --offline 2>/dev/null || \
    cargo build --release -p cis-node && \
    strip target/release/cis-node

# 预下载 fastembed 向量模型 (~130MB)
# 使用相同的 builder 镜像来运行下载
RUN mkdir -p /tmp/model-cache && \
    cd /build && \
    cargo test --package cis-core test_embedding -- --ignored --test-threads=1 2>&1 || true && \
    cp -r ~/.cache/huggingface/fastembed* /tmp/model-cache/ 2>/dev/null || true

# 运行镜像 - 使用 alpine 减小体积
FROM alpine:3.18
RUN apk add --no-cache ca-certificates curl sqlite-libs libgcc bash

WORKDIR /app

# 复制预下载的向量模型
COPY --from=builder /tmp/model-cache /root/.cache/huggingface/

COPY --from=builder /build/target/release/cis-node /usr/local/bin/
RUN mkdir -p /var/lib/cis/data /etc/cis /var/log/cis

# 创建配置脚本
COPY test-network/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 7676 7677/udp 6767 6768
ENTRYPOINT ["/entrypoint.sh"]
