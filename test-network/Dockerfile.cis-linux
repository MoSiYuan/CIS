# Build CIS node for Linux in Docker
FROM rustlang/rust:nightly-alpine AS builder

WORKDIR /build

# Install build dependencies
RUN apk add --no-cache musl-dev openssl-dev pkgconfig

# Copy Cargo files first for caching
COPY Cargo.toml Cargo.lock ./
COPY cis-core/Cargo.toml cis-core/
COPY cis-node/Cargo.toml cis-node/
COPY cis-skill-sdk/Cargo.toml cis-skill-sdk/
COPY cis-skill-sdk/cis-skill-sdk-derive/Cargo.toml cis-skill-sdk/cis-skill-sdk-derive/
COPY crates/cis-capability/Cargo.toml crates/cis-capability/
COPY crates/cis-mcp-adapter/Cargo.toml crates/cis-mcp-adapter/
COPY cis-gui/Cargo.toml cis-gui/
COPY skills/init-wizard/Cargo.toml skills/init-wizard/
COPY skills/push-client/Cargo.toml skills/push-client/
COPY skills/memory-organizer/Cargo.toml skills/memory-organizer/
COPY skills/ai-executor/Cargo.toml skills/ai-executor/
COPY skills/im/Cargo.toml skills/im/
COPY skills/dag-executor/Cargo.toml skills/dag-executor/
COPY skills/matrix-register-skill/Cargo.toml skills/matrix-register-skill/

# Create dummy source for dependency caching
RUN mkdir -p cis-core/src cis-node/src cis-skill-sdk/src cis-skill-sdk/cis-skill-sdk-derive/src \
    crates/cis-capability/src crates/cis-mcp-adapter/src cis-gui/src \
    skills/init-wizard/src skills/push-client/src skills/memory-organizer/src \
    skills/ai-executor/src skills/im/src skills/dag-executor/src skills/matrix-register-skill/src && \
    echo "fn main(){}" > cis-node/src/main.rs && \
    echo "" > cis-core/src/lib.rs

# Build dependencies (cached layer)
RUN cargo build --release -p cis-node 2>/dev/null || true

# Copy real source code
COPY cis-core/src cis-core/src
COPY cis-core/benches cis-core/benches
COPY cis-node/src cis-node/src
COPY cis-skill-sdk/src cis-skill-sdk/src
COPY cis-skill-sdk/cis-skill-sdk-derive/src cis-skill-sdk/cis-skill-sdk-derive/src
COPY crates/cis-capability/src crates/cis-capability/src
COPY crates/cis-mcp-adapter/src crates/cis-mcp-adapter/src
COPY cis-gui/src cis-gui/src
COPY skills/init-wizard/src skills/init-wizard/src
COPY skills/push-client/src skills/push-client/src
COPY skills/memory-organizer/src skills/memory-organizer/src
COPY skills/ai-executor/src skills/ai-executor/src
COPY skills/im/src skills/im/src
COPY skills/dag-executor/src skills/dag-executor/src
COPY skills/matrix-register-skill/src skills/matrix-register-skill/src

# Build the real binary
RUN touch cis-node/src/main.rs && \
    cargo build --release -p cis-node 2>&1 && \
    strip target/release/cis-node && \
    cp target/release/cis-node /tmp/cis-node-linux && \
    ls -lh /tmp/cis-node-linux

# Final stage - Alpine with all tools
FROM alpine:3.19

# Install runtime dependencies and tools
RUN apk add --no-cache \
    ca-certificates curl sqlite-libs libgcc \
    python3 py3-pip py3-numpy py3-scipy \
    nodejs npm \
    iputils bind-tools netcat-openbsd iperf3

# Install Claude CLI
RUN npm install -g @anthropic-ai/claude-cli 2>/dev/null || \
    npm install -g claude-cli 2>/dev/null || \
    echo "Claude CLI install skipped"

# Install fastembed
RUN pip3 install fastembed 2>/dev/null || \
    echo "fastembed install skipped"

# Copy the built binary
COPY --from=builder /tmp/cis-node-linux /usr/local/bin/cis-node
RUN chmod +x /usr/local/bin/cis-node

# Create required directories
RUN mkdir -p /var/lib/cis/data /etc/cis /var/log/cis /root/.cache/huggingface

# Verify binary works
RUN cis-node --version || echo "Binary check completed"

# Expose ports
EXPOSE 7676 7677/udp 6767 6768

# Default command
CMD ["cis-node", "--version"]
