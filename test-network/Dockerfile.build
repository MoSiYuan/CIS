# CIS Test Node - 使用 Debian 构建
FROM rust:1.75-slim-bookworm AS builder

WORKDIR /build

# 复制所有 Cargo 文件 (利用缓存层)
COPY Cargo.toml Cargo.lock ./
COPY cis-core/Cargo.toml cis-core/
COPY cis-node/Cargo.toml cis-node/
COPY cis-skill-sdk/Cargo.toml cis-skill-sdk/
COPY cis-skill-sdk/cis-skill-sdk-derive/Cargo.toml cis-skill-sdk/cis-skill-sdk-derive/
COPY crates/cis-capability/Cargo.toml crates/cis-capability/
COPY crates/cis-mcp-adapter/Cargo.toml crates/cis-mcp-adapter/
COPY skills/init-wizard/Cargo.toml skills/init-wizard/
COPY skills/push-client/Cargo.toml skills/push-client/
COPY skills/memory-organizer/Cargo.toml skills/memory-organizer/
COPY skills/ai-executor/Cargo.toml skills/ai-executor/
COPY skills/im/Cargo.toml skills/im/
COPY skills/dag-executor/Cargo.toml skills/dag-executor/
COPY skills/matrix-register-skill/Cargo.toml skills/matrix-register-skill/
COPY cis-gui/Cargo.toml cis-gui/

# 创建虚拟源文件
RUN mkdir -p cis-core/src cis-node/src cis-skill-sdk/src cis-skill-sdk/cis-skill-sdk-derive/src \
    crates/cis-capability/src crates/cis-mcp-adapter/src cis-gui/src \
    skills/init-wizard/src skills/push-client/src skills/memory-organizer/src \
    skills/ai-executor/src skills/im/src skills/dag-executor/src skills/matrix-register-skill/src && \
    echo "fn main(){}" > cis-node/src/main.rs && \
    echo "" > cis-core/src/lib.rs

# 预编译依赖
RUN cargo build --release -p cis-node 2>/dev/null || true

# 复制实际源码
COPY cis-core/src cis-core/src
COPY cis-node/src cis-node/src
COPY cis-skill-sdk/src cis-skill-sdk/src
COPY cis-skill-sdk/cis-skill-sdk-derive/src cis-skill-sdk/cis-skill-sdk-derive/src
COPY crates/cis-capability/src crates/cis-capability/src
COPY crates/cis-mcp-adapter/src crates/cis-mcp-adapter/src
COPY skills/init-wizard/src skills/init-wizard/src
COPY skills/push-client/src skills/push-client/src
COPY skills/memory-organizer/src skills/memory-organizer/src
COPY skills/ai-executor/src skills/ai-executor/src
COPY skills/im/src skills/im/src
COPY skills/dag-executor/src skills/dag-executor/src
COPY skills/matrix-register-skill/src skills/matrix-register-skill/src
COPY cis-gui/src cis-gui/src

# 构建
RUN touch cis-node/src/main.rs && \
    cargo build --release -p cis-node && \
    strip target/release/cis-node

# 运行镜像
FROM alpine:3.19
RUN apk add --no-cache ca-certificates curl sqlite-libs libgcc

WORKDIR /app
COPY --from=builder /build/target/release/cis-node /usr/local/bin/
RUN mkdir -p /var/lib/cis/data /etc/cis

# 创建 entrypoint 脚本
RUN printf '%s\n' \
    '#!/bin/sh' \
    'cat > /etc/cis/config.toml << CFG' \
    '[node]' \
    'id = "'"'"'${CIS_NODE_ID}'"'"'"' \
    'name = "'"'"'${CIS_NODE_NAME}'"'"'"' \
    'did = "'"'"'${CIS_DID}'"'"'"' \
    'role = "'"'"'${CIS_NODE_ROLE:-worker}'"'"'"' \
    '' \
    '[ai.glm]' \
    'model = "'"'"'${GLM_MODEL:-code-plan-glm4.7}'"'"'"' \
    'base_url = "https://api.glm.ai/v1"' \
    '' \
    '[network]' \
    'discovery_port = 6767' \
    'pairing_port = 6768' \
    'CFG' \
    '' \
    'exec cis-node daemon --config /etc/cis/config.toml' \
    > /entrypoint.sh && chmod +x /entrypoint.sh

EXPOSE 7676 7677/udp 6767 6768
ENTRYPOINT ["/entrypoint.sh"]
