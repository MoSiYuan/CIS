# Build cis-node for Linux in Docker
FROM rustlang/rust:nightly-slim AS builder

WORKDIR /build

# Install dependencies
RUN apt-get update && apt-get install -y \
    pkg-config libssl-dev git \
    && rm -rf /var/lib/apt/lists/*

# Copy project files
COPY Cargo.toml Cargo.lock ./
COPY cis-core/Cargo.toml cis-core/
COPY cis-node/Cargo.toml cis-node/
COPY cis-skill-sdk/Cargo.toml cis-skill-sdk/
COPY cis-skill-sdk/cis-skill-sdk-derive/Cargo.toml cis-skill-sdk/cis-skill-sdk-derive/
COPY crates/cis-capability/Cargo.toml crates/cis-capability/
COPY crates/cis-mcp-adapter/Cargo.toml crates/cis-mcp-adapter/
COPY cis-gui/Cargo.toml cis-gui/
COPY skills/init-wizard/Cargo.toml skills/init-wizard/
COPY skills/push-client/Cargo.toml skills/push-client/
COPY skills/memory-organizer/Cargo.toml skills/memory-organizer/
COPY skills/ai-executor/Cargo.toml skills/ai-executor/
COPY skills/im/Cargo.toml skills/im/
COPY skills/dag-executor/Cargo.toml skills/dag-executor/
COPY skills/matrix-register-skill/Cargo.toml skills/matrix-register-skill/

# Create dummy source files for dependency caching
RUN mkdir -p cis-core/src cis-node/src cis-skill-sdk/src cis-skill-sdk/cis-skill-sdk-derive/src \
    crates/cis-capability/src crates/cis-mcp-adapter/src cis-gui/src \
    skills/init-wizard/src skills/push-client/src skills/memory-organizer/src \
    skills/ai-executor/src skills/im/src skills/dag-executor/src skills/matrix-register-skill/src && \
    echo "fn main(){}" > cis-node/src/main.rs && \
    echo "" > cis-core/src/lib.rs

# Build dependencies first (this will be cached)
RUN cargo build --release -p cis-node 2>/dev/null || cargo fetch

# Copy real source code
COPY cis-core/src cis-core/src
COPY cis-node/src cis-node/src
COPY cis-skill-sdk/src cis-skill-sdk/src
COPY cis-skill-sdk/cis-skill-sdk-derive/src cis-skill-sdk/cis-skill-sdk-derive/src
COPY crates/cis-capability/src crates/cis-capability/src
COPY crates/cis-mcp-adapter/src crates/cis-mcp-adapter/src
COPY cis-gui/src cis-gui/src
COPY skills/init-wizard/src skills/init-wizard/src
COPY skills/push-client/src skills/push-client/src
COPY skills/memory-organizer/src skills/memory-organizer/src
COPY skills/ai-executor/src skills/ai-executor/src
COPY skills/im/src skills/im/src
COPY skills/dag-executor/src skills/dag-executor/src
COPY skills/matrix-register-skill/src skills/matrix-register-skill/src

# Build the real binary
RUN touch cis-node/src/main.rs && \
    cargo build --release -p cis-node 2>&1 && \
    strip target/release/cis-node && \
    cp target/release/cis-node /output/cis-node && \
    ls -lh /output/cis-node

# Final stage - minimal alpine image
FROM alpine:3.19

# Install runtime dependencies
RUN apk add --no-cache \
    ca-certificates curl sqlite-libs libgcc \
    iputils bind-tools netcat-openbsd

# Copy the built binary
COPY --from=builder /output/cis-node /usr/local/bin/
RUN chmod +x /usr/local/bin/cis-node

# Create required directories
RUN mkdir -p /var/lib/cis/data /etc/cis /var/log/cis

# Expose ports
EXPOSE 7676 7677/udp 6767 6768

# Default command
CMD ["cis-node", "--version"]
