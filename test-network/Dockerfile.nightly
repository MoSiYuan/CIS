# 使用 nightly Rust 镜像
FROM rustlang/rust:nightly-slim as builder

# 安装依赖
RUN apt-get update && apt-get install -y pkg-config libssl-dev libsqlite3-dev

WORKDIR /build

# 复制所有项目文件
COPY . .

# 构建发布版本 (指定目标目录)
ENV CARGO_TARGET_DIR=/tmp/cis-docker-target
RUN cargo build --release -p cis-node

# 运行阶段 - 使用 debian testing 以获得更新的 glibc
FROM debian:trixie-slim

RUN apt-get update && apt-get install -y ca-certificates libsqlite3-0 curl && rm -rf /var/lib/apt/lists/*

COPY --from=builder /tmp/cis-docker-target/release/cis-node /usr/local/bin/
RUN chmod +x /usr/local/bin/cis-node

# 创建启动脚本
RUN printf '%s\n' \
    '#!/bin/sh' \
    'mkdir -p /var/lib/cis/data /etc/cis' \
    'cat > /etc/cis/config.toml << EOF' \
    '[node]' \
    'id = "'"'"'${CIS_NODE_ID}'"'"'"' \
    'name = "'"'"'${CIS_NODE_NAME}'"'"'"' \
    'did = "'"'"'${CIS_DID}'"'"'"' \
    'role = "'"'"'${CIS_NODE_ROLE:-worker}'"'"'"' \
    '[network]' \
    'discovery_port = 6767' \
    'pairing_port = 6768' \
    'EOF' \
    'exec cis-node daemon --config /etc/cis/config.toml' \
    > /entrypoint.sh && chmod +x /entrypoint.sh

EXPOSE 7676 7677/udp 6767 6768

ENTRYPOINT ["/entrypoint.sh"]
