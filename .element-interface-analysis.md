# CIS èŠ‚ç‚¹å¯¹å¤–æš´éœ²æ¥å£é€»è¾‘åˆ†æ

## æ‰§è¡Œæ‘˜è¦

CIS èŠ‚ç‚¹å¯¹å¤–æš´éœ²äº†å¤šä¸ªæ¥å£ï¼Œä½†ç›®å‰ **Matrix Client-Server APIï¼ˆ7676 ç«¯å£ï¼Œä¾› Element å®¢æˆ·ç«¯è¿æ¥ï¼‰çš„å¯åŠ¨é€»è¾‘ä¸å®Œæ•´**ï¼Œåªæœ‰æœåŠ¡å®šä¹‰ï¼Œæ²¡æœ‰çœ‹åˆ°å®é™…çš„å¯åŠ¨è°ƒç”¨ã€‚

---

## å¯¹å¤–æš´éœ²çš„æ¥å£

### 1. Matrix Client-Server API (Port 7676) âš ï¸ æœªå®Œæ•´å®ç°

**ä½ç½®**: `cis-core/src/matrix/server.rs`

**åŠŸèƒ½**: æä¾› Matrix åè®®å…¼å®¹çš„ HTTP APIï¼Œä¾› Element ç­‰ Matrix å®¢æˆ·ç«¯è¿æ¥

**ä»£ç ç»“æ„**:
```rust
pub struct MatrixServer {
    port: u16,              // é»˜è®¤ 7676
    store: Arc<MatrixStore>,
    bridge: Option<Arc<MatrixBridge>>,
}

impl MatrixServer {
    pub async fn run(&self) -> Result<(), MatrixError> {
        // ç»‘å®šåˆ° 0.0.0.0:port
        // å¯åŠ¨ axum HTTP æœåŠ¡å™¨
    }
}
```

**æš´éœ²çš„ç«¯ç‚¹**:
- `GET /_matrix/client/versions` - æœåŠ¡å™¨å‘ç°
- `POST /_matrix/client/v3/login` - ç™»å½•
- `GET /_matrix/client/v3/sync` - åŒæ­¥æ¶ˆæ¯
- `POST /_matrix/client/v3/createRoom` - åˆ›å»ºæˆ¿é—´
- `POST /_matrix/client/v3/rooms/{room_id}/join` - åŠ å…¥æˆ¿é—´
- `PUT /_matrix/client/v3/rooms/{room_id}/send/{event_type}/{txn_id}` - å‘é€æ¶ˆæ¯
- `GET /.well-known/matrix/client` - å®¢æˆ·ç«¯å‘ç°

**é—®é¢˜**: 
- âš ï¸ `MatrixServer` åªè¢«å®šä¹‰å’Œåˆ›å»ºï¼Œ**æ²¡æœ‰çœ‹åˆ° `run()` è¢«è°ƒç”¨çš„ä»£ç **
- âš ï¸ cis-node ä¸­æ²¡æœ‰å‘½ä»¤æ¥å¯åŠ¨ Matrix æœåŠ¡å™¨

---

### 2. P2P/è”é‚¦é€šä¿¡æ¥å£ (Port 7677) âœ… å·²å®ç°

**ä½ç½®**: 
- `cis-core/src/p2p/mod.rs`
- `cis-node/src/commands/p2p.rs`
- `cis-node/src/commands/network.rs`

**åŠŸèƒ½**: èŠ‚ç‚¹é—´ P2P é€šä¿¡ã€è”é‚¦åŒæ­¥

**å¯åŠ¨æ–¹å¼**:
```bash
cis p2p start --bind 0.0.0.0:7677
cis network init  # ä¹Ÿä¼šå¯åŠ¨ P2P
```

**ä»£ç è°ƒç”¨é“¾**:
1. `cis-node/src/commands/p2p.rs::handle()` 
2. â†’ `P2PNetwork::start()`
3. â†’ å¯åŠ¨ mDNS å‘ç°ã€DHTã€QUIC ä¼ è¾“ç­‰

---

### 3. GLM API Service (Port 6767) âœ… å·²å®ç°

**ä½ç½®**: 
- `cis-core/src/glm/mod.rs`
- `cis-node/src/commands/glm.rs`

**åŠŸèƒ½**: äº‘ç«¯èŠ‚ç‚¹ API æœåŠ¡ï¼Œç”¨äº DAG è¿œç¨‹æ‰§è¡Œ

**å¯åŠ¨æ–¹å¼**:
```bash
cis glm start --bind 127.0.0.1:6767
```

**ä»£ç è°ƒç”¨é“¾**:
1. `cis-node/src/commands/glm.rs::execute()`
2. â†’ `start_glm_api_service(config).await`
3. â†’ å¯åŠ¨ HTTP æœåŠ¡å™¨

---

### 4. WebSocket Federation (Port 6768) âš ï¸ éƒ¨åˆ†å®ç°

**ä½ç½®**: `cis-core/src/matrix/websocket/`

**åŠŸèƒ½**: WebSocket è”é‚¦ï¼ˆä½å»¶è¿Ÿã€æŒä¹…è¿æ¥ï¼‰

**çŠ¶æ€**: 
- æœ‰æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å®ç°
- æœ‰æ³¨é‡Š `// server.run().await?;` ä½†æœªå®é™…è°ƒç”¨
- éœ€è¦ MatrixNucleus å¯åŠ¨

---

## å…³é”®å‘ç°

### 1. MatrixServer æœªè¢«å¯åŠ¨ âŒ

æœç´¢æ•´ä¸ªä»£ç åº“ï¼Œ**æ²¡æœ‰æ‰¾åˆ° `MatrixServer::run()` çš„è°ƒç”¨**:

```bash
# æœç´¢ MatrixServer çš„è°ƒç”¨
grep -rn "MatrixServer::" cis-node/src/  # æ— ç»“æœ
grep -rn "\.run\(\)" cis-node/src/        # æ—  MatrixServer ç›¸å…³
```

åªæœ‰æµ‹è¯•ä»£ç ä¸­åˆ›å»ºäº† MatrixServer å®ä¾‹:
```rust
// cis-core/src/matrix/server.rs:116
let server = MatrixServer::new(0, store);
```

### 2. æ²¡æœ‰ `cis node start` æˆ– `cis matrix start` å‘½ä»¤ âŒ

æŸ¥çœ‹ `cis-node/src/main.rs` ä¸­çš„ Commands:
- âœ… `cis p2p` - P2P ç½‘ç»œç®¡ç†
- âœ… `cis glm` - GLM æœåŠ¡
- âœ… `cis network` - ç½‘ç»œ ACL ç®¡ç†
- âŒ **æ²¡æœ‰ `cis matrix` æˆ– `cis server` å‘½ä»¤æ¥å¯åŠ¨ Matrix æœåŠ¡å™¨**

### 3. Element å®¢æˆ·ç«¯æ— æ³•è¿æ¥ âŒ

ç”±äº MatrixServer æ²¡æœ‰è¢«å¯åŠ¨ï¼š
- 7676 ç«¯å£ä¸ä¼šè¢«ç›‘å¬
- Element å®¢æˆ·ç«¯æ— æ³•è¿æ¥
- æ— æ³•å®ç° Matrix å®¢æˆ·ç«¯åŠŸèƒ½

---

## ä¿®å¤å»ºè®®

### æ–¹æ¡ˆ 1: æ·»åŠ  `cis matrix start` å‘½ä»¤ï¼ˆæ¨èï¼‰

åœ¨ `cis-node/src/commands/` æ·»åŠ  `matrix.rs`:

```rust
//! Matrix æœåŠ¡å™¨ç®¡ç†å‘½ä»¤

use clap::Subcommand;

#[derive(Debug, Subcommand)]
pub enum MatrixCommands {
    /// å¯åŠ¨ Matrix æœåŠ¡å™¨
    Start {
        /// ç›‘å¬ç«¯å£
        #[arg(short, long, default_value = "7676")]
        port: u16,
        /// åå°è¿è¡Œ
        #[arg(long)]
        daemon: bool,
    },
    /// åœæ­¢ Matrix æœåŠ¡å™¨
    Stop,
    /// æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
    Status,
}

pub async fn handle(cmd: MatrixCommands) -> anyhow::Result<()> {
    match cmd {
        MatrixCommands::Start { port, daemon } => {
            let store = Arc::new(MatrixStore::open_in_memory()?);
            let server = MatrixServer::new(port, store);
            
            println!("ğŸš€ Starting Matrix server on port {}", port);
            println!("   Element clients can connect to: http://localhost:{}", port);
            
            server.run().await?;
        }
        // ...
    }
    Ok(())
}
```

ç„¶ååœ¨ `main.rs` æ·»åŠ :
```rust
#[command(subcommand)]
enum Commands {
    // ...
    /// Matrix server management (for Element clients)
    Matrix {
        #[command(subcommand)]
        action: commands::matrix::MatrixCommands,
    },
}
```

### æ–¹æ¡ˆ 2: åœ¨ `cis node start` ä¸­å¯åŠ¨ï¼ˆå¦‚æœå­˜åœ¨è¯¥å‘½ä»¤ï¼‰

å¦‚æœæ·»åŠ  `cis node start` å‘½ä»¤ï¼Œå¯ä»¥ä¸€å¹¶å¯åŠ¨ Matrix æœåŠ¡å™¨:

```rust
async fn start_node() -> Result<()> {
    // å¯åŠ¨ P2P
    p2p_network.start().await?;
    
    // å¯åŠ¨ Matrix æœåŠ¡å™¨
    let matrix_server = MatrixServer::new(7676, store).await?;
    tokio::spawn(async move {
        matrix_server.run().await.unwrap();
    });
    
    Ok(())
}
```

### æ–¹æ¡ˆ 3: åœ¨ `cis init` æ—¶è‡ªåŠ¨å¯åŠ¨

åœ¨åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨å¯åŠ¨ Matrix æœåŠ¡å™¨ä½œä¸ºåå°æœåŠ¡ã€‚

---

## ä»£ç ä½ç½®æ±‡æ€»

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ |
|------|----------|------|
| MatrixServer å®šä¹‰ | `cis-core/src/matrix/server.rs` | âœ… å®Œæ•´ |
| Matrix è·¯ç”± | `cis-core/src/matrix/routes/*.rs` | âœ… å®Œæ•´ |
| MatrixStore | `cis-core/src/matrix/store.rs` | âœ… å®Œæ•´ |
| P2P å¯åŠ¨ | `cis-node/src/commands/p2p.rs` | âœ… å·²é›†æˆ |
| GLM å¯åŠ¨ | `cis-node/src/commands/glm.rs` | âœ… å·²é›†æˆ |
| **Matrix å¯åŠ¨** | **ç¼ºå¤±** | âŒ **éœ€è¦æ·»åŠ ** |

---

## ç›¸å…³ç«¯å£

| ç«¯å£ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| 7676 | Matrix Client-Server API (Element) | âŒ æœªå¯åŠ¨ |
| 7677 | P2P/è”é‚¦é€šä¿¡ | âœ… å¯ç”¨ |
| 6767 | GLM API Service | âœ… å¯ç”¨ |
| 6768 | WebSocket Federation | âš ï¸ éƒ¨åˆ†å®ç° |

---

## ç»“è®º

ç›®å‰ CIS èŠ‚ç‚¹**æ— æ³•å¯¹å¤–æä¾› Element å®¢æˆ·ç«¯è¿æ¥**ï¼Œå› ä¸º MatrixServer è™½ç„¶å®šä¹‰å®Œæ•´ï¼Œä½†**ç¼ºå°‘å¯åŠ¨é€»è¾‘**ã€‚éœ€è¦æ·»åŠ ç›¸åº”çš„ CLI å‘½ä»¤æ¥å¯åŠ¨ Matrix æœåŠ¡å™¨ã€‚

å»ºè®®ä¼˜å…ˆå®æ–½**æ–¹æ¡ˆ 1**ï¼ˆæ·»åŠ  `cis matrix start` å‘½ä»¤ï¼‰ï¼Œè¿™æ ·å¯ä»¥ï¼š
1. æ˜ç¡®åŒºåˆ†ä¸åŒçš„æœåŠ¡åŠŸèƒ½
2. çµæ´»æ§åˆ¶ Matrix æœåŠ¡å™¨çš„å¯åŠ¨/åœæ­¢
3. ä¾¿äºè°ƒè¯•å’Œå¼€å‘

---

**åˆ†ææ—¶é—´**: 2026-02-07  
**åˆ†æèŒƒå›´**: cis-core, cis-node  
**å‘ç°é—®é¢˜**: 1 ä¸ªå…³é”®é—®é¢˜ï¼ˆMatrixServer æœªå¯åŠ¨ï¼‰
