# 飞书机器人配置检查清单

## 当前状态

- ✅ 应用已创建
- ✅ 权限已申请
- ✅ 应用已发布（v0.1.0）
- ✅ API 连接正常
- ❌ 机器人能力可能未启用
- ❌ 会话列表为空

---

## 🔍 飞书开放平台配置检查

### 1. 检查机器人能力

访问以下页面，确认是否已添加机器人能力：

```
https://open.feishu.cn/app/cli_a90a99e490f95cc7/capability
```

**操作步骤**：
1. 查看是否有「机器人」相关的能力卡片
2. 如果看到「机器人」卡片但状态为「未启用」：
   - 点击「添加」或「启用」
   - 按照提示完成配置

### 2. 检查事件订阅

```
https://open.feishu.cn/app/cli_a90a99e490f95cc7/event
```

**注意**：
- 轮询模式**不需要**配置事件订阅
- 事件订阅只用于 Webhook 模式
- 如果看到事件订阅页面，可以忽略

### 3. 重新发布应用（添加机器人能力后）

如果启用了机器人能力，需要重新发布：

```
https://open.feishu.cn/app/cli_a90a99e490f95cc7/release
```

1. 点击「创建新版本」
2. 版本号：`0.2.0`
3. 更新说明：`启用机器人能力，支持私聊和群聊`
4. 点击「保存」
5. 点击「申请发布」

**注意**：
- 自建应用通常审核很快（几分钟）
- 审核通过后需要重新在飞书中添加机器人

---

## 🎯 临时测试方案：手动创建会话

如果机器人能力还未启用，我们可以手动触发 API 来创建测试会话。

### 方法：直接使用飞书 API 发送测试消息

当前轮询器每 10 秒检查一次会话列表，只要会话存在就能处理消息。

---

## 📊 权限说明

飞书自建应用的机器人使用限制：

| 会话类型 | 需要的条件 |
|---------|-----------|
| **企业内群聊** | ✅ 机器人能力启用 + 应用发布 |
| **外部群聊** | ❌ 自建应用不支持 |
| **私聊** | ⚠️ 需要机器人能力 + 用户主动发起 |

---

## ⚡ 快速解决

### 推荐：启用机器人能力

1. **访问机器人能力页面**：
   ```
   https://open.feishu.cn/app/cli_a90a99e490f95cc7/bot
   ```

2. **添加机器人能力**：
   - 如果看到「添加能力」按钮
   - 点击并选择「机器人」

3. **配置机器人信息**：
   - 名称：`CIS AI Assistant`
   - 描述：`CIS 智能助手`
   - 头像：可选

4. **保存并发布应用**

5. **等待审核通过**（通常几分钟）

6. **重新在飞书中搜索机器人并添加到群聊**

---

## 🔧 如果还是不行

### 检查当前配置

```bash
# 1. 检查配置文件
cat ~/.cis/config/feishu_im.toml

# 2. 检查轮询器是否运行
ps aux | grep run_poller

# 3. 查看日志
tail -20 /tmp/feishu_poller.log

# 4. 重新测试 API
cargo run --example test_api
```

### 重启轮询器

如果轮询器有问题，重启一下：

```bash
# 停止旧进程
pkill -f run_poller

# 重新启动
cargo run --example run_poller
```

---

## 💡 下一步

1. **检查飞书开放平台**：确认机器人能力已启用
2. **重新发布应用**：如果刚启用机器人能力
3. **创建企业内群聊**：只有自己也可以
4. **添加机器人到群聊**
5. **测试对话**

完成以上步骤后，运行 `cargo run --example test_api` 应该能看到会话列表不再为空。
