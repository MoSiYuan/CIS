# 飞书机器人测试指南

## 问题：外部群无法添加机器人

飞书自建应用的机器人通常只能在**企业内部群聊**中使用，外部群有权限限制。

---

## ✅ 解决方案

### 方案 1: 创建企业内测试群

1. **在飞书 PC 端创建群聊**
   - 点击左侧 `+` →「创建群聊」
   - 选择「企业内部群」
   - 添加同事（或者只有自己也可以）

2. **添加机器人到群聊**
   - 进入群聊
   - 点击右上角 `...` →「设置」
   - 找到「群机器人」
   - 搜索：`CIS AI Assistant` 或 `cli_a90a99e490f95cc7`
   - 点击添加

3. **测试对话**
   ```
   @CIS AI Assistant 你好
   ```

---

### 方案 2: 启用机器人能力的私聊

如果需要私聊功能，需要先在飞书开放平台启用机器人能力：

1. **访问机器人配置页面**：
   ```
   https://open.feishu.cn/app/cli_a90a99e490f95cc7/bot
   ```

2. **启用机器人能力**：
   - 查看是否有「添加能力」按钮
   - 添加「机器人」能力
   - 设置机器人名称、头像、简介

3. **重新发布应用**：
   ```
   https://open.feishu.cn/app/cli_a90a99e490f95cc7/release
   ```
   - 创建新版本（0.2.0）
   - 填写更新说明：「启用机器人能力」
   - 申请发布

4. **等待审核通过后**：
   - 重新在飞书中搜索机器人
   - 应该能看到「发消息」按钮

---

### 方案 3: 使用测试群聊（最简单）

1. **创建单人群聊**
   - 飞书允许创建只有自己的群聊
   - 可以当作测试环境使用

2. **步骤**：
   - 创建群聊（不邀请其他人）
   - 添加机器人
   - @机器人测试

---

## 🔍 诊断当前状态

让我检查一下轮询器是否正在运行，以及是否有任何消息：

```bash
# 检查轮询器进程
ps aux | grep run_poller | grep -v grep

# 查看最新日志
tail -20 /tmp/feishu_poller.log

# 重新测试 API 连接
cargo run --example test_api
```

---

## ⚡ 快速测试流程

### 最简单的方式：企业内群

1. **创建群聊**
   - 飞书 → `+` →「创建群聊」
   - 选择「企业内部群」
   - 不邀请其他人也可以

2. **添加机器人**
   - 群设置 → 群机器人
   - 搜索机器人名称/ID
   - 添加

3. **发送消息**
   ```
   @CIS AI Assistant 测试消息
   ```

4. **查看回复**
   - 最多等待 10 秒（轮询间隔）
   - 查看轮询器日志

---

## 📊 权限说明

飞书自建应用的机器人使用限制：

| 功能 | 企业内部群 | 外部群 | 私聊 |
|------|----------|--------|------|
| 自建应用机器人 | ✅ 支持 | ❌ 不支持 | ⚠️ 需启用能力 |
| 应用卡片 | ✅ 可查看 | ✅ 可查看 | ✅ 可查看 |
| 对话功能 | ⚠️ 需添加机器人 | ❌ 无法添加 | ⚠️ 需启用能力 |

---

## 🎯 推荐操作

### 立即可做：创建企业内群

1. **在飞书中操作**：
   - 点击左上角搜索框旁边的 `+`
   - 选择「创建群聊」
   - 选择「企业内部群」
   - 群名称：`CIS 测试群`
   - 不邀请其他人（只有自己）

2. **添加机器人**：
   - 进入群聊
   - 右上角 `...` →「设置」→「群机器人」
   - 点击「添加机器人」
   - 搜索：`cli_a90a99e490f95cc7`（完整 App ID）
   - 添加

3. **测试**：
   - 输入：`@CIS AI Assistant 你好`
   - 等待回复

---

## 🔧 如果还是无法添加

### 检查应用状态

访问飞书开放平台确认：

1. **机器人能力**：
   ```
   https://open.feishu.cn/app/cli_a90a99e490f95cc7/bot
   ```
   - 确认机器人能力已添加

2. **权限配置**：
   ```
   https://open.feishu.cn/app/cli_a90a99e490f95cc7/permission
   ```
   - 确认有 `im:message` 权限

3. **版本发布**：
   ```
   https://open.feishu.cn/app/cli_a90a99e490f95cc7/release
   ```
   - 确认有可用版本

### 如果以上都正常但仍然无法添加

可能需要：
1. 重新发布应用（启用机器人能力后）
2. 等待版本审核通过（可能需要几分钟到几小时）
3. 联系飞书技术支持

---

## 📝 测试命令

在尝试添加机器人到群聊后，运行以下命令验证：

```bash
# 1. 测试 API 连接
cargo run --example test_api

# 2. 查看会话列表
cargo run --example feishu_sessions
# 然后输入：list

# 3. 查看轮询器日志
tail -f /tmp/feishu_poller.log
```

如果会话列表显示有会话，说明机器人已成功添加！
