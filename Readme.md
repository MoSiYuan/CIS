**独联体**  
**CIS** (Cluster of Independent Systems)

版本：v1.0-FINAL  
分类：硬件绑定型分布式系统规范

[![CI](https://github.com/your-org/cis/actions/workflows/ci.yml/badge.svg)](https://github.com/your-org/cis/actions/workflows/ci.yml)
[![Release](https://github.com/your-org/cis/actions/workflows/release.yml/badge.svg)](https://github.com/your-org/cis/releases)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

---

## 快速开始

### 安装

**macOS** (Homebrew):
```bash
brew install cis
cis init
```

**Linux**:
```bash
curl -fsSL https://github.com/your-org/cis/releases/latest/download/install.sh | bash
cis init
```

**Windows** (PowerShell):
```powershell
irm https://github.com/your-org/cis/releases/latest/download/install.ps1 | iex
cis init
```

**从源码构建**:
```bash
git clone https://github.com/your-org/cis.git
cd cis
./scripts/install/setup-dev.sh
```

### 基本使用

```bash
# 检查环境
cis doctor

# 查看状态
cis status --paths

# 使用自然语言调用技能
cis skill do "分析今天的代码提交"

# 语义搜索记忆
cis memory search "暗黑模式配置"

# 与 AI 对话
cis agent "帮我优化这段代码"
```

---

## 1. 系统定义

独联体（CIS）是一种硬件锚定的分布式计算架构，遵循以下形式化约束：

- **节点（Node）**：具有独立进程生命周期的裸机实例，DID 与硬件指纹（CPU/主板/网卡）强绑定
- **集群（Cluster）**：通过 P2P 协议互连的节点集合，无中心协调器
- **本地性（Locality）**：私域记忆存储的排他性控制权，物理存储于裸机本地，禁止云端同步与容器化抽象
- **硬件迁移（Migration）**：硬件损毁后通过助记词在新硬件恢复记忆所有权，但生成新 DID 的技术过程

### 1.1 设计动机

本系统针对 LLM Agent 的**跨设备幻觉（Cross-Device Hallucination）**问题而设计。

在标准云原生架构中，Agent 实例运行于云端或容器化环境，通过共享数据库或远程 API 维持上下文一致性。当同一用户在不同物理设备（如工作站与家用 PC）部署独立 Agent 实例时，由于各设备的本地上下文窗口差异、记忆检索延迟及网络分区，Agent 可能生成与事实不符的内容（幻觉）。具体表现为：
- 设备 A 已确认的用户偏好，在设备 B 的 Agent 响应中缺失或矛盾
- 任务历史在不同设备间的非原子性同步，导致决策基础不一致
- 依赖云端 LLM 进行设备间状态协调时，模型参数随机性引入的语义漂移

CIS 通过以下机制消除跨设备幻觉：
- **硬绑定私域记忆**：用户全量记忆存储于本地 SQLite，不依赖云端 LLM 的上下文窗口或远程向量数据库检索，确保单节点记忆访问的确定性
- **记忆内联打包（Inlining）**：任务跨设备移交时，相关记忆片段以二进制形式随任务上下文原子性传输，接收节点在本地重建完整决策环境，零 LLM 参与传输过程
- **零 Token 状态同步**：设备间仅同步任务状态机变更（Merkle DAG 元数据），不依赖 LLM 对状态进行语义摘要或重构，避免模型生成过程引入的偏差

---

## 2. 命名释义

- **中文：独联体**  
  取"独立系统的联合体"之意，强调节点作为独立计算实体的自治属性，以及通过协议松散协作的拓扑结构。

- **英文缩写：CIS**  
  技术文档中可使用 CIS 指代本系统，全称为 Cluster of Independent Systems。

---

## 3. 核心概念

### 3.1 硬件绑定原则

**内存物理主义**：记忆仅存在于本地 SQLite 存储，加密密钥派生自硬件指纹与助记词组合。网络连通性不影响记忆存续，仅影响节点间通信能力。

**硬绑定**：DID 通过 `mnemonic_seed + machine_fingerprint` 派生。配置复制至异构硬件将导致 DID 验证失败，标记为 `FORGED` 状态。

**迁移机制**：助记词恢复私钥访问权，但不恢复 DID。新硬件 + 助记词 = 新 DID + 旧记忆导入权限。

### 3.2 集群架构

**节点边界**：每个节点作为独立运行时，拥有独立时钟、存储与执行上下文。

**节点间通信**：通过 gRPC over QUIC 实现节点间任务移交，采用 Exactly-Once 语义。无中央协调器，通信路径为直接 P2P。

**禁止虚拟化**：Docker 及同类容器化技术被排除在支持范围外，因容器化破坏硬件指纹的物理真实性，导致身份验证失效。

### 3.3 三零原则

| 原则                   | 规范                    | 实现机制                  |
| ---------------------- | ----------------------- | ------------------------- |
| **零 Token（节点间）** | 禁止 LLM 参与节点间通信 | Protobuf 二进制序列化     |
| **零轮询（状态）**     | 禁止主动查询外部状态    | Webhook 被动触发          |
| **零干预（硬件）**     | 禁止集成电源/资源管理   | 通过 Skill 接口由用户实现 |

---

## 4. 状态转换

### 4.1 节点生命周期

```
[初始化] → 助记词 + 硬件指纹 → DID生成 → [未入网]
   ↓
[在线] ← 现有节点认证 ← 通过
   ↓
[离线] ← 网络中断/主动断开
   ↓
[失效] ← 硬件损毁且无备份
   ↓
[迁移] ← 新硬件 + 助记词 → 新DID → [未入网]
```

### 4.2 任务移交状态机

**前置条件**：目标节点 P2P 可达（在线状态检测通过 `HealthService.Check()`）

```
[执行中] → TransferRequest → [移交中]
              ↓
       [目标节点] ← 幂等校验 → [已接收]
              ↓
       [完成] ← 执行完毕 → [失败] → 错误日志记录
```

**阻塞语义**：目标节点离线时，任务移交操作悬挂等待，不触发自动唤醒机制。

### 4.3 记忆隔离级别

- **私域记忆**：SQLite 加密存储，相对路径寻址，禁止绝对路径引用
- **公域元数据**：Merkle DAG 同步任务 ID、状态哈希、时间戳，不同步内容载荷
- **内联打包**：任务移交时递归打包引用记忆至 `task_context`，目标节点解压至临时沙箱执行

---

## 5. 接口边界

### 5.1 系统核心职责

- P2P 通信协议（gRPC over QUIC）
- 任务状态机（CRDT 冲突解决）
- 身份验证（DID 签名验证）
- 加密存储（SQLite + ChaCha20-Poly1305）

### 5.2 用户扩展接口（Skill）

以下功能通过 `#[skill]` 宏由用户扩展实现：

- 电源管理（WOL、ACPI、休眠策略）
- 资源监控（温度、GPU 显存、磁盘 I/O）
- 任务调度算法（负载均衡、优先级排序）
- 告警通道（SMS、邮件、Webhook 封装）

### 5.3 禁止操作清单

| 操作               | 状态     | 技术理由                               |
| ------------------ | -------- | -------------------------------------- |
| Docker 部署        | 明确禁止 | 硬件指纹失效、网络堆栈幻觉、存储层残留 |
| 云端记忆同步       | 明确禁止 | 违反本地性原则，引入跨设备幻觉风险     |
| 自动唤醒离线节点   | 明确禁止 | 违反零干预原则                         |
| 跨节点链式记忆查询 | 明确禁止 | 防止网络风暴与隐私泄露                 |
| LLM 参与节点间通信 | 明确禁止 | 违反零 Token 原则，防止语义漂移        |

---

## 6. 技术规范

**构建目标**：静态链接二进制（MUSL/CRT），单文件 15-25MB  
**网络栈**：Libp2p（QUIC 传输，NAT 穿透，mdns 发现）  
**存储引擎**：SQLite 3.40+（WAL 模式，SQLCipher 加密）  
**序列化**：Protobuf 3（proto3 语法）  
**身份加密**：ed25519（签名）、Argon2id（密钥派生）、ChaCha20-Poly1305（对称加密）

---

## 7. 术语对照表

| 术语           | 定义                                                            |
| -------------- | --------------------------------------------------------------- |
| **独联体/CIS** | 本系统标识，指独立计算系统的联合体                              |
| **跨设备幻觉** | 因 Agent 实例跨硬件运行时上下文不一致导致的生成内容偏离事实现象 |
| **硬件迁移**   | 硬件变更导致的 DID 重置与记忆恢复过程                           |
| **节点间移交** | 跨节点任务迁移的 Exactly-Once 协议                              |
| **私域**       | 本地加密存储的不可共享记忆空间                                  |
| **公域**       | 节点间共享的元数据 DAG（无内容载荷）                            |
| **Skill**      | 用户实现的扩展钩子（Rust 函数）                                 |
| **守望者**     | 多节点场景下的离线告警机制                                      |

---

**文档结束。**