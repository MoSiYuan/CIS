# CIS ç»Ÿä¸€ CLI äº¤äº’è®¾è®¡æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### å½“å‰ç—›ç‚¹
1. **å‘½ä»¤åˆ†æ•£**: init, pair, neighbor, network, node... ç”¨æˆ·ä¸çŸ¥é“ç”¨å“ªä¸ª
2. **é…ç½®åœ°ç‹±**: å¤šä¸ª toml æ–‡ä»¶éœ€è¦æ‰‹åŠ¨ç¼–è¾‘
3. **ç¼ºä¹å¼•å¯¼**: æ²¡æœ‰ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼Œç”¨æˆ·éœ€è¦è¯•å’Œæ‰¾ help
4. **ç»„ç½‘å¤æ‚**: éœ€è¦æ‰§è¡Œå¤šä¸ªå‘½ä»¤æ‰èƒ½å®Œæˆç»„ç½‘

### ç›®æ ‡
- **ä¸€é”®å¼æ“ä½œ**: ä¸€ä¸ªå‘½ä»¤å®Œæˆç»„ç½‘
- **æ™ºèƒ½å¼•å¯¼**: AI è‡ªåŠ¨é€‰æ‹©æœ€ä½³è·¯å¾„
- **æ— é…ç½®**: é…ç½®å†…ç½®ï¼Œç”¨æˆ·æ— éœ€ç¼–è¾‘ toml
- **ç»Ÿä¸€å…¥å£**: æ‰€æœ‰åŠŸèƒ½é€šè¿‡è‡ªç„¶è¯­è¨€æˆ–ç®€åŒ–å‘½ä»¤è®¿é—®

---

## è®¾è®¡æ–¹æ¡ˆ

### 1. ç»Ÿä¸€æ™ºèƒ½å‘½ä»¤ `cis do`

```bash
# è‡ªç„¶è¯­è¨€æ¥å£ - AI è‡ªåŠ¨è§£ææ„å›¾
cis do "å¸®æˆ‘ç»„ç½‘"
cis do "æ·»åŠ  node2 ä¸ºé‚»å±…"
cis do "æŸ¥çœ‹ç½‘ç»œçŠ¶æ€"
cis do "åˆå§‹åŒ– CIS"

# å¿«æ·åˆ«å
cis setup          # ä¸€é”®åˆå§‹åŒ–ï¼ˆæ›¿ä»£ init + é…ç½®ï¼‰
cis join           # ä¸€é”®ç»„ç½‘ï¼ˆç”Ÿæˆç æˆ–è‡ªåŠ¨å‘ç°ï¼‰
cis status         # ç»Ÿä¸€çŠ¶æ€æŸ¥çœ‹
```

### 2. ç»„ç½‘ä¸€é”®åŒ–

```bash
# æ—§æ–¹å¼ï¼ˆ4æ­¥ï¼‰
cis init --non-interactive
cis pair generate  # åœ¨ A æœºå™¨
cis pair join <code> --address <ip>  # åœ¨ B æœºå™¨
cis neighbor add <id> --yes

# æ–°æ–¹å¼ï¼ˆ1æ­¥ï¼‰
cis setup          # è‡ªåŠ¨åˆå§‹åŒ–
cis join           # è‡ªåŠ¨å‘ç°/ç”Ÿæˆç /è¿æ¥
```

### 3. æ— é…ç½®è®¾è®¡

```rust
// å†…ç½®é»˜è®¤é…ç½®ï¼Œç”¨æˆ·æ— éœ€ç¼–è¾‘ toml
pub struct Config {
    pub node_id: String,     // è‡ªåŠ¨ç”Ÿæˆ UUID
    pub node_name: String,   // è‡ªåŠ¨è¯»å– hostname
    pub did: String,         // è‡ªåŠ¨ç”Ÿæˆ
    pub ai_provider: String, // é»˜è®¤ claude
    pub network: NetworkConfig, // å†…ç½®é»˜è®¤ç«¯å£
}

impl Default for Config {
    fn default() -> Self {
        Self {
            node_id: uuid::Uuid::new_v4().to_string(),
            node_name: hostname::get().unwrap_or_default(),
            did: format!("did:cis:{}:{}", hostname, short_uuid),
            ai_provider: "claude".to_string(),
            network: NetworkConfig::default(), // 6767, 6768, 7676...
        }
    }
}
```

### 4. ç»Ÿä¸€çŠ¶æ€é¢æ¿

```bash
$ cis status

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  CIS Node Status                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  èŠ‚ç‚¹: node1-pc                          â•‘
â•‘  çŠ¶æ€: ğŸŸ¢ è¿è¡Œä¸­                          â•‘
â•‘  è§’è‰²: coordinator                       â•‘
â•‘  DID: did:cis:node1-pc:a1b2c3d4          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ç½‘ç»œçŠ¶æ€                                 â•‘
â•‘    â€¢ é‚»å±…: 2 ä¸ª (node2, node3)           â•‘
â•‘    â€¢ ç«¯å£: 6767âœ“ 6768âœ“ 7676âœ“            â•‘
â•‘    â€¢ é…å¯¹ç : æ—                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  å¿«é€Ÿæ“ä½œ                                 â•‘
â•‘    cis join    - åŠ å…¥/åˆ›å»ºç½‘ç»œ           â•‘
â•‘    cis peers   - æŸ¥çœ‹é‚»å±…                â•‘
â•‘    cis logs    - æŸ¥çœ‹æ—¥å¿—                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## æ ¸å¿ƒå‘½ä»¤é‡è®¾è®¡

### `cis setup` - ä¸€é”®åˆå§‹åŒ–

```bash
# è‡ªåŠ¨å®Œæˆ:
# 1. æ£€æµ‹ç¯å¢ƒ
# 2. ç”ŸæˆèŠ‚ç‚¹å¯†é’¥
# 3. åˆ›å»ºé»˜è®¤é…ç½®
# 4. åˆå§‹åŒ–æ•°æ®åº“
# 5. å¯åŠ¨å¿…è¦æœåŠ¡

cis setup --auto     # å…¨è‡ªåŠ¨ï¼Œæ— äº¤äº’
cis setup --ai       # AI è¾…åŠ©é…ç½®
```

### `cis join` - ä¸€é”®ç»„ç½‘

```bash
# æ™ºèƒ½æ¨¡å¼ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä½³ç»„ç½‘æ–¹å¼
cis join

# æµç¨‹:
# 1. æ£€æŸ¥å½“å‰ç½‘ç»œçŠ¶æ€
# 2. å°è¯•å‘ç°ç°æœ‰èŠ‚ç‚¹ (UDP å¹¿æ’­ 5ç§’)
# 3. å¦‚æœå‘ç° â†’ è‡ªåŠ¨è¿æ¥
# 4. å¦‚æœæ²¡å‘ç° â†’ ç”Ÿæˆé…å¯¹ç ç­‰å¾…è¿æ¥
# 5. æ˜¾ç¤ºçŠ¶æ€é¢æ¿

# è¾“å‡ºç¤ºä¾‹:
# ğŸ” æœç´¢ç½‘ç»œä¸­çš„èŠ‚ç‚¹...
# âœ… å‘ç° 1 ä¸ªèŠ‚ç‚¹: node2 (172.30.1.12)
# ğŸ”— æ­£åœ¨è¿æ¥...
# âœ… å·²æ·»åŠ ä¸ºé‚»å±…
# ğŸ“Š å½“å‰ç½‘ç»œ: 2 ä¸ªèŠ‚ç‚¹
```

### `cis peers` - ç»Ÿä¸€é‚»å±…ç®¡ç†

```bash
# æ›¿ä»£: neighbor list, peer add, node ls
cis peers              # åˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹
cis peers add <name>   # æ·»åŠ èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨å‘ç°æˆ–æç¤ºè¾“å…¥ï¼‰
cis peers rm <name>    # ç§»é™¤èŠ‚ç‚¹
cis peers ping         # æµ‹è¯•è¿é€šæ€§
```

### `cis config` - äº¤äº’å¼é…ç½®

```bash
# æ›¿ä»£: æ‰‹åŠ¨ç¼–è¾‘ toml
cis config             # äº¤äº’å¼é…ç½®å‘å¯¼
cis config ai          # é…ç½® AI æä¾›å•†
cis config network     # é…ç½®ç½‘ç»œç«¯å£
cis config show        # æŸ¥çœ‹å½“å‰é…ç½®
```

---

## å®ç°æ–¹æ¡ˆ

### æ–‡ä»¶ç»“æ„

```
cis-node/src/commands/
â”œâ”€â”€ unified/           # æ–°å¢ç»Ÿä¸€å‘½ä»¤
â”‚   â”œâ”€â”€ mod.rs        # do, setup, join, status
â”‚   â”œâ”€â”€ setup.rs      # ä¸€é”®åˆå§‹åŒ–
â”‚   â”œâ”€â”€ join.rs       # ä¸€é”®ç»„ç½‘
â”‚   â””â”€â”€ status.rs     # ç»Ÿä¸€çŠ¶æ€é¢æ¿
â”œâ”€â”€ legacy/           # ä¿ç•™æ—§å‘½ä»¤å…¼å®¹
â”‚   â”œâ”€â”€ pair.rs
â”‚   â”œâ”€â”€ neighbor.rs
â”‚   â””â”€â”€ ...
â””â”€â”€ mod.rs            # å‘½ä»¤è·¯ç”±
```

### æ ¸å¿ƒä»£ç 

```rust
// unified/join.rs
pub async fn cmd_join() -> Result<()> {
    // 1. æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    if !is_initialized() {
        println!("CIS æœªåˆå§‹åŒ–ï¼Œè¿è¡Œè‡ªåŠ¨è®¾ç½®...");
        auto_setup().await?;
    }
    
    // 2. æ£€æŸ¥å½“å‰ç½‘ç»œçŠ¶æ€
    let status = get_network_status().await?;
    
    if status.has_peers() {
        println!("ğŸ“Š å½“å‰å·²è¿æ¥ {} ä¸ªèŠ‚ç‚¹", status.peer_count());
        println!("ä½¿ç”¨ 'cis peers' æŸ¥çœ‹è¯¦æƒ…");
        return Ok(());
    }
    
    // 3. å°è¯•å‘ç°èŠ‚ç‚¹
    println!("ğŸ” æœç´¢ç½‘ç»œä¸­çš„èŠ‚ç‚¹...");
    let discovered = discover_peers(Duration::from_secs(5)).await?;
    
    if !discovered.is_empty() {
        // è‡ªåŠ¨è¿æ¥å‘ç°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
        let peer = &discovered[0];
        println!("âœ… å‘ç°èŠ‚ç‚¹: {} ({})", peer.name, peer.endpoint);
        connect_peer(peer).await?;
    } else {
        // ç”Ÿæˆé…å¯¹ç ç­‰å¾…è¿æ¥
        println!("ğŸ“¡ æœªå‘ç°ç°æœ‰ç½‘ç»œï¼Œåˆ›å»ºæ–°ç½‘ç»œ...");
        generate_pairing_code().await?;
    }
    
    Ok(())
}
```

---

## è¿ç§»ç­–ç•¥

### é˜¶æ®µ1: ä¿ç•™æ—§å‘½ä»¤ + æ–°å¢ç»Ÿä¸€å‘½ä»¤
```bash
# æ—§å‘½ä»¤ä»ç„¶å¯ç”¨
cis pair generate    # ä¿ç•™
cis neighbor list    # ä¿ç•™

# æ–°å¢æ¨èå‘½ä»¤
cis join             # æ¨è
cis peers            # æ¨è
```

### é˜¶æ®µ2: é€æ­¥åºŸå¼ƒæ—§å‘½ä»¤
```bash
$ cis pair generate
âš ï¸  è­¦å‘Š: 'pair' å‘½ä»¤å°†åœ¨ v2.0 ç§»é™¤
ğŸ’¡ å»ºè®®ä½¿ç”¨: cis join
```

### é˜¶æ®µ3: å®Œå…¨è¿ç§»
- ä¿ç•™åº•å±‚ API
- CLI åªæš´éœ²ç»Ÿä¸€å‘½ä»¤

---

## é…ç½®ç®€åŒ–

### å†…ç½®é»˜è®¤é…ç½® (æ— éœ€ toml)

```rust
// config/defaults.rs
pub const DEFAULT_PORTS: Ports = Ports {
    discovery: 6767,
    pairing: 6768,
    federation: 7676,
    p2p: 7677,
};

pub const DEFAULT_AI: AiConfig = AiConfig {
    provider: "claude",
    model: "claude-sonnet-4-20250514",
    timeout: 30,
};
```

### è¿è¡Œæ—¶é…ç½®å­˜å‚¨

```rust
// ä¸å†ä½¿ç”¨ toml æ–‡ä»¶ï¼Œæ”¹ç”¨ SQLite
pub struct RuntimeConfig {
    db: Connection,  // ~/.cis/config.db
}

impl RuntimeConfig {
    pub fn set(&self, key: &str, value: &str) -> Result<()>;
    pub fn get(&self, key: &str) -> Result<Option<String>>;
    pub fn reset(&self) -> Result<()>;  // æ¢å¤é»˜è®¤
}
```

---

## ç”¨æˆ·äº¤äº’ç¤ºä¾‹

### åœºæ™¯1: é¦–æ¬¡ä½¿ç”¨

```bash
$ cis join
âš ï¸  CIS æœªåˆå§‹åŒ–ï¼Œè¿è¡Œè‡ªåŠ¨è®¾ç½®...

ğŸ”§ è‡ªåŠ¨é…ç½®:
   â€¢ èŠ‚ç‚¹ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
   â€¢ èŠ‚ç‚¹å: my-pc
   â€¢ DID: did:cis:my-pc:a1b2c3d4
   âœ“ é…ç½®å·²ä¿å­˜

ğŸ” æœç´¢ç½‘ç»œä¸­çš„èŠ‚ç‚¹...
âœ… å‘ç° 1 ä¸ªèŠ‚ç‚¹: server (192.168.1.100)
ğŸ”— æ­£åœ¨è¿æ¥...
âœ… å·²æ·»åŠ ä¸ºé‚»å±…

ğŸ“Š ç½‘ç»œçŠ¶æ€:
   â€¢ æœ¬æœº: my-pc (coordinator)
   â€¢ é‚»å±…: 1 ä¸ª (server)
   â€¢ çŠ¶æ€: ğŸŸ¢ å·²è¿æ¥
```

### åœºæ™¯2: æ—¥å¸¸æ£€æŸ¥

```bash
$ cis status

ğŸŸ¢ my-pc (coordinator)
   DID: did:cis:my-pc:a1b2c3d4

ğŸ“¡ ç½‘ç»œ: 3 ä¸ªèŠ‚ç‚¹
   â€¢ server    ğŸŸ¢ åœ¨çº¿  192.168.1.100
   â€¢ laptop    ğŸŸ¡ ç¦»çº¿  (æœ€å seen 5åˆ†é’Ÿå‰)
   â€¢ phone     ğŸŸ¢ åœ¨çº¿  192.168.1.102

ğŸ’¡ æ“ä½œ: cis join | cis peers | cis logs
```

---

## æ€»ç»“

| æ—§æ–¹å¼ | æ–°æ–¹å¼ | ç®€åŒ– |
|--------|--------|------|
| `cis init` + ç¼–è¾‘ toml | `cis setup` | 10æ­¥ â†’ 1æ­¥ |
| `pair generate` + `pair join` | `cis join` | 2æ­¥ â†’ 1æ­¥ |
| ç¼–è¾‘ network_acl.toml | è‡ªåŠ¨ç®¡ç† | æ‰‹åŠ¨ â†’ è‡ªåŠ¨ |
| å¤šä¸ª status å‘½ä»¤ | `cis status` | Nä¸ª â†’ 1ä¸ª |
| toml é…ç½®åœ°ç‹± | å†…ç½®é»˜è®¤ + äº¤äº’é…ç½® | å¤æ‚ â†’ ç®€å• |
