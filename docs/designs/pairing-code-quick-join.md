# 6ä½æ•°å­—ä¸€æ¬¡æ€§ç»„ç½‘ç  - å¿«é€Ÿç»„ç½‘è®¾è®¡æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2026-02-08  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## 1. è®¾è®¡ç›®æ ‡

è§£å†³å½“å‰èŠ‚ç‚¹å‘ç°çš„ç—›ç‚¹ï¼š
- âŒ éœ€è¦çŸ¥é“å¯¹æ–¹ IP/DID
- âŒ ç½‘ç»œé…ç½®å¤æ‚
- âŒ è·¨ç½‘æ®µæ— æ³•å‘ç°
- âœ… è¾“å…¥6ä½æ•°å­—å³å¯è¿æ¥
- âœ… é›¶é…ç½®ç»„ç½‘
- âœ… é€‚åˆæ–°æ‰‹ç”¨æˆ·

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç›®æ ‡èŠ‚ç‚¹   â”‚  â—„â”€â”€ 6ä½æ•°å­— â”€â”€â”€â–º  â”‚   å‘èµ·èŠ‚ç‚¹   â”‚
â”‚  (é˜»å¡ç›‘å¬)  â”‚     ç»„ç½‘ç é…å¯¹      â”‚  (è¾“å…¥éªŒè¯ç ) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                    â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
       â””â”€â”€â–º  é€šè¿‡ä¸­ç»§/ç›´è¿å»ºç«‹å®‰å…¨é€šé“    â”œâ”€â”€â”€â”˜
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1 ç»„ç½‘ç ï¼ˆPairing Codeï¼‰

- **æ ¼å¼**: 6ä½æ•°å­—ï¼ˆ000000 - 999999ï¼‰
- **æœ‰æ•ˆæœŸ**: 5 åˆ†é’Ÿ
- **ä½¿ç”¨æ¬¡æ•°**: ä¸€æ¬¡æ€§ï¼ŒéªŒè¯æˆåŠŸåç«‹å³å¤±æ•ˆ
- **ç”Ÿæˆæ–¹å¼**: å®‰å…¨éšæœºæ•°

### 2.2 ä¸¤ç§ç»„ç½‘æ¨¡å¼

| æ¨¡å¼ | åœºæ™¯ | æµç¨‹ |
|------|------|------|
| **å±€åŸŸç½‘æ¨¡å¼** | åŒä¸€WiFiä¸‹ | UDPå¹¿æ’­å‘ç° + ç»„ç½‘ç éªŒè¯ |
| **ä¸­ç»§æ¨¡å¼** | è·¨ç½‘æ®µ/å…¬ç½‘ | é€šè¿‡CISä¸­ç»§æœåŠ¡å™¨é…å¯¹ |

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ ¸å¿ƒç»„ä»¶

```rust
// ç»„ç½‘ç ç®¡ç†å™¨
pub struct PairingManager {
    active_codes: HashMap<String, PairingSession>,
    timeout: Duration,      // 5åˆ†é’Ÿ
    max_attempts: u32,      // 5æ¬¡é”™è¯¯å°è¯•
}

// ç»„ç½‘ä¼šè¯
pub struct PairingSession {
    code: String,
    target_node: NodeInfo,
    state: PairingState,
    created_at: Instant,
    attempts: u32,
}

// çŠ¶æ€æœº
pub enum PairingState {
    Waiting,        // ç­‰å¾…éªŒè¯
    Verifying,      // éªŒè¯ä¸­
    Exchanging,     // äº¤æ¢å¯†é’¥
    Completed,      // å®Œæˆ
    Expired,        // è¿‡æœŸ
    Failed,         // å¤±è´¥
}
```

### 3.2 ç½‘ç»œæµç¨‹

```
ç›®æ ‡èŠ‚ç‚¹                    ç»„ç½‘æœåŠ¡                    å‘èµ·èŠ‚ç‚¹
   â”‚                          â”‚                          â”‚
   â”‚  1. generate-code        â”‚                          â”‚
   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                          â”‚
   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€ code:123456 â”€â”€â”€â”¤                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚  2. start-listen         â”‚                          â”‚
   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                          â”‚
   â”‚  (é˜»å¡ç­‰å¾…...)            â”‚                          â”‚
   â”‚                          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€ 3. join-request â”‚
   â”‚                          â”‚    code:123456           â”‚
   â”‚                          â”‚                          â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. verify â”€â”€â”€â”€â”€â”¤                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚  5. accept / deny        â”‚                          â”‚
   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                          â”‚
   â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. result â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                          â”‚                          â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. exchange â”€â”€â”¤                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚  8. establish-secure     â”‚                          â”‚
   â”‚     WebSocket/Noise      â”‚                          â”‚
```

---

## 4. å®‰å…¨è®¾è®¡

### 4.1 é˜²æš´åŠ›ç ´è§£

```rust
impl PairingManager {
    fn verify_code(&mut self, code: &str, node_id: &str) -> Result<()> {
        let session = self.active_codes.get_mut(code)
            .ok_or_else(|| Error::InvalidCode)?;
        
        // æ£€æŸ¥å°è¯•æ¬¡æ•°
        if session.attempts >= self.max_attempts {
            session.state = PairingState::Failed;
            return Err(Error::TooManyAttempts);
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if session.is_expired() {
            session.state = PairingState::Expired;
            return Err(Error::CodeExpired);
        }
        
        session.attempts += 1;
        Ok(())
    }
}
```

### 4.2 ä¼ è¾“å®‰å…¨

1. **ç»„ç½‘ç éªŒè¯**: æ˜æ–‡ä¼ è¾“ï¼ˆä»…6ä½æ•°å­—ï¼‰
2. **å¯†é’¥äº¤æ¢**: X25519 ECDH
3. **åç»­é€šä¿¡**: Noise Protocol åŠ å¯†

---

## 5. CLI è®¾è®¡

```bash
# ç›®æ ‡èŠ‚ç‚¹ - ç”Ÿæˆç»„ç½‘ç å¹¶ç›‘å¬
cis pair generate [--timeout 300] [--auto-accept]
# è¾“å‡º:
# ğŸ”¢ ç»„ç½‘ç : 847291
# â±ï¸  æœ‰æ•ˆæœŸ: 5åˆ†é’Ÿ
# ğŸ”„ çŠ¶æ€: ç­‰å¾…è¿æ¥...

# å‘èµ·èŠ‚ç‚¹ - è¾“å…¥ç»„ç½‘ç è¿æ¥
cis pair join <code> [--alias "home-server"]
# è¾“å‡º:
# ğŸ” æ­£åœ¨æŸ¥æ‰¾èŠ‚ç‚¹...
# âœ… å‘ç°èŠ‚ç‚¹: desktop-pc
# ğŸ” éªŒè¯æˆåŠŸ
# âœ… å·²æ·»åŠ ä¸ºé‚»å±…èŠ‚ç‚¹
```

---

## 6. å®ç°æ£€æŸ¥æ¸…å•

- [x] `pairing.rs` æ ¸å¿ƒæ¨¡å— (`cis-core/src/network/pairing.rs`)
- [x] `pair.rs` CLI å‘½ä»¤ (`cis-node/src/commands/pair.rs`)
- [x] ç»„ç½‘ç ç”Ÿæˆç®—æ³• (6ä½æ•°å­—éšæœºç”Ÿæˆ)
- [x] UDP ç«¯å£ 6768 ç›‘å¬/å¹¿æ’­
- [x] æ¡æ‰‹åè®®å®ç° (PAIR_REQ/PAIR_ACK)
- [x] å®‰å…¨éªŒè¯ (5åˆ†é’Ÿè¿‡æœŸã€5æ¬¡é”™è¯¯é™åˆ¶)

## 7. ä½¿ç”¨ç¤ºä¾‹

```bash
# ç»ˆç«¯ A - ç›®æ ‡èŠ‚ç‚¹ç”Ÿæˆç»„ç½‘ç 
cis pair generate
# è¾“å‡º:
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘           ğŸ”¢ ç»„ç½‘é…å¯¹ç                    â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘       847291                             â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  â±ï¸  æœ‰æ•ˆæœŸ: 5åˆ†é’Ÿ                        â•‘
# â•‘  ğŸ“Œ èŠ‚ç‚¹: desktop-pc                      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ç»ˆç«¯ B - å‘èµ·èŠ‚ç‚¹ä½¿ç”¨ç»„ç½‘ç è¿æ¥
cis pair join 847291
```
- [ ] çŠ¶æ€æœºç®¡ç†
