# NAT ç©¿é€æ•…éšœæ’æŸ¥æŒ‡å—

æœ¬æ–‡æ¡£å¸®åŠ©è¯Šæ–­å’Œè§£å†³ CIS P2P ç½‘ç»œä¸­çš„ NAT ç©¿é€é—®é¢˜ã€‚

## ç›®å½•

- [NAT ç±»å‹](#nat-ç±»å‹)
- [è¯Šæ–­å·¥å…·](#è¯Šæ–­å·¥å…·)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
- [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)

## NAT ç±»å‹

### NAT ç±»å‹åˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NAT ç±»å‹ç©¿é€éš¾åº¦                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¢ Open (å¼€æ”¾ç½‘ç»œ)                                              â”‚
â”‚     â€¢ æ—  NATï¼Œç›´è¿å…¬ç½‘                                           â”‚
â”‚     â€¢ ç©¿é€éš¾åº¦: ææ˜“                                              â”‚
â”‚     â€¢ æ”¯æŒ: æ‰€æœ‰åŠŸèƒ½                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¢ Full Cone (å…¨é”¥å½¢ NAT)                                       â”‚
â”‚     â€¢ ä»»ä½•å¤–éƒ¨ä¸»æœºå¯é€šè¿‡æ˜ å°„åœ°å€è®¿é—®å†…éƒ¨ä¸»æœº                        â”‚
â”‚     â€¢ ç©¿é€éš¾åº¦: å®¹æ˜“                                              â”‚
â”‚     â€¢ æ”¯æŒ: Hole Punching                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¡ Address-Restricted (åœ°å€é™åˆ¶é”¥å½¢ NAT)                         â”‚
â”‚     â€¢ ä»…å…è®¸å·²é€šä¿¡çš„å¤–éƒ¨åœ°å€è®¿é—®                                   â”‚
â”‚     â€¢ ç©¿é€éš¾åº¦: ä¸­ç­‰                                              â”‚
â”‚     â€¢ æ”¯æŒ: Hole Punching                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¡ Port-Restricted (ç«¯å£é™åˆ¶é”¥å½¢ NAT)                            â”‚
â”‚     â€¢ ä»…å…è®¸å·²é€šä¿¡çš„å¤–éƒ¨åœ°å€å’Œç«¯å£è®¿é—®                             â”‚
â”‚     â€¢ ç©¿é€éš¾åº¦: è¾ƒéš¾                                              â”‚
â”‚     â€¢ æ”¯æŒ: Hole Punchingï¼ˆéœ€è¦åŒæ—¶æ‰“æ´ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ Symmetric (å¯¹ç§° NAT)                                          â”‚
â”‚     â€¢ æ¯ä¸ªç›®æ ‡åœ°å€ä½¿ç”¨ä¸åŒçš„æ˜ å°„                                   â”‚
â”‚     â€¢ ç©¿é€éš¾åº¦: æéš¾ï¼ˆéœ€è¦ TURN ä¸­ç»§ï¼‰                            â”‚
â”‚     â€¢ æ”¯æŒ: TURN Relay Only                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ£€æµ‹ä½ çš„ NAT ç±»å‹

```bash
# ä½¿ç”¨å†…ç½®å·¥å…·æ£€æµ‹
cis p2p hole-punch --detect-only

# ç¤ºä¾‹è¾“å‡º:
# ğŸ•³ï¸  NAT Hole Punching Test
# 
# Step 1: Detecting NAT type...
#   NAT Type: Port-Restricted NAT
#   Description: Port-Restricted Cone NAT
#   External Address: 203.0.113.1:45678
#   Easy Traversal: No
#   Hole Punching: Supported
#   TURN Required: No
```

## è¯Šæ–­å·¥å…·

### 1. ç½‘ç»œè¯Šæ–­

```bash
# å®Œæ•´ç½‘ç»œè¯Šæ–­
cis p2p diagnose

# ä»… NAT è¯Šæ–­
cis p2p diagnose --check nat

# ç«¯å£æ£€æŸ¥
cis p2p diagnose --check port
```

### 2. NAT ç©¿é€æµ‹è¯•

```bash
# åŸºç¡€æµ‹è¯•
cis p2p hole-punch --detect-only

# æŒ‡å®š STUN æœåŠ¡å™¨
cis p2p hole-punch --detect-only \
    --stun-server stun.l.google.com:19302

# æµ‹è¯•åˆ°ç‰¹å®šèŠ‚ç‚¹çš„æ‰“æ´
cis p2p hole-punch --target 203.0.113.2:7677
```

### 3. è¿æ¥æµ‹è¯•

```bash
# Ping èŠ‚ç‚¹
cis p2p ping <node-id>

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
cis p2p status

# æŸ¥çœ‹ DHT çŠ¶æ€
cis p2p dht status
```

## å¸¸è§é—®é¢˜

### é—®é¢˜ 1: "NAT traversal failed"

**ç—‡çŠ¶:**
```
[WARN] NAT traversal failed, may require manual port forwarding
```

**å¯èƒ½åŸå› :**
1. UPnP ä¸å¯ç”¨æˆ–è¢«ç¦ç”¨
2. STUN æœåŠ¡å™¨æ— æ³•è®¿é—®
3. ä¸¥æ ¼çš„é˜²ç«å¢™è§„åˆ™
4. å¯¹ç§° NAT

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æ£€æŸ¥ UPnP å¯ç”¨æ€§
# ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢ï¼Œç¡®è®¤ UPnP å·²å¯ç”¨

# 2. æµ‹è¯• STUN æœåŠ¡å™¨è¿é€šæ€§
cis p2p hole-punch --detect-only

# 3. æ£€æŸ¥é˜²ç«å¢™
cis p2p diagnose --check port

# 4. æ£€æŸ¥ NAT ç±»å‹
cis p2p diagnose --check nat
```

### é—®é¢˜ 2: "Hole punch timeout"

**ç—‡çŠ¶:**
```
[WARN] Hole punch to 203.0.113.2:7677 timed out
```

**å¯èƒ½åŸå› :**
1. å¯¹ç«¯èŠ‚ç‚¹ç¦»çº¿
2. ä¸¤ç«¯éƒ½æ˜¯å¯¹ç§° NAT
3. é˜²ç«å¢™é˜»æ­¢ UDP
4. æ‰“æ´æ—¶æœºä¸å¯¹

**è§£å†³æ–¹æ¡ˆ:**

```bash
# 1. ç¡®è®¤å¯¹ç«¯åœ¨çº¿
cis p2p ping <node-id>

# 2. å¦‚æœæ˜¯å¯¹ç§° NATï¼Œé…ç½® TURN æœåŠ¡å™¨
# ç¼–è¾‘é…ç½®æ–‡ä»¶:
[[p2p.nat.turn]]
server = "turn.example.com:3478"
username = "user"
credential = "pass"

# 3. å¢åŠ æ‰“æ´é‡è¯•æ¬¡æ•°
cis p2p hole-punch --target <addr> --retry 10
```

### é—®é¢˜ 3: "UPnP gateway not found"

**ç—‡çŠ¶:**
```
[DEBUG] UPnP gateway not found: SearchGatewayError
```

**å¯èƒ½åŸå› :**
1. è·¯ç”±å™¨ä¸æ”¯æŒ UPnP
2. UPnP è¢«ç¦ç”¨
3. å¤šå±‚ NAT

**è§£å†³æ–¹æ¡ˆ:**

**é€‰é¡¹ A: å¯ç”¨è·¯ç”±å™¨ UPnP**
1. ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢
2. æ‰¾åˆ° "UPnP" æˆ– "IGD" è®¾ç½®
3. å¯ç”¨ UPnP åŠŸèƒ½

**é€‰é¡¹ B: æ‰‹åŠ¨ç«¯å£æ˜ å°„**
```bash
# åœ¨è·¯ç”±å™¨ä¸Šé…ç½®ç«¯å£æ˜ å°„:
# å¤–éƒ¨ç«¯å£: 7677 â†’ å†…éƒ¨ç«¯å£: 7677
# åè®®: UDP å’Œ TCP
```

**é€‰é¡¹ C: ä½¿ç”¨ DHT ä¸­ç»§**
```toml
[p2p]
enable_nat_traversal = false  # ç¦ç”¨è‡ªåŠ¨ç©¿é€
external_address = "manual"   # æ‰‹åŠ¨æŒ‡å®šå¤–éƒ¨åœ°å€
```

### é—®é¢˜ 4: "Symmetric NAT detected"

**ç—‡çŠ¶:**
```
[NAT Type: Symmetric NAT (requires TURN)]
```

**è¯´æ˜:**
å¯¹ç§° NAT æ— æ³•é€šè¿‡å¸¸è§„ hole punching ç©¿é€ï¼Œå¿…é¡»ä½¿ç”¨ TURN ä¸­ç»§ã€‚

**è§£å†³æ–¹æ¡ˆ:**

```toml
# é…ç½® TURN æœåŠ¡å™¨
[[p2p.nat.turn]]
server = "turn.example.com:3478"
username = "user"
credential = "pass"
realm = "example.com"

# æˆ–ä½¿ç”¨å…¬å…± TURN æœåŠ¡
[[p2p.nat.turn]]
server = "turns:global.turn.twilio.com:443"
username = "your-twilio-username"
credential = "your-auth-token"
```

### é—®é¢˜ 5: è¿æ¥ä¸ç¨³å®š

**ç—‡çŠ¶:**
- è¿æ¥ç»å¸¸æ–­å¼€
- åŒæ­¥é¢‘ç¹å¤±è´¥
- Ping å»¶è¿Ÿæ³¢åŠ¨å¤§

**æ’æŸ¥æ­¥éª¤:**

```bash
# 1. æ£€æŸ¥è¿æ¥è´¨é‡
cis p2p ping <node-id>

# 2. æŸ¥çœ‹è¿æ¥ç»Ÿè®¡
cis p2p peers --verbose

# 3. åˆ·æ–°ç«¯å£æ˜ å°„
cis p2p hole-punch --refresh
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: UPnP è‡ªåŠ¨é…ç½®

```toml
[p2p.nat]
enable_upnp = true
upnp_lease_duration = 3600  # 1å°æ—¶
```

**é€‚ç”¨åœºæ™¯:**
- å®¶ç”¨è·¯ç”±å™¨
- æ”¯æŒ UPnP çš„ç½‘ç»œ

### æ–¹æ¡ˆ 2: æ‰‹åŠ¨ç«¯å£æ˜ å°„

**è·¯ç”±å™¨é…ç½®:**
```
ç«¯å£è½¬å‘è§„åˆ™:
- åç§°: CIS P2P
- å¤–éƒ¨ç«¯å£: 7677
- å†…éƒ¨ç«¯å£: 7677
- å†…éƒ¨ IP: <ä½ çš„æœ¬åœ°IP>
- åè®®: TCP + UDP
```

**CIS é…ç½®:**
```toml
[p2p]
listen_port = 7677
enable_nat_traversal = false
external_address = "203.0.113.1:7677"  # ä½ çš„å…¬ç½‘IP
```

### æ–¹æ¡ˆ 3: DHT + Bootstrap ä¸­ç»§

```toml
[p2p]
enable_dht = true

[p2p.bootstrap]
nodes = [
    "bootstrap.cis.dev:6767",
    "bootstrap2.cis.dev:6767"
]
```

**å·¥ä½œåŸç†:**
1. é€šè¿‡ bootstrap èŠ‚ç‚¹å‘ç°å…¶ä»–èŠ‚ç‚¹
2. ä½¿ç”¨ DHT å­˜å‚¨å’Œæ£€ç´¢èŠ‚ç‚¹ä¿¡æ¯
3. å±€åŸŸç½‘èŠ‚ç‚¹å¯ç›´æ¥è¿æ¥

### æ–¹æ¡ˆ 4: TURN ä¸­ç»§

```toml
# é…ç½®å¤šä¸ª TURN æœåŠ¡å™¨å®ç°é«˜å¯ç”¨
[[p2p.nat.turn]]
server = "turn1.example.com:3478"
username = "user1"
credential = "pass1"
priority = 100

[[p2p.nat.turn]]
server = "turn2.example.com:3478"
username = "user2"
credential = "pass2"
priority = 90
```

**é€‚ç”¨åœºæ™¯:**
- å¯¹ç§° NAT
- ä¼ä¸šç½‘ç»œ
- é«˜å¯é æ€§è¦æ±‚

### æ–¹æ¡ˆ 5: VPN/ä¸“çº¿

å¯¹äºæ— æ³•é€šè¿‡ä»»ä½• NAT ç©¿é€æ–¹æ¡ˆçš„ç½‘ç»œï¼Œå»ºè®®ä½¿ç”¨ï¼š

1. **VPN ç»„ç½‘**
   - WireGuard
   - Tailscale
   - ZeroTier

2. **ä¸“çº¿è¿æ¥**
   - äº‘æœåŠ¡å™¨è½¬å‘
   - ä¸“ç”¨ç½‘ç»œé“¾è·¯

## é«˜çº§é…ç½®

### è‡ªå®šä¹‰ STUN æœåŠ¡å™¨

```toml
[p2p.stun]
servers = [
    "stun.l.google.com:19302",
    "stun1.l.google.com:19302",
    "stun2.l.google.com:19302",
    "stun3.l.google.com:19302",
    "stun4.l.google.com:19302",
    # ä¼ä¸š STUN æœåŠ¡å™¨
    "stun.company.com:3478"
]

# è¶…æ—¶è®¾ç½®
request_timeout_ms = 3000
retry_count = 3
```

### æ‰“æ´å‚æ•°è°ƒä¼˜

```toml
[p2p.hole_punch]
# æ‰“æ´åŒ…æ•°é‡
packet_count = 10

# å‘é€é—´éš”ï¼ˆæ¯«ç§’ï¼‰
packet_interval_ms = 100

# ç­‰å¾…å“åº”è¶…æ—¶ï¼ˆç§’ï¼‰
response_timeout_secs = 5

# æœ€å¤§é‡è¯•æ¬¡æ•°
max_retries = 3
```

### è¿æ¥ä¿æ´»

```toml
[p2p.keepalive]
# ä¿æ´»é—´éš”ï¼ˆç§’ï¼‰
interval_secs = 30

# è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
timeout_secs = 120

# å¤±è´¥åé‡è¿é—´éš”
reconnect_interval_secs = 60
```

## ç½‘ç»œç¯å¢ƒå‚è€ƒ

### å¸¸è§ç½‘ç»œç±»å‹

| ç½‘ç»œç±»å‹ | NAT ç±»å‹ | æ¨èæ–¹æ¡ˆ | æˆåŠŸç‡ |
|----------|----------|----------|--------|
| å®¶åº­å®½å¸¦ | Full/Port-Restricted | UPnP + STUN | 95% |
| ä¼ä¸šç½‘ç»œ | Symmetric/Restricted | TURN | 90% |
| ç§»åŠ¨ç½‘ç»œ | Symmetric | TURN | 85% |
| æ ¡å›­ç½‘ | Port-Restricted | STUN | 80% |
| å…¬å…± WiFi | Various | DHT Bootstrap | 70% |

### å¤šç½‘ç»œç¯å¢ƒé…ç½®ç¤ºä¾‹

```toml
# æ ¹æ®ç½‘ç»œç¯å¢ƒåŠ¨æ€é€‰æ‹©ç­–ç•¥
[p2p.nat.strategy]
# ä¼˜å…ˆå°è¯• UPnP
prefer_upnp = true

# UPnP å¤±è´¥åå°è¯• STUN
use_stun = true

# STUN å¤±è´¥åä½¿ç”¨ TURN
use_turn = true

# æœ€ç»ˆå›é€€åˆ° DHT ä¸­ç»§
fallback_to_dht = true
```

## æµ‹è¯•æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½² P2P ç½‘ç»œå‰ï¼Œè¯·å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] `cis p2p diagnose` é€šè¿‡æ‰€æœ‰æ£€æŸ¥
- [ ] `cis p2p hole-punch --detect-only` è¿”å›é¢„æœŸçš„ NAT ç±»å‹
- [ ] `cis p2p ping <bootstrap-node>` æˆåŠŸ
- [ ] `cis p2p discover` èƒ½å‘ç°å±€åŸŸç½‘èŠ‚ç‚¹
- [ ] `cis p2p dht status` æ˜¾ç¤ºæ­£å¸¸
- [ ] åŒæ­¥æµ‹è¯•æˆåŠŸå®Œæˆ
- [ ] é•¿æ—¶é—´è¿è¡Œï¼ˆ>24å°æ—¶ï¼‰è¿æ¥ç¨³å®š

## è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. **æ”¶é›†æ—¥å¿—**
   ```bash
   RUST_LOG=cis_core::p2p=debug cis p2p diagnose 2>&1 | tee p2p-debug.log
   ```

2. **æäº¤ Issue**
   - æä¾›è¯Šæ–­è¾“å‡º
   - ç½‘ç»œç¯å¢ƒæè¿°
   - è·¯ç”±å™¨å‹å·å’Œé…ç½®
   - æ—¥å¿—æ–‡ä»¶

3. **ç¤¾åŒºæ”¯æŒ**
   - GitHub Discussions
   - Discord/Slack é¢‘é“
