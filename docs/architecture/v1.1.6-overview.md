# CIS Architecture Overview v1.1.6

> **Version**: 1.1.6
> **Last Updated**: 2026-02-13
> **Status**: Production Ready

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Core Philosophy](#core-philosophy)
3. [High-Level Architecture](#high-level-architecture)
4. [System Components](#system-components)
5. [Data Flow](#data-flow)
6. [Technology Stack](#technology-stack)
7. [Design Principles](#design-principles)
8. [Extension Points](#extension-points)

---

## Executive Summary

CIS (Cluster of Independent Systems) is a hardware-bound, sovereign distributed computing system designed for AI-native workflow orchestration and memory management. The v1.1.6 architecture represents a mature, production-ready implementation with the following key characteristics:

### Key Capabilities

- **Bidirectional Agent Integration**: CIS can both call external AI agents (Claude, Kimi, etc.) and be called by them
- **Hybrid Memory System**: Combines precise log-based storage with selective vector indexing
- **DAG-Based Orchestration**: Four-tier decision system for task execution
- **P2P Networking**: Peer-to-peer communication with DID-based authentication
- **Project-Level Context**: Automatic project detection and configuration
- **Hot-Swappable Skills**: Runtime-loadable capability modules
- **Matrix Integration**: Federation gateway for decentralized communication

### Architecture Highlights

```
┌─────────────────────────────────────────────────────────────────┐
│                    CIS v1.1.6 Architecture                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Presentation Layer                          │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │  │
│  │  │    CLI     │  │    GUI     │  │   API      │        │  │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘        │  │
│  └────────┼───────────────┼───────────────┼───────────────────┘  │
│           │               │               │                     │
│  ┌────────┴───────────────┴───────────────┴───────────────────┐  │
│  │              Service Layer (Unified Interface)             │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │  │
│  │  │  Memory  │ │   Task   │ │  Skill   │ │ Project  │  │  │
│  │  │ Service  │ │ Service  │ │ Service  │ │ Service  │  │  │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘  │  │
│  └───────┼────────────┼──────────────┼──────────────┼────────┘  │
│          │            │              │              │            │
│  ┌───────┴────────────┴──────────────┴──────────────┴────────┐  │
│  │                  Core Engine Layer                       │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ │  │
│  │  │ Memory │ │Scheduler│ │ Vector │ │ Agent  │ │  P2P   │ │  │
│  │  │  V2    │ │   DAG   │ │ Index  │ │Provider│ │Network │ │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ │  │
│  └─────────────────────────────────────────────────────────────┘  │
│           │                        │                          │
│  ┌────────┴────────────────────────┴──────────────────────────┐  │
│  │              Storage & Infrastructure Layer                │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │  │
│  │  │ SQLite   │ │ WASM     │ │ Hardware │ │ Network  │  │  │
│  │  │ (Week DB)│ │ Runtime  │ │  Fingerprint│ │  Stack   │  │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Core Philosophy

### First Principles

1. **Memory Sovereignty**: User data is stored locally with encryption and never uploaded to cloud servers
2. **Hardware Binding**: DIDs are cryptographically bound to hardware fingerprints for identity verification
3. **P2P Federation**: No central coordinator - nodes communicate directly using peer-to-peer protocols
4. **Zero-Knowledge Architecture**: Sensitive data remains encrypted and under user control

### Occam's Razor

1. **Minimal Dependencies**: Core functionality operates without external services
2. **Emergent Features**: Advanced capabilities are implemented as skills, not core components
3. **Simplified Abstractions**: Avoid over-engineering; maintain code simplicity
4. **Composability**: Small, focused modules that combine to create complex behaviors

### Bidirectional Integration

CIS serves as infrastructure with memory as data:

```
CIS → Agent: CIS calls external LLM Agent through AgentProvider interface
Agent → CIS: External Agent calls CIS through CLI/API commands
```

This bidirectional flow enables:
- AI agents to leverage CIS memory and skills
- CIS to orchestrate multiple AI providers
- Seamless context switching between agents
- Persistent project-level configurations

---

## High-Level Architecture

### Layered Architecture

```
┌────────────────────────────────────────────────────────────────────┐
│                    Application Layer                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────┐ │
│  │ cis-node (CLI)  │  │ cis-gui (Desktop)│  │ cis-api    │ │
│  │                 │  │                  │  │ (REST/WS)  │ │
│  └──────────────────┘  └──────────────────┘  └─────────────┘ │
└────────────────────────────────────────────────────────────────────┘
                              ▼
┌────────────────────────────────────────────────────────────────────┐
│                    Service Layer                                │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              Dependency Injection Container                 │ │
│  │  - Service Discovery                                      │ │
│  │  - Lifecycle Management                                   │ │
│  │  - Configuration Injection                                 │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Services: MemoryService, TaskService, SkillService,              │
│            NodeService, DAGService, ProjectService                 │
└────────────────────────────────────────────────────────────────────┘
                              ▼
┌────────────────────────────────────────────────────────────────────┐
│                    Core Engine Layer                             │
│                                                                  │
│  ┌───────────────┐  ┌───────────────┐  ┌─────────────────┐   │
│  │   Memory V2   │  │   Scheduler   │  │   Vector Index  │   │
│  │  - LogMemory  │  │  - DAG Engine │  │  - HNSW         │   │
│  │  - Precision  │  │  - 4-Tier    │  │  - Semantic     │   │
│  │    Index      │  │    Decision   │  │    Search       │   │
│  └───────────────┘  └───────────────┘  └─────────────────┘   │
│                                                                  │
│  ┌───────────────┐  ┌───────────────┐  ┌─────────────────┐   │
│  │ AgentProvider │  │  SkillRouter  │  │  P2P Network   │   │
│  │  - Claude     │  │  - Registry   │  │  - libp2p      │   │
│  │  - Kimi       │  │  - Hot-swap  │  │  - DHT         │   │
│  │  - OpenCode   │  │  - Project   │  │  - NAT Traversal│   │
│  └───────────────┘  └───────────────┘  └─────────────────┘   │
└────────────────────────────────────────────────────────────────────┘
                              ▼
┌────────────────────────────────────────────────────────────────────┐
│                  Storage & Infrastructure Layer                 │
│                                                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │  Storage Engine │  │   Security      │  │  Networking  │ │
│  │  - SQLite      │  │  - DID Manager  │  │  - QUIC      │ │
│  │  - Weekly DB   │  │  - Encryption   │  │  - WebSocket │ │
│  │  - WAL Mode    │  │  - ACL         │  │  - mDNS      │ │
│  └──────────────────┘  └──────────────────┘  └──────────────┘ │
│                                                                  │
│  ┌──────────────────┐  ┌──────────────────┐                     │
│  │   WASM Runtime  │  │  Matrix Gateway  │                     │
│  │  - Sandboxing   │  │  - Federation   │                     │
│  │  - Capability   │  │  - Sync         │                     │
│  └──────────────────┘  └──────────────────┘                     │
└────────────────────────────────────────────────────────────────────┘
```

### Module Organization

```
cis-core/
├── Core Foundation
│   ├── types/          # Core data structures
│   ├── error/          # Unified error handling
│   ├── sandbox/        # Security boundary validation
│   ├── config/         # Configuration management
│   └── events/         # Domain events
│
├── Memory & Intelligence
│   ├── memory/         # Memory V2 architecture
│   │   ├── log_memory.rs       # Weekly log storage
│   │   ├── vector_index.rs     # Precision indexing
│   │   └── archiver.rs        # 54-week rotation
│   ├── vector/         # Semantic search engine
│   └── cache/          # LRU cache layer
│
├── Orchestration
│   ├── scheduler/      # DAG task scheduler
│   ├── decision/       # Four-tier decision system
│   └── task/          # Task management
│
├── Skills & Agents
│   ├── skill/          # Skill management system
│   │   ├── registry.rs         # Skill registry
│   │   ├── router.rs          # Skill router
│   │   └── executor.rs        # Skill executor
│   ├── agent/          # AI provider abstraction
│   │   ├── providers/         # Agent implementations
│   │   └── cluster/          # Agent cluster management
│   └── wasm/           # WASM runtime for skills
│
├── Networking
│   ├── p2p/            # Peer-to-peer networking
│   ├── network/        # Network session management
│   └── matrix/         # Matrix federation gateway
│
├── Storage
│   ├── storage/        # Unified storage layer
│   │   ├── connection.rs       # Database pooling
│   │   ├── memory_db.rs       # Memory database
│   │   └── wal.rs            # Write-ahead logging
│   └── telemetry/     # Request logging
│
├── Identity & Security
│   ├── identity/       # DID management
│   ├── decision/       # Decision framework
│   └── acl/           # Access control
│
├── Project & Context
│   ├── project/        # Project-level config
│   ├── intent/         # Intent parsing
│   └── conversation/  # Conversation management
│
└── Services
    ├── service/        # Business logic layer
    ├── cli/            # AI-Native CLI framework
    └── container/      # DI container
```

---

## System Components

### 1. Memory System (V2 Architecture)

The memory system is the heart of CIS, providing persistent, searchable storage for all user data.

```
┌──────────────────────────────────────────────────────────────────┐
│                    Memory Service V2                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                    API Layer                            │   │
│  │  set(), get(), search(), delete(), list()              │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                    Hybrid Storage                         │   │
│  │                                                          │   │
│  │  ┌──────────────────────┐    ┌──────────────────────┐   │   │
│  │  │    LogMemory        │    │   VectorIndex        │   │   │
│  │  │  (Complete Logs)    │    │  (Precision Index)   │   │   │
│  │  │                    │    │                      │   │   │
│  │  │  - Weekly DB files  │    │  - HNSW index       │   │   │
│  │  │  - Exact queries    │    │  - Semantic search   │   │   │
│  │  │  - 54-week retention│    │  - Selective (~10%)  │   │   │
│  │  └──────────────────────┘    └──────────────────────┘   │   │
│  │            │                           │                  │   │
│  │            └───────────┬───────────────┘                  │   │
│  │                        ▼                                  │   │
│  │            ┌──────────────────────┐                        │   │
│  │            │   WeekArchiver     │                        │   │
│  │            │  - Auto rotation  │                        │   │
│  │            │  - Compression    │                        │   │
│  │            │  - 54-week cycle  │                        │   │
│  │            └──────────────────────┘                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

**Key Features**:
- **Dual Storage**: Complete log storage + precision vector index
- **Weekly Rotation**: Automatic 54-week rolling archive
- **Selective Indexing**: Only ~10% of data gets vectorized
- **Hot/Cold Tiers**: Recent 4 weeks hot, older data compressed
- **Access Tracking**: Monitors usage patterns for optimization

### 2. DAG Scheduler

Task orchestration using directed acyclic graphs with a four-tier decision system.

```
┌──────────────────────────────────────────────────────────────────┐
│                    DAG Scheduler                              │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                 DAG Definition                           │   │
│  │  tasks: [                                                 │   │
│  │    { id: "1", name: "fetch", level: Mechanical },        │   │
│  │    { id: "2", name: "review", level: Confirmed,          │   │
│  │      deps: ["1"] },                                       │   │
│  │    { id: "3", name: "test", level: Mechanical,           │   │
│  │      deps: ["2"] },                                       │   │
│  │  ]                                                        │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │              Four-Tier Decision Engine                   │   │
│  │                                                          │   │
│  │  1. Mechanical ─────▶ Auto-execute, retry on failure    │   │
│  │  2. Recommended ────▶ Execute with countdown, cancelable  │   │
│  │  3. Confirmed ──────▶ Require human confirmation         │   │
│  │  4. Arbitrated ─────▶ Multi-stakeholder voting         │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │               Execution Engine                            │   │
│  │  - Dependency resolution                                  │   │
│  │  - Parallel execution                                    │   │
│  │  - Rollback on failure                                   │   │
│  │  - State persistence                                    │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

**Decision Levels**:

| Level | Risk | Behavior | Example Use Cases |
|-------|------|----------|-------------------|
| **Mechanical** | Low | Auto-execute with retry | Code formatting, linting, file operations |
| **Recommended** | Medium | Execute with 5s countdown | Running tests, generating docs |
| **Confirmed** | High | Require manual approval | Code commits, deployments |
| **Arbitrated** | Critical | Multi-party vote | Architecture changes, releases |

### 3. Agent Provider System

Abstract interface for integrating multiple AI providers.

```
┌──────────────────────────────────────────────────────────────────┐
│                  Agent Provider Interface                      │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  pub trait AgentProvider {                                      │
│      fn name(&self) -> &str;                                   │
│      async fn execute(&self, req: AgentRequest)                 │
│          -> Result<AgentResponse>;                              │
│      async fn execute_stream(&self, req: AgentRequest,          │
│          tx: mpsc::Sender<String>);                             │
│  }                                                             │
│                                                                  │
│  Implementations:                                               │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐              │
│  │  Claude    │  │   Kimi     │  │  OpenCode  │              │
│  │  Provider  │  │  Provider  │  │  Provider  │              │
│  └────────────┘  └────────────┘  └────────────┘              │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

**Supported Providers**:
- **Claude**: Anthropic's Claude API (Sonnet, Opus, Haiku)
- **Kimi**: Moonshot AI's Kimi API
- **OpenCode**: OpenCode's GLM models
- **Aider**: AI pair programming assistant
- **Custom**: Extensible for custom providers

### 4. Skill System

Hot-swappable capability modules loaded at runtime.

```
┌──────────────────────────────────────────────────────────────────┐
│                    Skill System                              │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                  Skill Registry                          │   │
│  │  - Discover skills from ~/.cis/skills/                   │   │
│  │  - Load skill.toml metadata                             │   │
│  │  - Validate permissions                                 │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                  Skill Router                           │   │
│  │  - Route requests to appropriate skill                  │   │
│  │  - Handle skill dependencies                          │   │
│  │  - Manage skill lifecycle                             │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                Skill Execution                           │   │
│  │                                                          │   │
│  │  Types:                                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │   Native     │  │    WASM     │  │    DAG      │  │   │
│  │  │  (Binary)    │  │ (Sandboxed) │  │ (Workflow)  │  │   │
│  │  └──────────────┘  └──────────────┘  └─────────────┘  │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

**Skill Structure**:
```
my-skill/
├── skill.toml          # Skill metadata
├── manifest.json       # Permissions and capabilities
├── run                # Native binary or WASM module
└── README.md          # Documentation
```

**Built-in Skills**:
- `init-wizard`: First-time setup and onboarding
- `memory-organizer`: Memory maintenance and cleanup
- `ai-executor`: AI task execution
- `dag-executor`: DAG workflow execution
- `im`: Instant messaging via Matrix
- `push-client`: Push notification client

### 5. P2P Networking

Decentralized peer-to-peer communication using libp2p.

```
┌──────────────────────────────────────────────────────────────────┐
│                    P2P Network Layer                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                   Discovery                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐│   │
│  │  │ mDNS Local   │  │ DHT Global   │  │ Bootstrap    ││   │
│  │  │ Discovery   │  │ Discovery   │  │ Nodes       ││   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘│   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                   Communication                           │   │
│  │  - QUIC for transport                                      │   │
│  │  - Noise protocol for encryption                            │   │
│  │  - DID-based authentication                                │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                    Data Sync                              │   │
│  │  - Public memory synchronization                          │   │
│  │  - CRDT-based conflict resolution                         │   │
│  │  - Merkle DAG verification                               │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

**Network Modes**:
- **Standalone**: Single-node operation, no networking
- **Local LAN**: mDNS-based peer discovery
- **P2P Public**: DHT-based global networking with NAT traversal
- **Hybrid**: Combination of local and P2P modes

### 6. Matrix Integration

Federation gateway for decentralized communication via Matrix protocol.

```
┌──────────────────────────────────────────────────────────────────┐
│                   Matrix Gateway                              │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                  Message Broker                           │   │
│  │  - Event handling                                        │   │
│  │  - Room management                                       │   │
│  │  - Federation                                            │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                  Sync Engine                             │   │
│  │  - Real-time synchronization                             │   │
│  │  - Offline message queueing                              │   │
│  │  - State reconciliation                                  │   │
│  └────────────────────────────────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────┴───────────────────────────────────┐   │
│  │                 Cloud Tunnel                             │   │
│  │  - WebSocket tunneling (if direct connection fails)      │   │
│  │  - Noise protocol encryption                            │   │
│  │  - NAT traversal assistance                             │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## Data Flow

### Memory Write Flow

```
User Request (e.g., "Remember my API key")
           │
           ▼
┌──────────────────────┐
│  Service Layer      │
│  MemoryService.set()│
└──────────────────────┘
           │
           ▼
┌──────────────────────┐
│  Classify Entry    │
│  - Determine index │
│    type           │
│  - Check policy    │
└──────────────────────┘
           │
           ├─────────────────┐
           ▼                 ▼
┌──────────────────┐  ┌──────────────────┐
│  LogMemory      │  │  VectorIndex    │
│  append()       │  │  index_entry()  │
│  (All data)     │  │  (Selective)    │
└──────────────────┘  └──────────────────┘
           │                 │
           ▼                 │
┌──────────────────┐          │
│  Weekly DB       │          │
│  (Hot data)     │          │
└──────────────────┘          │
           │                 │
           └─────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  Confirm & Log  │
           │  Response       │
           └──────────────────┘
```

### Task Execution Flow

```
DAG Trigger (CLI/API/Skill)
           │
           ▼
┌──────────────────────┐
│  Load DAG         │
│  - Validate       │
│  - Resolve deps   │
└──────────────────────┘
           │
           ▼
┌──────────────────────┐
│  Scheduler        │
│  - Topological    │
│    sort          │
│  - Level check   │
└──────────────────────┘
           │
           ▼
┌──────────────────────┐
│  Decision Engine   │
│  - Evaluate level │
│  - Get approval   │
│    (if needed)   │
└──────────────────────┘
           │
           ▼
┌──────────────────────┐
│  Execute Tasks    │
│  - Sequential     │
│    (deps)        │
│  - Parallel      │
│    (no deps)     │
└──────────────────────┘
           │
           ▼
┌──────────────────────┐
│  Handle Results   │
│  - Success        │
│    continue      │
│  - Failure       │
│    retry/rollback│
└──────────────────────┘
```

### Skill Invocation Flow

```
CLI/API Request
     │
     ▼
┌─────────────────┐
│ Intent Parser  │
│ - Identify     │
│   skill       │
│ - Extract     │
│   params      │
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ Skill Router   │
│ - Check       │
│   permissions│
│ - Resolve    │
│   project    │
│   skills     │
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ Skill Loader  │
│ - Load binary │
│   or WASM     │
│ - Validate    │
│   manifest   │
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ Skill Executor│
│ - Setup       │
│   sandbox     │
│ - Execute     │
│ - Monitor     │
│   timeout     │
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ Result Handler│
│ - Capture     │
│   output      │
│ - Update      │
│   state       │
│ - Emit events │
└─────────────────┘
```

---

## Technology Stack

### Core Technologies

| Component | Technology | Purpose |
|-----------|-----------|---------|
| **Language** | Rust 1.75+ | Performance, safety, concurrency |
| **Runtime** | Tokio | Async runtime |
| **Database** | SQLite | Embedded storage |
| **Serialization** | Serde | Data serialization |
| **Async** | async-std, futures | Async primitives |
| **Networking** | libp2p, QUIC | P2P communication |
| **Cryptography** | ed25519-dalek, cha cha20poly1305 | Encryption |
| **Vector Search** | HNSW | Semantic search |
| **WASM** | wasmi | Skill sandboxing |
| **Logging** | tracing | Structured logging |
| **CLI** | clap, ratatui | Command-line interface |
| **GUI** | Tauri, React | Desktop interface |

### Key Dependencies

```toml
[dependencies]
tokio = { version = "1.35", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
thiserror = "1.0"
tracing = "0.1"
rusqlite = { version = "0.30", features = ["bundled"] }
libp2p = { version = "0.53", features = ["full"], optional = true }
wasmi = "0.31"
ed25519-dalek = "2.0"
cha cha20poly1305 = "0.10"
```

### Optional Features

```toml
[features]
default = ["cli", "memory"]
p2p = ["libp2p"]
wasm = ["wasmi"]
matrix = ["matrix-sdk"]
encryption = ["ed25519-dalek", "cha cha20poly1305"]
full = ["p2p", "wasm", "matrix", "encryption"]
```

---

## Design Principles

### 1. Separation of Concerns

Each module has a single, well-defined responsibility:
- **Memory**: Data persistence and retrieval
- **Scheduler**: Task orchestration
- **Skills**: Capability extension
- **Agents**: AI provider abstraction
- **Network**: Peer communication

### 2. Dependency Inversion

High-level modules depend on abstractions, not concrete implementations:
- Services depend on traits, not specific implementations
- Agent providers implement the `AgentProvider` trait
- Storage backends implement storage traits
- Enables testing and swapping implementations

### 3. Interface Segregation

Small, focused interfaces that clients actually need:
```rust
pub trait MemoryService {
    async fn get(&self, key: &str) -> Result<Option<MemoryItem>>;
    async fn set(&self, key: &str, value: Vec<u8>) -> Result<()>;
    async fn search(&self, query: &str, limit: usize) -> Result<Vec<MemoryItem>>;
}
```

### 4. Open/Closed Principle

Open for extension, closed for modification:
- New skills can be added without modifying core
- New agent providers can be added via trait implementation
- Custom decision levels can be added

### 5. Fail-Safe Design

Graceful degradation under failure:
- Skills can fail without crashing the system
- Network partitions don't break local operations
- Memory service falls back to log storage if index fails

### 6. Performance Optimization

Target performance characteristics:
- Memory search: <80ms (p95)
- Task scheduling: <10ms overhead
- Skill loading: <100ms
- P2P discovery: <5s (LAN), <30s (global)

---

## Extension Points

### 1. Custom Skills

Users can create custom skills for domain-specific functionality:

```rust
use cis_skill_sdk::prelude::*;

#[skill]
pub struct MySkill {
    config: SkillConfig,
}

#[skill_impl]
impl Skill for MySkill {
    fn name(&self) -> &str {
        "my-custom-skill"
    }

    async fn handle(&self, ctx: &Context, event: Event) -> Result<()> {
        match event {
            Event::Invocation { args } => {
                // Handle skill invocation
            }
            _ => {}
        }
        Ok(())
    }
}
```

### 2. Agent Providers

Add support for new AI providers:

```rust
pub struct MyAgentProvider {
    client: Client,
}

#[async_trait]
impl AgentProvider for MyAgentProvider {
    fn name(&self) -> &str {
        "my-agent"
    }

    async fn execute(&self, req: AgentRequest) -> Result<AgentResponse> {
        // Implement agent execution logic
    }
}
```

### 3. Decision Levels

Custom decision levels for specific use cases:

```rust
pub struct CustomDecisionLevel {
    timeout: Duration,
    approvers: Vec<String>,
}

impl DecisionLevel for CustomDecisionLevel {
    async fn execute(&self, task: Task) -> Result<TaskResult> {
        // Implement custom decision logic
    }
}
```

### 4. Storage Backends

Alternative storage implementations:

```rust
pub struct CustomStorage {
    client: Client,
}

#[async_trait]
impl StorageBackend for CustomStorage {
    async fn get(&self, key: &str) -> Result<Option<Vec<u8>>> {
        // Custom storage logic
    }

    async fn set(&self, key: &str, value: Vec<u8>) -> Result<()> {
        // Custom storage logic
    }
}
```

### 5. Memory Index Strategies

Custom indexing strategies:

```rust
pub struct CustomIndexStrategy {
    classifier: Box<dyn Fn(&LogEntry) -> IndexType>,
}

impl IndexStrategy for CustomIndexStrategy {
    fn should_index(&self, entry: &LogEntry) -> bool {
        // Custom indexing logic
        (self.classifier)(entry) != IndexType::Temporary
    }

    fn calculate_weight(&self, entry: &LogEntry) -> f32 {
        // Custom weight calculation
    }
}
```

---

## Configuration

### Configuration Hierarchy

```
1. Global Config: ~/.cis/config.toml
2. Project Config: .cis/project.toml (if in project)
3. Environment Variables: CIS_*
4. CLI Arguments: --option value
```

### Global Configuration

```toml
# ~/.cis/config.toml

[core]
# Data directory
data_dir = "~/.cis"

# Log level
log_level = "info"

# Maximum concurrent tasks
max_concurrent_tasks = 10

[memory]
# Memory data directory
data_dir = "~/.cis/data/memory"

# Hot data retention (weeks)
hot_weeks = 4

# Total retention (weeks)
total_weeks = 54

# Vector index size limit
max_index_entries = 10000

[p2p]
# Enable P2P networking
enabled = true

# Listen port
listen_port = 7677

# Bootstrap nodes
bootstrap_nodes = [
    "/dns/cis-bootstrap.example.com/tcp/7677/p2p/12D3KooW..."
]

[p2p.discovery]
# Enable mDNS for local discovery
enable_mdns = true

# Enable DHT for global discovery
enable_dht = true

[agent]
# Default agent provider
default_agent = "claude"

# Model selection
default_model = "claude-3-sonnet"

[skills]
# Skill directories
skill_paths = [
    "~/.cis/skills",
    "/usr/local/lib/cis/skills"
]

# Auto-load skills
auto_load = true
```

### Project Configuration

```toml
# .cis/project.toml

[project]
name = "my-awesome-project"
id = "proj-abc-123"

[ai]
# Project-specific AI guide
guide = """
You are working on my-awesome-project.
Tech stack: Rust + React + PostgreSQL
Coding standards: Follow the project's CONVENTIONS.md
"""

provider = "claude"
model = "claude-3-sonnet"

# Project-local skills
[[skills]]
name = "custom-linter"
path = "./skills/custom-linter"
auto_load = true

[memory]
# Project namespace
namespace = "project/my-awesome-project"

# Shared memory keys
shared_keys = ["conventions", "architecture", "api-contracts"]

[persistent_agent]
# Auto-start persistent agents
auto_start = true

[[persistent_agent.agents]]
name = "project-helper"
runtime = "claude"
work_dir = "."
auto_restart = true
system_prompt = """
You are a project-specific CIS agent.
Always check project memory before making decisions.
"""
```

---

## Security Architecture

### Security Layers

```
┌──────────────────────────────────────────────────────────────┐
│                    Security Architecture                     │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │              Application Security                     │  │
│  │  - Input validation                                  │  │
│  │  - Output encoding                                   │  │
│  │  - Safe API boundaries                               │  │
│  └────────────────────────────────────────────────────────┘  │
│                         │                                    │
│  ┌────────────────────────┴──────────────────────────────┐  │
│  │               Access Control                          │  │
│  │  - DID-based authentication                          │  │
│  │  - ACL rules                                        │  │
│  │  - Capability security                              │  │
│  └────────────────────────────────────────────────────────┘  │
│                         │                                    │
│  ┌────────────────────────┴──────────────────────────────┐  │
│  │              Data Security                            │  │
│  │  - Private memory encryption                         │  │
│  │  - Secure channel (Noise protocol)                   │  │
│  │  - Hardware-bound identity                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                         │                                    │
│  ┌────────────────────────┴──────────────────────────────┐  │
│  │             Sandbox Security                          │  │
│  │  - WASM isolation                                   │  │
│  │  - Path validation                                  │  │
│  │  - Resource limits                                  │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### Security Features

1. **DID-Based Identity**: Cryptographically bound to hardware fingerprints
2. **Access Control Lists**: Fine-grained permissions for resources
3. **Memory Encryption**: Private domain encrypted at rest
4. **Sandbox Execution**: Skills run in WASM sandbox with capability security
5. **Secure Networking**: Noise protocol encryption for all P2P communication

---

## Monitoring & Observability

### Telemetry

CIS includes comprehensive request logging and telemetry:

```rust
// Request logging
pub struct RequestLogger {
    db: SqliteConnection,
}

impl RequestLogger {
    pub async fn log_request(&self, req: &Request) -> Result<()> {
        // Log request details
    }

    pub async fn log_stage(&self, stage: RequestStage) -> Result<()> {
        // Log execution stage
    }

    pub fn cleanup_old_logs(&self, days: u32) -> Result<usize> {
        // Cleanup old logs
    }
}
```

### Metrics

Key metrics tracked:
- Request latency (p50, p95, p99)
- Memory usage (heap, stack)
- Task execution time
- Skill load time
- P2P connection count
- Vector index size

### Logging

Structured logging with tracing:

```rust
use tracing::{info, warn, error, instrument};

#[instrument(skip(self))]
pub async fn execute_task(&self, task: Task) -> Result<TaskResult> {
    info!("Executing task: {}", task.name);

    match self.internal_execute(task).await {
        Ok(result) => {
            info!(task_result = ?result, "Task completed successfully");
            Ok(result)
        }
        Err(e) => {
            error!(error = %e, "Task execution failed");
            Err(e)
        }
    }
}
```

---

## Deployment Models

### Standalone Deployment

Single-node operation without networking:

```
┌─────────────────────┐
│   CIS Node        │
│  - Local storage  │
│  - No networking │
│  - Single user   │
└─────────────────────┘
```

### Team Deployment

Local network deployment with mDNS discovery:

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ CIS Node A   │────▶│ mDNS Peer    │◀────│ CIS Node B   │
│ (192.168.1.2)│    │ Discovery    │     │(192.168.1.3)│
└──────────────┘     └──────────────┘     └──────────────┘
       │                                          │
       └────────────────┬─────────────────────────┘
                       ▼
              ┌──────────────┐
              │ Public Memory │
              │ Sync         │
              └──────────────┘
```

### Global Deployment

P2P networking with DHT and NAT traversal:

```
┌──────────────┐                    ┌──────────────┐
│ CIS Node A   │                    │ CIS Node B   │
│ (Home)       │────────┐      ┌───│ (Office)     │
│ NAT: Router1 │        │      │   │ NAT: Router2 │
└──────────────┘        │      │   └──────────────┘
                       │      │
                       ▼      ▼
                 ┌──────────────┐
                 │  DHT &      │
                 │  Relay      │
                 └──────────────┘
                       ▲
                 ┌─────┴─────┐
                 │Bootstrap  │
                 │Nodes      │
                 └───────────┘
```

---

## Future Roadmap

### v1.2.0 (Planned)

- Enhanced vector index with adaptive strategies
- Persistent agent pool management
- Improved DAG visualization
- Mobile app (iOS/Android)

### v1.3.0 (Planned)

- Machine learning-based task optimization
- Advanced conflict resolution
- Multi-region federation
- Enterprise SSO integration

### v2.0.0 (Future)

- Complete rewrite of memory system for distributed一致性
- Native blockchain integration
- Quantum-resistant cryptography
- GPU-accelerated vector search

---

## Conclusion

CIS v1.1.6 represents a mature, production-ready architecture for AI-native workflow orchestration. The system's strength lies in its modular design, bidirectional agent integration, and hybrid memory architecture.

Key achievements:
- **Bidirectional Integration**: Seamless AI provider integration
- **Memory Innovation**: Precision indexing with automatic archiving
- **Extensibility**: Hot-swappable skills and custom providers
- **Security**: Hardware-bound identity with encryption
- **Networking**: True P2P federation

The architecture is designed to evolve, with clear extension points for future enhancements while maintaining backward compatibility and system stability.

---

**Document Version**: 1.0
**Last Updated**: 2026-02-13
**Authors**: CIS Architecture Team
**Status**: Final
