# DAG å…¨å±€å•ä¾‹ Agent è®¾è®¡æ–¹æ¡ˆç ”åˆ¤

## æ ¸å¿ƒæƒ³æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CIS é›†ç¾¤                                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  GLM Agent-1 â”‚â”€â”€â”€â”€â”                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                          â”‚
â”‚                      â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  GLM Agent-2 â”‚â”€â”€â”‚  å…¨å±€å•ä¾‹ Coordinator â”‚â”€â”€â”€â–¶â”‚ Node-A   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  (DAG æ‹†è§£ & ä»»åŠ¡åˆ†é…)  â”‚    â”‚ (æ‰§è¡Œ)   â”‚    â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                     â”‚            â”‚
â”‚                              â–¼                     â–¼            â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                      â”‚   SQLite     â”‚        â”‚ Node-B   â”‚       â”‚
â”‚                      â”‚ (ä»»åŠ¡é˜Ÿåˆ—)    â”‚        â”‚ (æ‰§è¡Œ)   â”‚       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è§¦å‘å‚æ•°**: `dag_options: { "coordinator": true }`

---

## ä¼˜ç‚¹åˆ†æ âœ…

### 1. é›†ä¸­è°ƒåº¦ç­–ç•¥
```rust
pub struct Coordinator {
    // ç»Ÿä¸€è´Ÿè½½å‡è¡¡
    pub fn assign_task(&self, task: Task) -> NodeId {
        // é€‰æ‹©è´Ÿè½½æœ€ä½çš„èŠ‚ç‚¹
        let nodes = self.discover_nodes();
        nodes.min_by(|n| n.current_load())
    }
    
    // å…¨å±€ä¼˜å…ˆçº§é˜Ÿåˆ—
    pub fn schedule(&self) {
        let queue: PriorityQueue<Task> = ...;
        // æŒ‰ä¼˜å…ˆçº§ + æ—¶é—´æˆ³æ’åº
    }
}
```

### 2. é¿å…åˆ†å¸ƒå¼ç«äº‰
```rust
// ä¹‹å‰ï¼šæ¯ä¸ªèŠ‚ç‚¹ç«äº‰æŠ¢é”
Node-A: UPDATE tasks SET status='Running' WHERE ...
Node-B: UPDATE tasks SET status='Running' WHERE ...  â† å†²çª

// ç°åœ¨ï¼šCoordinator ç»Ÿä¸€åˆ†é…
Coordinator: 
  1. SELECT * FROM tasks WHERE status='Pending' LIMIT 1
  2. INSERT INTO assignments (task_id, node_id) VALUES (...)
  3. NOTIFY node-B: "ä½ æœ‰æ–°ä»»åŠ¡"
```

### 3. DAG æ‹†è§£ä¼˜åŒ–
```rust
impl Coordinator {
    pub fn decompose_dag(&self, dag: DagDefinition) -> Vec<TaskBatch> {
        // æ™ºèƒ½æ‰¹æ¬¡ï¼šæŠŠæ— ä¾èµ–çš„ä»»åŠ¡æ‰“åŒ…ä¸€èµ·ä¸‹å‘
        let levels = dag.topological_sort();
        levels.into_iter().map(|level| {
            TaskBatch {
                tasks: level,
                parallel: true,  // åŒä¸€æ‰¹æ¬¡å¹¶è¡Œæ‰§è¡Œ
            }
        }).collect()
    }
}
```

### 4. å…¨å±€çŠ¶æ€ä¸€è‡´æ€§
```rust
// Coordinator ç»´æŠ¤ç»Ÿä¸€è§†å›¾
pub struct GlobalState {
    dag_status: HashMap<DagId, DagStatus>,
    node_health: HashMap<NodeId, NodeHealth>,
    task_assignments: HashMap<TaskId, NodeId>,
}

// æ‰€æœ‰æŸ¥è¯¢èµ° Coordinatorï¼Œæ— å¹¶å‘å†²çª
```

### 5. æ•…éšœæ¢å¤ç®€åŒ–
```rust
// Coordinator çŸ¥é“æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
pub fn recover(&self, failed_node: NodeId) {
    let lost_tasks = self.find_tasks_by_node(failed_node);
    for task in lost_tasks {
        // é‡æ–°åˆ†é…åˆ°å…¶ä»–èŠ‚ç‚¹
        self.reassign_task(task);
    }
}
```

---

## ç¼ºç‚¹/é£é™©åˆ†æ âš ï¸

### 1. å•ç‚¹æ•…éšœ (SPOF)
```
Coordinator å´©æºƒ â†’ æ•´ä¸ªé›†ç¾¤æ— æ³•è°ƒåº¦æ–°ä»»åŠ¡

ä¸´æ—¶æ–¹æ¡ˆï¼š
- å®šæœŸ Checkpoint çŠ¶æ€åˆ° SQLite
- é‡å¯åä»æ•°æ®åº“æ¢å¤

æ ¹æœ¬æ–¹æ¡ˆï¼ˆé«˜å¯ç”¨ï¼‰ï¼š
- Raft/Paxos å¤šå‰¯æœ¬ (å¤æ‚åº¦é«˜)
- ä¸»å¤‡æ¨¡å¼ (éœ€è¦æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢)
```

### 2. ä¸ CIS å»ä¸­å¿ƒåŒ–ç†å¿µå†²çª
| CIS è®¾è®¡åŸåˆ™ | å•ä¾‹ Coordinator å½±å“ |
|-------------|---------------------|
| æ— ä¸»èŠ‚ç‚¹ | å¼•å…¥ä¸»èŠ‚ç‚¹ |
| ä»»æ„èŠ‚ç‚¹å¯ç¦»çº¿å·¥ä½œ | ä¾èµ– Coordinator åœ¨çº¿ |
| é›¶å•ç‚¹æ•…éšœ | å•ç‚¹æ•…éšœé£é™© |

### 3. ç½‘ç»œåˆ†åŒºé—®é¢˜
```
åœºæ™¯ï¼šCoordinator ä¸ Node-A ç½‘ç»œæ–­å¼€

Node-A: æ— æ³•æ¥æ”¶æ–°ä»»åŠ¡ï¼ˆç­‰å¾… Coordinator é€šçŸ¥ï¼‰
        å·²é¢†å–çš„ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼ˆæœ¬åœ°çŠ¶æ€ï¼‰
        
ç»“æœï¼šNode-A æˆä¸º"å­¤å²›"ï¼Œæ— æ³•è´¡çŒ®ç®—åŠ›

å¯¹æ¯”ï¼šå»ä¸­å¿ƒåŒ–æ–¹æ¡ˆä¸­ï¼ŒNode-A å¯ä»¥ç»§ç»­æŠ¢é”æ‰§è¡Œä»»åŠ¡
```

### 4. æ€§èƒ½ç“¶é¢ˆ
```rust
// æ‰€æœ‰ä»»åŠ¡çŠ¶æ€å˜æ›´éƒ½éœ€ç»è¿‡ Coordinator
Node-A å®Œæˆä»»åŠ¡ â”€â”€â–¶ Coordinator â”€â”€â–¶ æ›´æ–°æ•°æ®åº“
     â–²                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é…æ–°ä»»åŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// é«˜å¹¶å‘æ—¶ Coordinator æˆä¸ºç“¶é¢ˆ
// QPS å—é™äº Coordinator å¤„ç†èƒ½åŠ›
```

### 5. è„‘è£‚é£é™©ï¼ˆå¤š Coordinatorï¼‰
```
ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå¯èƒ½å‡ºç°ä¸¤ä¸ª Coordinator éƒ½è®¤ä¸ºè‡ªå·±æ˜¯ä¸»èŠ‚ç‚¹

Partition-1: [Coordinator-A, Node-A, Node-B]
Partition-2: [Coordinator-B, Node-C, Node-D]

ä¸¤ä¸ª Coordinator å„è‡ªè°ƒåº¦ â†’ ä»»åŠ¡é‡å¤åˆ†é…

éœ€è¦ï¼šåˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼ˆRaftï¼‰é˜²æ­¢è„‘è£‚
```

---

## ä¸ä¹è§‚é”æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | å•ä¾‹ Coordinator | ä¹è§‚é”å»ä¸­å¿ƒåŒ– |
|------|------------------|---------------|
| **å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦é€‰ä¸¾/å®¹é”™ï¼‰ | ä½ï¼ˆæ•°æ®åº“çº¦æŸï¼‰ |
| **å¯ç”¨æ€§** | ä¸­ï¼ˆå•ç‚¹æ•…éšœï¼‰ | é«˜ï¼ˆä»»æ„èŠ‚ç‚¹å¯æ‰§è¡Œï¼‰ |
| **æ€§èƒ½** | ä¸­ï¼ˆä¸­å¿ƒåŒ–ç“¶é¢ˆï¼‰ | é«˜ï¼ˆå¹¶è¡ŒæŠ¢é”ï¼‰ |
| **ä¸€è‡´æ€§** | å¼ºï¼ˆç»Ÿä¸€è°ƒåº¦ï¼‰ | å¼±ï¼ˆå¯èƒ½å†²çªé‡è¯•ï¼‰ |
| **æ‰©å±•æ€§** | å·®ï¼ˆCoordinator ç“¶é¢ˆï¼‰ | å¥½ï¼ˆèŠ‚ç‚¹çº¿æ€§æ‰©å±•ï¼‰ |
| **ç½‘ç»œåˆ†åŒºå®¹å¿** | å·®ï¼ˆå­¤å²›èŠ‚ç‚¹æ— æ³•å·¥ä½œï¼‰ | å¥½ï¼ˆæœ¬åœ°å†³ç­–ï¼‰ |
| **å®ç°æˆæœ¬** | é«˜ï¼ˆ1-2å‘¨ï¼‰ | ä½ï¼ˆ2-3å¤©ï¼‰ |

---

## æ”¹è¿›å»ºè®®ï¼šæ··åˆæ¨¡å¼

### æ–¹æ¡ˆ Aï¼šè½»é‡çº§ Coordinatorï¼ˆæ¨èï¼‰
```rust
// åªåè°ƒï¼Œä¸æ§åˆ¶
pub struct LightweightCoordinator {
    // 1. æä¾›å…¨å±€è§†å›¾ï¼ˆåªè¯»ï¼‰
    pub fn get_global_status(&self) -> GlobalStatus;
    
    // 2. å»ºè®®åˆ†é…ï¼ˆéå¼ºåˆ¶ï¼‰
    pub fn suggest_assignment(&self, task: &Task) -> Option<NodeId> {
        // è¿”å›æ¨èèŠ‚ç‚¹ï¼Œä½†èŠ‚ç‚¹å¯ä»¥æ‹’ç»/å¿½ç•¥
        self.find_best_node(task)
    }
    
    // 3. å†²çªä»²è£ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰
    pub fn resolve_conflict(&self, task_id: TaskId) {
        // å½“ä¹è§‚é”å†²çªè¿‡å¤šæ—¶ä»‹å…¥
    }
}

// èŠ‚ç‚¹ä»ç„¶ä¹è§‚æŠ¢é”ï¼Œä½†å‚è€ƒ Coordinator çš„å»ºè®®
Node-A:
  let suggestion = coordinator.suggest_assignment(&task);
  if suggestion == Some(my_id) {
      // ä¼˜å…ˆå°è¯•è®¤é¢†
      try_claim(task);
  }
```

### æ–¹æ¡ˆ Bï¼šå¯é€‰ Coordinatorï¼ˆå‘åå…¼å®¹ï¼‰
```rust
// DAG å‚æ•°å†³å®šæ˜¯å¦å¯ç”¨
pub struct DagOptions {
    pub use_coordinator: bool,  // é»˜è®¤ falseï¼ˆä¹è§‚é”æ¨¡å¼ï¼‰
    pub coordinator_id: Option<String>,  // æŒ‡å®š Coordinator
}

// ç®€å• DAGï¼šä¹è§‚é”
// å¤æ‚ DAGï¼ˆè·¨å¤šèŠ‚ç‚¹ï¼‰ï¼šå¯ç”¨ Coordinator
cis dag run complex_pipeline.json --use-coordinator
```

### æ–¹æ¡ˆ Cï¼šRoom çº§åˆ« Coordinatorï¼ˆè”é‚¦ï¼‰
```rust
// æ¯ä¸ª Matrix Room æœ‰è‡ªå·±çš„ Coordinator
// é¿å…å…¨å±€å•ç‚¹
pub struct RoomCoordinator {
    room_id: String,
    coordinator_did: String,  // Room å†…é€‰ä¸¾äº§ç”Ÿ
}

// Room å†…å•ä¾‹ï¼ŒRoom é—´ç‹¬ç«‹
// Room-A çš„ Coordinator åªç®¡ç† Room-A çš„ä»»åŠ¡
```

---

## æ¨èå®ç°è·¯å¾„

### Phase 1ï¼šå…ˆå®ç°ä¹è§‚é”ï¼ˆçŸ­æœŸï¼‰
- æ•°æ®åº“å”¯ä¸€çº¦æŸ
- ç‰ˆæœ¬å·ä¹è§‚é”
- å¹‚ç­‰ç¡®è®¤

**åŸå› **ï¼š
- å¿«é€Ÿå¯ç”¨ï¼ˆ2-3å¤©ï¼‰
- ç¬¦åˆ CIS å»ä¸­å¿ƒåŒ–ç†å¿µ
- æ»¡è¶³ GLM åŸºæœ¬éœ€æ±‚

### Phase 2ï¼šå¯é€‰ Coordinatorï¼ˆä¸­æœŸï¼‰
```rust
// DAG å‚æ•°æ§åˆ¶
dag_options: {
    "coordination_mode": "optimistic" | "centralized",
    "coordinator_id": "did:cis:coordinator-1:abc"
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç®€å•ä»»åŠ¡ï¼šä¹è§‚é”ï¼ˆé»˜è®¤ï¼‰
- å¤æ‚è·¨èŠ‚ç‚¹ DAGï¼šå¯ç”¨ Coordinator

### Phase 3ï¼šé«˜å¯ç”¨ Coordinatorï¼ˆé•¿æœŸï¼‰
- Raft é€‰ä¸¾
- çŠ¶æ€æœºå¤åˆ¶
- è‡ªåŠ¨æ•…éšœè½¬ç§»

---

## ç»“è®º

| è¯„ä¼°é¡¹ | è¯„åˆ† | è¯´æ˜ |
|--------|------|------|
| æ¶æ„å¥‘åˆåº¦ | â­â­â˜†â˜†â˜† | ä¸ CIS å»ä¸­å¿ƒåŒ–ç†å¿µå†²çª |
| å®ç°å¤æ‚åº¦ | â­â­â­â­â˜† | éœ€è¦é€‰ä¸¾ã€å®¹é”™ã€ä¸€è‡´æ€§ |
| çŸ­æœŸå¯ç”¨æ€§ | â­â­â˜†â˜†â˜† | å•ç‚¹æ•…éšœé£é™©é«˜ |
| é•¿æœŸç»´æŠ¤æ€§ | â­â­â­â˜†â˜† | éœ€è¦æŒç»­ç»´æŠ¤é«˜å¯ç”¨ |
| æ€§èƒ½æ‰©å±•æ€§ | â­â­â˜†â˜†â˜† | ä¸­å¿ƒåŒ–ç“¶é¢ˆ |

**æ€»ä½“è¯„ä»·**ï¼š

ğŸ”´ **ä¸æ¨èä½œä¸ºé»˜è®¤æ–¹æ¡ˆ**

åŸå› ï¼š
1. ä¸ CIS "æ— ä¸»èŠ‚ç‚¹" æ ¸å¿ƒè®¾è®¡å†²çª
2. å¼•å…¥ä¸å¿…è¦çš„å•ç‚¹æ•…éšœé£é™©
3. å®ç°å¤æ‚åº¦é«˜ï¼Œå»¶è¿Ÿå‘å¸ƒ

ğŸŸ¡ **å»ºè®®ä½œä¸ºå¯é€‰å¢å¼º**

åœ¨ä¹è§‚é”åŸºç¡€ä¸Šï¼Œæä¾› `use_coordinator` å‚æ•°ï¼Œè®©ç”¨æˆ·æŒ‰éœ€å¯ç”¨ã€‚

ğŸŸ¢ **æ›¿ä»£æ–¹æ¡ˆï¼šè½»é‡çº§åè°ƒ**

ä¿ç•™ä¹è§‚é”ä½œä¸ºåŸºç¡€ï¼Œå¢åŠ  Coordinator ä½œä¸º"å»ºè®®è€…"è€Œé"æ§åˆ¶è€…"ï¼š
- æä¾›å…¨å±€è§†å›¾ï¼ˆåªè¯»ï¼‰
- å»ºè®®ä»»åŠ¡åˆ†é…ï¼ˆéå¼ºåˆ¶ï¼‰
- å†²çªæ—¶ä»²è£ï¼ˆå…œåº•ï¼‰

è¿™æ ·æ—¢é¿å…äº†å•ç‚¹æ•…éšœï¼Œåˆè·å¾—äº†é›†ä¸­è°ƒåº¦çš„éƒ¨åˆ†å¥½å¤„ã€‚

---

**å»ºè®®å†³ç­–**ï¼š
1. **ç«‹å³**ï¼šå®ç°ä¹è§‚é”æ–¹æ¡ˆï¼ˆæ»¡è¶³ GLM éœ€æ±‚ï¼‰
2. **åç»­**ï¼šè¯„ä¼°æ˜¯å¦éœ€è¦å¯é€‰ Coordinatorï¼ˆæ ¹æ®å®é™…è´Ÿè½½ï¼‰
3. **é•¿æœŸ**ï¼šè‹¥çœŸæœ‰éœ€è¦ï¼Œé‡‡ç”¨ Room çº§åˆ«è”é‚¦ Coordinator

ä½ æ˜¯å¦è®¤åŒè¿™ä¸ªè¯„ä¼°ï¼Ÿæˆ–è€…ä½ æœ‰ç‰¹å®šçš„åœºæ™¯å¿…é¡»ç”¨å•ä¾‹ Coordinatorï¼Ÿ
