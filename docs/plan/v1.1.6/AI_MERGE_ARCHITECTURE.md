# AIMerge 架构设计图

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Conflict Resolution                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  apply_resolution_strategy_async()                          │
│  ┌─────────────────────────────────────────────────┐        │
│  │ Choice: KeepLocal │ KeepRemote │ KeepBoth │ AI   │        │
│  └─────────────────────────────────────────────────┘        │
│                       │                                      │
│                       ▼                                      │
│              ┌─────────────────┐                            │
│              │  AIMerge?       │                            │
│              └─────────────────┘                            │
│                       │                                      │
│           ┌───────────┴───────────┐                        │
│           │                       │                        │
│           ▼                       ▼                        │
│      ┌─────────┐          ┌──────────────┐                │
│      │   No    │          │     Yes      │                │
│      └─────────┘          └──────────────┘                │
│           │                       │                        │
│           ▼                       ▼                        │
│    KeepLocal              ┌─────────────┐                 │
│                            │  AIMerger   │                 │
│                            └─────────────┘                 │
│                                   │                         │
│                                   ▼                         │
└─────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                    ▼                             ▼
           ┌───────────────┐            ┌──────────────┐
           │ Check AI      │            │  No AI       │
           │ Provider      │            │  Provider    │
           └───────────────┘            └──────────────┘
                    │                             │
                    ▼                             ▼
           ┌───────────────┐            ┌──────────────┐
           │  Available?   │            │  KeepLocal   │
           └───────────────┘            └──────────────┘
                    │
           ┌────────┴────────┐
           │                 │
           ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │   Yes    │      │   No     │
    └──────────┘      └──────────┘
           │                 │
           ▼                 ▼
    ┌──────────────┐  ┌──────────────┐
    │ Build Prompt │  │  KeepLocal   │
    └──────────────┘  └──────────────┘
           │
           ▼
    ┌──────────────┐
    │ Call AI      │
    │ (with retry) │
    └──────────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌─────────┐  ┌─────────┐
│ Success │  │  Fail   │
└─────────┘  └─────────┘
    │             │
    ▼             ▼
┌─────────┐  ┌──────────────┐
│ Return  │  │ KeepLocal    │
│ Merged  │  │ (Fallback)   │
└─────────┘  └──────────────┘
```

## AIMerger 内部流程

```
┌─────────────────────────────────────────────────────────────┐
│                        AIMerger                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  merge(key, local, remotes)                                 │
│  │                                                           │
│  ├─► Check AI Provider                                      │
│  │   ├─► None? ──► KeepLocal                                │
│  │   └─► Available? ──► No ──► KeepLocal                    │
│  │                                                           │
│  ├─► Build Merge Prompt                                     │
│  │   ├─► Conflict Key                                       │
│  │   ├─► Local Version (node, timestamp, value)             │
│  │   └─► Remote Versions (node, timestamp, value)           │
│  │                                                           │
│  ├─► merge_with_retry()                                     │
│  │   │                                                       │
│  │   └─► For attempt in 0..max_retries                       │
│  │       │                                                   │
│  │       ├─► call_ai_merge()                                │
│  │       │   │                                               │
│  │       │   ├─► build_system_prompt()                      │
│  │       │   │   └─► Based on Strategy                      │
│  │       │   │       ├─► SmartMerge                         │
│  │       │   │       ├─► ContentBased                      │
│  │       │   │       └─► TimeBased                         │
│  │       │   │                                               │
│  │       │   ├─► chat_with_context()                        │
│  │       │   │   └─► Timeout: config.timeout_secs           │
│  │       │   │                                               │
│  │       │   └─► parse_ai_response()                        │
│  │       │       ├─► Strip ```markdown```                   │
│  │       │       ├─► Strip ```json```                       │
│  │       │       └─► Trim whitespace                        │
│  │       │                                                   │
│  │       ├─► Success? ──► Return merged                      │
│  │       │                                                   │
│  │       └─► Error? ──► Store error, retry                  │
│  │                                                           │
│  └─► All retries failed? ──► Return error                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 三种合并策略

```
┌─────────────────────────────────────────────────────────────┐
│                    AIMergeStrategy                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   SmartMerge    │  │  ContentBased   │  │  TimeBased  │ │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────┤ │
│  │ • 保留双方信息  │  │ • 内容质量优先  │  │ • 时间优先  │ │
│  │ • 智能解决冲突  │  │ • 完整性优先    │  │ • 新旧合并  │ │
│  │ • 维护一致性    │  │ • 准确性优先    │  │ • 时序保留  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
│           │                    │                  │        │
│           ▼                    ▼                  ▼        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐│
│  │ 配置文件        │  │ 文档、笔记      │  │ 日志、时间线││
│  │ 结构化数据      │  │ 文章、内容      │  │ 时序数据    ││
│  └─────────────────┘  └─────────────────┘  └─────────────┘│
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 错误处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Error Handling                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────┐           │
│  │              Start AIMerge                  │           │
│  └─────────────────┬───────────────────────────┘           │
│                    │                                        │
│                    ▼                                        │
│         ┌──────────────────────┐                           │
│         │ Check AI Provider    │                           │
│         └──────────┬───────────┘                           │
│                    │                                        │
│        ┌───────────┴───────────┐                           │
│        │                       │                           │
│        ▼                       ▼                           │
│   ┌─────────┐           ┌──────────────┐                   │
│   │ Error   │           │   Available  │                   │
│   └────┬────┘           └──────┬───────┘                   │
│        │                       │                           │
│        ▼                       ▼                           │
│   ┌─────────┐         ┌──────────────┐                     │
│   │Warning  │         │ Build Prompt │                     │
│   │Log      │         └──────┬───────┘                     │
│   └────┬────┘                │                             │
│        │                       ▼                             │
│        │              ┌──────────────┐                     │
│        │              │ Call AI      │                     │
│        │              │ (with timeout)│                    │
│        │              └──────┬───────┘                     │
│        │                     │                             │
│        │        ┌────────────┴────────────┐                │
│        │        │                         │                │
│        │        ▼                         ▼                │
│        │   ┌─────────┐             ┌─────────┐            │
│        │   │ Success │             │  Error  │            │
│        │   └────┬────┘             └────┬────┘            │
│        │        │                       │                 │
│        │        ▼                       ▼                 │
│        │   ┌─────────┐          ┌──────────────┐          │
│        │   │ Return  │          │ Retry?       │          │
│        │   │ Merged  │          │ (attempt <  │          │
│        │   └─────────┘          │  max_retries)│         │
│        │                        └──────┬───────┘          │
│        │                               │                  │
│        │                    ┌──────────┴──────────┐       │
│        │                    │                     │       │
│        │                    ▼                     ▼       │
│        │               ┌─────────┐          ┌─────────┐   │
│        │               │   Yes   │          │   No    │   │
│        │               └────┬────┘          └────┬────┘   │
│        │                    │                    │        │
│        │                    ▼                    ▼        │
│        │               ┌─────────┐          ┌─────────┐   │
│        │               │ Retry   │          │Warning  │   │
│        │               └─────────┘          │Log      │   │
│        │                                    └────┬────┘   │
│        │                                         │        │
│        │                                         ▼        │
│        │                                    ┌─────────┐   │
│        │                                    │KeepLocal│   │
│        │                                    └─────────┘   │
│        │                                         │        │
│        ▼                                         ▼        │
│   ┌─────────┐                                ┌─────────┐  │
│   │KeepLocal│                                │ Return  │  │
│   └─────────┘                                │ Result  │  │
│                                              └─────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 配置选项

```
┌─────────────────────────────────────────────────────────────┐
│                   AIMergeConfig                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  strategy: AIMergeStrategy                                  │
│  ├── SmartMerge (default)                                   │
│  ├── ContentBased                                           │
│  └── TimeBased                                              │
│                                                              │
│  max_retries: usize (default: 2)                            │
│  ├── 0: No retry                                            │
│  ├── 1-3: Normal retry                                      │
│  └── 4+: Aggressive retry                                   │
│                                                              │
│  timeout_secs: u64 (default: 30)                            │
│  ├── 10-30: Normal timeout                                  │
│  ├── 30-60: Long timeout                                    │
│  └── 60+: Very long timeout                                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 使用示例流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Usage Example                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. Create AIMerger                                         │
│     ┌──────────────────────────────────┐                    │
│     │ let merger = AIMerger::new(config)│                   │
│     └──────────────────────────────────┘                    │
│                     │                                        │
│                     ▼                                        │
│  2. Set AI Provider                                         │
│     ┌──────────────────────────────────┐                    │
│     │ merger.set_ai_provider(provider) │                   │
│     │     .await;                      │                    │
│     └──────────────────────────────────┘                    │
│                     │                                        │
│                     ▼                                        │
│  3. Call Async Resolution                                  │
│     ┌──────────────────────────────────┐                    │
│     │ let merged = apply_resolution    │                   │
│     │   ::strategy_async(             │                   │
│     │     &AIMerge,                   │                   │
│     │     &local,                     │                   │
│     │     &remotes,                   │                   │
│     │     key,                        │                   │
│     │     Some(&merger)               │                   │
│     │   ).await?;                     │                   │
│     └──────────────────────────────────┘                    │
│                     │                                        │
│                     ▼                                        │
│  4. Handle Result                                          │
│     ┌──────────────────────────────────┐                    │
│     │ match merged {                  │                   │
│     │   Ok(value) => { ... }          │                   │
│     │   Err(e) => { ... }             │                   │
│     │ }                               │                   │
│     └──────────────────────────────────┘                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 文件依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                  File Dependencies                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ai_merge.rs                                                │
│  ├── crate::ai::AiProvider (trait)                          │
│  ├── crate::ai::Message                                     │
│  ├── crate::error::{CisError, Result}                       │
│  ├── tokio::sync::RwLock                                    │
│  ├── std::sync::Arc                                         │
│  └── tracing (logging)                                      │
│                                                              │
│  conflict_resolution.rs                                     │
│  ├── ai_merge (module)                                      │
│  ├── conflict_guard (module)                                │
│  ├── vector_clock (module)                                  │
│  └── crate::error::{CisError, Result}                       │
│                                                              │
│  mod.rs                                                     │
│  ├── ai_merge (pub)                                         │
│  ├── conflict_guard (pub)                                   │
│  ├── conflict_resolution (pub)                              │
│  ├── types (pub)                                            │
│  └── vector_clock (pub)                                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

**创建日期**: 2026-02-15
**版本**: 1.0.0
**作者**: Claude Code
