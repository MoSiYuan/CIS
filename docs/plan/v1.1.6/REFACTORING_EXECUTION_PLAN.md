# CIS 代码拆分执行计划

> **计划日期**: 2026-02-12
> **版本**: v1.1.6
> **执行周期**: 8 周
> **目标**: 拆分巨型模块，建立代码复用结构

---

## 执行摘要

### 整体目标

| 指标 | 当前值 | 目标值 | 改进幅度 |
|--------|---------|---------|----------|
| 平均模块行数 | ~800 行 | <500 行 | -37% |
| 最大模块行数 | 3,439 行 | <1000 行 | -71% |
| 代码重复率 | ~15% | <5% | -67% |
| 编译时间（增量） | ~120s | <60s | -50% |
| 测试覆盖率 | ~65% | >85% | +31% |

### 执行策略

**三阶段并发执行**：

```
阶段 1: 基础设施 (Week 1-2)
  └─ Team Q: 事件总线、服务容器、统一错误

阶段 2: 核心拆分 (Week 3-5)
  ├─ Team Q: scheduler 拆分 (10-15 人日)
  ├─ Team R: config 拆分 (3-5 人日)
  └─ Team S: p2p 拆分 (5-7 人日)

阶段 3: 次要拆分 (Week 6-7)
  ├─ Team T: skill 拆分 (4-6 人日)
  └─ Team U: agent/其他模块拆分 (3-4 人日)

阶段 4: 验收优化 (Week 8)
  └─ 全员: 测试、文档、性能优化
```

---

## 阶段 1: 基础设施 (Week 1-2)

### 目标

建立模块化基础设施，为后续拆分奠定基础。

### 负责团队: Team Q

**成员配置**: 3-5 人
**预计工作量**: 8 人日

### 任务清单

#### Q-1: 实现事件总线 (2 人日)

**目标文件**: `cis-core/src/events/mod.rs`

**任务**:
- [ ] 定义 `Event` trait
- [ ] 定义 `EventHandler` trait
- [ ] 实现 `EventBus` 结构
  - [ ] `publish()` 方法
  - [ ] `subscribe()` 方法
  - [ ] 通道管理
- [ ] 编写单元测试
- [ ] 集成到现有代码（可选，不强制）

**验收标准**:
- 单元测试覆盖率 > 90%
- 发布延迟 < 1ms (1000 订阅者)
- 订阅延迟 < 100μs

**依赖**: 无

**交付物**:
- `events/mod.rs` (~200 行)
- `events/bus.rs` (~300 行)
- `events/tests.rs` (~200 行)

---

#### Q-2: 实现服务容器 (2 人日)

**目标文件**: `cis-core/src/services/mod.rs`

**任务**:
- [ ] 定义 `Service` trait
- [ ] 实现 `ServiceContainer` 结构
  - [ ] `register()` 方法
  - [ ] `get()` 方法
  - [ ] 类型安全的 downcast
- [ ] 实现服务生命周期管理
- [ ] 编写单元测试
- [ ] 迁移 2-3 个核心服务到容器

**验收标准**:
- 单元测试覆盖率 > 90%
- 服务获取延迟 < 100μs
- 支持 >100 个并发注册

**依赖**: Q-1 (事件总线，可选)

**交付物**:
- `services/mod.rs` (~250 行)
- `services/container.rs` (~400 行)
- `services/tests.rs` (~150 行)

---

#### Q-3: 统一错误处理 (1 人日)

**目标文件**: `cis-core/src/error/mod.rs`

**任务**:
- [ ] 审查现有 `CisError` 定义
- [ ] 添加缺失的错误分类
  - [ ] 服务错误 (`ServiceNotFound`, `ServiceTypeMismatch`)
  - [ ] 事件错误 (`EventPublishFailed`, `EventSubscribeFailed`)
  - [ ] 验证错误 (`ValidationError`, `SchemaError`)
- [ ] 实现便利宏
  - [ ] `impl_error!` 宏
  - [ ] `bail!` 宏
- [ ] 编写单元测试
- [ ] 迁移现有错误处理

**验收标准**:
- 所有错误都有清晰描述
- 支持 `?` 操作符
- 错误上下文完整

**依赖**: 无

**交付物**:
- `error/mod.rs` (已存在，扩展)
- `error/macros.rs` (~100 行，新建)
- `error/tests.rs` (~150 行)

---

#### Q-4: 标准化日志 (1 人日)

**目标文件**: `cis-core/src/logging/mod.rs`

**任务**:
- [ ] 定义结构化日志宏
  - [ ] `log_event!` 宏
  - [ ] `log_perf!` 宏
  - [ ] `log_error!` 宏
- [ ] 集成 `tracing` 库
- [ ] 编写使用示例

**验收标准**:
- 所有日志包含时间戳
- 支持结构化查询
- 性能日志自动记录耗时

**依赖**: 无

**交付物**:
- `logging/mod.rs` (~150 行，新建)
- `logging/macros.rs` (~100 行)
- `CLAUDE.md` 更新日志指南

---

#### Q-5: CLI 引导文档优化 (2 人日)

**目标文件**: `CLAUDE.md`, `docs/CLI_GUIDE.md`

**任务**:
- [x] 创建优化版 CLI 指南 (已完成)
- [ ] 更新主 `CLAUDE.md`
  - [ ] 强调 Server API 优先
  - [ ] 添加效率优化技巧
  - [ ] 更新所有示例代码
- [ ] 创建 CLI 开发者指南
  - [ ] Handler 模板
  - [ ] 常见错误模式
  - [ ] 最佳实践

**验收标准**:
- 文档覆盖所有核心命令
- 示例代码可直接运行
- 强调 Server API 架构

**依赖**: Q-3 (统一错误)

**交付物**:
- `CLAUDE.md` (更新)
- `docs/CLI_GUIDE_OPTIMIZED.md` (已完成)
- `docs/CLI_DEVELOPER_GUIDE.md` (新建)

---

### 阶段 1 总计

| 指标 | 目标值 |
|------|--------|
| 工作量 | 8 人日 |
| 新增代码 | ~2,500 行 |
| 新增测试 | ~1,000 行 |
| 文档更新 | 3 个文件 |

---

## 阶段 2: 核心拆分 (Week 3-5)

### 目标

拆分最关键的大型模块，解决架构瓶颈。

### 负责团队

- **Team Q**: scheduler 拆分 (3-5 人)
- **Team R**: config 拆分 (2-3 人)
- **Team S**: p2p 拆分 (2-3 人)

**并发执行**: 3 周内完成

---

### Team Q: scheduler 拆分 (10-15 人日)

#### Q-6: 设计 scheduler 拆分方案 (1 人日)

**任务**:
- [ ] 审阅现有 `scheduler/mod.rs` (3,439 行)
- [ ] 设计目标结构
  - [ ] `core/` - DAG 核心 (~300 行)
  - [ ] `execution/` - 执行器 (~400 行)
  - [ ] `events/` - 事件系统 (~300 行)
  - [ ] `persistence/` - 持久化 (~250 行)
  - [ ] `notification/` - 通知 (~250 行)
- [ ] 定义模块间接口
- [ ] 编写迁移计划

**验收标准**:
- 每个新模块 <500 行
- 职责清晰，无重叠
- 接口定义完整

**依赖**: Q-1 (事件总线)

**交付物**:
- `SCHEDULER_REFACTORING_DESIGN.md` (~400 行)

---

#### Q-7: 实现 scheduler/core (2 人日)

**目标文件**:
- `scheduler/core/mod.rs`
- `scheduler/core/dag.rs`
- `scheduler/core/validator.rs`
- `scheduler/core/topo_sort.rs`

**任务**:
- [ ] 提取 DAG 定义
  - [ ] `TaskDag` 结构
  - [ ] `UnifiedDag` 结构
  - [ ] `Task` trait
- [ ] 提取验证逻辑
  - [ ] 循环检测
  - [ ] 唯一性检查
  - [ ] 依赖存在性检查
- [ ] 提取拓扑排序
  - [ ] Kahn 算法实现
  - [ ] 并行调度优化
- [ ] 编写单元测试

**验收标准**:
- 核心模块 <500 行
- 测试覆盖率 > 85%
- 性能无回退

**依赖**: Q-6 (设计)

**交付物**:
- `scheduler/core/` (~400 行代码 + ~300 行测试)

---

#### Q-8: 实现 scheduler/execution (3 人日)

**目标文件**:
- `scheduler/execution/mod.rs`
- `scheduler/execution/executor.rs`
- `scheduler/execution/local.rs`
- `scheduler/execution/multi_agent.rs`
- `scheduler/execution/skill.rs`

**任务**:
- [ ] 定义 `Executor` trait
- [ ] 提取 `LocalExecutor` 逻辑 (~400 行)
- [ ] 提取 `MultiAgentExecutor` 逻辑 (~1088 → ~600 行)
- [ ] 提取 `SkillExecutor` 逻辑 (~724 → ~500 行)
- [ ] 统一错误处理
- [ ] 编写单元测试

**验收标准**:
- 每个执行器 <600 行
- 测试覆盖率 > 80%
- 支持并发执行

**依赖**: Q-7 (core), Q-1 (事件总线)

**交付物**:
- `scheduler/execution/` (~1500 行代码 + ~800 行测试)

---

#### Q-9: 实现 scheduler/events (2 人日)

**目标文件**:
- `scheduler/events/mod.rs`
- `scheduler/events/bus.rs`
- `scheduler/events/dispatcher.rs`
- `scheduler/events/handlers.rs`

**任务**:
- [ ] 集成通用事件总线
- [ ] 定义调度器专用事件
  - [ ] `TaskStartedEvent`
  - [ ] `TaskCompletedEvent`
  - [ ] `TaskFailedEvent`
  - [ ] `DagCompletedEvent`
- [ ] 实现事件分发器
- [ ] 迁移现有事件逻辑
- [ ] 编写单元测试

**验收标准**:
- 事件模块 <400 行
- 与通用事件总线兼容
- 测试覆盖率 > 85%

**依赖**: Q-1 (通用事件总线), Q-7 (core)

**交付物**:
- `scheduler/events/` (~400 行代码 + ~300 行测试)

---

#### Q-10: 实现 scheduler/persistence (2 人日)

**目标文件**:
- `scheduler/persistence/mod.rs`
- `scheduler/persistence/store.rs`
- `scheduler/persistence/recovery.rs`

**任务**:
- [ ] 提取持久化逻辑
  - [ ] DAG 状态存储
  - [ ] 执行历史记录
- [ ] 实现状态恢复
  - [ ] 从持久化加载
  - [ ] 崩溃恢复
- [ ] 定义持久化接口（支持 SQLite/文件）
- [ ] 编写单元测试

**验收标准**:
- 持久化模块 <300 行
- 支持多种存储后端
- 测试覆盖率 > 80%

**依赖**: Q-7 (core)

**交付物**:
- `scheduler/persistence/` (~300 行代码 + ~200 行测试)

---

#### Q-11: 实现 scheduler/notification (2 人日)

**目标文件**:
- `scheduler/notification/mod.rs`
- `scheduler/notification/notifier.rs`
- `scheduler/notification/channels.rs`

**任务**:
- [ ] 提取通知逻辑
  - [ ] 任务完成通知
  - [ ] DAG 完成通知
  - [ ] 错误通知
- [ ] 定义通知通道
  - [ ] CLI 通道
  - [ ] GUI 通道
  - [ ] Webhook 通道
- [ ] 集成事件系统
- [ ] 编写单元测试

**验收标准**:
- 通知模块 <300 行
- 支持 3+ 通道
- 测试覆盖率 > 80%

**依赖**: Q-9 (events)

**交付物**:
- `scheduler/notification/` (~300 行代码 + ~200 行测试)

---

#### Q-12: scheduler 集成和测试 (3 人日)

**任务**:
- [ ] 更新 `scheduler/mod.rs` 导出
- [ ] 迁移所有现有调用
- [ ] 编写集成测试
- [ ] 性能基准测试
- [ ] 更新文档

**验收标准**:
- 所有现有功能正常工作
- 性能无回退
- 集成测试覆盖率 > 75%

**依赖**: Q-7 到 Q-11 (所有子模块)

**交付物**:
- `scheduler/mod.rs` (精简到 ~150 行)
- `scheduler/integration_tests.rs` (~500 行)
- 性能基准报告

---

### Team R: config 拆分 (3-5 人日)

#### R-1: 拆分 config/loader (2 人日)

**目标文件**:
- `config/loader/mod.rs`
- `config/loader/file.rs`
- `config/loader/parser.rs`
- `config/loader/validator.rs`
- `config/loader/defaults.rs`

**任务**:
- [ ] 提取文件加载逻辑
- [ ] 提取解析器 (TOML/YAML)
- [ ] 提取验证逻辑
- [ ] 提取默认值设置
- [ ] 编写单元测试

**验收标准**:
- loader 模块 <500 行
- 每个子文件 <150 行
- 测试覆盖率 > 85%

**依赖**: Q-3 (统一错误), Q-4 (日志)

**交付物**:
- `config/loader/` (~500 行代码 + ~300 行测试)

---

#### R-2: 拆分 config 子配置文件 (2 人日)

**任务**:
- [ ] 拆分 `config/p2p.rs` (916 → 4× ~200 行)
  - [ ] `p2p/discovery.rs`
  - [ ] `p2p/dht.rs`
  - [ ] `p2p/transport.rs`
- [ ] 拆分 `config/security.rs` (648 → 3× ~200 行)
  - [ ] `security/encryption.rs`
  - [ ] `security/keys.rs`
  - [ ] `security/acl.rs`
- [ ] 拆分 `config/wasm.rs` (636 → 3× ~200 行)
  - [ ] `wasm/sandbox.rs`
  - [ ] `wasm/limits.rs`
  - [ ] `wasm/permissions.rs`
- [ ] 编写单元测试

**验收标准**:
- 每个子文件 <250 行
- 职责清晰
- 测试覆盖率 > 80%

**依赖**: R-1 (loader)

**交付物**:
- `config/p2p/` (~800 行代码 + ~400 行测试)
- `config/security/` (~600 行代码 + ~300 行测试)
- `config/wasm/` (~600 行代码 + ~300 行测试)

---

#### R-3: config 集成和测试 (1 人日)

**任务**:
- [ ] 更新 `config/mod.rs` 导出
- [ ] 迁移所有现有调用
- [ ] 编写集成测试
- [ ] 更新文档

**验收标准**:
- 所有现有功能正常
- 配置加载时间无增加
- 集成测试覆盖率 > 75%

**依赖**: R-1, R-2

**交付物**:
- `config/mod.rs` (精简)
- `config/integration_tests.rs` (~300 行)
- 配置加载文档

---

### Team S: p2p 拆分 (5-7 人日)

#### S-1: 拆分 p2p/transport_secure (2 人日)

**任务**:
- [ ] 提取加密原语 → `transport/crypto.rs`
- [ ] 提取握手协议 → `transport/handshake.rs`
- [ ] 精简安全传输 → `transport/secure.rs` (~500 行)
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <500 行
- 测试覆盖率 > 80%

**依赖**: Q-3 (统一错误)

**交付物**:
- `p2p/transport/` (~1000 行代码 + ~500 行测试)

---

#### S-2: 拆分 p2p/nat (2 人日)

**任务**:
- [ ] 提取 STUN 协议 → `nat/stun.rs`
- [ ] 提取 UPnP 协议 → `nat/upnp.rs`
- [ ] 提取 TURN 协议 → `nat/turn.rs`
- [ ] 实现检测器 → `nat/detector.rs`
- [ ] 编写单元测试

**验收标准**:
- 每个协议文件 <250 行
- 测试覆盖率 > 80%

**依赖**: Q-3 (统一错误)

**交付物**:
- `p2p/nat/` (~600 行代码 + ~400 行测试)

---

#### S-3: 拆分 p2p/network (2 人日)

**任务**:
- [ ] 提取消息处理 → `network/messaging.rs`
- [ ] 提取事件处理 → `network/events.rs`
- [ ] 精简网络核心 → `network/core.rs` (~400 行)
- [ ] 与 connection_manager 整合
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <400 行
- 测试覆盖率 > 75%

**依赖**: Q-1 (事件总线), Q-3 (统一错误)

**交付物**:
- `p2p/network/` (~800 行代码 + ~400 行测试)

---

#### S-4: p2p 集成和测试 (1 人日)

**任务**:
- [ ] 更新 `p2p/mod.rs` 导出
- [ ] 迁移所有现有调用
- [ ] 编写集成测试
- [ ] 性能测试

**验收标准**:
- 所有现有功能正常
- P2P 性能无回退
- 集成测试覆盖率 > 70%

**依赖**: S-1, S-2, S-3

**交付物**:
- `p2p/mod.rs` (精简)
- `p2p/integration_tests.rs` (~400 行)
- P2P 性能报告

---

### 阶段 2 总计

| 指标 | 目标值 |
|------|--------|
| 总工作量 | 18-27 人日 |
| 新增/修改代码 | ~5,000 行 |
| 新增/修改测试 | ~3,500 行 |
| 执行周期 | 3 周 |

---

## 阶段 3: 次要拆分 (Week 6-7)

### 负责团队

- **Team T**: skill 拆分 (2-3 人)
- **Team U**: agent/其他模块拆分 (2-3 人)

**并发执行**: 2 周内完成

---

### Team T: skill 拆分 (4-6 人日)

#### T-1: 拆分 skill/chain (2 人日)

**任务**:
- [ ] 提取执行器核心 → `chain/executor.rs`
- [ ] 提取依赖解析 → `chain/resolver.rs`
- [ ] 提取执行上下文 → `chain/context.rs`
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <400 行
- 测试覆盖率 > 80%

**依赖**: Q-1 (事件总线)

**交付物**:
- `skill/chain/` (~800 行代码 + ~400 行测试)

---

#### T-2: 拆分 skill/router (2 人日)

**任务**:
- [ ] 提取路由核心 → `router/core.rs`
- [ ] 提取模式匹配 → `router/matcher.rs`
- [ ] 提取路由注册 → `router/registry.rs`
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <400 行
- 测试覆盖率 > 80%

**依赖**: Q-1 (事件总线)

**交付物**:
- `skill/router/` (~800 行代码 + ~400 行测试)

---

#### T-3: 拆分 skill/manager (2 人日)

**任务**:
- [ ] 提取管理器核心 → `manager/core.rs`
- [ ] 提取 Skill 加载 → `manager/loader.rs`
- [ ] 提取 Skill 卸载 → `manager/unloader.rs`
- [ ] 提取权限验证 → `manager/validator.rs`
- [ ] 与 permission_checker 整合
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <300 行
- 测试覆盖率 > 80%

**依赖**: Q-3 (统一错误), R-1 (config)

**交付物**:
- `skill/manager/` (~800 行代码 + ~400 行测试)

---

#### T-4: skill 集成和测试 (1 人日)

**任务**:
- [ ] 更新 `skill/mod.rs` 导出
- [ ] 迁移所有现有调用
- [ ] 编写集成测试
- [ ] 更新文档

**验收标准**:
- 所有现有功能正常
- Skill 加载性能无回退
- 集成测试覆盖率 > 75%

**依赖**: T-1, T-2, T-3

**交付物**:
- `skill/mod.rs` (精简)
- `skill/integration_tests.rs` (~300 行)
- Skill 管理文档

---

### Team U: agent/其他模块拆分 (3-4 人日)

#### U-1: 拆分 agent/guard (2 人日)

**任务**:
- [ ] 提取 RAII 守卫 → `guard/raii.rs`
- [ ] 提取清理逻辑 → `guard/cleanup.rs`
- [ ] 提取资源跟踪 → `guard/tracker.rs`
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <250 行
- 测试覆盖率 > 85%

**依赖**: Q-3 (统一错误)

**交付物**:
- `agent/guard/` (~500 行代码 + ~300 行测试)

---

#### U-2: 拆分其他大模块 (2 人日)

**任务**:
- [ ] 拆分 `agent/leak_detector.rs` (535 → ~400 行)
- [ ] 拆分 `agent/config.rs` (491 → ~400 行)
- [ ] 拆分 `p2p/sync.rs` (638 → ~500 行)
- [ ] 拆分 `p2p/dht.rs` (921 → ~700 行，或标记废弃)
- [ ] 编写单元测试

**验收标准**:
- 每个模块 <500 行
- 测试覆盖率 > 75%

**依赖**: Q-1 (事件总线), Q-3 (统一错误)

**交付物**:
- 多个精简模块 (~2000 行代码 + ~1000 行测试)

---

#### U-3: agent 集成和测试 (1 人日)

**任务**:
- [ ] 更新 `agent/mod.rs` 导出
- [ ] 迁移所有现有调用
- [ ] 编写集成测试
- [ ] 更新文档

**验收标准**:
- 所有现有功能正常
- Agent 性能无回退
- 集成测试覆盖率 > 75%

**依赖**: U-1, U-2

**交付物**:
- `agent/mod.rs` (精简)
- `agent/integration_tests.rs` (~300 行)
- Agent 管理文档

---

### 阶段 3 总计

| 指标 | 目标值 |
|------|--------|
| 总工作量 | 7-10 人日 |
| 新增/修改代码 | ~3,600 行 |
| 新增/修改测试 | ~2,000 行 |
| 执行周期 | 2 周 |

---

## 阶段 4: 验收和优化 (Week 8)

### 目标

全面测试、性能优化、文档更新。

### 负责团队: 全员 + QA + 性能团队 + 技术写作

**预计工作量**: 12-16 人日

---

### 验收-1: 单元测试迁移 (5-8 人日)

**任务**:
- [ ] 审查所有新模块测试覆盖率
  - [ ] 目标 >85%
  - [ ] 使用 `cargo-tarpaulin` 测量
- [ ] 补充缺失测试
  - [ ] 边界情况测试
  - [ ] 错误路径测试
  - [ ] 并发测试
- [ ] 建立测试覆盖率 CI 门禁
  - [ ] PR 必须通过覆盖率检查
  - [ ] 总覆盖率报告

**验收标准**:
- 整体覆盖率 >85%
- 所有核心模块 >90%
- CI 门禁生效

**依赖**: 所有前面任务

**交付物**:
- ~300 个测试文件
- CI 配置更新
- 覆盖率徽章

---

### 验收-2: 集成测试更新 (3-5 人日)

**任务**:
- [ ] 编写端到端集成测试
  - [ ] scheduler 执行完整 DAG
  - [ ] p2p 节点发现和通信
  - [ ] config 加载和验证
  - [ ] skill 加载和执行
- [ ] 性能压力测试
  - [ ] 1000+ 并发请求
  - [ ] 长时间运行稳定性
- [ ] 建立集成测试套件

**验收标准**:
- >20 个集成测试场景
- 所有核心路径覆盖
- 压力测试通过

**依赖**: 验收-1 (单元测试)

**交付物**:
- `tests/integration/` (~1000 行)
- 性能测试报告
- CI 集成测试配置

---

### 验收-3: 性能基准测试 (2-3 人日)

**任务**:
- [ ] 建立性能基准
  - [ ] 编译时间基准
  - [ ] 运行时性能基准
  - [ ] 内存占用基准
- [ ] 对比拆分前后性能
  - [ ] 使用 `cargo flamegraph`
  - [ ] 使用 `heaptrack`
  - [ ] 使用 `hyperfine`
- [ ] 性能回归检测
  - [ ] 设定性能阈值
  - [ ] CI 自动检测

**验收标准**:
- 编译时间 <60s (增量)
- 运行时性能无回退
- 内存占用 <200MB

**依赖**: 验收-2 (集成测试)

**交付物**:
- 性能基准报告 (~500 行)
- CI 性能检测配置
- 优化建议文档

---

### 验收-4: 文档更新 (2-3 人日)

**任务**:
- [ ] 更新所有模块文档
  - [ ] API 文档
  - [ ] 架构文档
  - [ ] 迁移指南
- [ ] 更新 `CLAUDE.md`
  - [ ] Server API 架构
  - [ ] CLI 使用指南
  - [ ] 最佳实践
- [ ] 编写示例代码
  - [ ] 完整 workflow 示例
  - [ ] 常见问题解答

**验收标准**:
- 所有公开 API 有文档
- 示例代码可直接运行
- 文档覆盖率 >90%

**依赖**: 所有前面任务

**交付物**:
- ~20 个文档文件
- 10+ 个代码示例
- `README.md` 更新

---

### 阶段 4 总计

| 指标 | 目标值 |
|------|--------|
| 总工作量 | 12-16 人日 |
| 测试文件 | ~50 个 |
| 文档更新 | ~20 个 |
| 执行周期 | 1 周 |

---

## 总体执行计划

### 时间表

```
Week 1-2  │ Team Q (基础设施)          │ 8 人日
           │ - 事件总线
           │ - 服务容器
           │ - 统一错误
           │ - 日志标准化
           │ - CLI 文档
           ├───────────────────────────────────────────────
Week 3-5  │ Team Q (scheduler)   │ 10-15 人日
           │ Team R (config)       │ 3-5 人日
           │ Team S (p2p)         │ 5-7 人日
           ├───────────────────────────────────────────────
Week 6-7  │ Team T (skill)        │ 4-6 人日
           │ Team U (agent/其他)    │ 3-4 人日
           ├───────────────────────────────────────────────
Week 8    │ 全员 (验收优化)       │ 12-16 人日
           │ - 单元测试
           │ - 集成测试
           │ - 性能基准
           │ - 文档更新
           └───────────────────────────────────────────────
总计: 8 周, 45-56 人日
```

### 依赖关系

```
阶段 1 (基础设施)
├─ Q-1: 事件总线
├─ Q-2: 服务容器 (可选依赖 Q-1)
├─ Q-3: 统一错误
├─ Q-4: 日志标准化
└─ Q-5: CLI 文档 (依赖 Q-3)

阶段 2 (核心拆分)
Team Q (scheduler)
├─ Q-6: 设计 (依赖 Q-1)
├─ Q-7: core (依赖 Q-6)
├─ Q-8: execution (依赖 Q-7, Q-1)
├─ Q-9: events (依赖 Q-1, Q-7)
├─ Q-10: persistence (依赖 Q-7)
├─ Q-11: notification (依赖 Q-9)
└─ Q-12: 集成 (依赖 Q-7 到 Q-11)

Team R (config)
├─ R-1: loader (依赖 Q-3, Q-4)
├─ R-2: 子配置 (依赖 R-1)
└─ R-3: 集成 (依赖 R-1, R-2)

Team S (p2p)
├─ S-1: transport (依赖 Q-3)
├─ S-2: nat (依赖 Q-3)
├─ S-3: network (依赖 Q-1, Q-3)
└─ S-4: 集成 (依赖 S-1, S-2, S-3)

阶段 3 (次要拆分)
Team T (skill)
├─ T-1: chain (依赖 Q-1)
├─ T-2: router (依赖 Q-1)
├─ T-3: manager (依赖 Q-3, R-1)
└─ T-4: 集成 (依赖 T-1, T-2, T-3)

Team U (agent/其他)
├─ U-1: guard (依赖 Q-3)
├─ U-2: 其他 (依赖 Q-1, Q-3)
└─ U-3: 集成 (依赖 U-1, U-2)

阶段 4 (验收优化)
├─ 验收-1: 单元测试 (依赖所有前面任务)
├─ 验收-2: 集成测试 (依赖 验收-1)
├─ 验收-3: 性能基准 (依赖 验收-2)
└─ 验收-4: 文档更新 (依赖所有前面任务)
```

### 风险管理

| 风险 | 概率 | 影响 | 缓解措施 | 负责人 |
|------|------|------|----------|--------|
| 拆分后性能下降 | 🟡 中 | 🟠 中 | 性能基准对比 | 性能团队 |
| 循环依赖 | 🟡 中 | 🟠 中 | 依赖图分析工具 | 架构师 |
| 测试不足 | 🟢 低 | 🔴 高 | 80% 覆盖率门禁 | QA |
| CI 瓶颈 | 🟡 中 | 🟡 中 | 优化测试配置 | DevOps |
| 文档滞后 | 🟡 中 | 🟡 中 | 并行编写文档 | 技术写作 |
| 团队适应困难 | 🟢 低 | 🟡 中 | 培训 + 代码示例 | 技术主管 |

### 成功指标

| 指标 | 当前 | 目标 | 测量方式 | 状态 |
|------|------|------|----------|------|
| 平均模块行数 | ~800 | <500 | `tokei` | ⏳ |
| 最大模块行数 | 3,439 | <1000 | `tokei` | ⏳ |
| 代码重复率 | ~15% | <5% | `cargo-detect-dupes` | ⏳ |
| 测试覆盖率 | ~65% | >85% | `tarpaulin` | ⏳ |
| 增量编译时间 | ~120s | <60s | `cargo build --timings` | ⏳ |
| 完整编译时间 | ~480s | <300s | `hyperfine` | ⏳ |

---

## 下一步行动

### 立即执行（Week 1）

1. ✅ **已完成任务**
   - [x] 分析巨型模块 (17 个文件 >600 行)
   - [x] 创建代码复用结构设计文档
   - [x] 优化 CLI 引导文档
   - [x] 创建执行计划

2. **本周启动** (准备启动 Team Q)
   - [ ] 实现 Q-1: 事件总线 (2 人日)
   - [ ] 实现 Q-2: 服务容器 (2 人日)
   - [ ] 实现 Q-3: 统一错误 (1 人日)
   - [ ] 实现 Q-4: 日志标准化 (1 人日)
   - [ ] 实现 Q-5: CLI 文档优化 (2 人日)

### 下周准备

1. **Team Q 继续执行** (scheduler 拆分)
   - [ ] Q-6: 设计 scheduler 拆分方案
   - [ ] Q-7: 实现 scheduler/core
   - [ ] Q-8: 实现 scheduler/execution

2. **并行启动 Team R** (config 拆分)
   - [ ] R-1: 拆分 config/loader

3. **并行启动 Team S** (p2p 拆分)
   - [ ] S-1: 拆分 p2p/transport_secure

---

## 附录

### A. 工具清单

**代码分析**:
- `tokei` - 代码行数统计
- `cargo-geiger` - 圈复杂度分析
- `cargo-detect-dupes` - 代码重复检测
- `cargo-depends` - 依赖图分析

**测试**:
- `cargo-tarpaulin` - 测试覆盖率
- `cargo-nextest` - 测试运行器
- `quickcheck` - 属性测试

**性能**:
- `cargo flamegraph` - 性能分析
- `heaptrack` - 内存跟踪
- `hyperfine` - 基准测试
- `cargo-criterion` - 微基准测试

**CI/CD**:
- GitHub Actions 配置
- 覆盖率门禁
- 性能回归检测

### B. 团队配置建议

**Team Q (基础设施 + scheduler)**
- 3-5 人
- 技能: Rust 异步编程、架构设计、测试
- 工作量: 18-23 人日

**Team R (config)**
- 2-3 人
- 技能: 配置管理、序列化、验证
- 工作量: 3-5 人日

**Team S (p2p)**
- 2-3 人
- 技能: 网络编程、P2P 协议、NAT 穿透
- 工作量: 5-7 人日

**Team T (skill)**
- 2-3 人
- 技能: Skill 管理、路由、依赖解析
- 工作量: 4-6 人日

**Team U (agent/其他)**
- 2-3 人
- 技能: Agent 管理、资源管理、并发
- 工作量: 3-4 人日

### C. 沟通机制

**每日站会** (可选，15 分钟)
- 进度同步
- 阻塞问题讨论
- 风险识别

**周报** (必需，30 分钟)
- 任务完成情况
- 质量指标
- 下周计划

**PR 审查流程**
1. 作者提交 PR
2. 自动检查通过（测试、覆盖率）
3. 至少 1 人审阅
4. 审阅通过后合并
5. 不及时响应则升级

---

**文档版本**: 1.0
**计划完成日期**: 2026-02-12
**制定者**: CIS Architecture Team
**审核状态**: 待审核
**预计开始**: 2026-02-13
**预计完成**: 2026-04-10
