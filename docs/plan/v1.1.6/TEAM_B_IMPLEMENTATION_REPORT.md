# Team B å®æ–½æŠ¥å‘Š - v1.1.6 å®‰å…¨æ”¹è¿›

> **å›¢é˜Ÿ**: Team B
> **ä»»åŠ¡**: P0-2 åŠ å¯†å¯†é’¥æ”¹è¿› + P0-3 ACL æ—¶é—´æˆ³éªŒè¯
> **å®Œæˆæ—¥æœŸ**: 2026-02-12
> **çŠ¶æ€**: âœ… å®Œæˆ

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šæ€»ç»“äº† Team B åœ¨ CIS v1.1.6 å¼€å‘å‘¨æœŸä¸­å®Œæˆçš„å®‰å…¨æ”¹è¿›ä»»åŠ¡ã€‚æˆ‘ä»¬æˆåŠŸå®æ–½äº† P0-2 å’Œ P0-3 ä¸¤ä¸ªä¸»è¦ä»»åŠ¡åŒ…ï¼Œä¿®å¤äº†å…³é”®çš„åŠ å¯†å®‰å…¨é—®é¢˜å’Œ ACL éªŒè¯æ¼æ´ã€‚

---

## P0-2: åŠ å¯†å¯†é’¥æ”¹è¿›

### èƒŒæ™¯

æ ¹æ®ä»£ç å®¡é˜…æŠ¥å‘Š (`docs/user/code-review-data-layer.md`)ï¼ŒåŸæœ‰çš„åŠ å¯†å®ç°ä½¿ç”¨å›ºå®šç›å€¼ `"cis-memory-encryption"` è¿›è¡Œå¯†é’¥æ´¾ç”Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚

### å®æ–½å†…å®¹

#### P0-2.1: å¯†é’¥å­˜å‚¨æ ¼å¼è®¾è®¡ âœ…

**æ–‡ä»¶**: `cis-core/src/memory/crypto/key_format_v2.md`

è®¾è®¡äº†æ–°çš„ v2 å¯†é’¥å­˜å‚¨æ ¼å¼ï¼ŒåŒ…å«ï¼š

- **Magic å­—èŠ‚**: `0x43495332` ("CIS2") ç”¨äºæ ¼å¼è¯†åˆ«
- **ç‰ˆæœ¬æ ‡è¯†**: æ ¼å¼ç‰ˆæœ¬å·
- **å”¯ä¸€ç›å€¼**: æ¯ä¸ªå¯†é’¥ä½¿ç”¨ 32 å­—èŠ‚éšæœºç›å€¼
- **æ´¾ç”Ÿå¯†é’¥**: ä½¿ç”¨ Argon2id æ´¾ç”Ÿçš„ 32 å­—èŠ‚å¯†é’¥
- **HMAC å®Œæ•´æ€§**: ä½¿ç”¨ HMAC-SHA256 ä¿æŠ¤å¯†é’¥å­˜å‚¨

**å­˜å‚¨æ ¼å¼** (JSON):
```json
{
  "format": "cis-key-v2",
  "version": 2,
  "created_at": "2026-02-12T10:30:00Z",
  "algorithm": "argon2id",
  "algorithm_params": {
    "iterations": 4096,
    "parallelism": 3,
    "memory": 65536,
    "output_length": 32
  },
  "encoding": "base64",
  "data": "<base64-encoded binary>"
}
```

#### P0-2.2: Argon2id å¯†é’¥æ´¾ç”Ÿå®ç° âœ…

**æ–‡ä»¶**: `cis-core/src/memory/encryption_v2.rs`

å®ç°äº†å®Œæ•´çš„ v2 åŠ å¯†ç³»ç»Ÿï¼š

**æ ¸å¿ƒç‰¹æ€§**:
1. **Argon2id æ´¾ç”Ÿ**:
   - æ—¶é—´æˆæœ¬: 4096 æ¬¡è¿­ä»£
   - å¹¶è¡Œåº¦: 3 ä¸ªé€šé“
   - å†…å­˜æˆæœ¬: 64 MB
   - è¾“å‡ºé•¿åº¦: 32 å­—èŠ‚

2. **å”¯ä¸€ç›å€¼**:
   ```rust
   let mut rng = rand::thread_rng();
   let mut salt = [0u8; 32];
   rng.fill_bytes(&mut salt);
   ```

3. **HMAC ä¿æŠ¤**:
   - ä½¿ç”¨ä¸»å¯†é’¥æ´¾ç”Ÿ HMAC å¯†é’¥
   - å¯¹æ•´ä¸ªå¯†é’¥è®°å½•è®¡ç®— HMAC-SHA256
   - é˜²æ­¢å¯†é’¥æ–‡ä»¶ç¯¡æ”¹

4. **å¯†é’¥åŠ è½½/ä¿å­˜**:
   - æ”¯æŒåºåˆ—åŒ–å’Œååºåˆ—åŒ–
   - è‡ªåŠ¨è®¾ç½®æ–‡ä»¶æƒé™ (0o600)
   - å®Œæ•´æ€§éªŒè¯

**API è®¾è®¡**:
```rust
pub struct EncryptionKeyV2 {
    pub key: [u8; 32],
    pub salt: [u8; 32],
    pub created_at: DateTime<Utc>,
}

impl EncryptionKeyV2 {
    pub fn from_node_key_v2(node_key: &[u8], unique_id: &[u8]) -> Result<Self>;
    pub fn load(path: impl AsRef<Path>) -> Result<Self>;
    pub fn save(&self, path: impl AsRef<Path>) -> Result<()>;
}

pub struct MemoryEncryptionV2 {
    // Clone å‹å¥½ - åªå­˜å‚¨å¯†é’¥
    key: [u8; 32],
}

impl MemoryEncryptionV2 {
    pub fn from_key(key: &EncryptionKeyV2) -> Self;
    pub fn from_node_key(node_key: &[u8], unique_id: &[u8]) -> Result<Self>;
    pub fn encrypt(&self, plaintext: &[u8]) -> Result<Vec<u8>>;
    pub fn decrypt(&self, ciphertext: &[u8]) -> Result<Vec<u8>>;
    pub fn re_encrypt(&self, old: &[u8], new: &Self) -> Result<Vec<u8>>;
    pub fn migrate_from_v1(&self, old: &[u8], old_v1: &MemoryEncryption) -> Result<Vec<u8>>;
}
```

**æµ‹è¯•è¦†ç›–** (12 ä¸ªæµ‹è¯•):
- âœ… v2 å¯†é’¥ç”Ÿæˆå’Œç›å€¼å”¯ä¸€æ€§
- âœ… åŠ å¯†/è§£å¯†å¾€è¿”
- âœ… å¯†é’¥ä¿å­˜å’ŒåŠ è½½
- âœ… HMAC éªŒè¯ï¼ˆåŒ…æ‹¬ç¯¡æ”¹æ£€æµ‹ï¼‰
- âœ… é”™è¯¯å¯†é’¥è§£å¯†å¤±è´¥
- âœ… æ¯æ¬¡åŠ å¯†äº§ç”Ÿä¸åŒå¯†æ–‡ï¼ˆéšæœº nonceï¼‰
- âœ… è®¤è¯æ ‡ç­¾æ£€æµ‹ç¯¡æ”¹
- âœ… å¯†é’¥è½®æ¢ï¼ˆre_encryptï¼‰
- âœ… ä» v1 è¿ç§»
- âœ… Argon2id å‚æ•°éªŒè¯
- âœ… å¯†é’¥å”¯ä¸€æ€§ï¼ˆä¸åŒèŠ‚ç‚¹ï¼‰
- âœ… å‘åå…¼å®¹æ€§æ£€æµ‹

#### P0-2.3: æ•°æ®è¿ç§»è„šæœ¬ âœ…

**æ–‡ä»¶**: `tools/migrate_keys.rs`

å®ç°äº†å®Œæ•´çš„å¯†é’¥è¿ç§»å·¥å…·ï¼š

**åŠŸèƒ½**:
1. **å•å¯†é’¥è¿ç§»**:
   ```bash
   cargo run --bin migrate_keys -- migrate \
       --from ~/.cis/keys/v1/old.key \
       --to ~/.cis/keys/v2/new.key \
       --node-id "did:cis:node:abc123" \
       --node-key ~/.cis/node_key
   ```

2. **æ‰¹é‡è¿ç§»**:
   ```bash
   cargo run --bin migrate_keys -- batch \
       --from-dir ~/.cis/keys/v1/ \
       --to-dir ~/.cis/keys/v2/ \
       --backup ~/.cis/keys/backup/ \
       --node-key ~/.cis/node_key \
       --node-id-map map.json
   ```

3. **éªŒè¯å·¥å…·**:
   ```bash
   cargo run --bin migrate_keys -- verify \
       --key-path ~/.cis/keys/v2/new.key \
       --test-data ~/.cis/test_encrypted.dat
   ```

**ç‰¹æ€§**:
- è‡ªåŠ¨å¤‡ä»½åŸå¯†é’¥æ–‡ä»¶
- èŠ‚ç‚¹ ID æ˜ å°„æ”¯æŒï¼ˆä»æ–‡ä»¶åæˆ–æ˜ å°„æ–‡ä»¶æå–ï¼‰
- è¿ç§»ç»“æœéªŒè¯ï¼ˆæ¯”è¾ƒ v1 å’Œ v2 è§£å¯†ç»“æœï¼‰
- è¯¦ç»†çš„è¿›åº¦æŠ¥å‘Š

**æµ‹è¯•** (3 ä¸ªæµ‹è¯•):
- âœ… èŠ‚ç‚¹ ID æå–ï¼ˆæ–‡ä»¶åè§£æï¼‰
- âœ… èŠ‚ç‚¹ ID æ˜ å°„æ–‡ä»¶è¯»å–
- âœ… è¿ç§»é›†æˆæµ‹è¯•ï¼ˆv1 å¯†é’¥æ ¼å¼éªŒè¯ï¼‰

**ä¾èµ–**: æ·»åŠ äº† `clap` (CLI è§£æ) å’Œä¸´æ—¶æ–‡ä»¶æ”¯æŒ

#### P0-2.4: æ›´æ–°åŠ å¯†è°ƒç”¨ç‚¹ âœ…

**ä¿®æ”¹çš„æ–‡ä»¶**:
1. `cis-core/Cargo.toml`:
   - æ·»åŠ  `hmac = "0.12"`
   - æ·»åŠ  `base64 = "0.22"`

2. `cis-core/src/memory/mod.rs`:
   ```rust
   pub mod encryption;
   pub mod encryption_v2;
   pub mod crypto;

   pub use self::encryption::MemoryEncryption;
   pub use self::encryption_v2::{EncryptionKeyV2, MemoryEncryptionV2};
   ```

3. `cis-core/src/memory/ops/mod.rs`:
   - æ·»åŠ  `EncryptionWrapper` æšä¸¾ï¼ˆæ”¯æŒ v1 å’Œ v2ï¼‰
   - å®ç° `encrypt`, `decrypt`, `re_encrypt` æ–¹æ³•
   - å®ç° `Clone` trait

4. `cis-core/src/memory/service.rs`:
   - æ›´æ–°å¯¼å…¥ï¼ˆåŒ…å« `EncryptionWrapper`, `MemoryEncryptionV2`ï¼‰
   - æ·»åŠ  `with_encryption()` (v1) æ–¹æ³•
   - æ·»åŠ  `with_v2_encryption()` æ–¹æ³•

**å‘åå…¼å®¹**:
- ä¿æŒ v1 API å®Œå…¨å¯ç”¨
- æ–°çš„ v2 API æ˜¯å¯é€‰çš„
- å¹³æ»‘è¿ç§»è·¯å¾„

---

## P0-3: ACL æ—¶é—´æˆ³éªŒè¯

### èƒŒæ™¯

æ ¹æ®ä»£ç å®¡é˜…æŠ¥å‘Š (`docs/user/code-review-network-layer.md`)ï¼ŒACL æ£€æŸ¥ç¼ºå°‘æ—¶é—´æˆ³éªŒè¯ï¼Œå¯èƒ½å—åˆ°é‡æ”¾æ”»å‡»ã€‚

### å®æ–½å†…å®¹

#### P0-3.1: æ›´æ–° ACL æ¡ç›®ç»“æ„ âœ…

**åŸæœ‰ç»“æ„** (`cis-core/src/network/acl.rs`):
```rust
pub struct AclEntry {
    pub did: String,
    pub added_at: i64,
    pub added_by: String,
    pub reason: Option<String>,
    pub expires_at: Option<i64>,  // âœ… å·²å­˜åœ¨
}

pub fn is_expired(&self) -> bool {
    self.expires_at.map(|exp| now() > exp).unwrap_or(false)
}
```

**åˆ†æ**: åŸæœ‰ç»“æ„å·²ç»åŒ…å« `expires_at` å­—æ®µå’Œ `is_expired()` æ–¹æ³•ï¼Œä½†ç¼ºå°‘ï¼š
- æ—¶é—´æˆ³éªŒè¯é€»è¾‘
- é‡æ”¾æ”»å‡»é˜²æŠ¤
- æ—¶é’Ÿåå·®å¤„ç†

#### P0-3.2: å®ç°æ—¶é—´æˆ³éªŒè¯é€»è¾‘ âœ…

**æ–‡ä»¶**: `cis-core/src/network/acl/validation.rs`

å®ç°äº†å®Œæ•´çš„ ACL éªŒè¯å™¨ï¼š

**æ ¸å¿ƒåŠŸèƒ½**:
1. **æ—¶é—´æˆ³éªŒè¯**:
   ```rust
   pub fn validate_timestamp(&self, timestamp: SystemTime, expiry: Duration)
       -> Result<AclValidationResult>
   ```

   - æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨æœªæ¥ï¼ˆè¶…å‡ºå®¹å¿åº¦ï¼‰
   - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
   - æ£€æŸ¥ç»å¯¹è¿‡æœŸæ—¶é—´
   - æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦å¤ªæ—§ï¼ˆé‡æ”¾æ”»å‡»é˜²æŠ¤ï¼‰

2. **è¿‡æœŸæ£€æŸ¥**:
   ```rust
   pub fn is_expired(&self, timestamp: SystemTime, expiry: Duration) -> bool
   ```

3. **å‰©ä½™æ—¶é—´è®¡ç®—**:
   ```rust
   pub fn remaining_time(&self, timestamp: SystemTime, expiry: Duration)
       -> Option<Duration>
   ```

4. **æ—¶é—´æˆ³å¯æ¥å—æ€§æ£€æŸ¥**:
   ```rust
   pub fn is_acceptable_timestamp(&self, timestamp: SystemTime) -> bool
   ```

**éªŒè¯ç»“æœ**:
```rust
pub enum AclValidationResult {
    Valid,                           // âœ… æœ‰æ•ˆ
    InvalidTimestamp(String),           // âŒ æ—¶é—´æˆ³æ— æ•ˆ
    Expired(String),                   // âŒ å·²è¿‡æœŸ
    InvalidSignature(String),            // âŒ ç­¾åæ— æ•ˆ
}
```

**æ—¶é’Ÿå®¹å¿åº¦**: é»˜è®¤ 60 ç§’ï¼ˆå¯é…ç½®ï¼‰

**æµ‹è¯•è¦†ç›–** (10 ä¸ªæµ‹è¯•):
- âœ… æœ‰æ•ˆæ—¶é—´æˆ³éªŒè¯
- âœ… è¿‡æœŸæ—¶é—´æˆ³æ£€æµ‹
- âœ… `is_expired()` æ–¹æ³•
- âœ… å‰©ä½™æ—¶é—´è®¡ç®—
- âœ… æœªæ¥æ—¶é—´æˆ³å®¹å¿åº¦
- âœ… è¿‡å»æ—¶é—´æˆ³å®¹å¿åº¦
- âœ… ä¸å¯æ¥å—çš„æœªæ¥æ—¶é—´æˆ³
- âœ… ä¸å¯æ¥å—çš„è¿‡å»æ—¶é—´æˆ³
- âœ… å¯æ¥å—æ—¶é—´æˆ³
- âœ… æŒç»­æ—¶é—´æ ¼å¼åŒ–

#### P0-3.3: æ—¶é’Ÿåå·®å¤„ç† âœ…

**æ–‡ä»¶**: `cis-core/src/network/clock_tolerance.rs`

å®ç°äº†åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶é’Ÿåå·®ç®¡ç†ï¼š

**æ ¸å¿ƒåŠŸèƒ½**:
1. **ClockTolerance**:
   ```rust
   pub struct ClockTolerance {
       tolerance: Duration,
       max_observed_skew: Duration,
   }
   ```

   **æ–¹æ³•**:
   - `is_acceptable(timestamp, reference)`: æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨å®¹å¿åº¦å†…
   - `calculate_skew(timestamp1, timestamp2)`: è®¡ç®—æ—¶é’Ÿåå·®
   - `update_observed_skew(skew)`: æ›´æ–°è§‚å¯Ÿåˆ°çš„æœ€å¤§åå·®
   - `adjust_timestamp(timestamp, reference)`: è°ƒæ•´è¶…å‡ºå®¹å¿åº¦çš„æ—¶é—´æˆ³
   - `needs_adjustment(timestamp, reference)`: æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´
   - `is_within_range(timestamp, start, end)`: æ£€æŸ¥æ˜¯å¦åœ¨èŒƒå›´å†…ï¼ˆå«å®¹å¿åº¦ï¼‰

2. **TimeSyncTracker**:
   ```rust
   pub struct TimeSyncTracker {
       tolerance: Duration,
       observed_skews: Vec<Duration>,
   }
   ```

   **æ–¹æ³•**:
   - `record_skew(skew)`: è®°å½•è§‚å¯Ÿåˆ°çš„æ—¶é’Ÿåå·®ï¼ˆä¿ç•™æœ€è¿‘ 100 ä¸ªï¼‰
   - `sync_status()`: è¯„ä¼°åŒæ­¥çŠ¶æ€
   - `average_skew()`: è®¡ç®—å¹³å‡åå·®
   - `max_skew()`: è®¡ç®—æœ€å¤§åå·®
   - `reset()`: é‡ç½®è·Ÿè¸ªå™¨

**åŒæ­¥çŠ¶æ€**:
```rust
pub enum SyncStatus {
    Synchronized,       // æ—¶é’Ÿåå·®åœ¨å®¹å¿åº¦å†…
    NotSynchronized,   // æ—¶é’Ÿåå·®è¶…å‡ºå®¹å¿åº¦
    Unknown,           // æœªè§‚å¯Ÿåˆ°è¶³å¤Ÿçš„æ—¶é—´æˆ³
}
```

**æµ‹è¯•è¦†ç›–** (8 ä¸ªæµ‹è¯•):
- âœ… å®¹å¿åº¦å†…æ—¶é—´æˆ³å¯æ¥å—
- âœ… è¶…å‡ºå®¹å¿åº¦æ—¶é—´æˆ³ä¸å¯æ¥å—
- âœ… æ—¶é’Ÿåå·®è®¡ç®—
- âœ… æ—¶é—´æˆ³è°ƒæ•´
- âœ… èŒƒå›´æ£€æŸ¥
- âœ… æ—¶é—´åŒæ­¥è·Ÿè¸ª
- âœ… è§‚å¯Ÿåˆ°çš„åå·®æ›´æ–°
- âœ… éœ€è¦è°ƒæ•´æ£€æŸ¥

#### P0-3.4: æ›´æ–° ACL ç­¾åæµç¨‹ âœ…

**æ–‡ä»¶**: `cis-core/src/network/acl/signing.rs`

å®ç°äº†åŒ…å«æ—¶é—´æˆ³çš„ ACL ç­¾åç³»ç»Ÿï¼š

**æ ¸å¿ƒç»„ä»¶**:
1. **AclSigner**:
   ```rust
   pub struct AclSigner {
       signing_key: ed25519_dalek::SigningKey,
   }
   ```

   **æ–¹æ³•**:
   - `from_bytes(key_bytes)`: ä»å­—èŠ‚åˆ›å»º
   - `from_hex(hex_str)`: ä» hex å­—ç¬¦ä¸²åˆ›å»º
   - `sign_entry(entry)`: ç­¾å ACL æ¡ç›®ï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
   - `sign_acl(acl)`: ç­¾åæ•´ä¸ª ACL é…ç½®
   - `public_key_base64()`: è·å– Base64 ç¼–ç çš„å…¬é’¥
   - `public_key_bytes()`: è·å–å…¬é’¥å­—èŠ‚

2. **AclVerifier**:
   ```rust
   pub struct AclVerifier {
       verifying_key: ed25519_dalek::VerifyingKey,
   }
   ```

   **æ–¹æ³•**:
   - `from_bytes(key_bytes)`: ä»å­—èŠ‚åˆ›å»º
   - `from_hex(hex_str)`: ä» hex å­—ç¬¦ä¸²åˆ›å»º
   - `from_signer(signer)`: ä»ç­¾åå™¨æå–éªŒè¯å™¨
   - `verify_entry(entry, signature)`: éªŒè¯ ACL æ¡ç›®ç­¾å
   - `verify_acl(acl, signature)`: éªŒè¯ ACL é…ç½®ç­¾å

**ç­¾åæ•°æ®ç»“æ„**:
```rust
struct AclEntrySignData<'a> {
    did: &'a str,
    added_at: i64,           // âœ… åŒ…å«æ—¶é—´æˆ³
    added_by: &'a str,
    reason: Option<&'a String>,
    expires_at: Option<i64>,  // âœ… åŒ…å«è¿‡æœŸæ—¶é—´
}
```

**ACL è´Ÿè½½**:
```rust
struct AclPayload {
    local_did: String,
    mode: NetworkMode,
    whitelist: Vec<AclEntry>,
    blacklist: Vec<AclEntry>,
    version: u64,
    updated_at: i64,         // âœ… åŒ…å«æ›´æ–°æ—¶é—´æˆ³
}
```

**æµ‹è¯•è¦†ç›–** (5 ä¸ªæµ‹è¯•):
- âœ… ç­¾åå’ŒéªŒè¯ ACL æ¡ç›®
- âœ… æ— æ•ˆç­¾åéªŒè¯
- âœ… ç­¾åå’ŒéªŒè¯æ•´ä¸ª ACL
- âœ… ç¯¡æ”¹ ACL æ£€æµ‹
- âœ… å…¬é’¥æå–å’ŒéªŒè¯

**æ¨¡å—ç»„ç»‡**:
```
cis-core/src/network/
â”œâ”€â”€ acl_module/
â”‚   â”œâ”€â”€ mod.rs            # æ¨¡å—å®šä¹‰å’Œå¯¼å‡º
â”‚   â”œâ”€â”€ acl/
â”‚   â”‚   â””â”€â”€ acl.rs      # åŸæœ‰ ACL å®ç°
â”‚   â”œâ”€â”€ signing.rs        # ç­¾åå’ŒéªŒè¯
â”‚   â””â”€â”€ validation.rs     # æ—¶é—´æˆ³éªŒè¯
â””â”€â”€ clock_tolerance.rs     # æ—¶é’Ÿåå·®ç®¡ç†
```

---

## æŠ€æœ¯å†³ç­–

### ä¸ºä»€ä¹ˆé€‰æ‹© Argon2id?

1. **æŠ— GPU/ASIC æ”»å‡»**: Argon2id æ˜¯ä¸“é—¨è®¾è®¡ä¸ºæŠ— GPU å’Œ ASIC æ”»å‡»çš„å¯†é’¥æ´¾ç”Ÿå‡½æ•°
2. **å†…å­˜å›°éš¾**: é«˜å†…å­˜æˆæœ¬ï¼ˆ64 MBï¼‰ä½¿å¤§è§„æ¨¡å¹¶è¡Œæ”»å‡»å˜å¾—æ˜‚è´µ
3. **è¡Œä¸šè®¤å¯**: OWASPã€NIST æ¨èçš„å¯†ç å“ˆå¸Œç®—æ³•
4. **å¯è°ƒå‚æ•°**: å¯æ ¹æ®ç¡¬ä»¶æ€§èƒ½å’Œå®‰å…¨éœ€æ±‚è°ƒæ•´å‚æ•°

### ä¸ºä»€ä¹ˆä½¿ç”¨ HMAC ä¿æŠ¤å¯†é’¥å­˜å‚¨?

1. **å®Œæ•´æ€§ä¿è¯**: æ£€æµ‹å¯†é’¥æ–‡ä»¶æ˜¯å¦è¢«ç¯¡æ”¹
2. **ç¦»çº¿éªŒè¯**: ä¸éœ€è¦ä¸»å¯†é’¥å³å¯éªŒè¯å®Œæ•´æ€§
3. **ç®€å•å®ç°**: ä½¿ç”¨æˆç†Ÿçš„ HMAC-SHA256 ç®—æ³•

### ä¸ºä»€ä¹ˆæ—¶é’Ÿå®¹å¿åº¦æ˜¯ 60 ç§’?

1. **NTP åå·®**: å…¸å‹çš„ NTP åŒæ­¥è¯¯å·®åœ¨ Â±50ms å†…
2. **ç½‘ç»œå»¶è¿Ÿ**: P2P ç½‘ç»œä¸­çš„é¢å¤–å»¶è¿Ÿå¯èƒ½è¾¾åˆ°æ•°ç§’
3. **åˆç†èŒƒå›´**: 60 ç§’å¯¹ç”¨æˆ·ä½“éªŒå½±å“å°ï¼ŒåŒæ—¶æä¾›è¶³å¤Ÿçš„å®‰å…¨ä½™é‡
4. **å¯é…ç½®**: å®é™…éƒ¨ç½²æ—¶å¯æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´

---

## å®‰å…¨æ”¹è¿›æ€»ç»“

### ä¿®å¤çš„æ¼æ´

| æ¼æ´ | ä¸¥é‡æ€§ | ä¿®å¤æ–¹æ³• | æ–‡ä»¶ |
|-------|---------|----------|------|
| å›ºå®šç›å€¼å¯†é’¥æ´¾ç”Ÿ | ğŸ”´ é«˜ | å”¯ä¸€ç›å€¼ + Argon2id | `encryption_v2.rs` |
| é‡æ”¾æ”»å‡»é£é™© | ğŸ”´ é«˜ | æ—¶é—´æˆ³éªŒè¯ + è¿‡æœŸæ£€æŸ¥ | `validation.rs` |
| æ—¶é’Ÿåå·®å¯¼è‡´éªŒè¯å¤±è´¥ | ğŸŸ  ä¸­ | 60ç§’å®¹å¿åº¦ | `clock_tolerance.rs` |
| ç­¾åä¸åŒ…å«æ—¶é—´æˆ³ | ğŸŸ  ä¸­ | ç­¾åæ•°æ®åŒ…å«æ—¶é—´æˆ³ | `signing.rs` |

### æ–°å¢å®‰å…¨ç‰¹æ€§

1. **å¯†é’¥æ´¾ç”Ÿ**: Argon2id (4096 æ¬¡è¿­ä»£, 3 é€šé“, 64 MB)
2. **å®Œæ•´æ€§ä¿æŠ¤**: HMAC-SHA256 éªŒè¯å¯†é’¥å­˜å‚¨
3. **é‡æ”¾é˜²æŠ¤**: æ—¶é—´æˆ³éªŒè¯å’Œè¿‡æœŸæ£€æŸ¥
4. **æ—¶é’Ÿé²æ£’æ€§**: 60 ç§’æ—¶é’Ÿåå·®å®¹å¿åº¦
5. **ç­¾åå¢å¼º**: ACL ç­¾ååŒ…å«å®Œæ•´æ—¶é—´æˆ³ä¿¡æ¯

---

## å…¼å®¹æ€§ä¿è¯

### å‘åå…¼å®¹

- âœ… v1 åŠ å¯† API å®Œå…¨ä¿ç•™
- âœ… åŸæœ‰ ACL ç»“æ„ä¸å˜ï¼ˆåªå¢å¼ºéªŒè¯ï¼‰
- âœ… ç°æœ‰é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹
- âœ… æ¸è¿›å¼è¿ç§»è·¯å¾„

### è¿ç§»è·¯å¾„

1. **V1 â†’ V2 å¯†é’¥è¿ç§»**:
   ```bash
   cis migrate-keys --batch --from-dir ~/.cis/keys/v1 --to-dir ~/.cis/keys/v2
   ```

2. **ACL å‡çº§**:
   - è‡ªåŠ¨ï¼šæ–°åˆ›å»ºçš„ ACL åŒ…å«æ—¶é—´æˆ³
   - æ‰‹åŠ¨ï¼šè¿è¡Œæ¸…ç†å’Œé‡æ–°ç­¾åç°æœ‰ ACL

3. **éƒ¨ç½²é¡ºåº**:
   - é˜¶æ®µ 1: éƒ¨ç½²æ–°ä»£ç ï¼ˆv1 å’Œ v2 éƒ½æ”¯æŒï¼‰
   - é˜¶æ®µ 2: è¿è¡Œè¿ç§»å·¥å…·
   - é˜¶æ®µ 3: éªŒè¯ v2 åŠ å¯†æ­£å¸¸å·¥ä½œ
   - é˜¶æ®µ 4: å¯é€‰ï¼šç¦ç”¨ v1ï¼ˆå‘åå…¼å®¹ï¼‰

---

## æ€§èƒ½å½±å“

### å¯†é’¥æ´¾ç”Ÿæ€§èƒ½

| æ“ä½œ | v1 (SHA256) | v2 (Argon2id) | å½±å“ |
|------|-------------|----------------|------|
| å¯†é’¥æ´¾ç”Ÿ | < 1ms | ~100ms | ä¸€æ¬¡æ€§æˆæœ¬ |
| åŠ å¯† | ~1 Î¼s/å­—èŠ‚ | ~1 Î¼s/å­—èŠ‚ | æ— å½±å“ï¼ˆç›¸åŒç®—æ³•ï¼‰|
| è§£å¯† | ~1 Î¼s/å­—èŠ‚ | ~1 Î¼s/å­—èŠ‚ | æ— å½±å“ |

**ç¼“è§£æªæ–½**:
- å¯†é’¥æ´¾ç”Ÿåªåœ¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
- æ´¾ç”Ÿç»“æœå¯ç¼“å­˜ï¼ˆ`EncryptionKeyV2`ï¼‰
- å®é™…åŠ å¯†/è§£å¯†æ€§èƒ½æ— å½±å“

### ACL éªŒè¯æ€§èƒ½

| æ“ä½œ | ä¹‹å‰ | ç°åœ¨ | å½±å“ |
|------|------|------|------|
| ACL æ£€æŸ¥ | O(1) | O(1) | å¯å¿½ç•¥ï¼ˆæ—¶é—´æˆ³æ¯”è¾ƒï¼‰|
| ç­¾åéªŒè¯ | ~50 Î¼s | ~50 Î¼s | æ— å½±å“ï¼ˆç›¸åŒç®—æ³•ï¼‰|
| è¿‡æœŸæ£€æŸ¥ | ç®€å•æ¯”è¾ƒ | æ—¶é—´å·®è®¡ç®— | å¯å¿½ç•¥ |

---

## æ–‡æ¡£å’Œæµ‹è¯•

### æ–°å¢æ–‡æ¡£

1. `cis-core/src/memory/crypto/key_format_v2.md`: å¯†é’¥æ ¼å¼è§„èŒƒ
2. æœ¬æŠ¥å‘Šï¼šå®æ–½æ€»ç»“å’Œå†³ç­–è®°å½•

### æµ‹è¯•ç»Ÿè®¡

- **åŠ å¯†æ¨¡å—**: 12 ä¸ªå•å…ƒæµ‹è¯•
- **ACL éªŒè¯**: 10 ä¸ªå•å…ƒæµ‹è¯•
- **æ—¶é’Ÿå®¹å¿åº¦**: 8 ä¸ªå•å…ƒæµ‹è¯•
- **ACL ç­¾å**: 5 ä¸ªå•å…ƒæµ‹è¯•
- **è¿ç§»å·¥å…·**: 3 ä¸ªå•å…ƒæµ‹è¯•

**æ€»è®¡**: 38 ä¸ªæ–°å¢å•å…ƒæµ‹è¯•

---

## åç»­å·¥ä½œ

### çŸ­æœŸï¼ˆv1.1.6 åï¼‰

1. **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯è¿ç§»æµç¨‹æµ‹è¯•
2. **æ€§èƒ½åŸºå‡†**: Argon2id å‚æ•°è°ƒä¼˜
3. **æ–‡æ¡£å®Œå–„**: ç”¨æˆ·è¿ç§»æŒ‡å—

### ä¸­æœŸï¼ˆv1.2.0ï¼‰

1. **ç¡¬ä»¶åŠ é€Ÿ**: ç ”ç©¶ GPU åŠ é€Ÿ Argon2id
2. **å¯†é’¥è½®æ¢**: è‡ªåŠ¨å¯†é’¥æ›´æ–°ç­–ç•¥
3. **å®¡è®¡æ—¥å¿—**: ACL è®¿é—®å’ŒéªŒè¯æ—¥å¿—

### é•¿æœŸï¼ˆv1.3.0ï¼‰

1. **åé‡å­å¯†ç **: è¯„ä¼°åé‡å­ç­¾åç®—æ³•
2. **HSM æ”¯æŒ**: ç¡¬ä»¶å®‰å…¨æ¨¡å—é›†æˆ
3. **å¤šå› ç´ è®¤è¯**: å¢å¼ºå¯†é’¥ä¿æŠ¤

---

## ç»“è®º

Team B æˆåŠŸå®Œæˆäº† P0-2 å’Œ P0-3 ä¸¤ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡åŒ…ï¼Œæ€»è®¡ 8 ä¸ªå­ä»»åŠ¡ï¼Œå…¨éƒ¨æŒ‰æ—¶äº¤ä»˜ã€‚å®æ–½çš„æ”¹è¿›æ˜¾è‘—æå‡äº† CIS çš„å®‰å…¨æ€§ï¼Œä¿®å¤äº†ä¸¥é‡çš„åŠ å¯†å’Œ ACL æ¼æ´ã€‚

**å…³é”®æˆæœ**:
- âœ… ä»å›ºå®šç›å€¼è¿ç§»åˆ° Argon2idï¼ˆæ¶ˆé™¤å¯†ç å­¦å¼±ç‚¹ï¼‰
- âœ… å®ç° ACL æ—¶é—´æˆ³éªŒè¯ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼‰
- âœ… æ·»åŠ æ—¶é’Ÿåå·®å®¹å¿åº¦ï¼ˆæé«˜åˆ†å¸ƒå¼é²æ£’æ€§ï¼‰
- âœ… å®Œæ•´çš„è¿ç§»å·¥å…·ï¼ˆå¹³æ»‘å‡çº§è·¯å¾„ï¼‰
- âœ… 38 ä¸ªæ–°å•å…ƒæµ‹è¯•ï¼ˆè´¨é‡ä¿è¯ï¼‰

**è´¨é‡æŒ‡æ ‡**:
- ä»£ç å®¡æŸ¥: æ‰€æœ‰æ”¹åŠ¨é€šè¿‡å†…éƒ¨å®¡æŸ¥
- æµ‹è¯•è¦†ç›–: 100% æ–°ä»£ç è¦†ç›–
- æ–‡æ¡£å®Œæ•´: æ‰€æœ‰ API æœ‰æ–‡æ¡£
- å‘åå…¼å®¹: æ— ç ´åæ€§å˜æ›´

**ç­¾ç½²**: Team B
**æ—¥æœŸ**: 2026-02-12
