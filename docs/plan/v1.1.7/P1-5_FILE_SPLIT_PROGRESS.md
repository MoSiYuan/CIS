# P1-5: æ–‡ä»¶è¿‡å¤§æ‹†åˆ† - è¿›åº¦æŠ¥å‘Š

**ä»»åŠ¡ID**: P1-5
**ä¼˜å…ˆçº§**: P1 (é«˜ä¼˜å…ˆçº§)
**å¼€å§‹æ—¶é—´**: 2026-02-18
**æœ€åæ›´æ–°**: 2026-02-18 16:30

---

## æ‰§è¡Œæ‘˜è¦

æœ¬ä»»åŠ¡æ—¨åœ¨æ‹†åˆ† CIS ä»£ç åº“ä¸­çš„è¿‡å¤§æ–‡ä»¶ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§å’Œç¼–è¯‘æ•ˆç‡ã€‚

**ç›®æ ‡æ–‡ä»¶**:
- error/unified.rs: 1140 è¡Œ âœ… å·²å®Œæˆ
- skill/manager.rs: 1038 è¡Œ ğŸš§ è¿›è¡Œä¸­
- wasm/sandbox.rs: 904 è¡Œ â³ å¾…å¤„ç†

---

## è¿›åº¦è¯¦æƒ…

### 1. error/unified.rs æ‹†åˆ† âœ… (100%)

**åŸæ–‡ä»¶**: cis-core/src/error/unified.rs (1140è¡Œ)

**æ‹†åˆ†ç­–ç•¥**: æŒ‰åŠŸèƒ½èŒè´£æ‹†åˆ†ä¸º5ä¸ªæ¨¡å—

**æ–°ç»“æ„**:
```
error/unified/
â”œâ”€â”€ mod.rs (136è¡Œ)      # æ¨¡å—å…¥å£å’Œå¯¼å‡º
â”œâ”€â”€ types.rs (270è¡Œ)    # æ ¸å¿ƒç±»å‹å®šä¹‰
â”œâ”€â”€ context.rs (100è¡Œ)  # é”™è¯¯ä¸Šä¸‹æ–‡
â”œâ”€â”€ convenience.rs (490è¡Œ)  # ä¾¿æ·æ„é€ å‡½æ•°
â””â”€â”€ conversions.rs (200è¡Œ)  # From traitå®ç°
```

**æ¨¡å—è¯´æ˜**:

#### mod.rs (136è¡Œ)
- å¯¼å‡ºæ‰€æœ‰å…¬å…±API
- åŒ…å«æ–‡æ¡£å’Œç¤ºä¾‹
- é›†æˆæµ‹è¯•ä»£ç 

#### types.rs (270è¡Œ)
- ErrorCategory æšä¸¾
- ErrorSeverity æšä¸¾
- Recoverability æšä¸¾
- CisError æ ¸å¿ƒç»“æ„
- Result ç±»å‹åˆ«å

#### context.rs (100è¡Œ)
- ErrorContext ç»“æ„
- é”®å€¼å¯¹ä¸Šä¸‹æ–‡ç®¡ç†
- æºä½ç½®è¿½è¸ª

#### convenience.rs (490è¡Œ)
- æ‰€æœ‰ä¾¿æ·æ„é€ å‡½æ•°
- æŒ‰é”™è¯¯åˆ†ç±»ç»„ç»‡ (Memory, Network, Scheduler, Agent, Skill, AI, etc.)
- æ¯ä¸ªå‡½æ•°åŒ…å«é»˜è®¤é”™è¯¯ä»£ç å’Œå»ºè®®

#### conversions.rs (200è¡Œ)
- Display trait å®ç°
- std::error::Error trait å®ç°
- From<std::io::Error> å®ç°
- From<LegacyCisError> å®ç°

**æ”¹è¿›æ•ˆæœ**:
- âœ… ä»£ç ç»„ç»‡æ›´æ¸…æ™°
- âœ… å‡å°‘ç¼–è¯‘é”™è¯¯ 28ä¸ª (2116 â†’ 2088)
- âœ… å•ä¸ªæ–‡ä»¶å°äº500è¡Œ
- âœ… æ›´å¥½çš„å…³æ³¨ç‚¹åˆ†ç¦»
- âœ… å‘åå…¼å®¹ (error/mod.rs é‡æ–°å¯¼å‡º)

**æäº¤ä¿¡æ¯**:
- Commit: d5e3059
- æ¶ˆæ¯: "refactor(error): split unified.rs into multiple modules (P1-5)"

---

### 2. skill/manager.rs æ‹†åˆ† ğŸš§ (10%)

**åŸæ–‡ä»¶**: cis-core/src/skill/manager.rs (1034è¡Œ)

**å½“å‰çŠ¶æ€**: å·²åˆ›å»º manager/ å­ç›®å½•ï¼ŒåŸæ–‡ä»¶ç§»è‡³ manager/mod.rs

**æ‹†åˆ†è®¡åˆ’**:

```
skill/manager/
â”œâ”€â”€ mod.rs (~600è¡Œ)     # SkillManager ä¸»è¦å®ç°
â”œâ”€â”€ event_loop.rs (~200è¡Œ)  # äº‹ä»¶å¾ªç¯å’Œ ActiveSkill
â”œâ”€â”€ context.rs (~100è¡Œ)  # SimpleSkillContext
â”œâ”€â”€ dummy.rs (~50è¡Œ)    # DummySkill (æµ‹è¯•è¾…åŠ©)
â””â”€â”€ commands.rs (~100è¡Œ) # SkillEventCommand
```

**ä¸»è¦ç»“æ„**:
- `SkillEventCommand`: äº‹ä»¶å¾ªç¯å‘½ä»¤
- `ActiveSkill`: æ´»è·ƒSkillå®ä¾‹ç®¡ç†
- `SimpleSkillContext`: ç®€å•ä¸Šä¸‹æ–‡å®ç°
- `DummySkill`: æµ‹è¯•ç”¨Skill
- `SkillManager`: ä¸»ç®¡ç†å™¨ (æ ¸å¿ƒ)

**ä¸‹ä¸€æ­¥**:
1. æå– event_loop.rs
2. æå– context.rs
3. æå– dummy.rs
4. æ›´æ–° mod.rs å¯¼å…¥
5. æµ‹è¯•ç¼–è¯‘

---

### 3. wasm/sandbox.rs æ‹†åˆ† â³ (0%)

**åŸæ–‡ä»¶**: cis-core/src/wasm/sandbox.rs (904è¡Œ)

**å¾…åˆ†æ**: éœ€è¦è¯»å–æ–‡ä»¶å†…å®¹ç¡®å®šæ‹†åˆ†ç­–ç•¥

**é¢„ä¼°æ‹†åˆ†**:
```
wasm/sandbox/
â”œâ”€â”€ mod.rs       # ä¸»æ¨¡å—
â”œâ”€â”€ runtime.rs   # WASMè¿è¡Œæ—¶
â”œâ”€â”€ instance.rs  # å®ä¾‹ç®¡ç†
â””â”€â”€ security.rs  # å®‰å…¨ç­–ç•¥
```

---

## æŠ€æœ¯ç»†èŠ‚

### æ‹†åˆ†åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½
2. **åˆç†å¤§å°**: æ¯ä¸ªæ–‡ä»¶ä¸è¶…è¿‡500è¡Œ
3. **æœ€å°ä¾èµ–**: æ¨¡å—é—´ä¾èµ–æ¸…æ™°ï¼Œé¿å…å¾ªç¯ä¾èµ–
4. **å‘åå…¼å®¹**: é€šè¿‡ mod.rs é‡æ–°å¯¼å‡ºï¼Œä¿æŒå¤–éƒ¨APIä¸å˜
5. **æµ‹è¯•å‹å¥½**: æ‹†åˆ†åçš„æ¨¡å—æ˜“äºå•ç‹¬æµ‹è¯•

### æ¨¡å—å¯¼å…¥æ¨¡å¼

```rust
// å­æ¨¡å—ä½¿ç”¨ç›¸å¯¹å¯¼å…¥
use super::types::CisError;

// mod.rs é‡æ–°å¯¼å‡ºå…¬å…±API
pub use types::{CisError, Result};
```

### Rust æ¨¡å—ç³»ç»Ÿæ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶ä¸ç›®å½•å†²çª**: ä¸èƒ½åŒæ—¶å­˜åœ¨ `file.rs` å’Œ `file/` ç›®å½•
2. **mod.rs å‘½å**: å­ç›®å½•ä¸­çš„å…¥å£æ–‡ä»¶å¿…é¡»å‘½åä¸º `mod.rs`
3. **å¯è§æ€§**: é»˜è®¤ç§æœ‰ï¼Œä½¿ç”¨ `pub` å¯¼å‡º
4. **å¾ªç¯å¯¼å…¥**: é¿å… `use super::super::` çš„æ·±å±‚å¯¼å…¥

---

## ç»Ÿè®¡æ•°æ®

### ä»£ç è¡Œæ•°å˜åŒ–

| æ–‡ä»¶ | æ‹†åˆ†å‰ | æ‹†åˆ†å | å˜åŒ– |
|------|--------|--------|------|
| error/unified.rs | 1140è¡Œ | 1196è¡Œ (æ€»è®¡) | +56è¡Œ (æ–‡æ¡£å’Œæ¨¡å—å£°æ˜) |
| - unified/mod.rs | - | 136è¡Œ | +136è¡Œ |
| - unified/types.rs | - | 270è¡Œ | +270è¡Œ |
| - unified/context.rs | - | 100è¡Œ | +100è¡Œ |
| - unified/convenience.rs | - | 490è¡Œ | +490è¡Œ |
| - unified/conversions.rs | - | 200è¡Œ | +200è¡Œ |

### ç¼–è¯‘é”™è¯¯å˜åŒ–

| æŒ‡æ ‡ | æ‹†åˆ†å‰ | æ‹†åˆ†å | æ”¹è¿› |
|------|--------|--------|------|
| æ€»é”™è¯¯æ•° | 2116 | 2088 | -28 (-1.3%) |
| Warnings | 111 | 115 | +4 |

---

## é£é™©ä¸æŒ‘æˆ˜

### å·²è§£å†³

1. âœ… **æ¨¡å—å¯¼å…¥è·¯å¾„**: ä¿®å¤ `super::` ç›¸å¯¹å¯¼å…¥
2. âœ… **å¾ªç¯ä¾èµ–**: è§£æ unified â†’ legacy ä¾èµ–
3. âœ… **é‡æ–°å¯¼å‡º**: ç¡®ä¿ error/mod.rs æ­£ç¡®å¯¼å‡º
4. âœ… **æµ‹è¯•ä»£ç **: è¿ç§»æµ‹è¯•åˆ° unified/mod.rs

### å¾…è§£å†³

1. â³ **Skill Manager å¤æ‚æ€§**: SkillManager æœ‰å¤šä¸ªèŒè´£ï¼Œæ‹†åˆ†éœ€è°¨æ…
2. â³ **WASM Sandbox å®‰å…¨æ€§**: æ²™ç®±ä»£ç ç´§å¯†è€¦åˆï¼Œæ‹†åˆ†å¯èƒ½å½±å“å®‰å…¨æ€§
3. â³ **ç¼–è¯‘æ—¶é—´**: æ‹†åˆ†å¯èƒ½å¢åŠ æˆ–å‡å°‘ç¼–è¯‘æ—¶é—´ï¼Œéœ€å®æµ‹

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (æœ¬å‘¨)

1. **å®Œæˆ skill/manager.rs æ‹†åˆ†**
   - æå– event_loop.rs
   - æå– context.rs
   - æå– dummy.rs
   - éªŒè¯ç¼–è¯‘

2. **åˆ†æ wasm/sandbox.rs**
   - è¯»å–æ–‡ä»¶ç»“æ„
   - ç¡®å®šæ‹†åˆ†ç­–ç•¥
   - åˆ›å»ºæ‹†åˆ†è®¡åˆ’

3. **è¿è¡Œæµ‹è¯•**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

### åç»­ä¼˜åŒ– (ä¸‹å‘¨)

1. **ç¼–è¯‘æ—¶é—´ä¼˜åŒ–**
   - æµ‹é‡æ‹†åˆ†å‰åç¼–è¯‘æ—¶é—´
   - è°ƒæ•´æ¨¡å—ä¾èµ–
   - å¹¶è¡ŒåŒ–ç¼–è¯‘

2. **æ–‡æ¡£æ›´æ–°**
   - æ›´æ–° ARCHITECTURE.md
   - æ·»åŠ æ¨¡å—å›¾ç¤º
   - ç¼–å†™è¿ç§»æŒ‡å—

---

## ç›¸å…³ Issues

- P1-5: æ–‡ä»¶è¿‡å¤§
- P0-1: ç‰ˆæœ¬å·ä¸ä¸€è‡´ (å·²è§£å†³)
- P1-13: è¿‡å¤šçš„ #[allow(dead_code)] (å·²è§£å†³)

---

## å‚è€ƒèµ„æ–™

- [Rust Module System](https://doc.rust-lang.org/book/ch07-00-managing-growing-projects-with-packages-crates-and-modules.html)
- [CIS Code Conventions](../../CONTRIBUTING.md)
- [Error Handling Design](./CIS_ERROR_HANDLING_DESIGN.md)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-18 16:30
**æ€»è¿›åº¦**: 33% (1/3 æ–‡ä»¶å®Œæˆ)
**é¢„è®¡å®Œæˆ**: 2026-02-20
