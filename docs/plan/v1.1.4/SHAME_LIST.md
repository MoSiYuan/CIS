# CIS v1.1.4 耻辱标签记录

> 自我监督文件：记录所有简化/mock/未完成的实现  
> 创建日期: 2026-02-10  
> 规则: 每出现一个简化实现，必须在此记录并立即修复

---

## 耻辱记录格式

```
### 耻辱 #[编号]
- **日期**: YYYY-MM-DD
- **文件**: `path/to/file.rs`
- **问题**: 简化/mock/未实现的具体描述
- **原因**: 为什么会出现（时间紧/难度大/没设计好）
- **修复承诺**: 如何修复，截止日期
- **状态**: 待修复/修复中/已修复
```

---

## P0-2 安全基线建立任务 - 耻辱记录

### 耻辱 #SEC-1
- **日期**: 2026-02-10
- **文件**: `docs/security/hardening_checklist.md`
- **问题**: Agent 命令白名单系统未完整实现，仅提供框架设计
- **原因**: 需要修改 Agent 执行流程，涉及较多组件交互
- **修复承诺**: 
  - 创建 `cis-core/src/agent/security.rs`
  - 实现 `CommandSecurity` 验证器
  - 集成到 `ClaudeProvider` 和 `KimiProvider`
- **截止日期**: 2026-02-15
- **状态**: 待修复

### 耻辱 #SEC-2
- **日期**: 2026-02-10
- **文件**: `docs/security/hardening_checklist.md`
- **问题**: WASI 文件系统能力限制未完整实现
- **原因**: 需要配置 wasmer-wasi 的能力限制，涉及 WASI API 研究
- **修复承诺**:
  - 创建 `cis-core/src/wasm/sandbox.rs`
  - 实现 `WasiSandbox` 能力限制
  - 禁用所有文件系统访问（除非显式配置）
- **截止日期**: 2026-02-12
- **状态**: 待修复

### 耻辱 #SEC-3
- **日期**: 2026-02-10
- **文件**: `docs/security/hardening_checklist.md`
- **问题**: 密钥加密存储未实现（需要用户密码）
- **原因**: 需要设计用户交互流程（密码输入/确认）
- **修复承诺**:
  - 创建 `cis-core/src/identity/encrypted_key.rs`
  - 使用 Argon2id + ChaCha20-Poly1305
  - 修改初始化流程支持密码设置
- **截止日期**: 2026-02-20
- **状态**: 待修复

### 耻辱 #SEC-4
- **日期**: 2026-02-10
- **文件**: `docs/security/hardening_checklist.md`
- **问题**: 证书固定（Certificate Pinning）未实现
- **原因**: 需要设计首次连接信任机制
- **修复承诺**:
  - 创建 `cis-core/src/network/pinning.rs`
  - 实现公钥指纹固定
  - 添加指纹变更警告
- **截止日期**: 2026-02-18
- **状态**: 待修复

### 耻辱 #SEC-5
- **日期**: 2026-02-10
- **文件**: `docs/security/hardening_checklist.md`
- **问题**: 速率限制器未完整实现
- **原因**: 需要设计分布式速率限制策略
- **修复承诺**:
  - 创建 `cis-core/src/network/rate_limiter.rs`
  - 实现基于令牌桶的速率限制
  - 支持 IP 和 DID 级别的限制
- **截止日期**: 2026-02-15
- **状态**: 待修复

### 耻辱 #SEC-6
- **日期**: 2026-02-10
- **文件**: `docs/security/hardening_checklist.md`
- **问题**: 输入验证框架未实现
- **原因**: 需要为所有 API 端点添加验证
- **修复承诺**:
  - 创建 `cis-core/src/validation/mod.rs`
  - 使用 `validator` crate 定义验证规则
  - 为所有请求类型添加 Validate derive
- **截止日期**: 2026-02-16
- **状态**: 待修复

---

## D02 全局状态消除任务 - 耻辱记录

### 耻辱 #D02-1
- **日期**: 2026-02-10
- **文件**: `cis-core/src/container.rs`
- **问题**: `ServiceContainer::production()` 未实现，仅返回错误
- **原因**: 需要完整的基础设施实现，超出当前任务范围
- **修复承诺**: v1.1.5 中实现 production() 方法
- **截止日期**: 2026-02-28
- **状态**: 待修复

### 耻辱 #D02-2
- **日期**: 2026-02-10
- **文件**: `cis-core/src/p2p/network.rs`
- **问题**: `P2PNetwork::stop()` trait 实现不完整，仅返回 Ok(())
- **原因**: trait 方法签名与实际需求不匹配
- **修复承诺**: v1.1.5 中重新设计停止机制
- **截止日期**: 2026-02-28
- **状态**: 待修复

### 耻辱 #D02-3
- **日期**: 2026-02-10
- **文件**: `cis-core/src/container.rs`
- **问题**: MockSkillExecutor 和 MockEmbeddingService 内联在 container.rs
- **原因**: 避免循环依赖
- **修复承诺**: v1.1.5 中重构为独立的 mock 实现
- **截止日期**: 2026-02-28
- **状态**: 待修复

### 耻辱 #D02-4
- **日期**: 2026-02-10
- **文件**: `cis-core/src/p2p/network.rs`, `cis-core/src/agent/cluster/manager.rs`, `cis-core/src/ai/embedding_service.rs`
- **问题**: 全局单例仅标记废弃未移除
- **原因**: 直接移除会破坏大量现有代码
- **修复承诺**: v1.2.0 中完全移除全局单例
- **截止日期**: 2026-03-31
- **状态**: 待修复

---

## 耻辱预防清单

开发前必须检查：
- [ ] 是否阅读了相关设计文档？
- [ ] 是否有完整的接口定义？
- [ ] 是否有错误处理？
- [ ] 是否有测试用例？
- [ ] 是否避免了硬编码？
- [ ] 是否避免了全局状态？

---

## 全面审查结果 (2026-02-10)

详细审查报告: [SHAME_COMPREHENSIVE_REVIEW.md](./SHAME_COMPREHENSIVE_REVIEW.md)

发现 **40 处** 需要关注的代码:
- 🔴 高优先级: 12 处 (需 v1.1.5 修复)
- 🟡 中优先级: 15 处 (需 v1.1.5/v1.2.0 修复)
- 🟢 低优先级: 8 处 (可延后)

### 新增耻辱标签

### 耻辱 #NEW-1 ✅ 已修复
- **日期**: 2026-02-10
- **文件**: `cis-core/src/p2p/dht_ops.rs`
- **问题**: DHT 完整实现未完成，多处简化 (广播查询、固定返回值、简化距离计算)
- **原因**: 时间和复杂度限制
- **修复日期**: 2026-02-10
- **修复内容**:
  - ✅ 创建 `cis-core/src/p2p/kademlia/` 模块
  - ✅ 实现 `NodeId` (160-bit) + 单元测试
  - ✅ 实现 `Distance` (XOR 距离) + 单元测试
  - ✅ 实现基础 `KademliaDht` 服务
  - ✅ 实现 `KBucket` (LRU 管理)
  - ✅ 实现 `RoutingTable` (160 buckets)
  - ✅ 实现查询管理器 (并行 α 查询)
  - ✅ 实现 RPC 协议 (PING/FIND_NODE/STORE/FIND_VALUE)
  - ✅ 实现本地存储 (带 TTL)
- **状态**: 已修复

### 耻辱 #NEW-2 ✅ 已修复
- **日期**: 2026-02-10
- **文件**: `cis-core/src/p2p/transport.rs:202,373`
- **问题**: 连接处理循环和心跳发送 TODO 未完成
- **原因**: 需要完整的连接状态机设计
- **修复日期**: 2026-02-10
- **修复内容**:
  - 实现 `spawn_connection_handler()` 方法，为每个连接启动数据处理任务
  - 实现双向心跳机制：ping/pong 消息
  - 在连接建立时自动启动处理循环（accept 和 connect）
  - 心跳超时自动清理死连接
  - 更新字节统计和最后活跃时间
- **状态**: 已修复

### 耻辱 #NEW-3 ✅ 已修复
- **日期**: 2026-02-10
- **文件**: `cis-core/src/container.rs:108,127,196`
- **问题**: 生产代码中使用 Mock 作为 feature 不可用的降级方案
- **原因**: 为了保证容器可启动
- **修复日期**: 2026-02-10
- **修复内容**:
  - 修改 `cis-core/Cargo.toml`: 将 `p2p` 和 `wasm` 加入 default features
  - 修改 `ServiceContainer::production()`: 移除 MockEmbeddingService 降级代码
  - 修改 `create_network_service()`: 移除 MockNetworkService 降级代码
  - 生产环境现在强制要求所有必要 features
- **状态**: 已修复

### 耻辱 #NEW-4
- **日期**: 2026-02-10
- **文件**: `cis-core/src/p2p/network.rs:261`
- **问题**: P2P_INSTANCE 全局单例仍在使用 (虽已标记废弃但未移除)
- **原因**: 大量现有代码依赖
- **修复承诺**: v1.2.0 完全移除全局单例
- **截止日期**: 2026-03-31
- **状态**: 待修复

### 耻辱 #NEW-5
- **日期**: 2026-02-10
- **文件**: `cis-core/src/decision/countdown.rs:180`
- **问题**: 交互式倒计时简化，未监听键盘输入
- **原因**: 需要异步输入处理
- **修复承诺**: v1.1.5 实现键盘事件监听
- **截止日期**: 2026-02-22
- **状态**: 待修复

### 耻辱 #NEW-6
- **日期**: 2026-02-10
- **文件**: `cis-core/src/p2p/network.rs:514,527`
- **问题**: 主题订阅简化实现，mDNS 任务未启动
- **原因**: 需要 GossipSub 实现
- **修复承诺**: v1.1.5 实现 GossipSub 或移除该功能
- **截止日期**: 2026-02-28
- **状态**: 待修复

### 耻辱统计

| 类别 | 待修复 | 修复中 | 已修复 |
|-----|-------|-------|-------|
| 安全相关 (SEC) | 6 | 0 | 0 |
| 全局状态 (D02) | 3 | 0 | 1 |
| P2P 加密 (D05) | 0 | 0 | 1 |
| 新增发现 (NEW) | 2 | 0 | 3 |
| **总计** | **11** | **0** | **5** |

---

*耻辱标签一旦打上，必须立即修复，不得拖延！*

**下次审查**: 2026-02-17
