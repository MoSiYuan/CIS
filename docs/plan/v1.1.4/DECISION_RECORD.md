# v1.1.4 决策记录

> 本文档记录 v1.1.4 版本开发过程中的所有关键决策
> 遵循 [ADR (Architecture Decision Record)](https://adr.github.io/) 格式

---

## 决策索引

| 编号 | 标题 | 状态 | 日期 | 决策者 |
|------|------|------|------|--------|
| [ADR-001](#adr-001-时间线从4-6周延长至12周) | 时间线延长至12周 | ✅ 批准 | 2026-02-10 | 团队评审 |
| [ADR-002](#adr-002-架构重构优先策略) | 架构重构先行 | ⏳ 待决定 | - | - |
| [ADR-003](#adr-003-安全基线作为阻塞条件) | 安全基线P0阻塞 | ⏳ 待决定 | - | - |
| [ADR-004](#adr-004-测试覆盖率目标调整) | 测试覆盖率70% | ⏳ 待决定 | - | - |
| [ADR-005](#adr-005-端口合并延后到-v120) | 端口合并延后 | ⏳ 待决定 | - | - |

---

## ADR-001: 时间线从 4-6 周延长至 12 周

### 状态
✅ **已批准** - 待团队评审确认

### 日期
2026-02-10

### 背景

原计划 4-6 周完成 v1.1.4，但经过以下分析发现不现实：

1. **工作量低估**: 70+ 简化实现，实际工作量 > 80 人天
2. **缺少关键规划**: 安全、测试策略完全缺失
3. **架构重构未计入**: 8 周重构计划未纳入时间线
4. **历史数据**: v1.1.3 类似工作量实际耗时 8 周

### 决策

**将 v1.1.4 开发周期从 4-6 周延长至 12 周**

```
原计划: 4-6 周 (约 30 人天)
实际需要: 88 人天 + 30% buffer = 114 人天
按 2.5 人计算: 114 / (2.5 × 5) = 9.1 周
取整缓冲: 12 周
```

### 理由

1. **质量优先**: 宁可延期，不能牺牲质量
2. **安全必需**: P0 安全问题必须解决
3. **测试重要**: 70% 覆盖率需要时间
4. **重构必要**: 架构债务不还，后续更难

### 后果

**正面影响**:
- ✅ 交付质量更高
- ✅ 技术债减少
- ✅ 团队压力降低
- ✅ 安全基线建立

**负面影响**:
- ❌ 交付时间延后 6-8 周
- ❌ 人力成本增加 50%
- ❌ 市场机会成本

**风险**:
- 竞品可能抢先
- 用户等待时间更长
- 团队士气可能受影响

### 替代方案

1. **维持 6 周**:
   - 优点: 快速交付
   - 缺点: 质量/安全无法保证
   - 风险: 极高

2. **分阶段交付**:
   - 优点: 部分功能提前可用
   - 缺点: 发布复杂度增加
   - 风险: 中等

### 相关决策

- [ADR-002]: 架构重构策略
- [ADR-003]: 安全基线要求
- [ADR-004]: 测试覆盖率目标

### 实施计划

- [ ] 更新 ROADMAP.md
- [ ] 与干系人沟通
- [ ] 调整项目计划
- [ ] 更新发布日期

---

## ADR-002: 架构重构优先策略

### 状态
⏳ **待决定** - 团队评审中

### 背景

[ARCHITECTURE_REVIEW.md](./ARCHITECTURE_REVIEW.md) 识别了严重的架构问题：
- 全局单例 (P0)
- 跨层调用 (P0)
- 硬编码配置 (P0)
- 事件总线缺失 (P1)

重构计划需要 8 周，与功能开发存在冲突。

### 决策选项

#### 选项 A: 重构先行 (推荐)

```
Month 1: 架构重构 Phase 1-3
Month 2-3: 功能开发
```

**优点**:
- ✅ 一次性解决技术债
- ✅ 后续开发效率高
- ✅ 避免返工

**缺点**:
- ❌ 前期无可见产出
- ❌ 需要团队耐心

#### 选项 B: 渐进重构

```
Week 1-2:  重构 Phase 1 + WASM 基础
Week 3-4:  重构 Phase 2 + P2P 基础
Week 5-6:  重构 Phase 3 + Agent 联邦
...
```

**优点**:
- ✅ 功能逐步交付
- ✅ 风险分散

**缺点**:
- ❌ 重构可能反复
- ❌ 总工作量增加

#### 选项 C: 分支隔离

```
refactor/ 分支: 架构重构
feature/ 分支: 功能开发
定期合并
```

**优点**:
- ✅ 并行开发
- ✅ 互不阻塞

**缺点**:
- ❌ 合并冲突频繁
- ❌ 集成成本高

### 待定事项

- 团队对"前期无产出"的接受度
- 团队对"返工风险"的容忍度
- 团队对"并行分支"的驾驭能力

---

## ADR-003: 安全基线作为阻塞条件

### 状态
⏳ **待决定** - 团队评审中

### 背景

[SECURITY_ASSESSMENT.md](./SECURITY_ASSESSMENT.md) 识别了多个 P0 安全问题：
- P2P 传输明文 (高危)
- WASM 沙箱逃逸风险 (高危)
- Agent 命令无限制 (高危)

### 决策问题

**是否接受 P0 安全问题阻塞 v1.1.4 发布？**

#### 选项 A: 是，必须解决 (推荐)

- P2P 传输加密
- WASM 沙箱加固
- 输入验证框架

#### 选项 B: 否，可以延后

- 标记为已知风险
- 在文档中说明
- v1.1.5 修复

### 待定事项

- 安全团队的意见
- 用户对安全的要求
- 法律合规要求

---

## ADR-004: 测试覆盖率目标调整

### 状态
⏳ **待决定** - 团队评审中

### 背景

[TESTING_STRATEGY.md](./TESTING_STRATEGY.md) 建议测试覆盖率目标 75%。

### 决策选项

| 目标 | 工作量 | 质量 | 风险 |
|------|--------|------|------|
| 75% | 20d | 高 | 可能延期 |
| **70%** | **15d** | **中** | **平衡** |
| 65% | 12d | 中 | 技术债 |
| 60% | 10d | 低 | 高风险 |

### 推荐

**70%** - 平衡质量和进度

---

## ADR-005: 端口合并延后到 v1.2.0

### 状态
⏳ **待决定** - 团队评审中

### 背景

[PORT_CONSOLIDATION_PROPOSAL.md](./PORT_CONSOLIDATION_PROPOSAL.md) 提议将 4 个端口合并为 2 个，工作量 5 周。

### 决策问题

**端口合并是否必须在 v1.1.4 完成？**

#### 选项 A: 是，必须完成

- 优点: 配置简化，用户体验好
- 缺点: 增加 5 周工作量
- 风险: 可能阻塞其他功能

#### 选项 B: 否，延后到 v1.2.0 (推荐)

- 优点: 集中资源做核心功能
- 缺点: 配置复杂度维持现状
- 风险: 低

### 推荐

**延后到 v1.2.0** - 不阻塞核心功能

---

## 决策模板

### ADR-XXX: [决策标题]

### 状态
⏳ **待决定** / ✅ **已批准** / ❌ **已拒绝**

### 日期
YYYY-MM-DD

### 背景
[为什么需要这个决策？]

### 决策
[最终决定是什么？]

### 理由
[为什么做出这个决定？]

### 后果

**正面影响**:
- ✅ ...

**负面影响**:
- ❌ ...

**风险**:
- ...

### 替代方案

1. **[方案 A]**:
   - 优点: ...
   - 缺点: ...

2. **[方案 B]**:
   - 优点: ...
   - 缺点: ...

### 相关决策
- [ADR-XXX]: ...

### 实施计划
- [ ] ...
- [ ] ...

---

## 决策流程

```
提出问题
    │
    ▼
背景调研
    │
    ▼
方案设计 (2-3个选项)
    │
    ▼
团队评审
    │
    ▼
决策 (负责人审批)
    │
    ▼
记录到本文档
    │
    ▼
通知团队
    │
    ▼
执行跟踪
```

---

*文档维护: 每次决策后立即更新*
*最后更新: 2026-02-10*
