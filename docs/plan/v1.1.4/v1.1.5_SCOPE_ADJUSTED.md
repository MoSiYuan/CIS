# CIS v1.1.5 范围调整方案

> 基于用户决策 6: 调整 v1.1.5 范围
> 调整日期: 2026-02-10
> 原始计划: 修复 9 个耻辱标签
> 调整后: 修复高优先级问题 + 用户确认的关键决策

---

## 用户决策确认

| 决策 | 用户选择 | 实施计划 |
|------|---------|---------|
| 1. Mock 降级 | **A. 强制启用 features** | ✅ v1.1.5 实施 |
| 2. 全局单例 | **详细解释后确认** | 分阶段迁移 (B方案) |
| 3. DHT 实现 | **A. 完整 Kademlia** | ✅ v1.1.5 实施 |
| 4. 密钥加密 | **使用 SSH Key** | ✅ v1.1.5 实施 (替代 SEC-3) |
| 5. 命令白名单 | **C. 分级权限** | ✅ v1.1.5 实施 |
| 6. v1.1.5 范围 | **调整** | 本方案 |

---

## v1.1.5 调整后的范围

### 保留在 v1.1.5 的问题 (高优先级)

#### P0-1: Mock 降级移除 (NEW-3)
- **问题**: 生产代码使用 Mock 作为 feature 降级
- **解决方案**: 强制启用必要 features
- **工作量**: 3 天
- **截止日期**: 2026-02-20

```rust
// 修改前: feature 不可用时使用 Mock
#[cfg(not(feature = "vector"))]
{
    Arc::new(MockEmbeddingService::new()) // ❌
}

// 修改后: 强制启用，否则 panic
#[cfg(not(feature = "vector"))]
compile_error!("vector feature must be enabled for production builds");
```

#### P0-2: 完整 Kademlia DHT (NEW-1)
- **问题**: DHT 简化实现（广播查询）
- **解决方案**: 实现标准 Kademlia DHT
- **工作量**: 7 天
- **截止日期**: 2026-02-28

**实现内容**:
- Kademlia 路由表 (K-buckets)
- XOR 距离计算
- 迭代查找算法
- 节点刷新机制

#### P0-3: P2P 连接处理循环 (NEW-2)
- **问题**: 连接处理循环和心跳 TODO
- **解决方案**: 完整连接状态机
- **工作量**: 5 天
- **截止日期**: 2026-02-25

**实现内容**:
- 连接状态机 (Connecting/Connected/Disconnecting/Disconnected)
- 读写分离任务
- 心跳发送和超时检测
- 连接优雅关闭

#### P0-4: SSH Key 密钥保护 (替代 SEC-3)
- **问题**: 原方案使用密码保护密钥
- **解决方案**: 使用 SSH Key 保护节点私钥
- **工作量**: 7 天
- **截止日期**: 2026-03-01

**实现内容**:
- SSH key 派生加密密钥
- 节点私钥加密存储
- ssh-agent 集成
- YubiKey/硬件密钥支持

#### P0-5: 分级权限命令白名单 (SEC-1)
- **问题**: Agent 命令无限制
- **解决方案**: 根据任务级别开放不同权限
- **工作量**: 5 天
- **截止日期**: 2026-02-25

**权限级别**:
```rust
pub enum CommandPermission {
    ReadOnly,      // ls, cat, grep (Mechanical)
    ReadWrite,     // + edit files (Recommended)
    System,        // + system commands (Confirmed)
    Dangerous,     // rm, format, etc (Arbitrated + 人工确认)
}
```

#### P0-6: 安全加固 (SEC-2, SEC-4, SEC-5, SEC-6)
- **问题**: WASI 限制、证书固定、速率限制、输入验证
- **解决方案**: 实现完整安全机制
- **工作量**: 10 天
- **截止日期**: 2026-03-05

**具体内容**:
- SEC-2: WASI 文件系统能力限制
- SEC-4: 公钥指纹固定
- SEC-5: 令牌桶速率限制
- SEC-6: 统一输入验证框架

---

### 延后到 v1.1.6 的问题 (中优先级)

#### P1-1: P2P 全局单例第一阶段迁移
- **原因**: 工作量大（2-3 周），但已有废弃警告
- **计划**: v1.1.6 完成核心服务迁移
- **当前状态**: 保持废弃警告，允许使用

#### P1-2: 倒计时键盘监听 (NEW-5)
- **原因**: 用户体验优化，非核心安全功能
- **计划**: v1.1.6 实现异步键盘事件

#### P1-3: 主题订阅/GossipSub (NEW-6)
- **原因**: 功能不完整但不影响核心流程
- **计划**: v1.1.6 实现或移除

#### P1-4: 其他中低优先级简化实现
- GLM 模块简化
- Matrix Sync 简化
- Skill Router 完善
- 等等

---

### 保留在 v1.2.0 的问题

- 完全移除全局单例 (NEW-4, D02-4)
- 架构重构 Phase 4-5
- 端口合并 (2端口方案)
- Matrix 同步完整实现

---

## 调整后时间线

```
v1.1.5 (6 周) - 高优先级安全和核心功能
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Week 1-2: Mock 降级移除 + 命令白名单
  ├─ 移除所有 Mock 降级
  ├─ 强制启用必要 features
  ├─ 设计分级权限系统
  └─ 实现基础命令白名单

Week 3-4: P2P 核心功能
  ├─ DHT 完整实现 (Kademlia)
  ├─ 连接处理循环
  ├─ 心跳机制
  └─ 集成测试

Week 5-6: 安全加固 + SSH Key
  ├─ WASI 限制
  ├─ 速率限制
  ├─ 输入验证
  ├─ 证书固定
  └─ SSH Key 密钥保护

v1.1.6 (4 周) - 全局状态迁移和用户体验
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Week 1-2: P2P 全局单例迁移第一阶段
  ├─ Agent Federation 迁移
  ├─ Matrix Bridge 迁移
  └─ 验证和回归测试

Week 3: 用户体验优化
  ├─ 倒计时键盘监听
  ├─ 主题订阅实现/移除
  └─ CLI 优化

Week 4: 测试和发布准备
  ├─ 集成测试
  ├─ 性能测试
  └─ 文档更新

v1.2.0 (待定) - 架构完善
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- 完全移除全局单例
- 架构重构 Phase 4-5
- 端口合并
- Matrix 同步完整实现
```

---

## 工作量统计

### v1.1.5
| 任务 | 天数 | 优先级 |
|------|------|--------|
| Mock 降级移除 | 3 | P0 |
| Kademlia DHT | 7 | P0 |
| P2P 连接循环 | 5 | P0 |
| SSH Key 保护 | 7 | P0 |
| 分级权限白名单 | 5 | P0 |
| 安全加固 (4项) | 10 | P0 |
| 缓冲/测试 | 7 | - |
| **总计** | **44 天** | **~9 周** |

### v1.1.6
| 任务 | 天数 | 优先级 |
|------|------|--------|
| 全局单例迁移 | 10 | P1 |
| 用户体验优化 | 7 | P1 |
| 测试和发布 | 7 | - |
| **总计** | **24 天** | **~5 周** |

---

## 风险缓解

| 风险 | 缓解措施 |
|------|---------|
| Kademlia 实现延期 | 准备简化方案 B (增强广播) 作为备选 |
| SSH Key 集成复杂 | 先支持文件加载，ssh-agent 延后 |
| 测试不足 | 每个功能必须有配套测试，延后发布也不妥协质量 |

---

## 验收标准

### v1.1.5
- [ ] 无 Mock 降级代码
- [ ] DHT 可通过单元测试 (Kademlia 标准测试)
- [ ] P2P 连接稳定 (1000次传输成功率 > 99%)
- [ ] SSH Key 加密可用
- [ ] 命令白名单生效
- [ ] 所有安全加固项完成
- [ ] 测试覆盖率 > 75%

### v1.1.6
- [ ] Agent Federation 无全局单例调用
- [ ] Matrix Bridge 无全局单例调用
- [ ] 倒计时可键盘交互
- [ ] 测试覆盖率 > 80%

---

## 决策记录

**决策**: 调整 v1.1.5 范围，聚焦高优先级安全和核心功能
**理由**: 
1. 保证核心安全和功能质量
2. 避免 v1.1.5 过度延期
3. 分阶段交付，用户可尽早使用核心功能
**影响**: v1.1.5 延期至 9 周，但交付质量更高
**批准**: 用户确认 (2026-02-10)

---

*方案创建: 2026-02-10*  
*最后更新: 2026-02-10*
