# CIS v1.1.4 最终范围确认

> 文档版本: v1.0.0 (草案)
> 状态: 待团队评审确认
> 更新日期: 2026-02-10

---

## 执行摘要

基于外部评审和内部讨论，v1.1.4 版本范围调整如下：

| 维度 | 原计划 | 调整后 | 变化 |
|------|--------|--------|------|
| **时间线** | 4-6周 | **12周** | +6-8周 |
| **P0 项目** | 4项 | **6项** | +2项(安全) |
| **P1 项目** | 10项 | **8项** | -2项(下版) |
| **测试覆盖** | 目标75% | **70%** | -5% |
| **人员** | 2人 | **2-3人** | +1人(测试) |

---

## 一、时间线确认

### 1.1 最终时间线

```
┌─────────────────────────────────────────────────────────────┐
│                    v1.1.4 开发时间线 (12周)                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Month 1: 基础设施 + 重构 (Week 1-4)                         │
│    Week 1-2:  架构重构 Phase 1-2 + 安全基线                 │
│    Week 3-4:  架构重构 Phase 3 + 测试框架                   │
│                                                             │
│  Month 2: 核心功能开发 (Week 5-8)                            │
│    Week 5-6:  WASM 执行 + P2P 加密                          │
│    Week 7-8:  Agent 联邦 + 调度器完善                       │
│                                                             │
│  Month 3: 测试 + 优化 + 发布 (Week 9-12)                     │
│    Week 9-10: 测试用例编写 + 覆盖率达标                     │
│    Week 11:  性能优化 + 安全加固                            │
│    Week 12:  回归测试 + 发布准备                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 里程碑

| 里程碑 | 日期 | 交付物 | 验收标准 |
|--------|------|--------|---------|
| **M1: 基础就绪** | Week 4 | 架构重构 Phase 1-3、测试框架 | 重构完成、测试框架可用 |
| **M2: 核心功能** | Week 8 | WASM、P2P、联邦可用 | P0 功能测试通过 |
| **M3: 测试达标** | Week 10 | 测试覆盖率 70% | CI 全部通过 |
| **M4: 发布就绪** | Week 12 | 性能达标、安全审计通过 | 发布条件满足 |

### 1.3 关键路径

```
架构重构 (4周)
    │
    ▼
WASM 执行 (2周) ──┬── P2P 加密 (2周)
    │              │
    ▼              ▼
Agent 联邦 (2周) ──┴── 调度器 (1周)
    │
    ▼
测试 (2周)
    │
    ▼
优化 + 发布 (2周)
```

---

## 二、范围优先级

### 2.1 P0 - 必须完成 (6项)

| 序号 | 项目 | 工作量 | 负责人 | 验收标准 |
|------|------|--------|--------|---------|
| **P0-1** | **架构重构 Phase 1-3** | 20d | | 配置抽象 + 全局状态 + 事件总线 |
| **P0-2** | **安全基线建立** | 5d | | 威胁模型 + 加固清单 |
| **P0-3** | **WASM 基础执行** | 10d | | 加载 → 执行 → 清理可用 |
| **P0-4** | **P2P 传输加密** | 5d | | Noise Protocol 集成 |
| **P0-5** | **WASM 沙箱审计** | 3d | | 资源限制 + 逃逸测试 |
| **P0-6** | **测试框架搭建** | 5d | | CI/CD + Mock 框架 |

**小计**: 48 人天

### 2.2 P1 - 尽量完成 (8项)

| 序号 | 项目 | 工作量 | 负责人 | 验收标准 |
|------|------|--------|--------|---------|
| **P1-1** | P2P 连接处理循环 | 3d | | 双向通信稳定 |
| **P1-2** | Agent 联邦事件订阅 | 3d | | Matrix 事件流可用 |
| **P1-3** | 远程任务处理 | 4d | | 任务分发 → 执行 → 返回 |
| **P1-4** | 输入验证框架 | 2d | | 统一验证接口 |
| **P1-5** | 命令白名单 | 2d | | Agent 命令限制 |
| **P1-6** | 测试用例编写 | 15d | | 覆盖率 70% |
| **P1-7** | DAG Skill 执行 | 3d | | 递归执行可用 |
| **P1-8** | 安全加固实施 | 8d | | P0/P1 安全问题解决 |

**小计**: 40 人天

### 2.3 P2 - 可以下版 (延后到 v1.1.5)

| 序号 | 项目 | 原因 |
|------|------|------|
| **P2-1** | 架构重构 Phase 4 (大文件拆分) | 不阻塞功能 |
| **P2-2** | 架构重构 Phase 5 (存储抽象) | 可以后续重构 |
| **P2-3** | 端口合并 (2端口方案) | 不影响核心功能 |
| **P2-4** | P2P DHT 完整实现 | 简化版本够用 |
| **P2-5** | NAT Relay 打洞 | 大多数场景不需要 |
| **P2-6** | Worker 监控真实数据 | CLI 优化，非核心 |
| **P2-7** | 终端 Resize 支持 | 边缘场景 |
| **P2-8** | 日志跟随实现 | CLI 优化 |

---

## 三、人员分工

### 3.1 建议配置

```
┌─────────────────────────────────────────────────────────────┐
│                      团队配置建议                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  开发 A (全职):                                             │
│    - 架构重构 (20d)                                         │
│    - WASM 执行 (10d)                                        │
│    - Agent 联邦 (7d)                                        │
│                                                             │
│  开发 B (全职):                                             │
│    - P2P 网络 (加密 + 连接) (8d)                            │
│    - 调度器 (4d)                                            │
│    - 安全加固 (8d)                                          │
│                                                             │
│  测试/安全 (兼职 50%):                                      │
│    - 测试框架搭建 (5d)                                      │
│    - 测试用例编写 (15d)                                     │
│    - 安全基线 + 审计 (8d)                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技能要求

| 角色 | 必备技能 | 加分技能 |
|------|---------|---------|
| **开发 A** | Rust, WASM, 架构设计 | async/await, trait system |
| **开发 B** | Rust, 网络编程, P2P | libp2p, QUIC, noise protocol |
| **测试/安全** | Rust, 测试框架 | security audit, penetration testing |

---

## 四、验收标准

### 4.1 功能验收

#### P0 功能 (100% 通过)

```bash
# WASM Skill 执行
cis skill run test-skill
# 预期: 成功执行并返回结果

# P2P 加密连接
cis node connect <peer-id>
# 预期: 加密连接建立成功

# Agent 联邦任务
cis agent federate <remote-node>
cis agent dispatch --remote <task-id>
# 预期: 任务分发到远程节点并返回结果
```

#### P1 功能 (80% 通过)

```bash
# P2P 连接稳定性
# 预期: 1000 次数据传输，成功率 > 99%

# DAG Skill 执行
cis dag run test-dag
# 预期: 依赖正确解析，任务按序执行
```

### 4.2 性能验收

| 指标 | 目标 | 测量方法 |
|------|------|---------|
| WASM 启动时间 | < 100ms | `cargo bench --bench wasm_startup` |
| P2P 连接建立 | < 5s | 集成测试 |
| 联邦任务分发 | < 1s | 压测脚本 |
| 内存占用 | < 500MB | `heaptrack` |

### 4.3 安全验收

- [ ] `cargo audit` 无高危漏洞
- [ ] Wireshark 抓包无法解析 P2P 内容
- [ ] WASM 沙箱逃逸测试通过
- [ ] 命令白名单测试通过
- [ ] 输入验证覆盖率 100%

### 4.4 测试验收

| 模块 | 覆盖率目标 |
|------|-----------|
| `p2p/` | 75% |
| `wasm/` | 80% |
| `agent/federation/` | 75% |
| 整体 | **70%** |

### 4.5 质量门禁

- [ ] CI 全部通过
- [ ] Code Review 通过
- [ ] 无 P0/P1 Bug
- [ ] 性能基准达标

---

## 五、风险管理

### 5.1 Top 3 风险

| 风险 | 概率 | 影响 | 缓解措施 | 负责人 |
|------|------|------|---------|--------|
| **WASM 集成延迟** | 中 | 高 | 2周后评估，必要时降级到 Native Skill | |
| **P2P 加密性能差** | 低 | 中 | 预先性能测试，准备替代方案 | |
| **人力不足** | 中 | 高 | 及早识别，必要时外包/延期 | |

### 5.2 应急预案

#### 场景 A: WASM 无法按时完成

```yaml
trigger: Week 6 进度 < 50%
actions:
  - 降低 WASM 优先级
  - 先实现 Native Skill 联邦
  - WASM 延迟到 v1.1.5
decision: 项目负责人
```

#### 场景 B: 测试覆盖率无法达标

```yaml
trigger: Week 10 覆盖率 < 60%
actions:
  - 延长测试周期 1 周
  - 降低目标到 65%
  - 标记技术债
decision: 技术负责人
```

#### 场景 C: 发现严重安全漏洞

```yaml
trigger: 任何时候发现 CVE
actions:
  - 立即停止新功能开发
  - 专注修复漏洞
  - 评估是否需要重新发布
decision: 安全负责人 + 项目负责人
```

---

## 六、不在范围内的内容

### 6.1 明确排除

| 功能 | 原因 | 计划版本 |
|------|------|---------|
| 端口合并 (2端口) | 不阻塞核心功能 | v1.2.0 |
| 架构重构 Phase 4-5 | 不阻塞开发 | v1.2.0 |
| P2P DHT 完整实现 | 简化版本够用 | v1.2.0 |
| GUI 功能完善 | 资源优先核心 | v1.3.0 |
| 性能深度优化 | 不是本版重点 | v1.2.0 |

### 6.2 有条件包含

| 功能 | 条件 | 决策时间点 |
|------|------|-----------|
| NAT Relay 打洞 | P0/P1 全部提前完成 | Week 8 |
| Worker 监控真实数据 | 节省时间 > 3天 | Week 10 |
| 终端 Resize 支持 | 有现成库可用 | Week 6 |

---

## 七、依赖和假设

### 7.1 外部依赖

| 依赖项 | 版本 | 风险 | 缓解 |
|--------|------|------|------|
| wasmer | 4.x | API 变更 | 锁定版本 |
| libp2p | 0.53 | 文档不全 | 社区支持 |
| tokio | 1.x | 稳定 | 已成熟 |

### 7.2 假设条件

- [ ] 人力稳定，无关键人员流失
- [ ] 无外部依赖重大变更
- [ ] 测试环境可用
- [ ] 安全审计无重大阻碍

---

## 八、成功指标

### 8.1 定量指标

| 指标 | 目标 | 当前基线 |
|------|------|---------|
| WASM Skill 可用性 | 100% | 0% |
| P2P 连接成功率 | > 99% | ?% |
| 测试覆盖率 | 70% | ?% |
| 安全高危漏洞 | 0 | ? |

### 8.2 定性指标

- [ ] 团队对架构有信心
- [ ] 代码可维护性提升
- [ ] 安全基线建立
- [ ] 测试文化形成

---

## 九、变更控制

### 9.1 范围变更流程

```
提出变更
    │
    ▼
影响评估 (工作量/时间/风险)
    │
    ▼
决策 (负责人审批)
    │
    ▼
更新文档
    │
    ▼
通知团队
```

### 9.2 变更审批权限

| 变更类型 | 审批人 | 示例 |
|---------|--------|------|
| P0 范围变更 | 项目负责人 + 技术负责人 | 新增 P0 项目 |
| P1 范围变更 | 技术负责人 | P1 项目调整 |
| 时间线变更 | 项目负责人 | 延期 1 周以上 |
| 人员变更 | 项目负责人 | 关键人员更换 |

---

## 十、附录

### 10.1 工作量汇总

| 优先级 | 项目数 | 总工作量 |
|--------|--------|---------|
| P0 | 6 | 48d |
| P1 | 8 | 40d |
| **总计** | **14** | **88d** |

按 2.5 人 (2全职 + 0.5兼职) 计算：
- 开发周数: 88 / (2.5 × 5) = 7 周
- 缓冲 (30%): 2 周
- 测试周: 2 周
- **总计**: 11 周 → 取整 **12 周**

### 10.2 相关文档

- [REVIEW_CLAUDE.md](./REVIEW_CLAUDE.md) - 外部评审报告
- [SECURITY_ASSESSMENT.md](./SECURITY_ASSESSMENT.md) - 安全评估
- [TESTING_STRATEGY.md](./TESTING_STRATEGY.md) - 测试策略
- [ROADMAP.md](./ROADMAP.md) - 版本路线图
- [TASK_BREAKDOWN.md](./TASK_BREAKDOWN.md) - 详细任务

---

*文档状态: 草案*
*待团队评审确认后生效*
*最后更新: 2026-02-10*
