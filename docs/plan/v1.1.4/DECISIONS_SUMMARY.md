# CIS v1.1.4/v1.1.5 决策总结

> 用户决策记录和下一步行动
> 日期: 2026-02-10

---

## 用户决策确认

### 决策 1: Mock 降级策略 ✅
**选择**: **A. 强制启用 features**

**实施**: 
- 移除所有 `#[cfg(not(feature = "..."))]` 下的 Mock 降级代码
- 使用 `compile_error!` 强制要求必要 features
- 修改 `ServiceContainer::production()`

**状态**: 已规划到 v1.1.5 (P0-1)
**截止日期**: 2026-02-20

---

### 决策 2: P2P_INSTANCE 全局单例 ✅
**选择**: **详细解释后确认分阶段迁移**

**详细分析**: [DECISION_P2P_INSTANCE_ANALYSIS.md](./DECISION_P2P_INSTANCE_ANALYSIS.md)

**关键结论**:
- 一次性移除风险太高（2-3 周工作量，可能引入回归 bug）
- 采用**分阶段迁移方案**:
  - v1.1.5: 迁移 Agent Federation 和 Matrix Bridge
  - v1.1.6: 迁移次要服务
  - v1.2.0: 完全移除全局单例

**状态**: 第一阶段规划到 v1.1.6 (P1-1)

---

### 决策 3: DHT 实现策略 ✅
**选择**: **A. 完整 Kademlia**

**实施**:
- 实现标准 Kademlia DHT 协议
- 包括 K-buckets、XOR 距离、迭代查找
- 替换当前的简化广播实现

**状态**: 已规划到 v1.1.5 (P0-2)
**截止日期**: 2026-02-28

---

### 决策 4: 密钥加密方案 ✅
**选择**: **使用 SSH Key (替代原密码方案)**

**详细方案**: [DECISION_SSH_KEY_ALTERNATIVE.md](./DECISION_SSH_KEY_ALTERNATIVE.md)

**关键优势**:
- 复用现有 SSH 基础设施
- 支持 ssh-agent（无需重复输入密码）
- 支持硬件密钥（YubiKey）
- 跨设备同步通过 SSH config

**实施**:
- 使用 SSH key 派生对称密钥
- 加密节点私钥存储
- 集成 ssh-agent 自动解锁

**状态**: 已规划到 v1.1.5 (P0-4)，替代原 SEC-3
**截止日期**: 2026-03-01

---

### 决策 5: 命令白名单策略 ✅
**选择**: **C. 分级权限**

**实施**:
```rust
pub enum CommandPermission {
    ReadOnly,      // Mechanical level: ls, cat, grep
    ReadWrite,     // Recommended level: + edit files
    System,        // Confirmed level: + system commands
    Dangerous,     // Arbitrated level: rm, format (require human confirm)
}
```

**状态**: 已规划到 v1.1.5 (P0-5)
**截止日期**: 2026-02-25

---

### 决策 6: v1.1.5 范围调整 ✅
**选择**: **调整（聚焦高优先级）**

**详细方案**: [v1.1.5_SCOPE_ADJUSTED.md](./v1.1.5_SCOPE_ADJUSTED.md)

**关键调整**:
- v1.1.5: 6 个高优先级任务（原 9 个耻辱标签中的核心部分）
- v1.1.6: 中优先级问题（全局单例迁移、用户体验）
- v1.2.0: 架构完善（完全移除全局单例等）

**时间线**:
- v1.1.5: ~9 周（6 周开发 + 3 周测试缓冲）
- v1.1.6: ~5 周
- v1.2.0: 待定

---

## 调整后 v1.1.5 范围

### P0 任务 (必须完成)

| 编号 | 任务 | 工作量 | 截止日期 |
|------|------|--------|---------|
| P0-1 | Mock 降级移除 | 3 天 | 2026-02-20 |
| P0-2 | 完整 Kademlia DHT | 7 天 | 2026-02-28 |
| P0-3 | P2P 连接处理循环 | 5 天 | 2026-02-25 |
| P0-4 | SSH Key 密钥保护 | 7 天 | 2026-03-01 |
| P0-5 | 分级权限命令白名单 | 5 天 | 2026-02-25 |
| P0-6 | 安全加固 (4项) | 10 天 | 2026-03-05 |
| - | 缓冲/测试 | 7 天 | - |
| **总计** | **44 天 (~9 周)** | | |

### 延后到 v1.1.6

- P2P 全局单例第一阶段迁移
- 倒计时键盘监听
- 主题订阅/GossipSub

---

## 配置文件更新

### `.claude/settings.local.json`

已更新，新增：
- 开发规则（禁止 mock、必须错误处理等）
- 项目信息
- 当前阶段标记

---

## 耻辱标签更新

### 当前状态

| 类别 | 待修复 | 已修复 | 说明 |
|------|--------|--------|------|
| SEC (安全) | 5 | 0 | SEC-3 替换为 SSH Key 方案 |
| NEW (新增) | 4 | 0 | 6 个中的 4 个在 v1.1.5 |
| D02 (全局状态) | 1 | 1 | 3 个中的 1 个在 v1.1.5 |
| **总计** | **10** | **1** | |

### 详细列表

**v1.1.5 待修复**:
1. NEW-3: Mock 降级
2. NEW-1: DHT 完整实现
3. NEW-2: P2P 连接循环
4. P0-4: SSH Key (替代 SEC-3)
5. P0-5: 分级权限 (SEC-1)
6. SEC-2: WASI 限制
7. SEC-4: 证书固定
8. SEC-5: 速率限制
9. SEC-6: 输入验证
10. D02-2: 全局单例 (部分)

**v1.1.6 延后**:
- NEW-5: 倒计时键盘监听
- NEW-6: 主题订阅

**v1.2.0 延后**:
- NEW-4: 完全移除全局单例

---

## 下一步行动

### 立即执行 (本周)

1. **开始 v1.1.5 开发**
   - 按优先级执行 P0-1 (Mock 降级移除)
   - 并行启动 P0-2 (Kademlia DHT) 设计

2. **技术准备**
   - 研究 Kademlia 算法细节
   - 调研 SSH key 库 (ssh-key, ssh-agent-client)
   - 设计分级权限数据结构

3. **文档更新**
   - 更新架构文档
   - 编写实现指南

### 本周完成标准

- [ ] P0-1 Mock 降级移除完成
- [ ] Kademlia DHT 设计文档
- [ ] SSH Key 方案详细设计
- [ ] 分级权限接口设计

---

## 决策记录

| 决策 | 选择 | 状态 | 文档 |
|------|------|------|------|
| Mock 降级 | A. 强制启用 | ✅ 确认 | 本文件 |
| 全局单例 | 分阶段迁移 | ✅ 确认 | DECISION_P2P_INSTANCE_ANALYSIS.md |
| DHT 实现 | A. 完整 Kademlia | ✅ 确认 | 本文件 |
| 密钥加密 | SSH Key 方案 | ✅ 确认 | DECISION_SSH_KEY_ALTERNATIVE.md |
| 命令白名单 | C. 分级权限 | ✅ 确认 | 本文件 |
| v1.1.5 范围 | 调整 | ✅ 确认 | v1.1.5_SCOPE_ADJUSTED.md |

**所有决策已确认，可以开始 v1.1.5 开发！**

---

*决策时间: 2026-02-10*  
*执行开始: 立即*
