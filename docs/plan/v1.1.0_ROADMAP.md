# CIS v1.1.0 生产就绪路线图

**版本**: v1.1.0  
**代号**: Production Ready  
**目标日期**: 2026 Q2 (约 12 周)  
**基线版本**: v1.0.0 (Foundation)  
**文档版本**: 2.0.0 (综合外界评估与内部规划)

---

## 📊 当前状态 (v1.0.0)

```
整体完成度: ████████░░ 80% (来自 kimi_agent 评估)

核心引擎:   ██████████ 90% ✅ DAG、存储、安全
Matrix联邦: █████████░ 85% ✅ 端口6767/7676分离
存储系统:   █████████░ 90% ✅ 分离存储设计
安全机制:   █████████░ 90% ✅ ChaCha20/Ed25519

GUI界面:    █████░░░░░ 50% ⚠️ 演示数据阶段
WASM Skill: ████░░░░░░ 40% ⚠️ execute_wasm()为todo!
IM集成:     ███░░░░░░░ 30% ⚠️ MatrixAdapter占位符
P2P网络:    ██████░░░░ 60% ⚠️ mDNS+QUIC部分实现

测试覆盖:   ████░░░░░░ 40% 🔴 SIGBUS等测试失败
代码质量:   ████████░░ 80% ✅ 编译通过，4个警告
```

### 🔴 P0 阻塞问题 (必须解决)
1. **SIGBUS 内存错误** - `memory/service.rs`, `storage/db.rs` 测试失败
2. **GUI 演示数据** - 无法生产使用，需连接真实数据库

---

## 🎯 v1.1.0 目标

### 核心目标
从"基础可用"推进至"生产就绪"

| 维度 | v1.0.0 | v1.1.0 目标 |
|------|--------|-------------|
| 完成度 | 80% | 95%+ |
| 测试覆盖率 | ~40% | 70%+ |
| 生产可用 | ⚠️ 部分 | ✅ 完整 |
| 安全审计 | ⚠️ 未审计 | ✅ 通过 |

### 成功标准
```yaml
稳定性:
  单元测试: 100% 通过
  集成测试: 100% 通过
  E2E测试: > 95% 通过
  无内存错误: SIGBUS/SIGSEGV = 0

功能完整:
  WASM执行: 完整Host API
  四级决策: 全部实现
  GUI: 真实数据+实时更新
  P2P组网: LAN+WAN+NAT穿透
  Element集成: 双向命令+E2EE

性能基线:
  DAG执行P95: < 100ms
  向量检索P95: < 50ms
  内存使用: < 200MB
  启动时间: < 2s

安全合规:
  高危漏洞: 0
  中危漏洞: 0
  渗透测试: 通过
```

---

## 📅 阶段规划

### Phase 1: 稳定性加固 (Week 1-2)
**主题**: 修复所有阻塞问题，建立生产基线

#### Week 1: 内存安全修复

| 任务包 | 优先级 | 负责人 | 原子任务 | 验收标准 |
|--------|--------|--------|----------|----------|
| P1-1 内存安全 | P0 | Agent-A | 3个 | SIGBUS修复 |
| P1-2 WebSocket测试 | P0 | Agent-B | 3个 | 测试通过 |
| P1-3 项目注册表 | P0 | Agent-C | 2个 | 测试通过 |

**原子任务详情**:
- [ ] **P1-1.1** 修复 `memory::service::tests::test_memory_service_delete`
  - 问题: 异步删除竞态条件
  - 方案: 添加 `Arc<Mutex<>>` 保护
  - 验收: 连续运行100次通过

- [ ] **P1-1.2** 修复 `storage::db::tests::test_core_db`
  - 问题: 数据库连接池未隔离
  - 方案: 使用 `tempfile::TempDir`
  - 验收: 并行测试无冲突

- [ ] **P1-2.1** 修复 `test_sync_response_handling`
  - 问题: 异步响应超时
  - 方案: 增加 `tokio::time::timeout`

- [ ] **P1-3.1** 修复 `test_project_skill_config`
  - 问题: 临时目录清理失败
  - 方案: RAII模式 `tempfile::TempDir`

#### Week 2: 测试与CI强化

| 任务包 | 优先级 | 负责人 | 原子任务 | 验收标准 |
|--------|--------|--------|----------|----------|
| P1-4 E2E测试 | P1 | Agent-D | 4个 | E2E套件 |
| P1-5 CI/CD | P1 | Agent-E | 4个 | 工作流 |
| P1-6 编译警告 | P2 | Agent-F | 3个 | 0警告 |
| P1-8 验收 | P0 | Lead | - | 基线达标 |

**交付标准**:
```bash
cargo test --lib  # 100% 通过
cargo clippy      # 0 警告
cargo tarpaulin   # > 80% 覆盖率
```

---

### Phase 2: 核心功能完善 (Week 3-6)
**主题**: 完成所有核心功能，达到功能完整

#### Week 3-4: WASM 与决策

| 任务包 | 优先级 | 依赖 | 关键产出 |
|--------|--------|------|----------|
| P2-1 WASM执行 | P0 | P1-1 | `feat/wasm-execution/` |
| P2-2 四级决策 | P0 | - | 全部四级实现 |

**P2-1 WASM 执行详情**:
```rust
// 当前状态
async fn execute_wasm(&self, wasm_bytes: &[u8], inputs: Value) -> Result<Value> {
    todo!("WASM execution not yet implemented")
}

// 目标状态
- [x] 选择运行时 (wasmtime/wasmer)
- [x] 模块加载与缓存
- [x] Host API: memory_get/set, ai_chat, log, http_post
- [x] 资源限制: CPU<30s, 内存<128MB
- [x] 输入输出序列化 (JSON)
```

**P2-2 四级决策详情**:
| 级别 | 当前状态 | 需实现 | 验收 |
|------|----------|--------|------|
| Mechanical | ✅ | - | 自动执行 |
| Recommended | ⚠️ | 倒计时机制 | 30s超时降级 |
| Confirmed | ⚠️ | 用户确认 | CLI提示Y/n |
| Arbitrated | ⚠️ | 仲裁工作流 | Raft共识 |

#### Week 5-6: GUI 与网络

| 任务包 | 优先级 | 依赖 | 关键产出 |
|--------|--------|------|----------|
| P2-3 GUI数据 | P1 | P1-1 | 真实数据连接 |
| P2-4 P2P组网 | P1 | - | LAN+WAN+NAT |

**P2-3 GUI 数据连接**:
```
方案: 共享SQLite (推荐)
- NodeStore → node.db
- MemoryStore → memory.db  
- MatrixStore → matrix-social.db

实时更新:
- 方式A: SQLite notify + 轮询
- 方式B: WebSocket推送
- 选择: 先实现轮询，后续优化
```

**P2-4 P2P 组网**:
- [x] mDNS 局域网发现 (优化广播频率)
- [x] DHT 广域网发现 (Kademlia)
- [x] NAT穿透 (STUN+TURN+UPnP)
- [x] 连接质量监测 (延迟/丢包/带宽)

---

### Phase 3: 性能优化 (Week 7-8)
**主题**: 达到生产级性能指标

| 任务包 | 优先级 | 依赖 | 目标 |
|--------|--------|------|------|
| P3-1 内存优化 | P1 | P1-1,P2-1 | 空闲<50MB |
| P3-2 异步优化 | P1 | P1-1 | 10并发DAG |
| P3-3 存储优化 | P1 | - | 查询<5ms |
| P3-4 启动优化 | P2 | - | 冷启动<2s |

**性能基线**:
```yaml
DAG执行:
  P50: < 50ms
  P95: < 100ms
  P99: < 200ms

向量检索:
  P50: < 20ms
  P95: < 50ms (10k向量)

吞吐量:
  DAG/秒: >= 100
  向量检索/秒: >= 1000
```

---

### Phase 4: 生态集成 (Week 9-10)
**主题**: 建立完整生态，降低使用门槛

| 任务包 | 优先级 | 依赖 | 关键产出 |
|--------|--------|------|----------|
| P4-1 Element集成 | P0 | P2-4 | Matrix AppService |
| P4-2 VS Code插件 | P1 | - | 侧边栏+命令 |
| P4-3 Homebrew | P1 | P1-5 | Tap发布 |
| P4-4 文档完善 | P1 | - | 完整文档 |

**P4-1 Element 集成**:
```
功能:
- CIS作为Matrix AppService注册
- 自动创建项目Room (#cis-<project>)
- DAG状态广播到Room
- 双向命令 (!cis run <dag>)
- E2EE支持 (Olm/Megolm)
```

---

### Phase 5: 安全审计 (Week 11)
**主题**: 达到生产级安全标准

| 任务包 | 优先级 | 依赖 | 关键产出 |
|--------|--------|------|----------|
| P5-1 代码审计 | P0 | P1~P4 | 审计报告 |
| P5-2 渗透测试 | P0 | P5-1 | 测试报告 |
| P5-3 安全配置 | P1 | - | 安全文档 |

**审计标准**:
```yaml
代码安全:
  高危漏洞: 0
  中危漏洞: 0
  unsafe块: 有文档说明
  加密实现: 通过审查

渗透测试:
  未授权访问: 0
  数据泄露: 0
  模糊测试: 无崩溃
```

---

### Phase 6: 发布准备 (Week 12)
**主题**: 正式发布 v1.1.0

| 任务包 | 优先级 | 依赖 | 关键产出 |
|--------|--------|------|----------|
| P6-1 版本发布 | P0 | P1~P5 | GitHub Release |
| P6-2 发布营销 | P1 | P6-1 | 博客+视频 |
| P6-4 最终验收 | P0 | P6-1~3 | 发布报告 |

---

## 📋 任务总览

### 按阶段统计

| 阶段 | 周数 | 任务包 | 原子任务 | 并行度 | 人天 |
|------|------|--------|----------|--------|------|
| Phase 1: 稳定性 | 2 | 8 | 32 | 6 | 14 |
| Phase 2: 核心功能 | 4 | 10 | 38 | 8 | 26 |
| Phase 3: 性能优化 | 2 | 4 | 16 | 4 | 10 |
| Phase 4: 生态集成 | 2 | 4 | 16 | 4 | 12 |
| Phase 5: 安全审计 | 1 | 3 | 10 | 2 | 7 |
| Phase 6: 发布准备 | 1 | 3 | 8 | 3 | 5 |
| **总计** | **12** | **32** | **120** | - | **74** |

### 按优先级统计

| 优先级 | 任务包数 | 说明 |
|--------|----------|------|
| P0 (阻塞) | 12 | 必须完成，影响发布 |
| P1 (重要) | 16 | 应该完成，影响体验 |
| P2 (建议) | 4 | 增值功能，可延后 |

---

## 🔗 关键依赖链

```
Phase 1 (稳定性)
├── P1-1 内存安全 ───┐
├── P1-2 WebSocket ──┤
├── P1-3 注册表 ─────┤ → P1-4 E2E测试 → P1-8 验收
└── P1-5 CI/CD ──────┘

Phase 2 (核心功能)
├── P2-1 WASM ───────┐ ← 依赖 P1-1
├── P2-2 决策 ───────┤
├── P2-3 GUI ────────┤ ← 依赖 P1-1
├── P2-4 P2P ────────┘ → P4-1 Element
└── P2-10 验收

Phase 3-6
├── Phase 3 性能 ← P1-1, P2-1
├── Phase 4 生态 ← P2-4 (Element)
├── Phase 5 安全 ← P1~P4
└── Phase 6 发布 ← P1~P5
```

---

## 👥 AI Agent 分配建议

### Agent 类型与技能要求

| 类型 | 技能 | 负责任务 |
|------|------|----------|
| Rust-Core | Rust精通、异步 | P1-1, P1-2, P2-1, P3-1, P3-2 |
| Network | 网络协议、P2P | P1-2, P2-4, P4-1 |
| Frontend | egui、TS | P2-3, P4-2 |
| DevOps | CI/CD、容器 | P1-5, P4-3 |
| Security | 加密、渗透 | P5-1, P5-2 |
| Docs | 技术写作 | P4-4, P6-2 |
| Lead | 项目管理 | 各Phase验收 |

### Week 1-2 分配示例

```yaml
Week 1:
  Agent-A (Rust-Core): P1-1 内存安全
  Agent-B (Network): P1-2 WebSocket
  Agent-C (Rust-Core): P1-3 注册表
  Agent-D (DevOps): P1-5 CI/CD
  Agent-E (Rust-Core): P1-6 编译警告

Week 2:
  Agent-Lead: P1-4 E2E测试 ← 等待 P1-1/2/3
  Agent-Lead: P1-8 验收
  Agent-A: P2-1 WASM ← 等待 P1-1
  Agent-F (Network): P2-4 P2P组网
```

---

## ⚠️ 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| SIGBUS修复困难 | 中 | 高 | 预留缓冲时间，使用AddressSanitizer |
| WASM复杂度高 | 中 | 高 | 提前调研，备选wasmer/wasmtime |
| GUI工作量大 | 高 | 中 | 简化功能，先只读后交互 |
| 安全审计问题 | 高 | 高 | 预留1周缓冲，提前自查 |
| 性能不达预期 | 中 | 中 | 设定合理基线，渐进优化 |

---

## 📚 参考文档

### 当前版本 (v1.0.0)
- [发布说明](../releases/v1.0.0/README.md)
- [评估报告](./archives/kimi_agent.md)
- [生产就绪计划](./CIS_PRODUCTION_READINESS_PLAN.md)

### 设计文档
- [架构设计](./ARCHITECTURE_DESIGN.md)
- [DAG架构](./DAG_SKILL_ARCHITECTURE.md)
- [网络设计](./NETWORK_ACCESS_DESIGN.md)
- [GUI设计](./GUI_ELEMENT_STYLE_DESIGN.md)

---

## 📝 变更日志

| 版本 | 日期 | 变更 |
|------|------|------|
| 2.0.0 | 2026-02-08 | 综合外界评估与生产就绪计划重构 |
| 1.0.0 | 2026-02-08 | 初始版本 |

---

**制定**: CIS Core Team  
**审核**: 综合 kimi_agent 评估 + CIS_PRODUCTION_READINESS_PLAN  
**更新**: 每周回顾调整
