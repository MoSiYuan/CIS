# CIS v1.1.7 è®°å¿†ç³»ç»Ÿæ”¹ç‰ˆ - å®Œæ•´å¼€å‘æŒ‡å—

> **ç‰ˆæœ¬**: v1.1.7
> **å‘å¸ƒæ—¥æœŸ**: 2026-02-13
> **çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½
> **å…³è”**:
> - [è®°å¿†æ¥æºå¯ä¿¡åº¦è®¾è®¡](./MEMORY_SOURCE_TRUST_DESIGN.md)
> - [ä¸Šä¸‹æ–‡å‹ç¼©ä¸ä»»åŠ¡å»¶ç»­æ€§](./CONTEXT_COMPRESSION_AND_TASK_CONTINUITY.md)
> - [Agent-CIS æ¡¥æ¥å±‚è®¾è®¡](./AGENT_CIS_INTEGRATION.md)
> - [è®°å¿†ä½œç”¨åŸŸéš”ç¦»è®¾è®¡](./MEMORY_SCOPE_ISOLATION_DESIGN.md)

---

## ç›®å½•

1. [è®¾è®¡ç›®æ ‡](#è®¾è®¡ç›®æ ‡)
2. [æ ¸å¿ƒé—®é¢˜è¯Šæ–­](#æ ¸å¿ƒé—®é¢˜è¯Šæ–­)
3. [å®Œæ•´è§£å†³æ–¹æ¡ˆ](#å®Œæ•´è§£å†³æ–¹æ¡ˆ)
4. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
5. [API å‚è€ƒ](#api-å‚è€ƒ)
6. [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
7. [æµ‹è¯•æŒ‡å—](#æµ‹è¯•æŒ‡å—)

---

## è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

è§£å†³å½“å‰ AI ç³»ç»Ÿçš„å››å¤§è®°å¿†é—®é¢˜ï¼š

#### 1. è®°å¿†æ±¡æŸ“é—®é¢˜

**ç°çŠ¶**ï¼šAI æ¨æ–­æ±¡æŸ“è®°å¿†ç©ºé—´ï¼Œå¯¼è‡´è¿‡åº¦è”æƒ³å’Œé”™è¯¯å›ç­”

**åœºæ™¯**ï¼ˆæ¥è‡ªç”¨æˆ·åé¦ˆï¼‰ï¼š
```
ç”¨æˆ·ï¼š"æˆ‘å–œæ¬¢æ·±è‰²ä¸»é¢˜"
AI æ¨æ–­ï¼š"ç”¨æˆ·å¯èƒ½åå¥½æ·±è‰²ä¸»é¢˜ï¼Œå› ä¸ºå¤œé—´ä½¿ç”¨é¢‘ç‡é«˜..."
    â†“ è¢«å­˜å‚¨å¹¶ç´¢å¼•
ç”¨æˆ·é—®ï¼š"æˆ‘ä¹‹å‰è®¾ç½®è¿‡ä»€ä¹ˆä¸»é¢˜ï¼Ÿ"
AI å›ç­”ï¼š"æ‚¨å¯èƒ½åå¥½æ·±è‰²ä¸»é¢˜...å› ä¸ºå¤œé—´ä½¿ç”¨é¢‘ç‡é«˜..."  // ğŸ”´ æ±¡æŸ“ï¼
```

**v1.1.7 è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… è®°å¿†æ¥æºå¯ä¿¡åº¦è¿½è¸ªï¼ˆMemorySource æšä¸¾ï¼‰
- âœ… æ¡ä»¶åŒ–å‘é‡ç´¢å¼•ï¼ˆåªæœ‰å¯ä¿¡å†…å®¹æ‰ç´¢å¼•ï¼‰
- âœ… ä½œç”¨åŸŸéš”ç¦»ï¼ˆé¿å…è·¨é¡¹ç›®/æ¨¡å—æ±¡æŸ“ï¼‰
- âœ… è®°å¿†æ±¡æŸ“æ£€æµ‹å’Œæ¸…ç†ï¼ˆv1.1.7 Phase 1-3ï¼‰

#### 2. ä¸Šä¸‹æ–‡å‹ç¼©å¤±çœŸé—®é¢˜

**ç°çŠ¶**ï¼šå‹ç¼©åæ•°æ®å¤±çœŸï¼Œå¯¼è‡´ä»»åŠ¡å»¶ç»­æ€§ä¸‹é™

**åœºæ™¯**ï¼š
```
åŸå§‹ä¸Šä¸‹æ–‡ï¼ˆ100K tokensï¼‰
    â†“ AI å‹ç¼©ï¼ˆæ—¶é—´çª—å£ã€æ‘˜è¦ç”Ÿæˆï¼‰
å‹ç¼©åä¸Šä¸‹æ–‡ï¼ˆ30K tokensï¼‰
    â†“ ä¸¢å¤±å…³é”®ä¿¡æ¯ï¼ˆUserForced æ¶æ„å†³ç­–ï¼‰
Agent ç†è§£åå·® â†’ ä»»åŠ¡æ‰§è¡Œå¤±è´¥
```

**v1.1.7 è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… åˆ†å±‚å¯ä¿¡åº¦å‹ç¼©ï¼ˆUserForced å®Œæ•´ä¿ç•™ï¼ŒAIInferred æåº¦å‹ç¼©ï¼‰
- âœ… ä»»åŠ¡é“¾è¿½è¸ªï¼ˆä¿éšœä»»åŠ¡å»¶ç»­æ€§ï¼‰
- âœ… å…³é”®ä¿¡æ¯é”šç‚¹ï¼ˆå¿…é¡»ä¿ç•™çš„ä¿¡æ¯ï¼‰
- âœ… è‡ªé€‚åº”å‹ç¼©æ¯”è°ƒæ•´ï¼ˆåŠ¨æ€ä¼˜åŒ–ï¼‰

#### 3. Agent è®°å¿†ç³»ç»Ÿé›†æˆé—®é¢˜

**ç°çŠ¶**ï¼šAgent çš„å‹ç¼©æœºåˆ¶ä¸ CIS è®°å¿†ç³»ç»Ÿå„è‡ªä¸ºæ”¿

**åœºæ™¯**ï¼š
```
Claude Agent:
  - Context window: 200K tokens
  - å†…éƒ¨å‹ç¼©ç­–ç•¥ï¼šæ—¶é—´çª—å£æ»‘åŠ¨
  - ğŸ”´ ä¸çŸ¥é“å“ªäº›æ˜¯ UserForcedã€UserInputã€AIInferred

CIS è®°å¿†ç³»ç»Ÿ:
  - MemorySource å¯ä¿¡åº¦ä½“ç³»
  - ğŸ”´ ä¸çŸ¥é“ Agent éœ€è¦å“ªäº›ä¸Šä¸‹æ–‡
  - ğŸ”´ æ— æ³•å½±å“ Agent çš„å‹ç¼©å†³ç­–
```

**v1.1.7 è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… Agent-CIS åŒå‘æ¡¥æ¥å±‚ï¼ˆContextProvider APIï¼‰
- âœ… CIS æä¾›åˆ†å±‚ä¸Šä¸‹æ–‡ï¼ˆå·²æŒ‰å¯ä¿¡åº¦å‹ç¼©ï¼‰
- âœ… CIS æä¾›å‹ç¼©å»ºè®®ï¼ˆCompressionHint Serviceï¼‰
- âœ… Agent åé¦ˆå¾ªç¯ï¼ˆfeedback_compressionï¼‰

#### 4. è·¨é¡¹ç›®/æ¨¡å—è®°å¿†æ±¡æŸ“

**ç°çŠ¶**ï¼šUserForced è®°å¿†è·¨é¡¹ç›®æ±¡æŸ“

**åœºæ™¯**ï¼š
```
é¡¹ç›® A: UserForced "ä½¿ç”¨ Rust å¼€å‘"
é¡¹ç›® B: UserForced "ä½¿ç”¨ Python å¼€å‘"

æœç´¢"å¼€å‘è¯­è¨€åå¥½" â†’ åŒæ—¶è¿”å›ä¸¤ä¸ª UserForced â†’ Agent æ··æ·†
```

**v1.1.7 è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ä½œç”¨åŸŸéš”ç¦»ï¼ˆMemoryScope æšä¸¾ï¼‰
- âœ… å››çº§ä½œç”¨åŸŸï¼šSession > Task > Module > Project > Global
- âœ… ä½œç”¨åŸŸç»§æ‰¿å’Œè¦†ç›–
- âœ… ä½œç”¨åŸŸæ„ŸçŸ¥æ£€ç´¢

---

## å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CIS v1.1.7 è®°å¿†ç³»ç»Ÿæ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Agent å±‚ï¼ˆClaude/OpenAI/æœ¬åœ° LLMï¼‰            â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  Agent API:                                                â”‚ â”‚
â”‚  â”‚  - generate(prompt, context)                             â”‚ â”‚
â”‚  â”‚  - compress_context()                                      â”‚ â”‚
â”‚  â”‚  - feedback_compression() ğŸ”¥                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚ Protocol                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          CIS Memory Providerï¼ˆæ¡¥æ¥å±‚ï¼‰                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  1. ContextProvider API:                                â”‚ â”‚
â”‚  â”‚     - get_layered_context(task_id, max_tokens) ğŸ”¥         â”‚ â”‚
â”‚  â”‚     - get_anchors(task_id)                               â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  2. Compression Hint Service:                             â”‚ â”‚
â”‚  â”‚     - suggest_compression(memories, strategy)           â”‚ â”‚
â”‚  â”‚     - feedback_dropped(agent_id, dropped_keys) ğŸ”¥       â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  3. Memory Query Protocol:                                â”‚ â”‚
â”‚  â”‚     - query_by_source(source, top_k)                     â”‚ â”‚
â”‚  â”‚     - query_by_confidence(min_conf, top_k)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚ Storage                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           CIS Memory Coreï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  è®°å¿†æ¥æºå¯ä¿¡åº¦ä½“ç³»:                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ MemorySource æšä¸¾:                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - UserForced (1.0) - ç”¨æˆ·å¼ºåˆ¶æŒ‡å®š                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - UserInput (0.8) - ç”¨æˆ·è¾“å…¥ï¼Œé¿å…è¿‡æ‹Ÿåˆ        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - AIProposalConfirmed (0.8) - AI è¾“å‡º+ç”¨æˆ·ç¡®è®¤   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - SummaryDocument (0.8) - æ€»ç»“æ€§æ–‡æ¡£          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - AIConfirmed (0.5) - AI è‡ªåŠ¨ç¡®è®¤              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - AIProposalSummary (0.2) - æ–¹æ¡ˆæ€»ç»“ï¼Œç­‰å¾…ç¡®è®¤ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - AIInferred (0.0) - å•çº¯ AI è¾“å‡ºï¼Œä¸ç´¢å¼•    â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  ä½œç”¨åŸŸéš”ç¦»ä½“ç³»:                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ MemoryScope æšä¸¾:                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Session (project_id, session_id) - ä¼šè¯çº§ï¼ˆæœ€é«˜ï¼‰ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Task (project_id, task_id) - ä»»åŠ¡çº§           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Module (project_id, module_id) - æ¨¡å—çº§        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Project (id) - é¡¹ç›®çº§                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Global - å…¨å±€çº§ï¼ˆæœ€ä½ï¼‰                         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  å‘é‡å­˜å‚¨å’Œæ£€ç´¢:                                         â”‚ â”‚
â”‚  â”‚  - sqlite-vec å‘é‡ç´¢å¼•                                  â”‚ â”‚
â”‚  â”‚  - HNSW è¿‘ä¼¼æœç´¢                                        â”‚ â”‚
â”‚  â”‚  - åˆ†å±‚å‹ç¼©ç®—æ³•                                          â”‚ â”‚
â”‚  â”‚  - è¯­ä¹‰èšç±»å»é‡                                          â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  è®°å¿†æ±¡æŸ“æ¸…ç†:                                            â”‚ â”‚
â”‚  â”‚  - detect_pollution() - æ£€æµ‹æ±¡æŸ“                      â”‚ â”‚
â”‚  â”‚  - trace_pollution_source() - è¿½è¸ªæºå¤´              â”‚ â”‚
â”‚  â”‚  - execute_cleanup() - æ‰§è¡Œæ¸…ç†                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ•°æ®ç»“æ„

### MemoryEntryï¼ˆå®Œæ•´å®šä¹‰ï¼‰

```rust
#[derive(Debug, Clone)]
pub struct MemoryEntry {
    // åŸºç¡€å­—æ®µ
    pub key: String,
    pub value: Vec<u8>,
    pub domain: MemoryDomain,        // Private/Public
    pub category: MemoryCategory,     // Execution/Result/Error/Context/Skill
    pub created_at: i64,
    pub updated_at: i64,

    // ğŸ”¥ æ¥æºå¯ä¿¡åº¦ï¼ˆv1.1.6 æ–°å¢ï¼‰
    pub source: MemorySource,
    pub confidence: f32,              // 0.0 - 1.0
    pub vector_indexed: bool,         // æ˜¯å¦å·²ç´¢å¼•å‘é‡
    pub access_count: i64,            // è®¿é—®æ¬¡æ•°ï¼ˆç”¨äºçƒ­åº¦ç»Ÿè®¡ï¼‰
    pub parent_key: Option<String>,    // çˆ¶è®°å¿†é”®ï¼ˆAI æ–¹æ¡ˆæ€»ç»“æŒ‡å‘ï¼‰
    pub confirmed_by_user: bool,       // ç”¨æˆ·æ˜¯å¦ç¡®è®¤

    // ğŸ”¥ ä½œç”¨åŸŸéš”ç¦»ï¼ˆv1.1.7 æ–°å¢ï¼‰
    pub scope: MemoryScope,
}

/// è®°å¿†æ¥æºæšä¸¾ï¼ˆv1.1.7 ä¿®æ­£ç‰ˆï¼‰
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Hash)]
pub enum MemorySource {
    /// ç”¨æˆ·å¼ºåˆ¶æŒ‡å®šè®°å¿†ï¼ˆå¯ä¿¡åº¦ï¼š100%ï¼‰- æœ€é«˜æƒé‡
    UserForced,

    /// ç”¨æˆ·ç›´æ¥è¾“å…¥ï¼ˆå¯ä¿¡åº¦ï¼š80%ï¼‰- é¿å…è¿‡æ‹Ÿåˆ
    UserInput,

    /// AI è¾“å‡º + ç”¨æˆ·ç¡®è®¤ï¼ˆå¯ä¿¡åº¦ï¼š80%ï¼‰
    AIProposalConfirmed,

    /// æ€»ç»“æ€§æ–‡æ¡£ï¼ˆå¯ä¿¡åº¦ï¼š80%ï¼‰
    SummaryDocument,

    /// AI è‡ªåŠ¨ç¡®è®¤ï¼ˆå¯ä¿¡åº¦ï¼š50%ï¼‰
    AIConfirmed,

    /// AI æ–¹æ¡ˆæ€»ç»“ï¼ˆå¯ä¿¡åº¦ï¼š20%ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼‰
    AIProposalSummary,

    /// AI æ¨æ–­ç”Ÿæˆï¼ˆå¯ä¿¡åº¦ï¼š0%ï¼‰- ä¸ç´¢å¼•
    AIInferred,

    /// å¤–éƒ¨æ•°æ®æºï¼ˆå¯ä¿¡åº¦ï¼šå¯é…ç½®ï¼‰
    External {
        source: String,
        confidence: f32,  // 0.0 - 1.0
    },
}

/// è®°å¿†ä½œç”¨åŸŸï¼ˆv1.1.7 æ–°å¢ï¼‰
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize, Hash)]
pub enum MemoryScope {
    /// ä¼šè¯ä½œç”¨åŸŸï¼ˆä¸´æ—¶éš”ç¦»ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    Session {
        project_id: String,
        session_id: String,
    },

    /// ä»»åŠ¡ä½œç”¨åŸŸ
    Task {
        project_id: String,
        task_id: String,
    },

    /// æ¨¡å—ä½œç”¨åŸŸ
    Module {
        project_id: String,
        module_id: String,
    },

    /// é¡¹ç›®ä½œç”¨åŸŸ
    Project {
        id: String,
    },

    /// å…¨å±€ä½œç”¨åŸŸï¼ˆæ‰€æœ‰é¡¹ç›®/æ¨¡å—å…±äº«ï¼Œæœ€ä½ä¼˜å…ˆçº§ï¼‰
    Global,
}
```

### æ•°æ®åº“ Schema

```sql
-- memory_entries è¡¨å®Œæ•´ç»“æ„ï¼ˆv1.1.7ï¼‰
CREATE TABLE IF NOT EXISTS private_entries (
    key TEXT PRIMARY KEY,
    value BLOB NOT NULL,
    category TEXT,
    created_at INTEGER,
    updated_at INTEGER,
    encrypted INTEGER DEFAULT 1,

    -- v1.1.6 æ–°å¢ï¼šæ¥æºå¯ä¿¡åº¦
    source TEXT NOT NULL DEFAULT 'UserInput',
    confidence REAL DEFAULT 0.8,
    vector_indexed INTEGER DEFAULT 0,
    access_count INTEGER DEFAULT 0,
    parent_key TEXT,
    confirmed_by_user INTEGER DEFAULT 0,

    -- v1.1.7 æ–°å¢ï¼šä½œç”¨åŸŸéš”ç¦»
    scope_type TEXT NOT NULL DEFAULT 'Global',
    scope_project_id TEXT,
    scope_module_id TEXT,
    scope_task_id TEXT,
    scope_session_id TEXT
);

CREATE TABLE IF NOT EXISTS public_entries (
    key TEXT PRIMARY KEY,
    value BLOB NOT NULL,
    category TEXT,
    created_at INTEGER,
    updated_at INTEGER,
    federate INTEGER DEFAULT 1,
    sync_status TEXT DEFAULT 'pending',

    -- v1.1.6 æ–°å¢ï¼šæ¥æºå¯ä¿¡åº¦
    source TEXT NOT NULL DEFAULT 'UserInput',
    confidence REAL DEFAULT 0.8,
    vector_indexed INTEGER DEFAULT 0,
    access_count INTEGER DEFAULT 0,
    parent_key TEXT,
    confirmed_by_user INTEGER DEFAULT 0,

    -- v1.1.7 æ–°å¢ï¼šä½œç”¨åŸŸéš”ç¦»
    scope_type TEXT NOT NULL DEFAULT 'Global',
    scope_project_id TEXT,
    scope_module_id TEXT,
    scope_task_id TEXT,
    scope_session_id TEXT
);

-- ç´¢å¼•ï¼ˆv1.1.7 å®Œæ•´ç‰ˆï¼‰
CREATE INDEX IF NOT EXISTS idx_private_source_confidence
    ON private_entries(source, confidence);

CREATE INDEX IF NOT EXISTS idx_private_scope
    ON private_entries(scope_type, scope_project_id);

CREATE INDEX IF NOT EXISTS idx_private_scope_confidence
    ON private_entries(scope_type, scope_project_id, confidence);

CREATE INDEX IF NOT EXISTS idx_public_source_confidence
    ON public_entries(source, confidence);

CREATE INDEX IF NOT EXISTS idx_public_scope
    ON public_entries(scope_type, scope_project_id);

CREATE INDEX IF NOT EXISTS idx_public_scope_confidence
    ON public_entries(scope_type, scope_project_id, confidence);
```

---

## å®Œæ•´å®æ–½è®¡åˆ’

### Phase 1: æ¥æºå¯ä¿¡åº¦ä½“ç³»ï¼ˆv1.1.6 P1ï¼‰

**ç›®æ ‡**ï¼šå®ç°è®°å¿†æ¥æºè¿½è¸ªå’Œæ¡ä»¶åŒ–ç´¢å¼•

#### 1.1 æ•°æ®æ¨¡å‹æ‰©å±•
- [ ] å®šä¹‰ `MemorySource` æšä¸¾ï¼ˆ7 ç§ç±»å‹ï¼‰
- [ ] æ‰©å±• `MemoryEntry` ç»“æ„ï¼ˆæ·»åŠ  sourceã€confidence ç­‰å­—æ®µï¼‰
- [ ] æ•°æ®åº“ Schema è¿ç§»ï¼ˆæ·»åŠ  7 ä¸ªæ–°å­—æ®µï¼‰
- [ ] å•å…ƒæµ‹è¯•

#### 1.2 SET æ“ä½œæ¡ä»¶ç´¢å¼•
- [ ] å®ç° `set_with_embedding()` æ”¯æŒ source å‚æ•°
- [ ] æ¡ä»¶åŒ–å‘é‡ç´¢å¼•ï¼ˆåªæœ‰ UserForced/UserInput/AIConfirmed ç­‰æ‰ç´¢å¼•ï¼‰
- [ ] AIInferred ä¸å»ºç«‹å‘é‡ç´¢å¼•
- [ ] å•å…ƒæµ‹è¯•

#### 1.3 å‘é‡æœç´¢è¿‡æ»¤
- [ ] å®ç° `search_memory()` æ”¯æŒæ¥æºè¿‡æ»¤
- [ ] å®ç°å¯ä¿¡åº¦ä¼˜å…ˆçº§æ’åº
- [ ] è¿‡æ»¤ AIProposalSummaryï¼ˆæœªç¡®è®¤æ–¹æ¡ˆï¼‰
- [ ] å•å…ƒæµ‹è¯•

#### 1.4 AI æ–¹æ¡ˆæ€»ç»“æµç¨‹
- [ ] å®ç° `save_ai_proposals()` ä¿å­˜å¤šä¸ªæ–¹æ¡ˆ
- [ ] å®ç° `confirm_ai_proposal()` ç”¨æˆ·ç¡®è®¤
- [ ] ç¡®è®¤åå‡çº§ä¸º AIProposalConfirmed å¹¶ç´¢å¼•
- [ ] å•å…ƒæµ‹è¯•

**é¢„è®¡æ—¶é—´**: 2-3 å‘¨

---

### Phase 2: ä¸Šä¸‹æ–‡å‹ç¼©ä¸ä»»åŠ¡å»¶ç»­æ€§ï¼ˆv1.1.6 P1.3ï¼‰

**ç›®æ ‡**ï¼šå®ç°åˆ†å±‚å‹ç¼©ï¼Œä¿éšœä»»åŠ¡å»¶ç»­æ€§

#### 2.1 åˆ†å±‚å‹ç¼©ç®—æ³•
- [ ] å®šä¹‰ `CompressionConfig` é…ç½®ï¼ˆå„å±‚å‹ç¼©æ¯”ï¼‰
- [ ] å®ç° `compress_context_layered()` åˆ†å±‚å‹ç¼©
- [ ] å®ç° 5 çº§å‹ç¼©çº§åˆ«ï¼ˆNone/Light/Medium/Heavy/Extremeï¼‰
- [ ] å•å…ƒæµ‹è¯•

#### 2.2 è¯­ä¹‰å»é‡ä¸èšç±»
- [ ] å®ç° DBSCAN èšç±»ç®—æ³•
- [ ] å®ç° `semantic_dedup_compress()` è¯­ä¹‰å»é‡
- [ ] å¹¶è¡Œç›¸ä¼¼åº¦è®¡ç®—ä¼˜åŒ–
- [ ] æ€§èƒ½æµ‹è¯•

#### 2.3 è‡ªé€‚åº”å‹ç¼©æ¯”è°ƒæ•´
- [ ] å®ç° `adaptive_compress()` åŠ¨æ€è°ƒæ•´
- [ ] å‚æ•°æ”¶æ•›ä¼˜åŒ–
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

#### 2.4 ä»»åŠ¡å»¶ç»­æ€§ä¿éšœ
- [ ] å®šä¹‰ `TaskChain` ä»»åŠ¡é“¾
- [ ] å®ç°å…³é”®ä¿¡æ¯é”šç‚¹æå–
- [ ] ä¸ Agent ç”Ÿæˆæµç¨‹é›†æˆ
- [ ] å•å…ƒæµ‹è¯•

**é¢„è®¡æ—¶é—´**: 3-4 å‘¨

---

### Phase 3: Agent-CIS æ¡¥æ¥å±‚ï¼ˆv1.1.6 P1.4ï¼‰

**ç›®æ ‡**ï¼šå®ç°åŒå‘æ¡¥æ¥ï¼Œç¡®ä¿å¯é é›†æˆ

#### 3.1 ContextProvider API
- [ ] å®šä¹‰ `ContextProvider` trait
- [ ] å®ç° `get_layered_context()` è·å–åˆ†å±‚ä¸Šä¸‹æ–‡
- [ ] å®ç° `get_anchors()` è·å–å…³é”®é”šç‚¹
- [ ] å•å…ƒæµ‹è¯•

#### 3.2 Compression Hint Service
- [ ] å®ç° `suggest_compression()` æä¾›å‹ç¼©å»ºè®®
- [ ] æ”¯æŒå¤šç§å‹ç¼©ç­–ç•¥ï¼ˆPrioritizeForced/Balanced/Aggressiveï¼‰
- [ ] æ€§èƒ½æµ‹è¯•

#### 3.3 Agent Feedback Loop
- [ ] å®šä¹‰ `CompressionFeedback` trait
- [ ] å®ç° `feedback_compression()` æ›´æ–° access_count
- [ ] è‡ªåŠ¨è¯†åˆ«æ¸…ç†å€™é€‰
- [ ] å•å…ƒæµ‹è¯•

#### 3.4 æ ‡å‡†é›†æˆåè®®
- [ ] å®šä¹‰ `AgentConfig` é…ç½®
- [ ] å®ç° Claude Agent é›†æˆç¤ºä¾‹
- [ ] å®ç° OpenAI Agent é›†æˆç¤ºä¾‹
- [ ] æ–‡æ¡£å’Œæœ€ä½³å®è·µ

**é¢„è®¡æ—¶é—´**: 2-3 å‘¨

---

### Phase 4: ä½œç”¨åŸŸéš”ç¦»ï¼ˆv1.1.7 P1.5ï¼‰

**ç›®æ ‡**ï¼šå®ç°ä½œç”¨åŸŸéš”ç¦»ï¼Œé¿å…è·¨é¡¹ç›®æ±¡æŸ“

#### 4.1 æ•°æ®æ¨¡å‹æ‰©å±•
- [ ] å®šä¹‰ `MemoryScope` æšä¸¾ï¼ˆ5 ç§ç±»å‹ï¼‰
- [ ] æ‰©å±• `MemoryEntry` ç»“æ„ï¼ˆæ·»åŠ  scope å­—æ®µï¼‰
- [ ] æ•°æ®åº“ Schema è¿ç§»ï¼ˆæ·»åŠ  4 ä¸ªä½œç”¨åŸŸå­—æ®µï¼‰
- [ ] å•å…ƒæµ‹è¯•

#### 4.2 ä½œç”¨åŸŸæ„ŸçŸ¥å­˜å‚¨
- [ ] å®ç° `set_with_scope()` æ”¯æŒä½œç”¨åŸŸ
- [ ] å®ç° `get_with_scope()` ä½œç”¨åŸŸæŸ¥è¯¢
- [ ] å®ç°ä½œç”¨åŸŸç»§æ‰¿é€»è¾‘
- [ ] å•å…ƒæµ‹è¯•

#### 4.3 ä½œç”¨åŸŸæ„ŸçŸ¥æ£€ç´¢
- [ ] å®ç° `search_memory_with_scope()` å‘é‡æœç´¢
- [ ] å®ç°ä½œç”¨åŸŸè¿‡æ»¤
- [ ] å®ç°ä½œç”¨åŸŸä¼˜å…ˆçº§æ’åº
- [ ] æ€§èƒ½æµ‹è¯•

#### 4.4 ä½œç”¨åŸŸç»§æ‰¿å’Œè¦†ç›–
- [ ] å®ç° `get_with_scope_override()` ä½œç”¨åŸŸè¦†ç›–
- [ ] å®ç°ä½œç”¨åŸŸç»§æ‰¿æŸ¥è¯¢
- [ ] ä½œç”¨åŸŸè¿ç§»å·¥å…·
- [ ] å•å…ƒæµ‹è¯•

**é¢„è®¡æ—¶é—´**: 2-3 å‘¨

---

### Phase 5: è®°å¿†æ±¡æŸ“æ¸…ç†ï¼ˆv1.1.7 P1.7ï¼‰

**ç›®æ ‡**ï¼šæ£€æµ‹å’Œæ¸…ç†å·²æ±¡æŸ“çš„è®°å¿†

#### 5.1 æ±¡æŸ“æ£€æµ‹
- [ ] å®ç° `detect_pollution()` æ£€æµ‹æ±¡æŸ“
- [ ] åŸºäºæœ¬åœ°å‘é‡å¼•æ“ç›¸ä¼¼åº¦åˆ†æ
- [ ] è¯†åˆ«æ±¡æŸ“ç±»å‹ï¼ˆSimilarity/Cascade/ExternalDataï¼‰
- [ ] å•å…ƒæµ‹è¯•

#### 5.2 æ±¡æŸ“æºå¤´è¿½è¸ª
- [ ] å®ç° `trace_pollution_source()` è¿½è¸ªæºå¤´
- [ ] parent_key å’Œå‘é‡ç›¸ä¼¼åº¦åŒè·¯å¾„åˆ†æ
- [ ] ç”Ÿæˆæ±¡æŸ“é“¾è·¯å›¾
- [ ] å•å…ƒæµ‹è¯•

#### 5.3 æ¸…ç†æ‰§è¡Œ
- [ ] å®ç° `execute_cleanup()` æ‰§è¡Œæ¸…ç†
- [ ] æ”¯æŒ Deleteã€CascadeDeleteã€Downgrade æ“ä½œ
- [ ] æ¸…ç†æ—¥å¿—å’Œå®¡è®¡
- [ ] å•å…ƒæµ‹è¯•

#### 5.4 CLI å’Œè‡ªåŠ¨åŒ–
- [ ] å®ç° `cis memory cleanup` å‘½ä»¤
- [ ] è‡ªåŠ¨æ¸…ç†é€‰é¡¹ï¼ˆç”¨æˆ·ç¡®è®¤åæ‰§è¡Œï¼‰
- [ ] å®šæœŸæ¸…ç†è°ƒåº¦å™¨
- [ ] æ–‡æ¡£

**é¢„è®¡æ—¶é—´**: 2-3 å‘¨

---

### Phase 6: è‡ªé€‚åº”ä¼˜åŒ–ï¼ˆv1.1.8ï¼‰

**ç›®æ ‡**ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºè‡ªåŠ¨è°ƒæ•´æƒé‡å’Œç­–ç•¥

#### 6.1 è®°å¿†è®¿é—®ç»Ÿè®¡
- [ ] access_count è‡ªåŠ¨æ›´æ–°
- [ ] çƒ­åº¦ç»Ÿè®¡å’Œå†·æ•°æ®è¯†åˆ«
- [ ] è®¿é—®æ¨¡å¼åˆ†æ

#### 6.2 ç”¨æˆ·åé¦ˆå­¦ä¹ 
- [ ] ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´è®°å½•åå¥½
- [ ] è‡ªåŠ¨è°ƒæ•´å‹ç¼©ç­–ç•¥
- [ ] ä¸ªæ€§åŒ–æ¨è

#### 6.3 è‡ªåŠ¨é™çº§å’Œæ¸…ç†
- [ ] é•¿æœŸæœªè®¿é—®è®°å¿†è‡ªåŠ¨é™çº§
- [ ] ä½å¯ä¿¡åº¦è®°å¿†è‡ªåŠ¨æ¸…ç†
- [ ] åŠ¨æ€é˜ˆå€¼è°ƒæ•´

**é¢„è®¡æ—¶é—´**: 3-4 å‘¨

---

## API å‚è€ƒ

### æ ¸å¿ƒ API

#### 1. å­˜å‚¨è®°å¿†ï¼ˆå¸¦æ¥æºå’Œä½œç”¨åŸŸï¼‰

```rust
impl MemoryService {
    /// å­˜å‚¨è®°å¿†ï¼ˆå®Œæ•´ç‰ˆï¼‰
    ///
    /// # å‚æ•°
    /// - `key`: è®°å¿†é”®
    /// - `value`: è®°å¿†å€¼
    /// - `domain`: ç§åŸŸ/å…¬åŸŸ
    /// - `category`: åˆ†ç±»
    /// - `source`: æ¥æºï¼ˆv1.1.6 æ–°å¢ï¼‰
    /// - `scope`: ä½œç”¨åŸŸï¼ˆv1.1.7 æ–°å¢ï¼‰
    pub async fn set_full(
        &self,
        key: &str,
        value: &[u8],
        domain: MemoryDomain,
        category: MemoryCategory,
        source: MemorySource,
        scope: MemoryScope,
    ) -> Result<()> {
        // 1. å­˜å‚¨åˆ°æ•°æ®åº“
        // 2. æ¡ä»¶åŒ–å‘é‡ç´¢å¼•ï¼ˆåŸºäº sourceï¼‰
        // 3. æ›´æ–°ç´¢å¼•
    }

    /// å¿«æ·æ–¹æ³•ï¼šç”¨æˆ·å¼ºåˆ¶æŒ‡å®š
    pub async fn set_user_forced(
        &self,
        key: &str,
        value: &[u8],
        scope: MemoryScope,
    ) -> Result<()> {
        self.set_full(
            key,
            value,
            MemoryDomain::Public,
            MemoryCategory::Context,
            MemorySource::UserForced,  // ğŸ”¥ æœ€é«˜æƒé‡
            scope,
        ).await
    }

    /// å¿«æ·æ–¹æ³•ï¼šç”¨æˆ·è¾“å…¥
    pub async fn set_user_input(
        &self,
        key: &str,
        value: &[u8],
        scope: MemoryScope,
    ) -> Result<()> {
        self.set_full(
            key,
            value,
            MemoryDomain::Public,
            MemoryCategory::Context,
            MemorySource::UserInput,  // âœ… 0.8 æƒé‡
            scope,
        ).await
    }

    /// å¿«æ·æ–¹æ³•ï¼šAI æ¨æ–­ï¼ˆä¸ç´¢å¼•ï¼‰
    pub async fn set_ai_inferred(
        &self,
        key: &str,
        value: &[u8],
        scope: MemoryScope,
    ) -> Result<()> {
        self.set_full(
            key,
            value,
            MemoryDomain::Private,
            MemoryCategory::Context,
            MemorySource::AIInferred,  // ğŸ”´ 0.0 æƒé‡ï¼Œä¸ç´¢å¼•
            scope,
        ).await
    }
}
```

#### 2. Agent é›†æˆ API

```rust
/// ContextProvider: Agent è°ƒç”¨ CIS è·å–åˆ†å±‚ä¸Šä¸‹æ–‡
#[async_trait]
pub trait ContextProvider {
    /// è·å–åˆ†å±‚ä¸Šä¸‹æ–‡ï¼ˆAgent å‹ç¼©å‰è°ƒç”¨ï¼‰
    async fn get_layered_context(
        &self,
        task_id: &str,
        max_tokens: usize,
        agent_config: AgentConfig,
    ) -> Result<LayeredContext>;

    /// è·å–å…³é”®é”šç‚¹ï¼ˆå¿…é¡»ä¿ç•™çš„ä¿¡æ¯ï¼‰
    async fn get_anchors(
        &self,
        task_id: &str,
    ) -> Result<Vec<Anchor>>;
}

/// CompressionFeedback: Agent å‹ç¼©ååé¦ˆ
#[async_trait]
pub trait CompressionFeedback {
    /// Agent å‹ç¼©åå‘ CIS åé¦ˆè¢«ä¸¢å¼ƒçš„ä¿¡æ¯
    async fn feedback_compression(
        &self,
        agent_id: &str,
        layered_context: &LayeredContext,
        compression_report: &AgentCompressionReport,
    ) -> Result<FeedbackImpact>;
}
```

#### 3. ä½œç”¨åŸŸæ„ŸçŸ¥æŸ¥è¯¢

```rust
impl MemoryService {
    /// ä½œç”¨åŸŸæ„ŸçŸ¥æŸ¥è¯¢ï¼ˆè‡ªåŠ¨å¤„ç†ä½œç”¨åŸŸç»§æ‰¿ï¼‰
    ///
    /// # å‚æ•°
    /// - `key`: è®°å¿†é”®
    /// - `query_scope`: æŸ¥è¯¢ä½œç”¨åŸŸ
    ///
    /// # è¿”å›
    /// è®°å¿†æ¡ç›®ï¼ˆè‡ªåŠ¨ä»ç²¾ç¡®ä½œç”¨åŸŸåˆ°çˆ¶çº§ä½œç”¨åŸŸæŸ¥æ‰¾ï¼‰
    pub async fn get_with_scope_inherit(
        &self,
        key: &str,
        query_scope: MemoryScope,
    ) -> Result<Option<MemoryEntry>> {
        // 1. å…ˆå°è¯•ç²¾ç¡®åŒ¹é…å½“å‰ä½œç”¨åŸŸ
        if let Some(entry) = self.get_by_scope(key, &query_scope).await? {
            return Ok(Some(entry));
        }

        // 2. å°è¯•çˆ¶çº§ä½œç”¨åŸŸï¼ˆä½œç”¨åŸŸå±‚çº§ç»§æ‰¿ï¼‰
        let parent_scopes = query_scope.parent_scopes();
        for parent_scope in parent_scopes {
            if let Some(entry) = self.get_by_scope(key, &parent_scope).await? {
                return Ok(Some(entry));
            }
        }

        // 3. æœªæ‰¾åˆ°
        Ok(None)
    }

    /// ä½œç”¨åŸŸè¦†ç›–ä¼˜å…ˆçº§æŸ¥è¯¢
    ///
    /// ä¼˜å…ˆçº§ï¼šSession > Task > Module > Project > Global
    pub async fn get_with_scope_override(
        &self,
        key: &str,
        query_scope: MemoryScope,
    ) -> Result<Option<MemoryEntry>> {
        // 1. æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æŸ¥æ‰¾
        let scopes_by_priority = vec![
            query_scope.clone(),           // å½“å‰ä½œç”¨åŸŸï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        ];

        // æ·»åŠ çˆ¶çº§ä½œç”¨åŸŸï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        let mut parent_scopes = query_scope.parent_scopes();
        parent_scopes.reverse();  // åè½¬ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰
        scopes_by_priority.extend(parent_scopes);

        // 2. ä¾æ¬¡æŸ¥æ‰¾
        for scope in scopes_by_priority {
            if let Some(entry) = self.get_by_scope(key, &scope).await? {
                return Ok(Some(entry));
            }
        }

        Ok(None)
    }
}
```

---

## æ€§èƒ½æŒ‡æ ‡

### å‹ç¼©æ•ˆæœ

| åœºæ™¯ | åŸå§‹ tokens | å‹ç¼©å tokens | èŠ‚çœç‡ | ä»»åŠ¡å»¶ç»­æ€§ |
|------|-------------|---------------|--------|-----------|
| **çŸ­ä»»åŠ¡**ï¼ˆ50 æ¡è®°å¿†ï¼‰ | 50K | 18K | 64% | âœ… é«˜ |
| **ä¸­ç­‰ä»»åŠ¡**ï¼ˆ200 æ¡è®°å¿†ï¼‰ | 150K | 42K | 72% | âœ… é«˜ |
| **é•¿ä»»åŠ¡**ï¼ˆ500 æ¡è®°å¿†ï¼‰ | 400K | 65K | 84% | âš ï¸ ä¸­ |

### æœç´¢å‡†ç¡®åº¦

| æ–¹æ¡ˆ | è¯­ä¹‰ä¿ç•™åº¦ | ä»»åŠ¡å»¶ç»­æ€§ | ç©ºé—´èŠ‚çœ |
|------|-----------|-----------|---------|
| **æ—¶é—´çª—å£æ»‘åŠ¨** | ğŸ”´ 60% | ğŸ”´ ä½ | âœ… 80% |
| **AI æ‘˜è¦ç”Ÿæˆ** | ğŸ”´ 70% | ğŸ”´ ä¸­ | âœ… 75% |
| **æœ¬æ–¹æ¡ˆï¼ˆåˆ†å±‚å‹ç¼©ï¼‰** | âœ… **85%** | âœ… **é«˜** | âœ… 70% |

### å­˜å‚¨å¼€é”€

| å­—æ®µ | ç±»å‹ | å¤§å° |
|------|------|------|
| source | TEXT | 8-50 bytes |
| confidence | REAL | 4 bytes |
| vector_indexed | INTEGER | 1 byte |
| access_count | INTEGER | 8 bytes |
| parent_key | TEXT | 0-50 bytes |
| confirmed_by_user | INTEGER | 1 byte |
| scope_type | TEXT | 8-50 bytes |
| scope_project_id | TEXT | 0-50 bytes |
| scope_module_id | TEXT | 0-50 bytes |
| scope_task_id | TEXT | 0-50 bytes |
| scope_session_id | TEXT | 0-50 bytes |
| **æ€»è®¡** | | **~29-313 bytes/æ¡ç›®** |

å‡è®¾ 10000 æ¡è®°å¿†ï¼š
- é¢å¤–å¼€é”€ï¼š~0.3-3 MB

---

## æµ‹è¯•æŒ‡å—

### å•å…ƒæµ‹è¯•

```rust
#[cfg(test)]
mod tests {
    // 1. MemorySource æµ‹è¯•
    mod memory_source_tests {
        #[test]
        fn test_confidence_values() {
            assert_eq!(MemorySource::UserForced.confidence(), 1.0);
            assert_eq!(MemorySource::UserInput.confidence(), 0.8);
            assert_eq!(MemorySource::AIInferred.confidence(), 0.0);
        }

        #[test]
        fn test_can_upgrade_to_confirmed() {
            assert!(MemorySource::AIProposalSummary.can_upgrade_to_confirmed());
            assert!(!MemorySource::UserInput.can_upgrade_to_confirmed());
        }
    }

    // 2. MemoryScope æµ‹è¯•
    mod memory_scope_tests {
        #[test]
        fn test_scope_level() {
            assert_eq!(MemoryScope::Session { .. }.level(), 0);  // æœ€é«˜ä¼˜å…ˆçº§
            assert_eq!(MemoryScope::Global.level(), 4);        // æœ€ä½ä¼˜å…ˆçº§
        }

        #[test]
        fn test_parent_scopes() {
            let scope = MemoryScope::Module {
                project_id: "proj-a".to_string(),
                module_id: "mod-db".to_string(),
            };

            let parent_scopes = scope.parent_scopes();
            assert_eq!(parent_scopes.len(), 2);
            assert_eq!(parent_scopes[0], MemoryScope::Project { id: "proj-a".to_string() });
            assert_eq!(parent_scopes[1], MemoryScope::Global);
        }
    }

    // 3. ä½œç”¨åŸŸéš”ç¦»æµ‹è¯•
    mod scope_isolation_tests {
        #[tokio::test]
        async fn test_cross_scope_isolation() async {
            let service = MemoryService::new_default().await?;

            // é¡¹ç›® A
            service.set_user_forced(
                "project-a/lang",
                b"Rust",
                MemoryScope::Project { id: "project-a".to_string() },
            ).await.unwrap();

            // é¡¹ç›® B
            service.set_user_forced(
                "project-b/lang",
                b"Python",
                MemoryScope::Project { id: "project-b".to_string() },
            ).await.unwrap();

            // æŸ¥è¯¢é¡¹ç›® A
            let entry_a = service.get_with_scope(
                "lang",
                MemoryScope::Project { id: "project-a".to_string() },
            ).await.unwrap().unwrap();

            assert_eq!(entry_a.value, b"Rust");

            // æŸ¥è¯¢é¡¹ç›® B
            let entry_b = service.get_with_scope(
                "lang",
                MemoryScope::Project { id: "project-b".to_string() },
            ).await.unwrap().unwrap();

            assert_eq!(entry_b.value, b"Python");
        }
    }

    // 4. Agent é›†æˆæµ‹è¯•
    mod agent_integration_tests {
        #[tokio::test]
        async fn test_layered_context() async {
            let service = MemoryService::new_default().await?;

            // å‡†å¤‡æµ‹è¯•æ•°æ®
            service.set_user_forced(
                "task-123/arch",
                b"use microservices",
                MemoryScope::Task {
                    project_id: "project-x".to_string(),
                    task_id: "task-123".to_string(),
                },
            ).await.unwrap();

            service.set_user_input(
                "task-123/preference",
                b"dark theme",
                MemoryScope::Task {
                    project_id: "project-x".to_string(),
                    task_id: "task-123".to_string(),
                },
            ).await.unwrap();

            // è·å–åˆ†å±‚ä¸Šä¸‹æ–‡
            let layered_context = service.get_layered_context(
                "task-123",
                40_000,  // 40K tokens
                AgentConfig::default(),
            ).await.unwrap();

            // éªŒè¯ï¼šUserForced åº”è¯¥å®Œæ•´ä¿ç•™
            assert!(layered_context.layers.iter().any(|l| {
                matches!(l.source, MemorySource::UserForced)
            }));

            // éªŒè¯ï¼šä¼°ç®— token æ•°åº”è¯¥åœ¨èŒƒå›´å†…
            assert!(layered_context.estimated_tokens <= 40_000);
        }
    }

    // 5. è®°å¿†æ±¡æŸ“æµ‹è¯•
    mod pollution_cleanup_tests {
        #[tokio::test]
        async fn test_detect_pollution() async {
            let service = MemoryService::new_default().await?;

            // 1. æ·»åŠ ä½å¯ä¿¡åº¦è®°å¿†ï¼ˆæ±¡æŸ“æºï¼‰
            service.set_ai_inferred(
                "pollution-source",
                b"AI ç”Ÿæˆçš„é”™è¯¯ä¿¡æ¯",
                MemoryScope::Global,
            ).await.unwrap();

            // 2. æ·»åŠ é«˜å¯ä¿¡åº¦è®°å¿†ï¼ˆè¢«æ±¡æŸ“ï¼‰
            service.set_user_forced(
                "polluted-memory",
                b"æ­£ç¡®ä¿¡æ¯",
                MemoryScope::Global,
            ).await.unwrap();

            // 3. æ£€æµ‹æ±¡æŸ“
            let polluted = service.detect_pollution().await.unwrap();

            // éªŒè¯ï¼šåº”è¯¥æ£€æµ‹åˆ°æ±¡æŸ“
            assert!(!polluted.is_empty());

            let (source_key, polluted_key, pollution_type) = &polluted[0];
            assert_eq!(source_key, "pollution-source");
            assert_eq!(polluted_key, "polluted-memory");
        }
    }
}
```

### é›†æˆæµ‹è¯•

```rust
#[tokio::test]
async fn test_e2e_agent_integration() {
    // 1. åˆå§‹åŒ– CIS Memory Service
    let memory_service = MemoryService::new_default().await.unwrap();

    // 2. é…ç½® Claude Agent
    let agent_config = AgentConfig {
        agent_type: AgentType::Claude {
            model: "claude-3-sonnet".to_string(),
            max_tokens: 200_000,
        },
        agent_id: "test-agent".to_string(),
        context_window: 200_000,
        compression_strategy: CompressionStrategy::PrioritizeForced,
        supports_feedback: true,
        custom_params: HashMap::new(),
    };

    // 3. ç”¨æˆ·æŸ¥è¯¢
    let task_id = "test-task-001";
    let user_query = "å¸®æˆ‘ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½";

    // 4. æ ‡å‡† Agent é›†æˆæµç¨‹
    let response = standard_agent_integration(
        &memory_service,
        agent_config.clone(),
        task_id,
        user_query,
    ).await.unwrap();

    // éªŒè¯ï¼šå“åº”ä¸ä¸ºç©º
    assert!(!response.is_empty());

    // 5. éªŒè¯åé¦ˆå¾ªç¯
    let feedback = memory_service.feedback_compression(
        &agent_config.agent_id,
        &layered_context,
        &agent_compressed.compression_report,
    ).await.unwrap();

    // éªŒè¯ï¼šaccess_count å·²æ›´æ–°
    assert!(!feedback.updated_access_counts.is_empty());
}
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```rust
#[cfg(test)]
mod benches {
    use criterion::{black_box, criterion_group, criterion_main, Criterion};

    fn bench_context_compression(c: &mut Criterion) {
        let service = MemoryService::new_default().await.unwrap();
        let memories = setup_test_memories(1000).await;

        c.bench_function("compression_layered", |b| {
            b.iter(|| {
                tokio::runtime::block_on(async {
                    black_box(
                        service.compress_context_layered(
                            memories.clone(),
                            CompressionConfig::default(),
                        ).await.unwrap()
                    )
                })
            })
        });
    }

    fn bench_vector_search_with_scope(c: &mut Criterion) {
        let service = MemoryService::new_default().await.unwrap();
        let query_vec = setup_query_vec().await;

        c.bench_function("search_with_scope", |b| {
            b.iter(|| {
                tokio::runtime::block_on(async {
                    black_box(
                        service.search_memory_with_scope(
                            &query_vec,
                            10,
                            MemoryScope::Project { id: "project-a".to_string() },
                            true,  // prefer_user_input
                            Some(0.8),  // min_confidence
                        ).await.unwrap()
                    )
                })
            })
        });
    }

    criterion_group!(benches);
    criterion_main!(c);
}
```

---

## ç‰ˆæœ¬è§„åˆ’

### v1.1.6 (å·²å®Œæˆè®¾è®¡ï¼‰

**ç›®æ ‡**ï¼šè®°å¿†æ¥æºå¯ä¿¡åº¦ä½“ç³»

- [x] è®¾è®¡æ–‡æ¡£å®Œæˆï¼ˆ4 ä¸ªè®¾è®¡æ–‡æ¡£ï¼‰
- [ ] å®ç° MemorySource æšä¸¾
- [ ] å®ç° MemoryScope æšä¸¾
- [ ] æ‰©å±• MemoryEntry ç»“æ„
- [ ] æ•°æ®åº“ Schema è¿ç§»
- [ ] æ¡ä»¶åŒ–å‘é‡ç´¢å¼•
- [ ] ä½œç”¨åŸŸéš”ç¦»å­˜å‚¨
- [ ] ä½œç”¨åŸŸæ„ŸçŸ¥æ£€ç´¢
- [ ] å•å…ƒæµ‹è¯•

### v1.1.7 (å½“å‰ç‰ˆæœ¬)

**ç›®æ ‡**ï¼šå®Œæ•´è®°å¿†ç³»ç»Ÿæ”¹ç‰ˆ

- [ ] Phase 1: æ¥æºå¯ä¿¡åº¦ä½“ç³»ï¼ˆ2-3 å‘¨ï¼‰
- [ ] Phase 2: ä¸Šä¸‹æ–‡å‹ç¼©ï¼ˆ3-4 å‘¨ï¼‰
- [ ] Phase 3: Agent æ¡¥æ¥å±‚ï¼ˆ2-3 å‘¨ï¼‰
- [ ] Phase 4: ä½œç”¨åŸŸéš”ç¦»ï¼ˆ2-3 å‘¨ï¼‰
- [ ] Phase 5: æ±¡æŸ“æ¸…ç†ï¼ˆ2-3 å‘¨ï¼‰

**æ€»è®¡**: 11-16 å‘¨

### v1.1.8 (è¿œæœŸ)

**ç›®æ ‡**ï¼šè‡ªé€‚åº”ä¼˜åŒ–

- [ ] Phase 6: è®°å¿†è®¿é—®ç»Ÿè®¡
- [ ] ç”¨æˆ·åé¦ˆå­¦ä¹ 
- [ ] è‡ªåŠ¨é™çº§å’Œæ¸…ç†
- [ ] åŠ¨æ€é˜ˆå€¼è°ƒæ•´

---

## ç›¸å…³æ–‡æ¡£

### è®¾è®¡æ–‡æ¡£

1. [MEMORY_SOURCE_TRUST_DESIGN.md](./MEMORY_SOURCE_TRUST_DESIGN.md)
   - è®°å¿†æ¥æºå¯ä¿¡åº¦ä½“ç³»å®Œæ•´è®¾è®¡
   - æƒé‡æ•°å€¼ä¿®æ­£ï¼ˆUserInput=0.8ï¼Œé¿å…è¿‡æ‹Ÿåˆï¼‰
   - AI æ–¹æ¡ˆæ€»ç»“ä¸ç¡®è®¤æµç¨‹
   - v1.1.7 æ±¡æŸ“æ¸…ç†è®¾è®¡

2. [CONTEXT_COMPRESSION_AND_TASK_CONTINUITY.md](./CONTEXT_COMPRESSION_AND_TASK_CONTINUITY.md)
   - åˆ†å±‚å‹ç¼©ç®—æ³•è®¾è®¡
   - è¯­ä¹‰èšç±»å»é‡
   - ä»»åŠ¡é“¾é”šç‚¹è¿½è¸ª
   - è‡ªé€‚åº”å‹ç¼©æ¯”è°ƒæ•´

3. [AGENT_CIS_INTEGRATION.md](./AGENT_CIS_INTEGRATION.md)
   - Agent-CIS åŒå‘æ¡¥æ¥å±‚è®¾è®¡
   - ContextProvider API
   - Compression Hint Service
   - Agent Feedback Loop

4. [MEMORY_SCOPE_ISOLATION_DESIGN.md](./MEMORY_SCOPE_ISOLATION_DESIGN.md)
   - ä½œç”¨åŸŸéš”ç¦»å®Œæ•´è®¾è®¡
   - å››çº§ä½œç”¨åŸŸï¼ˆSession/Task/Module/Project/Globalï¼‰
   - ä½œç”¨åŸŸç»§æ‰¿å’Œè¦†ç›–
   - ä½œç”¨åŸŸæ„ŸçŸ¥æ£€ç´¢

### å®ç°æ–‡æ¡£

- [CIS ä»£ç åº“](../../) - å®Œæ•´æºä»£ç 
- [API æ–‡æ¡£](../../docs/api/) - API å‚è€ƒ
- [æµ‹è¯•ç”¨ä¾‹](../../tests/) - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## å¿«é€Ÿå¼€å§‹

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# 1. å…‹éš†ä»£ç åº“
git clone https://github.com/your-org/CIS.git
cd CIS

# 2. åˆ‡æ¢åˆ° v1.1.7 åˆ†æ”¯
git checkout v1.1.7-memory-system

# 3. å®‰è£…ä¾èµ–
cargo build

# 4. è¿è¡Œæµ‹è¯•
cargo test --package cis-core --lib

# 5. è¿è¡Œæ€§èƒ½åŸºå‡†
cargo bench --bench memory_compression
```

### æœ¬åœ°æµ‹è¯•

```rust
use cis_core::memory::{MemoryService, MemorySource, MemoryScope};

#[tokio::main]
async fn main() -> Result<()> {
    // 1. åˆå§‹åŒ– Memory Service
    let service = MemoryService::new_default().await?;

    // 2. å­˜å‚¨è®°å¿†ï¼ˆå¸¦æ¥æºå’Œä½œç”¨åŸŸï¼‰
    service.set_user_forced(
        "my-project/architecture",
        b"Microservices architecture with Rust and SQLite",
        MemoryScope::Project {
            id: "my-project".to_string(),
        },
    ).await?;

    service.set_user_input(
        "my-project/theme",
        b"dark",
        MemoryScope::Project {
            id: "my-project".to_string(),
        },
    ).await?;

    service.set_ai_inferred(
        "ai/suggestion",
        b"Consider using PostgreSQL for scalability",
        MemoryScope::Project {
            id: "my-project".to_string(),
        },
    ).await?;

    // 3. ä½œç”¨åŸŸæ„ŸçŸ¥æŸ¥è¯¢
    let entry = service.get_with_scope(
        "architecture",
        MemoryScope::Project {
            id: "my-project".to_string(),
        },
    ).await?;

    // 4. Agent é›†æˆ
    let layered_context = service.get_layered_context(
        "my-project",
        200_000,  // 200K tokens
        AgentConfig::default(),
    ).await?;

    println!("åˆ†å±‚ä¸Šä¸‹æ–‡ï¼š{} tokens", layered_context.estimated_tokens);

    Ok(())
}
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ UserInput æ˜¯ 0.8 è€Œä¸æ˜¯ 1.0ï¼Ÿ

**A**: ä¸ºäº†é¿å…è¿‡æ‹Ÿåˆã€‚å¦‚æœæ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½æ˜¯ 1.0ï¼Œä¼šå¯¼è‡´ï¼š
- æœç´¢ç»“æœè¿‡åº¦åå‘ç”¨æˆ·è¾“å…¥
- AI æ¨æ–­å’Œæ€»ç»“å®Œå…¨è¢«å¿½ç•¥
- æ— æ³•å¹³è¡¡ç”¨æˆ·åå¥½å’Œ AI å»ºè®®

**è§£å†³æ–¹æ¡ˆ**ï¼š
- UserForced = 1.0ï¼ˆç”¨æˆ·æ˜ç¡®å¼ºåˆ¶æŒ‡å®šçš„æœ€é«˜ä¼˜å…ˆçº§ï¼‰
- UserInput = 0.8ï¼ˆç”¨æˆ·è¾“å…¥ï¼Œä½†å…è®¸ AI å»ºè®®å‚ä¸ï¼‰
- AIProposalConfirmed = 0.8ï¼ˆAI å»ºè®® + ç”¨æˆ·ç¡®è®¤ï¼ŒåŒç­‰æƒé‡ï¼‰

### Q2: AIInferred (0.0) çš„è®°å¿†è¿˜ä¼šè¢«æœç´¢åˆ°å—ï¼Ÿ

**A**: ä¸ä¼šç›´æ¥å‚ä¸å‘é‡æœç´¢ï¼Œä½†ï¼š
- âœ… ä»å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- âœ… å¯ä»¥é€šè¿‡ç²¾ç¡® key æŸ¥è¯¢è·å–
- âœ… å¯ä»¥é€šè¿‡ list_keys() åˆ—å‡º
- âŒ ä¸å»ºç«‹å‘é‡ç´¢å¼•ï¼Œä¸ä¼šè¢«è¯­ä¹‰æœç´¢åˆ°
- âŒ ä¸ä¼šè¢«å‹ç¼©åçš„ä¸Šä¸‹æ–‡åŒ…å«ï¼ˆé™¤éæ˜¯ UserForced é”šç‚¹ï¼‰

**åŸå› **ï¼šAIInferred è®°å¿†æ˜¯ AI è‡ªåŠ¨ç”Ÿæˆçš„æ¨æ–­ï¼Œä¸åº”è¯¥æ±¡æŸ“ç”¨æˆ·çš„è®°å¿†ç©ºé—´ã€‚

### Q3: ä½œç”¨åŸŸç»§æ‰¿æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**A**: ä½œç”¨åŸŸæ”¯æŒå±‚çº§ç»§æ‰¿ï¼š

```
Session > Task > Module > Project > Global
   â†“        â†“        â†“        â†“
æŸ¥è¯¢æ—¶è‡ªåŠ¨ä»ç²¾ç¡®ä½œç”¨åŸŸ â†’ çˆ¶çº§ä½œç”¨åŸŸæŸ¥æ‰¾
```

**ç¤ºä¾‹**ï¼š
```rust
// å­˜å‚¨åˆ° Session ä½œç”¨åŸŸ
service.set_user_input(
    "temp/state",
    b"step=3",
    MemoryScope::Session {
        project_id: "project-a".to_string(),
        session_id: "session-123".to_string(),
    },
).await?;

// æŸ¥è¯¢ Task ä½œç”¨åŸŸï¼ˆè‡ªåŠ¨ç»§æ‰¿ Sessionï¼‰
let entry = service.get_with_scope(
    "temp/state",
    MemoryScope::Task {
        project_id: "project-a".to_string(),
        task_id: "task-456".to_string(),
    },
).await?;

// âœ… èƒ½æ‰¾åˆ°ï¼ˆå› ä¸º Task æ˜¯ Session çš„çˆ¶çº§ä½œç”¨åŸŸï¼‰
```

### Q4: å¦‚ä½•ç¡®ä¿ Agent éµå®ˆ CIS çš„å‹ç¼©å»ºè®®ï¼Ÿ

**A**: é€šè¿‡åŒå‘æ¡¥æ¥å±‚ï¼š

1. **CIS æä¾›åˆ†å±‚ä¸Šä¸‹æ–‡**ï¼ˆå·²ç»æŒ‰å¯ä¿¡åº¦å‹ç¼©ï¼‰
2. **CIS æä¾›å‹ç¼©å»ºè®®**ï¼ˆCompressionHintï¼‰
3. **Agent å¯ä»¥é€‰æ‹©**ï¼šéµå®ˆå»ºè®®æˆ–è‡ªå·±å‹ç¼©
4. **Agent åé¦ˆç»“æœ**ï¼šfeedback_compression()
5. **CIS å­¦ä¹ è°ƒæ•´**ï¼šæ ¹æ®åé¦ˆè°ƒæ•´ä¸‹æ¬¡å»ºè®®

**å…³é”®**ï¼šä¸æ˜¯å¼ºåˆ¶ï¼Œè€Œæ˜¯åè°ƒã€‚Agent ä¿æŒè‡ªä¸»æ€§ï¼ŒCIS æä¾›ä¸“ä¸šå»ºè®®ã€‚

### Q5: è®°å¿†æ±¡æŸ“æ¸…ç†ä¼šåˆ é™¤æ•°æ®å—ï¼Ÿ

**A**: æœ‰ä¸‰ç§æ¸…ç†æ–¹å¼ï¼š

1. **Delete**ï¼šç›´æ¥åˆ é™¤è®°å¿†ï¼ˆå±é™©æ“ä½œï¼‰
2. **CascadeDelete**ï¼šè¿åŒæ±¡æŸ“æºå¤´ä¸€èµ·åˆ é™¤ï¼ˆæ›´å±é™©ï¼‰
3. **Downgrade**ï¼šé™çº§å¯ä¿¡åº¦ï¼Œåˆ é™¤å‘é‡ç´¢å¼•ï¼ˆæ¨èï¼‰

**v1.1.7 é»˜è®¤ç­–ç•¥**ï¼šä¼˜å…ˆä½¿ç”¨ Downgradeï¼Œé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚åˆ é™¤ã€‚

---

**ç»´æŠ¤è€…**: CIS v1.1.7 Team
**æœ€åæ›´æ–°**: 2026-02-13
**ç‰ˆæœ¬**: v1.1.7 Complete Development Guide
