# CIS v1.0.0 安全机制

**版本**: 1.0.0  
**日期**: 2026-02-08  

---

## 🔐 安全架构

```
┌─────────────────────────────────────────────────────────────┐
│                    安全分层架构                               │
├─────────────────────────────────────────────────────────────┤
│  Layer 4: 应用安全                                            │
│  ├── DID 身份认证                                             │
│  ├── Bearer Token 鉴权                                        │
│  └── 访问控制列表                                             │
├─────────────────────────────────────────────────────────────┤
│  Layer 3: 传输安全                                            │
│  ├── Noise Protocol 握手                                      │
│  ├── ChaCha20-Poly1305 加密                                   │
│  └── 证书固定 (Certificate Pinning)                           │
├─────────────────────────────────────────────────────────────┤
│  Layer 2: 存储安全                                            │
│  ├── 数据库加密 (SQLCipher)                                   │
│  ├── 私钥安全存储 (Keychain/Keyring)                          │
│  └── 内存安全 (Rust 保障)                                     │
├─────────────────────────────────────────────────────────────┤
│  Layer 1: 物理安全                                            │
│  ├── 硬件绑定                                                 │
│  └── 安全启动                                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 🛡️ 加密算法

### 对称加密

| 算法 | 用途 | 密钥长度 |
|------|------|----------|
| ChaCha20-Poly1305 | 数据传输加密 | 256-bit |
| AES-256-GCM | 数据库加密 | 256-bit |

### 非对称加密

| 算法 | 用途 | 密钥长度 |
|------|------|----------|
| Ed25519 | 数字签名 | 256-bit |
| X25519 | 密钥交换 | 256-bit |

### 哈希算法

| 算法 | 用途 |
|------|------|
| BLAKE3 | 数据完整性校验 |
| SHA-256 | 指纹生成 |

---

## 🔑 身份认证

### DID (去中心化身份)

```
DID 格式: did:cis:<node_id>:<pub_key_short>

示例: did:cis:munin:a1b2c3d4
```

#### 身份验证流程

```
┌─────────┐                    ┌─────────┐
│ 客户端   │ ──── DID + 签名 ───▶ │ 服务端   │
│         │ ◀─── 挑战随机数 ─────│         │
│         │ ──── 签名响应 ─────▶ │         │
│         │ ◀─── Bearer Token ──│         │
└─────────┘                    └─────────┘
```

### Bearer Token

- **格式**: `BASE64(随机64字节)`
- **有效期**: 30 天 (可配置)
- **存储**: `matrix-social.db` - `matrix_tokens` 表

---

## 📡 传输安全

### Noise Protocol

用于 WebSocket 联邦连接的加密握手。

```rust
// Noise_XX 模式
// 1. 静态密钥交换
// 2.  ephemeral 密钥交换
// 3. 身份验证
```

### 端口安全

| 端口 | 协议 | 暴露范围 | 认证 |
|------|------|----------|------|
| 6767 | HTTP | 对外 | Bearer Token |
| 7676 | HTTP | 内部 | DID 签名 |
| 6768 | WebSocket | 内部 | Noise + DID |

---

## 💾 存储安全

### 数据库加密

```rust
// SQLCipher 配置
PRAGMA key = '主密钥派生';
PRAGMA cipher = 'aes-256-cbc';
```

### 密钥存储

| 平台 | 存储位置 | 保护方式 |
|------|----------|----------|
| macOS | Keychain | 系统密钥链 |
| Linux | Keyring | libsecret |
| Windows | Credential Manager | DPAPI |

### 私钥文件

```
~/.cis/data/
└── node.key          # Ed25519 私钥
    └── 权限: 0600    # 仅所有者可读写
```

---

## 🔒 隐私保护

### 数据分类

| 级别 | 数据类型 | 处理方式 |
|------|----------|----------|
| P0 | 私钥 | 硬件安全模块 |
| P1 | 个人记忆 | 本地加密存储 |
| P2 | 房间消息 | 端到端加密 |
| P3 | 公开房间 | 无加密 |

### 零知识设计

- 私域记忆永不上云
- 向量嵌入本地计算
- 联邦同步仅交换加密数据

---

## ⚠️ 安全建议

### 生产环境

1. **启用防火墙**
   ```bash
   # 仅暴露 6767 端口
   ufw allow 6767/tcp
   ufw deny 7676/tcp
   ufw deny 6768/tcp
   ```

2. **使用 TLS**
   ```toml
   [matrix]
   tls_cert = "/path/to/cert.pem"
   tls_key = "/path/to/key.pem"
   ```

3. **定期轮换密钥**
   ```bash
   cis node rotate-key
   ```

### 开发环境

1. **使用测试密钥**
2. **禁用生产功能**
3. **启用详细日志**

---

## 🚨 安全事件响应

### 漏洞报告

- **邮箱**: security@cis.dev
- **PGP**: [下载公钥](https://cis.dev/security.asc)
- **响应时间**: 24 小时内确认

### 应急流程

1. **发现** → 报告到 security@cis.dev
2. **确认** → 24 小时内确认漏洞
3. **修复** → 开发修复补丁
4. **发布** → 发布安全更新
5. **通告** → 公开安全公告

---

## 📋 安全审计

### v1.0.0 审计状态

| 项目 | 状态 | 备注 |
|------|------|------|
| 代码审计 | ⏳ 计划中 | 预计 v1.1.0 完成 |
| 渗透测试 | ⏳ 计划中 | 预计 v1.1.0 完成 |
| 依赖审计 | ✅ 完成 | cargo audit |
| 模糊测试 | ⚠️ 部分 | 核心模块 |

### 已知限制

- WASM 沙箱未完全隔离
- GUI 内存安全待验证
- P2P 网络审计未完成

---

## 📚 参考

- [Noise Protocol](http://noiseprotocol.org/)
- [Ed25519](https://ed25519.cr.yp.to/)
- [DID Spec](https://www.w3.org/TR/did-core/)

---

**安全团队**: security@cis.dev  
**最后更新**: 2026-02-08
