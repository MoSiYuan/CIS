# CIS-MATRIX æ•´åˆå¯èƒ½æ€§ç ”åˆ¤

## æ¦‚è¿°

MATRIX è§„æ ¼ä¹¦æä¾›äº†ä¸€ä¸ª**åŒç«¯å£åµŒå…¥å¼ Matrix Homeserver**æ¶æ„ï¼Œä¸ CIS çš„æ•´åˆå¯èƒ½æ€§**éå¸¸é«˜**ã€‚è¿™æœ¬è´¨ä¸Šæ˜¯ä¸º CIS æä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–çš„ IM/é€šä¿¡åè®®å±‚ã€‚

---

## æ¶æ„å¯¹æ¯”

### å½“å‰ CIS æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CIS Core                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Skills    â”‚  â”‚   Memory    â”‚  â”‚   Agent     â”‚          â”‚
â”‚  â”‚   Registry  â”‚  â”‚   Service   â”‚  â”‚   Provider  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚   Storage   â”‚                          â”‚
â”‚                    â”‚ (SQLite)    â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                                    â–²
         â”‚                                    â”‚
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  CLI Tool  â”‚                    â”‚  WASM Runtime  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MATRIX æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Embedded Matrix                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  7676 HMI   â”‚  â”‚  6767 BMI   â”‚  â”‚    EMS      â”‚          â”‚
â”‚  â”‚  (Human)    â”‚  â”‚   (Bot)     â”‚  â”‚   Core      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚  Bridge     â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                                    â–²
         â”‚                                    â”‚
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Element   â”‚                    â”‚  CIS Nodes     â”‚
   â”‚  Cinny     â”‚                    â”‚  (Federation)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•´åˆåæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CIS-MATRIX Node                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                 MATRIX Layer                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  7676 HMI   â”‚  â”‚  6767 BMI   â”‚  â”‚    EMS      â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  (Element)  â”‚  â”‚ (Federation)â”‚  â”‚  (Store)    â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                           â”‚                         â”‚    â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                  â”‚    â”‚
â”‚  â”‚                    â”‚  Bridge     â”‚â—„â”€â”€â”€â”             â”‚    â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      CIS Core          â”‚                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚â”‚
â”‚  â”‚  â”‚   Skills    â”‚  â”‚   Memory    â”‚  â”‚   Agent    â”‚      â”‚â”‚
â”‚  â”‚  â”‚  (IM Skill) â”‚  â”‚ (Public/Private)â”‚  Provider  â”‚      â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•´åˆä»·å€¼è¯„ä¼°

### âœ… é«˜ä»·å€¼æ•´åˆç‚¹

| ç‰¹æ€§ | ä»·å€¼ | è¯´æ˜ |
|------|------|------|
| **Element å®¢æˆ·ç«¯** | â­â­â­ | ç«‹å³è·å¾—æˆç†Ÿçš„ Matrix å®¢æˆ·ç«¯ç”Ÿæ€ |
| **æ ‡å‡†åŒ–åè®®** | â­â­â­ | Matrix æ˜¯å¼€æ”¾æ ‡å‡†ï¼Œé¿å…ç§é”åè®® |
| **åŒç«¯å£æ¶æ„** | â­â­â­ | 7676 äººæœº/6767 æœºæœºåˆ†ç¦»ï¼Œå®‰å…¨æ¸…æ™° |
| **è”é‚¦é€šä¿¡** | â­â­â­ | CIS èŠ‚ç‚¹é—´é€šè¿‡ 6767 è”é‚¦äº’è” |
| **åŠ å¯†æ”¯æŒ** | â­â­â­ | Matrix E2EE å¯ç›´æ¥ç”¨äºç§åŸŸè®°å¿†åŒæ­¥ |
| **æˆ¿é—´ç®¡ç†** | â­â­ | Matrix æˆ¿é—´å¯ä½œä¸º Skill ä¸Šä¸‹æ–‡è½½ä½“ |

### ğŸ”§ æ•´åˆå·¥ä½œé‡

| ç»„ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|--------|------|
| 7676 HMI æœåŠ¡å™¨ | ä¸­ç­‰ | `axum`, `rustls` |
| 6767 BMI æœåŠ¡å™¨ | ä¸­ç­‰ | `axum`, `mTLS`, `ed25519` |
| EMS (Embedded Matrix) | å¤§ | Matrix åè®®å®ç° |
| Bridge å±‚ | å° | CIS Core å·²æœ‰æ¥å£ |
| SQLite Schema æ‰©å±• | å° | å·²æœ‰ rusqlite |

---

## æ•´åˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ A: å®Œå…¨æ•´åˆï¼ˆæ¨èï¼‰

å°† MATRIX ä½œä¸º CIS çš„æ ‡å‡†é€šä¿¡å±‚ï¼š

```rust
// cis-core/src/matrix/mod.rs

pub struct MatrixLayer {
    hmi: HmiServer,      // 7676
    bmi: BmiServer,      // 6767
    ems: Ems,            // Embedded Matrix Server
    bridge: Bridge,      // CIS-Matrix è½¬æ¢
}

impl MatrixLayer {
    /// å¯åŠ¨åŒç«¯å£æœåŠ¡å™¨
    pub async fn run(&self) -> Result<()> {
        tokio::select! {
            _ = self.hmi.run() => {},
            _ = self.bmi.run() => {},
        }
    }
    
    /// å‘é€æ¶ˆæ¯åˆ° Matrix æˆ¿é—´ï¼ˆSkill è°ƒç”¨ï¼‰
    pub fn send_to_room(&self, room_id: &str, msg: &str) -> Result<()>;
    
    /// ä» Matrix æ¥æ”¶æ¶ˆæ¯ï¼ˆè§¦å‘ Skillï¼‰
    pub async fn recv_from_room(&self, room_id: &str) -> Option<MatrixEvent>;
}
```

**ä¼˜ç‚¹**:
- Element/Cinny ç›´æ¥ä½œä¸º CIS å®¢æˆ·ç«¯
- Matrix æˆ¿é—´ = Skill åä½œç©ºé—´
- æ ‡å‡† Matrix åè®®ï¼Œç”Ÿæ€ä¸°å¯Œ

**ç¼ºç‚¹**:
- å¼•å…¥ Matrix åè®®å¤æ‚åº¦
- EMS å®ç°å·¥ä½œé‡è¾ƒå¤§

### æ–¹æ¡ˆ B: è½»é‡æ•´åˆ

ä»…ä½¿ç”¨ 7676 ç«¯å£ï¼Œä½œä¸º IM Skill çš„ä¸€ç§å®ç°ï¼š

```rust
// skills/matrix-im/src/lib.rs

pub struct MatrixImSkill {
    homeserver: String,  // å¤–éƒ¨ Matrix æœåŠ¡å™¨
    access_token: String,
}

impl Skill for MatrixImSkill {
    fn name(&self) -> &str { "matrix-im" }
    
    async fn handle_event(&self, ctx: &dyn SkillContext, event: Event) -> Result<()> {
        // é€šè¿‡ Matrix Client-Server API æ”¶å‘æ¶ˆæ¯
        // ä¸å®ç° EMSï¼Œåªä½œä¸ºå®¢æˆ·ç«¯
    }
}
```

**ä¼˜ç‚¹**:
- å·¥ä½œé‡å°
- å¯è¿æ¥ç°æœ‰ Matrix æœåŠ¡å™¨

**ç¼ºç‚¹**:
- éœ€è¦å¤–éƒ¨ Matrix æœåŠ¡å™¨
- ä¸èƒ½ä½œä¸º CIS èŠ‚ç‚¹è”é‚¦åŸºç¡€

### æ–¹æ¡ˆ C: æ··åˆæ•´åˆ

- çŸ­æœŸï¼šæ–¹æ¡ˆ Bï¼Œå¿«é€Ÿè·å¾— IM èƒ½åŠ›
- é•¿æœŸï¼šæ–¹æ¡ˆ Aï¼Œå®Œå…¨æ•´åˆä¸º CIS åŸºç¡€è®¾æ–½

---

## ä¸ç°æœ‰ IM Skill çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CIS Skill ç”Ÿæ€                           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Native IM  â”‚  â”‚ Matrix IM   â”‚  â”‚  WeChat IM  â”‚          â”‚
â”‚  â”‚  (Claude)   â”‚  â”‚  (This Doc) â”‚  â”‚  (Future)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚  IM Trait   â”‚                          â”‚
â”‚                    â”‚  (Abstract) â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»ºè®®**:
- Claude ç»§ç»­å¼€å‘ **Native IM Skill**ï¼ˆè½»é‡ã€å¿«é€ŸéªŒè¯ï¼‰
- MATRIX ä½œä¸º **åŸºç¡€è®¾æ–½å±‚** å¹¶è¡Œå¼€å‘ï¼ˆæ ‡å‡†ã€è”é‚¦ï¼‰
- ä¸¤è€…é€šè¿‡ **IM Trait** æŠ½è±¡ï¼Œå¯äº’æ¢

---

## å¼€å‘å»ºè®®

### Phase 1: 7676 HMIï¼ˆ1-2 å‘¨ï¼‰

ç›®æ ‡: Element èƒ½ç™»å½• CIS èŠ‚ç‚¹

```rust
// æ–°å¢æ¨¡å—
- cis-core/src/matrix/
  - hmi.rs       # 7676 æœåŠ¡å™¨
  - ems.rs       # Embedded Matrix Serverï¼ˆç®€åŒ–ç‰ˆï¼‰
  - bridge.rs    # CIS-Matrix æ¡¥æ¥
  - mod.rs
```

éªŒæ”¶:
```bash
curl -k https://localhost:7676/_matrix/client/versions
# Element é…ç½®åèƒ½ç™»å½•å¹¶æ”¶å‘æ¶ˆæ¯
```

### Phase 2: CIS é›†æˆï¼ˆ1 å‘¨ï¼‰

ç›®æ ‡: Element æŒ‡ä»¤é©±åŠ¨ CIS Skill

- Bridge å±‚è§£æ `!skill` å‰ç¼€
- Skill ç»“æœå›å†™åˆ° Matrix æˆ¿é—´
- è‡ªåŠ¨åˆ›å»º `#cis-control:local` æˆ¿é—´

### Phase 3: 6767 è”é‚¦ï¼ˆ2 å‘¨ï¼‰

ç›®æ ‡: CIS èŠ‚ç‚¹é—´äº’è”

- mTLS åŒå‘è®¤è¯
- Matrix Federation API
- èŠ‚ç‚¹å‘ç°ä¸åŒæ­¥

---

## ä»£ç æ•´åˆç¤ºä¾‹

### 1. Matrix äº‹ä»¶ â†’ CIS Skill

```rust
// cis-core/src/matrix/bridge.rs

impl Bridge {
    /// Matrix æ¶ˆæ¯å…¥å‘å¤„ç†
    pub async fn on_matrix_message(&self, room_id: &RoomId, sender: &UserId, body: &str) {
        // 1. æ£€æŸ¥æ˜¯å¦æ˜¯ Skill æŒ‡ä»¤
        if let Some(task) = self.parse_skill_command(body) {
            // 2. è°ƒç”¨ CIS Core
            let result = self.core.invoke(task).await;
            
            // 3. ç»“æœå›å†™ Matrix
            let msg = format!("[CIS] {}", result);
            self.ems.send_message(room_id, &msg).await;
        }
        
        // 4. å¦åˆ™ä½œä¸ºæ™®é€š IM æ¶ˆæ¯å¤„ç†
        else {
            self.core.handle_im_message(room_id, sender, body).await;
        }
    }
}
```

### 2. CIS Skill â†’ Matrix æ¶ˆæ¯

```rust
// skills/im/src/lib.rs (é€šè¿‡ Matrix å‘é€)

impl ImSkill {
    async fn send_message(&self, ctx: &dyn SkillContext, msg: ImMessage) -> Result<()> {
        // æ–¹å¼ 1: é€šè¿‡ Matrix Layerï¼ˆå¦‚æœæ•´åˆäº†ï¼‰
        if let Some(matrix) = ctx.get_matrix_layer() {
            matrix.send_to_room(&msg.room_id, &msg.content).await?;
        }
        
        // æ–¹å¼ 2: ç›´æ¥è°ƒç”¨ Matrix Client API
        else {
            self.matrix_client.send(&msg.room_id, &msg.content).await?;
        }
        
        Ok(())
    }
}
```

---

## å†³ç­–å»ºè®®

| ç»´åº¦ | å»ºè®® |
|------|------|
| **æ•´åˆå¿…è¦æ€§** | **é«˜** - Matrix æä¾›æ ‡å‡†åè®®å’Œå®¢æˆ·ç«¯ç”Ÿæ€ |
| **æ•´åˆæ—¶æœº** | **å¹¶è¡Œ** - ä¸é˜»å¡ Claude çš„ IM Skill å¼€å‘ |
| **æ•´åˆæ·±åº¦** | **æ¸è¿›** - å…ˆ 7676 HMIï¼Œå 6767 è”é‚¦ |
| **æŠ€æœ¯é€‰å‹** | **`matrix-sdk` + `axum`** - é¿å…ä»å¤´å®ç° |
| **ä¼˜å…ˆçº§** | **P1** - ä¸ WASM Runtimeã€CLI åŒçº§ |

---

## ç»“è®º

**CIS-MATRIX æ•´åˆä¸ä»…å¯è¡Œï¼Œè€Œä¸”é«˜åº¦æ¨è**ã€‚MATRIX è§„æ ¼ä¹¦ä¸º CIS æä¾›äº†ï¼š

1. **å³ç”¨çš„å®¢æˆ·ç«¯** - Element/Cinny ç›´æ¥ä½œä¸º CIS æ§åˆ¶ç•Œé¢
2. **æ ‡å‡†åŒ–çš„è”é‚¦** - CIS èŠ‚ç‚¹é—´é€šè¿‡ 6767 äº’è”
3. **å®‰å…¨çš„é€šä¿¡** - mTLS + Ed25519 ç­¾å
4. **ä¸°å¯Œçš„ç”Ÿæ€** - Matrix åè®®çš„å¼€æºå®ç°å’Œå·¥å…·

**å»ºè®®è¡ŒåŠ¨**:
1. âœ… æ‰¹å‡† MATRIX æ•´åˆ
2. ğŸ”„ åˆ›å»º `cis-core/src/matrix/` æ¨¡å—
3. ğŸ”„ é€‰æ‹© `matrix-sdk` åº“ä½œä¸ºåŸºç¡€
4. ğŸ”„ Phase 1: å®ç° 7676 HMI éª¨æ¶
5. ğŸ”„ ä¸ Claude çš„ IM Skill ä¿æŒæ¥å£å…¼å®¹
