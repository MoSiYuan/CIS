# CIS 威胁模型分析

**版本**: 1.0  
**日期**: 2026-02-08  
**状态**: 已审查

---

## 概述

本文档描述了 CIS (Cluster of Independent Systems) 的威胁模型，包括系统边界、信任假设、威胁参与者和攻击面分析。CIS 是一个基于 P2P 网络的分布式 Agent 系统，具有独特的安全需求。

---

## 系统边界

### 网络边界

```
┌─────────────────────────────────────────────────────────────────┐
│                        CIS 网络边界                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐     │
│  │   节点 A    │◄────►│   节点 B    │◄────►│   节点 C    │     │
│  │  (工作站)   │ P2P  │  (服务器)   │ P2P  │  (笔记本)   │     │
│  └──────┬──────┘      └──────┬──────┘      └──────┬──────┘     │
│         │                    │                    │            │
│         ▼                    ▼                    ▼            │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐     │
│  │  本地存储   │      │  本地存储   │      │  本地存储   │     │
│  │  SQLite     │      │  SQLite     │      │  SQLite     │     │
│  └─────────────┘      └─────────────┘      └─────────────┘     │
│                                                                  │
│  外部边界:                                                       │
│  • 公网 P2P 连接 (QUIC/WebSocket)                               │
│  • mDNS 局域网发现                                              │
│  • LLM API 连接 (OpenAI/Claude/Kimi)                            │
│  • DHT 网络 (可选)                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 组件边界

| 组件 | 边界类型 | 说明 |
|------|----------|------|
| cis-core | 核心库 | 不直接暴露网络接口 |
| cis-node | 节点服务 | 暴露 6767, 7676, 7677 端口 |
| cis-gui | GUI 应用 | 本地显示，不直接网络通信 |
| Skill | 扩展模块 | 通过沙箱接口访问资源 |
| 本地数据库 | 存储层 | SQLite，文件系统隔离 |

---

## 信任假设

### 完全信任的组件

1. **硬件层**
   - CPU/主板/网卡硬件指纹
   - 安全启动（如果启用）
   - 物理环境安全

2. **操作系统**
   - 文件系统权限
   - 进程内存隔离
   - 系统密钥链 (Keychain/Keyring)

3. **CIS 核心代码**
   - Rust 内存安全保证
   - 经过审计的加密实现

### 部分信任的组件

1. **网络节点**
   - 白名单中的节点：高度信任
   - 通过 DID 验证的节点：中度信任
   - 开放模式下的节点：低度信任

2. **Skill 模块**
   - 内置 Skill：高度信任
   - 社区 Skill：需审查后信任
   - WASM Skill：沙箱隔离

3. **LLM Provider**
   - 仅传输脱敏数据
   - API 密钥本地存储

### 不信任的组件

1. **公网网络**
   - 中间人攻击可能
   - DDoS 攻击可能
   - 流量分析可能

2. **DHT 网络**
   - 节点身份不可信
   - 仅用于发现，不用于数据传输

3. **其他 P2P 节点**
   - 直到 DID 验证完成前均不信任

---

## 威胁参与者

### 外部攻击者

#### 能力评估

| 类型 | 能力 | 资源 | 动机 |
|------|------|------|------|
| 脚本小子 | 低 | 公开工具 | 低 |
| 网络罪犯 | 中 | 商业工具 | 中（经济） |
| APT 组织 | 高 | 国家资源 | 高（情报） |
| 内部人员 | 极高 | 内部访问 | 高（多种） |

#### 攻击场景

**场景 1: P2P 连接欺骗**
```
攻击者 → 伪装成合法节点 → 尝试连接
防御: DID Challenge/Response + 白名单
```

**场景 2: 中间人攻击**
```
攻击者 → 拦截 WebSocket 连接 → 篡改数据
防御: Noise Protocol + 证书固定
```

**场景 3: DDoS 攻击**
```
攻击者 → 大量连接请求 → 服务不可用
防御: 速率限制 + 连接池管理
```

### 恶意节点

#### 内部威胁场景

**场景 1: 白名单节点被入侵**
```
被入侵的合法节点 → 发送恶意 ACL 更新 → 污染网络
防御: ACL 签名验证 + 版本控制 + 多节点确认
```

**场景 2: Sybil 攻击**
```
攻击者 → 创建多个虚假节点 → 试图控制网络
防御: 硬件绑定 DID + 手动白名单
```

**场景 3: 历史攻击**
```
攻击者 → 重放旧消息 → 状态混乱
防御: 时间戳 + 消息序列号 + 防重放缓存
```

### 内部威胁

#### 风险级别

| 威胁类型 | 风险等级 | 检测难度 | 缓解措施 |
|----------|----------|----------|----------|
| 管理员滥用 | 高 | 低 | 审计日志 |
| 开发者后门 | 中 | 中 | 代码审查 |
| 配置错误 | 中 | 低 | 配置验证 |
| 物理访问 | 高 | 高 | 硬件绑定 |

#### 攻击场景

**场景 1: 配置泄露**
```
内部人员 → 复制配置文件到外部设备 → 数据泄露
防御: 硬件绑定 + 加密存储
```

**场景 2: 日志分析**
```
内部人员 → 访问审计日志 → 获取敏感信息
防御: 日志脱敏 + 访问控制
```

---

## 攻击面分析

### 网络层攻击面

#### 1. P2P QUIC (端口 7677)

```
攻击向量:
┌─────────────────────────────────────────────────────────┐
│  1. 连接洪泛攻击                                        │
│     风险: 高    缓解: 连接速率限制 + IP 黑名单          │
│                                                         │
│  2. 协议版本降级攻击                                    │
│     风险: 中    缓解: 强制 TLS 1.3 + 版本检查           │
│                                                         │
│  3. 大型消息 DoS                                        │
│     风险: 中    缓解: 消息大小限制                      │
│                                                         │
│  4. NAT 穿透滥用                                        │
│     风险: 低    缓解: UPnP 验证 + 手动配置优先          │
└─────────────────────────────────────────────────────────┘
```

#### 2. WebSocket Federation (端口 6767)

| 攻击类型 | 风险等级 | 描述 | 缓解措施 |
|----------|----------|------|----------|
| 未授权访问 | 高 | 绕过 DID 验证 | 强制 Challenge/Response |
| 消息洪泛 | 中 | 大量 Matrix 事件 | 速率限制 + 消息队列 |
| 连接保持 | 低 | 长时间占用连接 | 心跳超时 + 连接回收 |
| 头部注入 | 中 | HTTP 头攻击 | 严格头部验证 |

#### 3. Matrix Client API (端口 7676)

```
攻击向量:
• Bearer Token 泄露 → 未授权访问
• API 滥用 → 资源耗尽
• 输入注入 → 命令执行

缓解措施:
• Token 定期轮换
• API 速率限制
• 严格输入验证
```

#### 4. mDNS 发现 (端口 5353)

| 风险 | 等级 | 说明 |
|------|------|------|
| 信息泄露 | 中 | 服务广播可被监听 |
| 欺骗攻击 | 低 | 伪造 mDNS 响应 |

**缓解**: mDNS 仅用于发现，实际连接仍需 DID 验证

### 应用层攻击面

#### 1. DID 身份系统

```
攻击树:
                    DID 身份攻击
                         │
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
    私钥窃取       助记词恢复       签名伪造
        │                │                │
    ┌───┴───┐        ┌───┴───┐        ┌───┴───┐
    ▼       ▼        ▼       ▼        ▼       ▼
 内存读取  文件读取  暴力破解  社工   算法攻击 实现漏洞
    │       │        │       │        │       │
   缓解    缓解      缓解    缓解     缓解    缓解
   ───────────────────────────────────────────────
   • 内存安全(Rust)  • Argon2id     • Ed25519
   • 文件权限 0600   • 助记词加密   • 标准库实现
```

#### 2. ACL 系统

| 攻击类型 | 风险 | 描述 |
|----------|------|------|
| 版本回滚 | 高 | 传播旧版本 ACL |
| 签名伪造 | 高 | 伪造 ACL 更新签名 |
| 权限提升 | 中 | 通过 ACL 修改获得更高权限 |
| 配置污染 | 中 | 恶意节点传播有害配置 |

**缓解措施**:
- 版本号单调递增检查
- 多签名验证
- 可信更新者列表
- 配置变更审计

#### 3. Skill 沙箱

```
攻击向量:
┌─────────────────────────────────────────────────────────┐
│  1. WASM 逃逸                                           │
│     风险: 高    缓解: WASI 沙箱 + 能力限制              │
│                                                         │
│  2. 资源耗尽                                            │
│     风险: 中    缓解: CPU/内存/时间限制                 │
│                                                         │
│  3. API 滥用                                            │
│     风险: 中    缓解: 权限系统 + 调用审计               │
│                                                         │
│  4. 数据泄露                                            │
│     风险: 中    缓解: 数据访问控制 + 加密               │
└─────────────────────────────────────────────────────────┘
```

### 数据层攻击面

#### 1. SQLite 数据库

| 攻击类型 | 风险等级 | 影响 | 缓解措施 |
|----------|----------|------|----------|
| SQL 注入 | 低 | 使用参数化查询 | rusqlite 预处理 |
| 文件读取 | 中 | 数据库文件被复制 | 文件权限 0600 |
| 加密破解 | 中 | 数据库加密被破解 | ChaCha20-Poly1305 |
| 备份泄露 | 高 | 备份文件泄露 | 加密备份 + 定期清理 |

#### 2. 配置文件

```
敏感文件:
~/.cis/
├── config.toml          # 配置信息
├── node.key             # Ed25519 私钥 (加密)
├── network_acl.toml     # 网络 ACL
└── data/
    └── core.db          # 加密数据库

保护措施:
• 目录权限: 0700 (仅所有者)
• 文件权限: 0600 (敏感文件)
• 私钥加密: ChaCha20-Poly1305
• 助记词: 可选加密存储
```

#### 3. 内存数据

| 数据类型 | 风险 | 保护措施 |
|----------|------|----------|
| 私钥 | 极高 | 使用时解密，立即清除 |
| Bearer Token | 高 | 定期轮换，内存不持久化 |
| 会话密钥 | 高 | 临时生成，连接结束清除 |
| 解密数据 | 中 | 最小化生命周期 |

---

## 风险评级

### 风险矩阵

```
影响
  ^
高│  [DDoS]        [MITM]      [私钥泄露]
  │       [ACL污染]     [数据库破解]
  │            [WASM逃逸]
  │
中│  [mDNS欺骗]   [配置错误]   [重放攻击]
  │       [连接洪泛]
  │
低│  [协议降级]   [资源耗尽]   [信息泄露]
  │
  └───────────────────────────────────────> 可能性
       低           中          高
```

### 优先级列表

| 排名 | 威胁 | 风险等级 | 处理优先级 |
|------|------|----------|------------|
| 1 | 私钥/助记词泄露 | 关键 | P0 |
| 2 | 中间人攻击 | 高 | P0 |
| 3 | ACL 系统攻击 | 高 | P1 |
| 4 | DDoS 攻击 | 高 | P1 |
| 5 | Skill 沙箱逃逸 | 高 | P1 |
| 6 | 数据库加密破解 | 中 | P2 |
| 7 | 重放攻击 | 中 | P2 |
| 8 | 配置泄露 | 中 | P2 |
| 9 | mDNS 欺骗 | 低 | P3 |
| 10 | 资源耗尽 | 低 | P3 |

### 残余风险

以下风险在现有架构下无法完全消除，需要用户意识：

1. **物理访问**: 冷启动攻击可能获取内存中的密钥
2. **供应链攻击**: 依赖的 Rust crate 可能存在漏洞
3. **侧信道攻击**: 时序分析可能泄露信息
4. **社会工程**: 用户可能被欺骗执行恶意操作

---

## 参考

- [CIS 安全指南](./SECURITY_GUIDE.md)
- [CIS 应急响应手册](./INCIDENT_RESPONSE.md)
- [NETWORK_ACCESS_DESIGN.md](../../plan/NETWORK_ACCESS_DESIGN.md)
- [acl_implementation.md](../acl_implementation.md)

---

**文档维护**: CIS 安全团队  
**最后更新**: 2026-02-08
