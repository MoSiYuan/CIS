name: Security Audit

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
  pull_request:
    branches: [ main ]
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
  schedule:
    # 每天 UTC 00:00 运行
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  cargo-audit:
    name: Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
      
      - name: Cache cargo audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit
      
      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit
          fi
      
      - name: Update advisory database
        run: cargo audit update
      
      - name: Run cargo audit
        run: cargo audit --json > audit-report.json
        continue-on-error: true
      
      - name: Generate human-readable report
        run: cargo audit
        continue-on-error: true
      
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cargo-audit-report
          path: |
            audit-report.json
            reports/security/
      
      - name: Check for critical vulnerabilities
        run: |
          # 检查是否有高危漏洞（排除已知的无法修复的漏洞）
          VULN_COUNT=$(cargo audit 2>&1 | grep -c "vulnerabilities found" || true)
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "⚠️ 发现漏洞，请查看报告详情"
            cargo audit || true
            # 暂时不阻止构建，因为 rsa 漏洞无法修复
            exit 0
          fi

  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny
      
      - name: Check for banned dependencies
        run: cargo deny check
        continue-on-error: true

  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny
      
      - name: Check licenses
        run: cargo deny check licenses
        continue-on-error: true
