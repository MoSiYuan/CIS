# CIS 生产化就绪计划 (Production Readiness Plan)

**版本**: v1.0  
**日期**: 2026-02-08  
**目标**: 将 CIS 从 Alpha 推进至生产就绪 (Production Ready)  
**当前状态**: ~75% 完成度，核心功能可用，需完善稳定性与生态

---

## 执行摘要

本计划将 CIS 生产化分解为 **6 个阶段、42 个任务包、156 个原子任务**，支持 AI Agent 并行执行。

```
生产化路线图
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 1: 稳定性加固 (Week 1-2)    ████████████████████ 100% → 生产基线
Phase 2: 核心功能完善 (Week 3-4)  ████████████████░░░░ 80% → 功能完整
Phase 3: 性能优化 (Week 5-6)      ██████████████░░░░░░ 70% → 性能达标
Phase 4: 生态集成 (Week 7-8)      ████████████░░░░░░░░ 60% → 生态就绪
Phase 5: 安全审计 (Week 9-10)     ██████████░░░░░░░░░░ 50% → 安全合规
Phase 6: 发布准备 (Week 11-12)    ████████░░░░░░░░░░░░ 40% → 正式发布
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 任务总览矩阵

| 阶段 | 任务包数 | 原子任务数 | 并行度 | 预估人天 | 关键里程碑 |
|------|----------|------------|--------|----------|------------|
| Phase 1: 稳定性加固 | 8 | 32 | 高 (6 并行) | 14 | 测试通过率 100% |
| Phase 2: 核心功能完善 | 10 | 38 | 高 (8 并行) | 18 | WASM 执行完整 |
| Phase 3: 性能优化 | 7 | 26 | 中 (4 并行) | 12 | P95 < 100ms |
| Phase 4: 生态集成 | 9 | 34 | 高 (7 并行) | 16 | Element 完整集成 |
| Phase 5: 安全审计 | 5 | 18 | 低 (2 并行) | 10 | 零高危漏洞 |
| Phase 6: 发布准备 | 3 | 8 | 中 (3 并行) | 6 | v1.0.0 发布 |
| **总计** | **42** | **156** | - | **76** | - |

---

## Phase 1: 稳定性加固 (Stability Hardening)

**目标**: 修复所有测试失败，建立生产级基线  
**周期**: Week 1-2  
**并行策略**: 6 个任务包可并行，每个任务包内部串行

### 任务包 P1-1: 内存安全修复

**优先级**: P0 (阻塞)  
**负责人**: Agent-A  
**依赖**: 无  
**预估**: 3 天

```
┌─────────────────────────────────────────────────────────────┐
│ 问题: SIGBUS - access to undefined memory                    │
│ 文件: memory/service.rs, storage/db.rs                      │
│ 根因: 异步锁修改导致状态竞争，数据库连接未正确关闭           │
└─────────────────────────────────────────────────────────────┘
```

**原子任务**:

- [ ] **P1-1.1** 修复 `memory::service::tests::test_memory_service_delete`
  - 分析: 异步删除操作的竞态条件
  - 方案: 添加 `Arc<Mutex<>>` 保护删除流程
  - 验收: 测试连续运行 100 次通过
  
- [ ] **P1-1.2** 修复 `storage::db::tests::test_core_db`
  - 分析: 数据库连接池在测试间未隔离
  - 方案: 使用 `tempfile` 创建隔离测试数据库
  - 验收: 测试并行运行无冲突

- [ ] **P1-1.3** 修复 WASM 运行时内存问题
  - 分析: `wasmtime`/`wasmer` 运行时未正确初始化
  - 方案: 添加 `lazy_static` 全局运行时
  - 验收: WASM 测试全部通过

**输出物**:
- `fix/memory-safety.patch`
- 测试报告: `reports/p1-1-test-results.md`

---

### 任务包 P1-2: WebSocket 测试修复

**优先级**: P0 (阻塞)  
**负责人**: Agent-B  
**依赖**: 无  
**预估**: 2 天

**原子任务**:

- [ ] **P1-2.1** 修复 `test_sync_response_handling`
  - 问题: 异步响应超时
  - 方案: 增加 `tokio::time::timeout` 配置
  
- [ ] **P1-2.2** 修复 `test_sync_request_handling`
  - 问题: Mock 服务器端口冲突
  - 方案: 使用 `portpicker` 动态分配端口

- [ ] **P1-2.3** 添加 WebSocket 重连测试
  - 场景: 网络断开后自动重连
  - 验收: 3 次断连后仍能恢复同步

**输出物**:
- `fix/websocket-tests.patch`
- WebSocket 测试覆盖率报告

---

### 任务包 P1-3: 项目注册表测试修复

**优先级**: P0 (阻塞)  
**负责人**: Agent-C  
**依赖**: 无  
**预估**: 1.5 天

**原子任务**:

- [ ] **P1-3.1** 修复 `test_project_skill_config`
  - 问题: 临时目录清理失败
  - 方案: 使用 `tempfile::TempDir` RAII 模式
  
- [ ] **P1-3.2** 添加项目配置热重载测试
  - 场景: 配置文件变更后自动重载
  - 验收: 变更后 5 秒内生效

**输出物**:
- `fix/project-registry.patch`

---

### 任务包 P1-4: 端到端测试套件

**优先级**: P1 (重要)  
**负责人**: Agent-D  
**依赖**: P1-1, P1-2, P1-3 完成  
**预估**: 2 天

**原子任务**:

- [ ] **P1-4.1** 创建 E2E 测试框架
  - 使用 `assert_cmd` + `predicates`
  - 创建 `tests/e2e/` 目录
  
- [ ] **P1-4.2** 编写 `cis init` E2E 测试
  - 场景: 全新环境初始化
  - 验证: 目录结构、配置文件生成
  
- [ ] **P1-4.3** 编写 `cis skill do` E2E 测试
  - 场景: 自然语言调用 Skill
  - 验证: 任务创建、执行、结果返回
  
- [ ] **P1-4.4** 编写 `cis dag run` E2E 测试
  - 场景: DAG 配置文件执行
  - 验证: 任务依赖、执行顺序、结果聚合

**输出物**:
- `tests/e2e/` 测试套件
- E2E 测试文档

---

### 任务包 P1-5: CI/CD 流水线强化

**优先级**: P1 (重要)  
**负责人**: Agent-E  
**依赖**: 无  
**预估**: 2 天

**原子任务**:

- [ ] **P1-5.1** 添加测试覆盖率检查
  - 目标: > 80% 覆盖率
  - 工具: `cargo-tarpaulin`
  - 集成: GitHub Actions
  
- [ ] **P1-5.2** 添加跨平台构建
  - 平台: macOS (x86_64, arm64), Linux (x86_64, aarch64)
  - 工具: `cross` + GitHub Actions matrix
  
- [ ] **P1-5.3** 添加性能基准测试
  - 工具: `criterion.rs`
  - 基准: DAG 执行、向量检索、Skill 调用
  
- [ ] **P1-5.4** 添加安全扫描
  - 工具: `cargo-audit`, `cargo-deny`
  - 检查: 依赖漏洞、许可证合规

**输出物**:
- `.github/workflows/enhanced-ci.yml`
- 覆盖率报告配置

---

### 任务包 P1-6: 编译警告清理

**优先级**: P2 (建议)  
**负责人**: Agent-F  
**依赖**: 无  
**预估**: 1 天

**原子任务**:

- [ ] **P1-6.1** 修复所有 `cargo clippy` 警告
  - 当前: 4 个警告
  - 目标: 0 警告
  
- [ ] **P1-6.2** 启用 `#![deny(warnings)]`
  - 文件: `cis-core/src/lib.rs`
  
- [ ] **P1-6.3** 添加 `rustfmt` 检查
  - 集成: CI 流水线

**输出物**:
- `fix/clippy-warnings.patch`

---

### 任务包 P1-7: 文档测试

**优先级**: P2 (建议)  
**负责人**: Agent-G  
**依赖**: 无  
**预估**: 1.5 天

**原子任务**:

- [ ] **P1-7.1** 添加 DocTest
  - 目标: 所有公共 API 都有示例代码
  - 验收: `cargo test --doc` 通过
  
- [ ] **P1-7.2** 验证文档准确性
  - 检查: API 文档与实际代码一致
  - 工具: `cargo doc --no-deps`

**输出物**:
- 文档测试覆盖报告

---

### 任务包 P1-8: 稳定性验收

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P1-1 ~ P1-7 全部完成  
**预估**: 1 天

**验收标准**:

```yaml
稳定性基线:
  单元测试通过率: 100%
  集成测试通过率: 100%
  E2E 测试通过率: > 95%
  代码覆盖率: > 80%
  编译警告: 0
  安全漏洞: 0 高危
  
性能基线:
  DAG 执行: < 100ms (空 DAG)
  向量检索: < 50ms (1k 向量)
  Skill 调用: < 200ms (简单 Skill)
  内存使用: < 100MB (空闲)
```

**输出物**:
- `reports/phase1-completion-report.md`

---

## Phase 2: 核心功能完善 (Core Feature Completion)

**目标**: 完成所有核心功能，达到功能完整  
**周期**: Week 3-4  
**并行策略**: 8 个任务包可并行

### 任务包 P2-1: WASM Skill 完整执行

**优先级**: P0 (阻塞)  
**负责人**: Agent-H  
**依赖**: P1-1 完成  
**预估**: 4 天

**当前状态**:
```rust
// scheduler/skill_executor.rs
async fn execute_wasm(&self, wasm_bytes: &[u8], inputs: Value) -> Result<Value> {
    todo!("WASM execution not yet implemented")  // ← 需要实现
}
```

**原子任务**:

- [ ] **P2-1.1** 选择 WASM 运行时
  - 方案 A: `wasmtime` (推荐，Cranelift 编译器)
  - 方案 B: `wasmer` (已部分集成)
  - 决策: 基于性能和生态选择
  
- [ ] **P2-1.2** 实现 WASM 模块加载
  - 文件: `cis-core/src/wasm/loader.rs`
  - 功能: 验证、编译、缓存 WASM 模块
  
- [ ] **P2-1.3** 实现 Host API
  - API 列表:
    - `memory_get(key: &str) -> Option<String>`
    - `memory_set(key: &str, value: &str)`
    - `ai_chat(prompt: &str) -> String`
    - `log(level: &str, message: &str)`
    - `http_post(url: &str, body: &str) -> Result<String>`
  
- [ ] **P2-1.4** 实现输入输出序列化
  - 格式: JSON
  - 边界: 处理大输入 (> 1MB)
  
- [ ] **P2-1.5** 实现资源限制
  - CPU: 限制执行时间 (< 30s)
  - 内存: 限制内存使用 (< 128MB)
  - 网络: 可选禁用网络访问
  
- [ ] **P2-1.6** 添加 WASM 测试套件
  - 测试用例: 简单计算、内存操作、AI 调用
  - 验收: 100% 测试通过

**输出物**:
- `feat/wasm-execution/` 模块
- WASM Skill 开发文档

---

### 任务包 P2-2: 四级决策完整实现

**优先级**: P0 (阻塞)  
**负责人**: Agent-I  
**依赖**: 无  
**预估**: 3 天

**当前状态**:
- Mechanical: ✅ 工作正常
- Recommended: ⚠️ 倒计时机制待实现
- Confirmed: ⚠️ 用户输入待实现
- Arbitrated: ⚠️ 仲裁工作流待实现

**原子任务**:

- [ ] **P2-2.1** 实现 Recommended 倒计时
  - 配置: `decision.timeout_recommended = 30s`
  - 行为: 超时后自动降级为 Mechanical
  - UI: 显示倒计时进度
  
- [ ] **P2-2.2** 实现 Confirmed 用户确认
  - 交互: CLI 提示 `确认执行? [Y/n]`
  - 超时: 5 分钟无响应则取消
  - 记录: 确认操作写入审计日志
  
- [ ] **P2-2.3** 实现 Arbitrated 仲裁工作流
  - 场景: 多节点冲突时仲裁
  - 机制: Raft 共识或指定仲裁节点
  - 超时: 10 分钟未达成共识则失败
  
- [ ] **P2-2.4** 添加决策配置
  - 文件: `~/.config/cis/decision.toml`
  - 配置项: 各级超时、默认级别、仲裁节点

**输出物**:
- `feat/four-level-decision/` 模块
- 决策配置文档

---

### 任务包 P2-3: GUI 数据连接

**优先级**: P1 (重要)  
**负责人**: Agent-J  
**依赖**: P1-1 完成  
**预估**: 3 天

**当前状态**: GUI 使用演示数据

**原子任务**:

- [ ] **P2-3.1** 实现 GUI ↔ Core 通信
  - 方案: 共享 SQLite (推荐)
  - 备选: Unix Socket / HTTP API
  - 决策: 基于简单性和性能选择
  
- [ ] **P2-3.2** 连接节点列表
  - 数据来源: `network.nodes` 表
  - 实时更新: 使用 SQLite `notify` 或轮询
  
- [ ] **P2-3.3** 连接 DAG 状态显示
  - 数据来源: `dag_runs`, `tasks` 表
  - 实时更新: 执行进度实时刷新
  
- [ ] **P2-3.4** 连接债务列表
  - 数据来源: `debts` 表
  - 交互: GUI 直接解决债务
  
- [ ] **P2-3.5** 连接 ACL 管理
  - 数据来源: `network.acl` 表
  - 交互: 可视化添加/删除节点

**输出物**:
- `cis-gui/src/data/` 数据连接模块
- GUI 架构文档更新

---

### 任务包 P2-4: P2P 组网完善

**优先级**: P1 (重要)  
**负责人**: Agent-K  
**依赖**: 无  
**预估**: 4 天

**当前状态**: mDNS 发现 + QUIC 传输部分实现

**原子任务**:

- [ ] **P2-4.1** 完善 mDNS 服务发现
  - 功能: 自动发现局域网 CIS 节点
  - 优化: 减少广播频率，避免网络拥塞
  
- [ ] **P2-4.2** 实现 DHT 广域网发现
  - 协议: libp2p Kademlia DHT
  - 引导: 配置引导节点列表
  
- [ ] **P2-4.3** 实现 NAT 穿透
  - STUN: 公网 IP 发现
  - TURN: 中继 fallback
  - UPnP: 自动端口映射
  
- [ ] **P2-4.4** 实现连接质量监测
  - 指标: 延迟、丢包率、带宽
  - 策略: 自动切换最优路径
  
- [ ] **P2-4.5** 添加 P2P 测试套件
  - 场景: 局域网发现、广域网连接、NAT 穿透
  - 验收: 3 种网络环境下 100% 连通

**输出物**:
- `feat/p2p-networking/` 模块
- P2P 网络配置文档

---

### 任务包 P2-5: ACL 完整功能

**优先级**: P1 (重要)  
**负责人**: Agent-L  
**依赖**: 无  
**预估**: 2 天

**当前状态**: 命令框架存在，功能待完善

**原子任务**:

- [ ] **P2-5.1** 实现 ACL 规则引擎
  - 规则类型: Allow/Deny/Quarantine
  - 匹配条件: DID、IP、时间窗口
  
- [ ] **P2-5.2** 实现 ACL 同步传播
  - 机制: DNS 风格版本控制
  - 防回滚: 版本号单调递增
  
- [ ] **P2-5.3** 实现四种网络模式
  - Whitelist: 仅允许已知节点
  - Solitary: 拒绝新连接
  - Open: 允许验证通过的节点
  - Quarantine: 仅审计不拒绝
  
- [ ] **P2-5.4** 添加 ACL CLI 命令
  - `cis network allow <did> --reason "..."`
  - `cis network deny <did> --reason "..."`
  - `cis network mode <whitelist|solitary|open|quarantine>`
  - `cis network list [--format json|table]`

**输出物**:
- `feat/acl-system/` 模块
- ACL 配置指南

---

### 任务包 P2-6: IM 集成功能

**优先级**: P2 (建议)  
**负责人**: Agent-M  
**依赖**: P2-4 完成  
**预估**: 3 天

**当前状态**: 占位符

**原子任务**:

- [ ] **P2-6.1** 设计 IM 集成架构
  - 方案: Matrix Bot + Webhook
  - 备选: 直接集成 Slack/Discord API
  
- [ ] **P2-6.2** 实现 Matrix Bot
  - 功能: 接收命令、发送通知
  - 命令: `!cis status`, `!cis run <dag>`
  
- [ ] **P2-6.3** 实现通知推送
  - 场景: DAG 完成、债务产生、节点上线
  - 格式: Markdown 富文本
  
- [ ] **P2-6.4** 实现双向交互
  - 场景: IM 中确认决策、解决债务
  - 安全: 验证用户身份 (DID)

**输出物**:
- `feat/im-integration/` 模块
- IM 集成文档

---

### 任务包 P2-7: 远程会话完善

**优先级**: P1 (重要)  
**负责人**: Agent-N  
**依赖**: 无  
**预估**: 2.5 天

**当前状态**: WebSocket PTY 框架存在

**原子任务**:

- [ ] **P2-7.1** 实现多会话管理
  - 功能: 创建、列出、切换、关闭会话
  - 命令: `cis session ls/new/attach/kill`
  
- [ ] **P2-7.2** 实现会话恢复
  - 场景: 网络断开后恢复会话
  - 机制: 会话状态持久化到 SQLite
  
- [ ] **P2-7.3** 实现 Agent 多路复用
  - 场景: 一个会话中切换不同 Agent
  - 命令: `cis session agent <claude|kimi|aider>`
  
- [ ] **P2-7.4** 添加权限控制
  - 粒度: 会话级别 ACL
  - 审计: 记录所有会话操作

**输出物**:
- `feat/remote-session/` 模块
- 远程会话使用指南

---

### 任务包 P2-8: 向量引擎优化

**优先级**: P1 (重要)  
**负责人**: Agent-O  
**依赖**: 无  
**预估**: 2 天

**原子任务**:

- [ ] **P2-8.1** 优化嵌入模型加载
  - 当前: 首次使用下载
  - 优化: `cis init` 时预下载
  - 备选: 使用远程 API (OpenAI)
  
- [ ] **P2-8.2** 实现向量索引分片
  - 场景: 百万级向量
  - 策略: 按项目分片，减少单次检索范围
  
- [ ] **P2-8.3** 添加向量缓存
  - 机制: LRU 缓存热点向量
  - 容量: 可配置 (默认 10k)

**输出物**:
- `feat/vector-optimization/` 模块
- 向量引擎性能报告

---

### 任务包 P2-9: Skill 生态完善

**优先级**: P2 (建议)  
**负责人**: Agent-P  
**依赖**: P2-1 完成  
**预估**: 3 天

**原子任务**:

- [ ] **P2-9.1** 创建官方 Skill 模板
  - 类型: WASM / Binary / DAG
  - 包含: 示例代码、测试、CI 配置
  
- [ ] **P2-9.2** 实现 Skill 版本管理
  - 功能: 安装、更新、回滚
  - 命令: `cis skill install/update/rollback`
  
- [ ] **P2-9.3** 实现 Skill 市场 (本地)
  - 功能: 浏览、搜索、安装 Skill
  - 格式: Git 仓库或本地目录
  
- [ ] **P2-9.4** 创建 5 个官方 Skill
  - 代码审查 Skill
  - 文档生成 Skill
  - 测试生成 Skill
  - 部署自动化 Skill
  - 会议纪要 Skill

**输出物**:
- `skills/official/` 官方 Skill 集合
- Skill 开发 SDK 文档

---

### 任务包 P2-10: 核心功能验收

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P2-1 ~ P2-9 全部完成  
**预估**: 1 天

**验收标准**:

```yaml
功能完整度:
  WASM 执行: 100% (所有 Host API 可用)
  四级决策: 100% (全部实现)
  GUI 数据: 100% (真实数据)
  P2P 组网: 100% (LAN + WAN)
  ACL 系统: 100% (四种模式)
  IM 集成: 80% (Matrix Bot)
  远程会话: 100% (多会话 + 恢复)
  
Skill 生态:
  官方 Skill: >= 5 个
  Skill SDK: 完整文档
  模板项目: 3 个 (WASM/Binary/DAG)
```

**输出物**:
- `reports/phase2-completion-report.md`

---

## Phase 3: 性能优化 (Performance Optimization)

**目标**: 达到生产级性能指标  
**周期**: Week 5-6  
**并行策略**: 4 个任务包可并行

### 任务包 P3-1: 内存优化

**优先级**: P1 (重要)  
**负责人**: Agent-Q  
**依赖**: P1-1, P2-1 完成  
**预估**: 3 天

**原子任务**:

- [ ] **P3-1.1** 减少 String/Vec 克隆
  - 工具: `cargo-clone-analyze`
  - 优化: 使用 `&str` 替代 `String`，`Arc<[T]>` 替代 `Vec<T>`
  
- [ ] **P3-1.2** 优化数据库连接池
  - 当前: 每个模块独立连接
  - 优化: 共享连接池，`r2d2` 管理
  
- [ ] **P3-1.3** 实现对象池
  - 场景: WASM 运行时、HTTP 客户端
  - 工具: `object_pool` crate
  
- [ ] **P3-1.4** 添加内存分析
  - 工具: `dhat` 或 `heaptrack`
  - 目标: 识别内存泄漏点

**验收标准**:
```yaml
内存使用:
  空闲状态: < 50MB
  DAG 执行: < 100MB
  向量检索: < 150MB
  24小时运行: 无内存泄漏
```

**输出物**:
- `opt/memory-optimization.patch`
- 内存分析报告

---

### 任务包 P3-2: 异步优化

**优先级**: P1 (重要)  
**负责人**: Agent-R  
**依赖**: P1-1 完成  
**预估**: 2.5 天

**原子任务**:

- [ ] **P3-2.1** 替换剩余同步锁
  - 文件: 全面审查 `std::sync::Mutex`
  - 替换: `tokio::sync::RwLock`
  
- [ ] **P3-2.2** 优化任务调度
  - 当前: 顺序执行
  - 优化: 无依赖任务并行执行
  
- [ ] **P3-2.3** 实现背压机制
  - 场景: 大量并发 DAG 请求
  - 机制: 队列长度限制 + 优雅降级
  
- [ ] **P3-2.4** 添加异步追踪
  - 工具: `tokio-console`
  - 功能: 可视化任务执行

**验收标准**:
```yaml
并发性能:
  同时执行 DAG: >= 10 个
  任务调度延迟: < 10ms
  无死锁: 100% 测试通过
```

**输出物**:
- `opt/async-optimization.patch`
- 并发性能报告

---

### 任务包 P3-3: 存储优化

**优先级**: P1 (重要)  
**负责人**: Agent-S  
**依赖**: 无  
**预估**: 2.5 天

**原子任务**:

- [ ] **P3-3.1** 添加数据库索引
  - 分析: `EXPLAIN QUERY PLAN` 慢查询
  - 索引: `tasks(dag_run_id)`, `memories(project_id)`
  
- [ ] **P3-3.2** 实现查询缓存
  - 场景: 频繁读取的配置、节点列表
  - 机制: LRU 缓存 + 失效通知
  
- [ ] **P3-3.3** 优化 WAL 模式
  - 配置: `PRAGMA wal_autocheckpoint = 1000`
  - 监控: WAL 文件大小
  
- [ ] **P3-3.4** 实现数据压缩
  - 场景: 大文本记忆
  - 算法: zstd

**验收标准**:
```yaml
存储性能:
  简单查询: < 5ms
  复杂 JOIN: < 50ms
  向量检索: < 30ms (10k 向量)
  数据库大小: 年增长 < 2x
```

**输出物**:
- `opt/storage-optimization.patch`
- 存储性能报告

---

### 任务包 P3-4: 启动优化

**优先级**: P2 (建议)  
**负责人**: Agent-T  
**依赖**: 无  
**预估**: 2 天

**原子任务**:

- [ ] **P3-4.1** 延迟加载模块
  - 当前: 启动时加载所有模块
  - 优化: 按需加载 WASM 运行时、向量引擎
  
- [ ] **P3-4.2** 并行初始化
  - 场景: 数据库、网络、身份同时初始化
  - 工具: `tokio::join!`
  
- [ ] **P3-4.3** 添加启动缓存
  - 场景: 节点发现结果、DID 解析
  - 机制: 序列化到磁盘，下次快速加载

**验收标准**:
```yaml
启动时间:
  冷启动: < 2s
  热启动: < 500ms
  初始化进度: 可显示百分比
```

**输出物**:
- `opt/startup-optimization.patch`
- 启动性能报告

---

### 任务包 P3-5: 性能验收

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P3-1 ~ P3-4 全部完成  
**预估**: 1 天

**验收标准**:

```yaml
性能基线 (生产环境):
  DAG 执行延迟:
    P50: < 50ms
    P95: < 100ms
    P99: < 200ms
    
  向量检索延迟:
    P50: < 20ms
    P95: < 50ms
    P99: < 100ms
    
  吞吐量:
    DAG/秒: >= 100
    向量检索/秒: >= 1000
    
  资源使用:
    CPU: < 50% (4核)
    内存: < 200MB
    磁盘 I/O: < 10MB/s
```

**输出物**:
- `reports/phase3-completion-report.md`
- 性能基准测试套件

---

## Phase 4: 生态集成 (Ecosystem Integration)

**目标**: 建立完整生态，降低使用门槛  
**周期**: Week 7-8  
**并行策略**: 7 个任务包可并行

### 任务包 P4-1: Element 完整集成

**优先级**: P0 (阻塞)  
**负责人**: Agent-U  
**依赖**: P2-4 完成  
**预估**: 4 天

**当前状态**: Matrix 用户注册 API 已实现

**原子任务**:

- [ ] **P4-1.1** 实现 CIS 作为 Matrix AppService
  - 注册: 向 homeserver 注册 AppService
  - 权限: 管理 Room、发送消息
  
- [ ] **P4-1.2** 实现 Room 自动创建
  - 场景: 每个项目自动创建 Room
  - 命名: `#cis-<project>:<server>`
  
- [ ] **P4-1.3** 实现 DAG 状态广播
  - 事件: `m.room.message` 格式化状态
  - 富文本: 使用 HTML 格式
  
- [ ] **P4-1.4** 实现双向命令
  - 命令: `!cis run <dag>`
  - 响应: 执行结果回复到 Room
  
- [ ] **P4-1.5** 实现 E2EE 支持
  - 加密: Olm/Megolm 密钥管理
  - 验证: 设备交叉签名

**输出物**:
- `feat/element-integration/` 模块
- Element 集成指南

---

### 任务包 P4-2: VS Code 插件

**优先级**: P1 (重要)  
**负责人**: Agent-V  
**依赖**: 无  
**预估**: 3 天

**原子任务**:

- [ ] **P4-2.1** 创建插件框架
  - 模板: VS Code Extension Generator
  - 语言: TypeScript
  
- [ ] **P4-2.2** 实现侧边栏面板
  - 功能: 节点列表、DAG 状态、债务列表
  - 刷新: 自动/手动
  
- [ ] **P4-2.3** 实现命令集成
  - 命令: `CIS: Run DAG`, `CIS: View Status`
  - 快捷键: 可配置
  
- [ ] **P4-2.4** 实现代码 Lens
  - 场景: DAG 配置文件显示执行按钮
  - 交互: 点击运行

**输出物**:
- `extensions/vscode/` 插件源码
- VS Code 市场发布

---

### 任务包 P4-3: Homebrew 发布

**优先级**: P1 (重要)  
**负责人**: Agent-W  
**依赖**: P1-5 完成  
**预估**: 1.5 天

**原子任务**:

- [ ] **P4-3.1** 创建 Homebrew Formula
  - 文件: `packaging/homebrew/cis.rb`
  - 依赖: Rust、SQLite
  
- [ ] **P4-3.2** 配置自动更新
  - 机制: GitHub Release 触发 PR
  - 工具: `brew bump-formula-pr`
  
- [ ] **P4-3.3** 提交到 Homebrew Core
  - 要求: 100+ stars、稳定版本
  - 备选: 自建 Tap

**输出物**:
- `MoSiYuan/homebrew-cis` Tap
- 安装文档更新

---

### 任务包 P4-4: Docker 支持

**优先级**: P2 (建议)  
**负责人**: Agent-X  
**依赖**: 无  
**预估**: 2 天

**注意**: CIS 设计为硬件绑定，Docker 会破坏此特性，需谨慎

**原子任务**:

- [ ] **P4-4.1** 创建 Dockerfile
  - 基础: `rust:1.75-slim`
  - 注意: 添加 `--privileged` 支持硬件指纹
  
- [ ] **P4-4.2** 创建 Docker Compose
  - 服务: CIS + Element Web
  - 网络: 主机模式
  
- [ ] **P4-4.3** 添加开发容器支持
  - 配置: `.devcontainer/devcontainer.json`
  - 场景: GitHub Codespaces

**输出物**:
- `Dockerfile`
- `docker-compose.yml`
- 容器化警告文档

---

### 任务包 P4-5: Shell 集成

**优先级**: P1 (重要)  
**负责人**: Agent-Y  
**依赖**: 无  
**预估**: 2 天

**原子任务**:

- [ ] **P4-5.1** 创建 Shell 补全脚本
  - 支持: Bash、Zsh、Fish
  - 生成: `cis completions <shell>`
  
- [ ] **P4-5.2** 创建 Shell 别名
  - 示例: `cisd='cis dag'`, `ciss='cis skill'`
  - 配置: 自动添加到 `.bashrc`/`.zshrc`
  
- [ ] **P4-5.3** 实现 Shell 钩子
  - 场景: 进入项目目录自动切换 CIS 配置
  - 机制: `chpwd` 钩子

**输出物**:
- `shell/` 补全脚本
- Shell 集成文档

---

### 任务包 P4-6: 文档完善

**优先级**: P1 (重要)  
**负责人**: Agent-Z  
**依赖**: 无  
**预估**: 3 天

**原子任务**:

- [ ] **P4-6.1** 编写用户指南
  - 快速开始: 5 分钟上手
  - 核心概念: DAG、Skill、记忆
  - 进阶使用: 网络配置、安全配置
  
- [ ] **P4-6.2** 编写开发者文档
  - 架构设计: 模块关系图
  - API 文档: 自动生成 (rustdoc)
  - 贡献指南: PR 流程、代码规范
  
- [ ] **P4-6.3** 编写部署文档
  - 单机部署: 二进制安装
  - 集群部署: 多节点组网
  - 容器部署: Docker 注意事项
  
- [ ] **P4-6.4** 创建视频教程
  - 入门: 安装与初始化
  - 进阶: 创建第一个 Skill
  - 高级: 多节点组网

**输出物**:
- `docs/` 完整文档
- 视频教程链接

---

### 任务包 P4-7: 示例项目

**优先级**: P2 (建议)  
**负责人**: Agent-AA  
**依赖**: P2-9 完成  
**预估**: 2 天

**原子任务**:

- [ ] **P4-7.1** 创建个人知识管理示例
  - 场景: 笔记整理、标签管理
  - 包含: DAG 配置、Skill 代码
  
- [ ] **P4-7.2** 创建开发工作流示例
  - 场景: 代码审查、测试生成、部署
  - 包含: CI/CD 集成
  
- [ ] **P4-7.3** 创建多设备同步示例
  - 场景: 笔记本 ↔ 服务器 ↔ 手机
  - 包含: 网络配置、ACL 设置

**输出物**:
- `examples/` 示例集合
- 示例演示视频

---

### 任务包 P4-8: 生态集成验收

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P4-1 ~ P4-7 全部完成  
**预估**: 0.5 天

**验收标准**:

```yaml
生态完整度:
  Element 集成: 100% (双向命令 + E2EE)
  VS Code 插件: 100% (侧边栏 + 命令)
  包管理器: 100% (Homebrew)
  Shell 集成: 100% (补全 + 别名)
  文档: 100% (用户 + 开发者 + 部署)
  示例: >= 3 个
```

**输出物**:
- `reports/phase4-completion-report.md`

---

## Phase 5: 安全审计 (Security Audit)

**目标**: 达到生产级安全标准  
**周期**: Week 9-10  
**并行策略**: 2 个任务包可并行（安全需串行审查）

### 任务包 P5-1: 代码安全审计

**优先级**: P0 (阻塞)  
**负责人**: Security-Agent-A  
**依赖**: P1-1 ~ P4-8 完成  
**预估**: 4 天

**原子任务**:

- [ ] **P5-1.1** 依赖漏洞扫描
  - 工具: `cargo-audit`
  - 修复: 更新有漏洞的依赖
  
- [ ] **P5-1.2** 静态代码分析
  - 工具: `cargo-clippy` (严格模式)
  - 工具: `semgrep` (安全规则)
  
- [ ] **P5-1.3** 不安全代码审查
  - 搜索: `unsafe` 块
  - 审查: 每个 `unsafe` 的必要性和安全性
  
- [ ] **P5-1.4** 加密实现审查
  - 检查: ChaCha20-Poly1305 正确使用
  - 检查: 密钥派生 (Argon2id)
  - 检查: 随机数生成 (OsRng)
  
- [ ] **P5-1.5** 输入验证审查
  - 检查: 所有用户输入的验证
  - 检查: SQL 注入防护
  - 检查: 路径遍历防护

**验收标准**:
```yaml
安全基线:
  高危漏洞: 0
  中危漏洞: 0
  低危漏洞: < 5 (需记录)
  unsafe 块: 有文档说明
  加密实现: 通过审查
```

**输出物**:
- `reports/security-audit-report.md`
- 漏洞修复记录

---

### 任务包 P5-2: 渗透测试

**优先级**: P0 (阻塞)  
**负责人**: Security-Agent-B  
**依赖**: P5-1 完成  
**预估**: 3 天

**原子任务**:

- [ ] **P5-2.1** 网络层渗透测试
  - 工具: `nmap`, `wireshark`
  - 测试: 端口扫描、协议分析
  
- [ ] **P5-2.2** WebSocket API 测试
  - 工具: `websocat`, 自定义脚本
  - 测试: 未授权访问、注入攻击
  
- [ ] **P5-2.3** P2P 网络测试
  - 测试: 中间人攻击、重放攻击
  - 验证: Noise XX 握手安全性
  
- [ ] **P5-2.4** 模糊测试
  - 工具: `cargo-fuzz`
  - 目标: 输入解析、协议处理

**验收标准**:
```yaml
渗透测试:
  未授权访问: 0
  数据泄露: 0
  拒绝服务: 0
  模糊测试: 无崩溃
```

**输出物**:
- `reports/penetration-test-report.md`

---

### 任务包 P5-3: 安全配置审查

**优先级**: P1 (重要)  
**负责人**: Security-Agent-C  
**依赖**: 无  
**预估**: 2 天

**原子任务**:

- [ ] **P5-3.1** 默认安全配置审查
  - 检查: 默认网络模式 (应为 Whitelist)
  - 检查: 默认加密启用
  - 检查: 最小权限原则
  
- [ ] **P5-3.2** 安全文档编写
  - 威胁模型: 识别潜在威胁
  - 安全指南: 安全配置建议
  - 应急响应: 安全事件处理

**输出物**:
- `docs/security/` 安全文档
- `SECURITY.md`

---

### 任务包 P5-4: 安全验收

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P5-1 ~ P5-3 全部完成  
**预估**: 1 天

**验收标准**:

```yaml
安全合规:
  代码审计: 通过
  渗透测试: 通过
  模糊测试: 通过
  安全配置: 审查通过
  文档: 完整
  
认证 (可选):
  SOC 2: 准备材料
  ISO 27001: 准备材料
```

**输出物**:
- `reports/phase5-completion-report.md`

---

## Phase 6: 发布准备 (Release Preparation)

**目标**: 正式发布 v1.0.0  
**周期**: Week 11-12  
**并行策略**: 3 个任务包可并行

### 任务包 P6-1: 版本发布

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P1 ~ P5 全部完成  
**预估**: 2 天

**原子任务**:

- [ ] **P6-1.1** 版本号确定
  - 当前: v0.9.0
  - 发布: v1.0.0
  
- [ ] **P6-1.2** 更新 CHANGELOG
  - 格式: Keep a Changelog
  - 内容: 所有变更、破坏性变更、迁移指南
  
- [ ] **P6-1.3** 创建 Git Tag
  - 命令: `git tag -a v1.0.0 -m "Release v1.0.0"`
  - 推送: `git push origin v1.0.0`
  
- [ ] **P6-1.4** 创建 GitHub Release
  - 内容: 发布说明、二进制文件
  - 资产: macOS、Linux、Windows 二进制

**输出物**:
- GitHub Release v1.0.0
- 发布说明

---

### 任务包 P6-2: 发布营销

**优先级**: P1 (重要)  
**负责人**: Agent-AB  
**依赖**: P6-1 完成  
**预估**: 2 天

**原子任务**:

- [ ] **P6-2.1** 撰写发布博客
  - 平台: 个人博客、知乎、V2EX
  - 内容: 功能亮点、使用场景、未来规划
  
- [ ] **P6-2.2** 准备演示材料
  - 演示视频: 5 分钟功能演示
  - 幻灯片: 架构介绍、使用案例
  
- [ ] **P6-2.3** 社区推广
  - 平台: Hacker News、Reddit、Twitter
  - 内容: 技术亮点、开源价值

**输出物**:
- 发布博客
- 演示视频
- 社区帖子

---

### 任务包 P6-3: 发布后支持

**优先级**: P1 (重要)  
**负责人**: Agent-AC  
**依赖**: P6-1 完成  
**预估**: 持续

**原子任务**:

- [ ] **P6-3.1** 创建 Issue 模板
  - Bug 报告模板
  - 功能请求模板
  
- [ ] **P6-3.2** 创建讨论区
  - 平台: GitHub Discussions
  - 分类: Q&A、Show and Tell、Ideas
  
- [ ] **P6-3.3** 建立发布节奏
  - Patch: 每两周 (bug 修复)
  - Minor: 每月 (新功能)
  - Major: 每季度 (重大变更)

**输出物**:
- `.github/ISSUE_TEMPLATE/`
- GitHub Discussions 配置
- 发布节奏文档

---

### 任务包 P6-4: 最终验收

**优先级**: P0 (阻塞)  
**负责人**: Agent-Lead  
**依赖**: P6-1 ~ P6-3 完成  
**预估**: 1 天

**最终验收标准**:

```yaml
v1.0.0 发布标准:
  稳定性: 100% 测试通过
  功能: 100% 核心功能完成
  性能: 达到所有性能基线
  安全: 零高危漏洞
  生态: Element + VS Code + Homebrew
  文档: 完整用户 + 开发者文档
  
发布检查清单:
  [x] 所有测试通过
  [x] 性能基准达标
  [x] 安全审计通过
  [x] 文档完整
  [x] 示例可用
  [x] GitHub Release 创建
  [x] 发布博客发布
  [x] 社区推广完成
```

**输出物**:
- `reports/v1.0.0-release-report.md`
- 庆祝 🎉

---

## 任务依赖图

```
Phase 1: 稳定性加固
├── P1-1: 内存安全 (P0) ──┐
├── P1-2: WebSocket 测试 (P0) ──┤
├── P1-3: 项目注册表 (P0) ──────┤
├── P1-4: E2E 测试 (P1) ────────┤ ← 依赖 P1-1, P1-2, P1-3
├── P1-5: CI/CD (P1) ───────────┤
├── P1-6: 编译警告 (P2) ────────┤
├── P1-7: 文档测试 (P2) ────────┤
└── P1-8: 验收 (P0) ←───────────┘

Phase 2: 核心功能完善
├── P2-1: WASM 执行 (P0) ←──────┐
├── P2-2: 四级决策 (P0) ────────┤
├── P2-3: GUI 数据 (P1) ←───────┤ ← 依赖 P1-1
├── P2-4: P2P 组网 (P1) ────────┤
├── P2-5: ACL 系统 (P1) ────────┤
├── P2-6: IM 集成 (P2) ←────────┤ ← 依赖 P2-4
├── P2-7: 远程会话 (P1) ────────┤
├── P2-8: 向量优化 (P1) ────────┤
├── P2-9: Skill 生态 (P2) ←─────┤ ← 依赖 P2-1
└── P2-10: 验收 (P0) ←──────────┘

Phase 3: 性能优化
├── P3-1: 内存优化 (P1) ←───────┐ ← 依赖 P1-1, P2-1
├── P3-2: 异步优化 (P1) ←───────┤ ← 依赖 P1-1
├── P3-3: 存储优化 (P1) ────────┤
├── P3-4: 启动优化 (P2) ────────┤
└── P3-5: 验收 (P0) ←───────────┘

Phase 4: 生态集成
├── P4-1: Element (P0) ←────────┐ ← 依赖 P2-4
├── P4-2: VS Code (P1) ─────────┤
├── P4-3: Homebrew (P1) ←───────┤ ← 依赖 P1-5
├── P4-4: Docker (P2) ──────────┤
├── P4-5: Shell (P1) ───────────┤
├── P4-6: 文档 (P1) ────────────┤
├── P4-7: 示例 (P2) ←───────────┤ ← 依赖 P2-9
└── P4-8: 验收 (P0) ←───────────┘

Phase 5: 安全审计
├── P5-1: 代码审计 (P0) ←───────┐ ← 依赖 P1 ~ P4
├── P5-2: 渗透测试 (P0) ←───────┤ ← 依赖 P5-1
├── P5-3: 安全配置 (P1) ────────┤
└── P5-4: 验收 (P0) ←───────────┘

Phase 6: 发布准备
├── P6-1: 版本发布 (P0) ←───────┐ ← 依赖 P1 ~ P5
├── P6-2: 发布营销 (P1) ←───────┤ ← 依赖 P6-1
├── P6-3: 发布后支持 (P1) ←─────┤ ← 依赖 P6-1
└── P6-4: 最终验收 (P0) ←───────┘
```

---

## AI Agent 任务分配建议

### 并行执行策略

```yaml
Week 1:
  Agent-A: P1-1 (内存安全)
  Agent-B: P1-2 (WebSocket 测试)
  Agent-C: P1-3 (项目注册表)
  Agent-D: P1-5 (CI/CD)
  Agent-E: P1-6 (编译警告)
  Agent-F: P1-7 (文档测试)

Week 2:
  Agent-Lead: P1-4 (E2E 测试) ← 等待 P1-1/2/3
  Agent-Lead: P1-8 (验收)
  Agent-H: P2-1 (WASM 执行) ← 等待 P1-1
  Agent-I: P2-2 (四级决策)
  Agent-J: P2-3 (GUI 数据) ← 等待 P1-1
  Agent-K: P2-4 (P2P 组网)

Week 3-4:
  [继续并行执行 Phase 2 任务包]

Week 5-6:
  [并行执行 Phase 3 任务包]

Week 7-8:
  [并行执行 Phase 4 任务包]

Week 9-10:
  [串行执行 Phase 5 安全审计]

Week 11-12:
  [并行执行 Phase 6 发布准备]
```

### Agent 能力要求

| Agent 类型 | 技能要求 | 负责任务包 |
|------------|----------|------------|
| Rust-Core | Rust 精通、异步编程 | P1-1, P1-2, P1-3, P2-1, P2-2, P3-1, P3-2 |
| Network | 网络协议、P2P | P1-2, P2-4, P2-5, P2-7, P4-1 |
| Frontend | egui、TypeScript | P2-3, P4-2 |
| DevOps | CI/CD、容器 | P1-5, P4-3, P4-4 |
| Security | 加密、渗透测试 | P5-1, P5-2, P5-3 |
| Docs | 技术写作 | P1-7, P4-6, P4-7 |
| Lead | 项目管理 | P1-4, P1-8, P2-10, P3-5, P4-8, P5-4, P6-4 |

---

## 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| WASM 运行时复杂度 | 中 | 高 | 提前调研，备选方案 |
| Matrix 协议复杂性 | 中 | 中 | 使用成熟库，逐步集成 |
| 安全审计发现问题 | 高 | 高 | 预留缓冲时间 |
| 性能优化不达预期 | 中 | 中 | 设定合理基线 |
| 社区反馈负面 | 低 | 中 | 提前内测收集反馈 |

---

## 附录

### A. 术语表

- **DAG**: Directed Acyclic Graph，有向无环图，任务编排结构
- **Skill**: CIS 中的可执行单元，支持 Binary/WASM/DAG 三种类型
- **DID**: Decentralized Identifier，去中心化身份标识
- **Matrix**: 去中心化通信协议
- **P2P**: Peer-to-Peer，点对点网络
- **E2EE**: End-to-End Encryption，端到端加密

### B. 参考文档

- [Architecture Design](./ARCHITECTURE_DESIGN.md)
- [DAG Implementation Status](./DAG_IMPLEMENTATION_STATUS.md)
- [Network Access Design](./NETWORK_ACCESS_DESIGN.md)
- [GUI Security Design](./GUI_SECURITY_DESIGN.md)

### C. 变更日志

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-02-08 | 初始版本 |

---

**文档结束**

*本计划由 AI Agent 生成，供 AI Agent 并行执行任务使用。*
