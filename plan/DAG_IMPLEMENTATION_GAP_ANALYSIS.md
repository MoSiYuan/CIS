# CIS-DAG å®ç°å·®è·åˆ†æä¸è°ƒæ•´è®¡åˆ’

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2026-02-02  
**çŠ¶æ€**: è§„åˆ’ä¸­

---

## 1. ç°çŠ¶æ¦‚è¿°

### 1.1 å½“å‰å®ç°çŠ¶æ€

| æ¨¡å— | å½“å‰å®ç° | ä»£ç ä½ç½® |
|------|----------|----------|
| DAG æ ¸å¿ƒ | åŸºç¡€ DAG ç»“æ„ï¼ŒHashMap å­˜å‚¨ | `cis-core/src/scheduler/mod.rs` (801 è¡Œ) |
| Task å®šä¹‰ | åŸºç¡€ Task ç»“æ„ | `cis-core/src/types.rs` (222 è¡Œ) |
| æ²™ç›’ | è·¯å¾„ç™½åå•éªŒè¯ | `cis-core/src/sandbox/mod.rs` (539 è¡Œ) |
| çŠ¶æ€æœº | åŸºç¡€çŠ¶æ€æµè½¬ | `Pending â†’ Ready â†’ Running â†’ Completed/Failed/Skipped` |

### 1.2 è®¾è®¡æ–¹æ¡ˆå›é¡¾

è¯¦è§ `docs/issue/kimi.md` - CIS-DAG v1.0 æœ€ç»ˆæ–¹æ¡ˆï¼šç‹¬è”ä½“æ‰§è¡Œåè®®

æ ¸å¿ƒç†å¿µï¼š
- **ä¸»æƒè‡ªæ²»**: èŠ‚ç‚¹ç¦»çº¿å¯ç‹¬ç«‹å†³ç­–
- **æ¶Œç°è€Œéæ§åˆ¶**: å…è®¸ä¸´æ—¶æ··ä¹±ï¼ˆå€ºåŠ¡ç´¯ç§¯ï¼‰
- **é¡ºæ‰‹å³æ­£ä¹‰**: æƒ³æ³•â†’æ‰§è¡Œ < 10ç§’
- **é›¶å‡ºç½‘**: æ•°æ®æ°¸ä¸è§¦ç¢°å…¬ç½‘

---

## 2. å·®è·åˆ†æ

### 2.1 æ•°æ®ç»“æ„å±‚

#### 2.1.1 DAG ç»“æ„

| ç»´åº¦ | è®¾è®¡æ–¹æ¡ˆ | å½“å‰å®ç° | å·®è· |
|------|----------|----------|------|
| **å­˜å‚¨ç»“æ„** | `Vec<Task>` å›ºå®šé•¿åº¦æ•°ç»„ | `HashMap<String, DagNode>` | éœ€è¦é‡æ„ä¸ºæ•°ç»„ç´¢å¼• |
| **ID ç±»å‹** | `idx: u8` (0-255ï¼Œç‰©ç†é™åˆ¶) | `task_id: String` | éœ€è¦æ”¹ä¸º u8 ç´¢å¼• |
| **Run ID** | ULID | æ—  | éœ€è¦æ·»åŠ  |
| **æ‰§è¡Œç­–ç•¥** | `AllSuccess \| FirstSuccess \| AllowDebt` | æ—  | éœ€è¦æ·»åŠ  |

**å½±å“è¯„ä¼°**: ğŸ”´ **é«˜** - æ ¸å¿ƒç»“æ„å·®å¼‚éœ€è¦è¾ƒå¤§æ”¹åŠ¨

#### 2.1.2 Task ç»“æ„

```rust
// è®¾è®¡æ–¹æ¡ˆ
pub struct Task {
    pub idx: u8,                  // å½“å‰: id: String
    pub name: String,
    pub exec: Exec {              // å½“å‰: æ— æ‰§è¡Œå®šä¹‰
        pub cmd: Vec<String>,
        pub env: HashMap<String, String>,
        pub timeout: u16,
        pub sandbox: SandboxConfig,
    },
    pub deps: Vec<u8>,            // å½“å‰: dependencies: Vec<String>
    pub level: TaskLevel,         // å½“å‰: æ—  (å…³é”®ç¼ºå¤±)
    pub on_ambiguity: AmbiguityPolicy,  // å½“å‰: æ— 
    pub inputs: Vec<PathBuf>,     // å½“å‰: æ— 
    pub outputs: Vec<String>,     // å½“å‰: result: Option<String>
    pub rollback: Option<Vec<String>>,  // å½“å‰: æ—  (å…³é”®ç¼ºå¤±)
    pub idempotent: bool,         // å½“å‰: æ— 
}
```

**å…³é”®ç¼ºå¤±å­—æ®µ**:
- [ ] `level: TaskLevel` - å››çº§å†³ç­–æœºåˆ¶
- [ ] `rollback` - å›æ»šå‘½ä»¤
- [ ] `idempotent` - å¹‚ç­‰æ€§æ ‡è®°
- [ ] `inputs/outputs` - è¾“å…¥è¾“å‡ºå¥‘çº¦
- [ ] `on_ambiguity` - æ¨¡ç³Šå¤„ç†ç­–ç•¥

### 2.2 çŠ¶æ€æœºå±‚

#### 2.2.1 çŠ¶æ€å¯¹æ¯”

```
è®¾è®¡æ–¹æ¡ˆ:
Pending â†’ Running â†’ Completed
   â†“         â†“          â†“
Skipped   Failed     Debtï¼ˆå¯å¿½ç•¥çš„å¤±è´¥ï¼‰
   â†“      ï¼ˆæŠ€æœ¯å€ºåŠ¡ï¼‰   â†“
         ï¼ˆé˜»å¡æ€§ï¼‰â†’ Arbitratedï¼ˆäººå·¥ä»‹å…¥ï¼‰

å½“å‰å®ç°:
Pending â†’ Ready â†’ Running â†’ Completed/Failed
              â†“          â†“
           Failed     Skipped
```

**ç¼ºå¤±çŠ¶æ€**:
- [ ] `Debt` - æŠ€æœ¯å€ºåŠ¡çŠ¶æ€
- [ ] `Arbitrated` - äººå·¥ä»²è£çŠ¶æ€

**ç¼ºå¤±æ¦‚å¿µ**:
- [ ] å€ºåŠ¡ç±»å‹åŒºåˆ†ï¼ˆIgnorable vs Blockingï¼‰
- [ ] å€ºåŠ¡ç´¯ç§¯æœºåˆ¶

### 2.3 æ‰§è¡Œæ¨¡å‹å±‚

| åŠŸèƒ½ | è®¾è®¡æ–¹æ¡ˆ | å½“å‰å®ç° | ä¼˜å…ˆçº§ |
|------|----------|----------|--------|
| **é€Ÿå†™æ‰§è¡Œ** | `cis run "æè¿°"` è‡ªåŠ¨ç”Ÿæˆ DAG | æ—  | ğŸ”´ é«˜ |
| **çƒ­ä¿®æ”¹** | `cis amend` æ‰§è¡Œä¸­ä¿®æ”¹ Task | æ—  | ğŸŸ¡ ä¸­ |
| **å€ºåŠ¡ç®¡ç†** | `cis debt` æŸ¥çœ‹ç´¯ç§¯å€ºåŠ¡ | æ—  | ğŸŸ¡ ä¸­ |
| **å››çº§å†³ç­–** | Mechanical/Recommended/Confirmed/Arbitrated | æ—  | ğŸ”´ é«˜ |
| **å‹å¥½é”™è¯¯** | `FriendlyError` ç»“æ„ | åŸºç¡€é”™è¯¯å¤„ç† | ğŸŸ¢ ä½ |
| **Coffee Mode** | å¼±ç½‘è‡ªé€‚åº”/Island Mode | æ—  | ğŸŸ¡ ä¸­ |

### 2.4 å®‰å…¨ä¸æ²™ç›’å±‚

| åŠŸèƒ½ | è®¾è®¡æ–¹æ¡ˆ | å½“å‰å®ç° | å·®è· |
|------|----------|----------|------|
| **è¿›ç¨‹æ²™ç›’** | chroot + æ¸…ç©ºç¯å¢ƒå˜é‡ + èµ„æºé™åˆ¶ | ä»…è·¯å¾„ç™½åå• | ğŸ”´ éœ€è¡¥å…… |
| **å‘½ä»¤ç™½åå•** | æ˜¾å¼ cmd åˆ—è¡¨ï¼Œé Shell | æ—  | ğŸ”´ éœ€å®ç° |
| **ç¯å¢ƒéš”ç¦»** | æ˜¾å¼æ³¨å…¥ envï¼Œæ— ç»§æ‰¿ | æ—  | ğŸŸ¡ éœ€è¡¥å…… |
| **èµ„æºé™åˆ¶** | CPU/å†…å­˜/ç£ç›˜ç¡¬é™åˆ¶ | æ—  | ğŸŸ¢ å¯å»¶å |

### 2.5 CLI/GUI å±‚

| å‘½ä»¤ | è®¾è®¡æ–¹æ¡ˆ | å½“å‰å®ç° | çŠ¶æ€ |
|------|----------|----------|------|
| `cis run <sketch>` | é€Ÿå†™æ‰§è¡Œ | æ—  | âŒ ç¼ºå¤± |
| `cis status <run_id>` | TUI è¿›åº¦æ¡ | åŸºç¡€ task åˆ—è¡¨ | âš ï¸ éƒ¨åˆ† |
| `cis amend` | çƒ­ä¿®æ”¹ | æ—  | âŒ ç¼ºå¤± |
| `cis debt` | å€ºåŠ¡çœ‹æ¿ | æ—  | âŒ ç¼ºå¤± |
| `cis doctor` | ç¯å¢ƒè¯Šæ–­ | æ—  | âŒ ç¼ºå¤± |
| `cis verify-sandbox` | æ²™ç›’éªŒè¯ | æ—  | âŒ ç¼ºå¤± |

---

## 3. è°ƒæ•´å»ºè®®

### 3.1 ç«‹å³è°ƒæ•´ï¼ˆBreaking Changesï¼‰

#### 3.1.1 ä¿ç•™å½“å‰ DAG å®ç°ï¼Œæ¸è¿›å¼æ¼”è¿›

**å»ºè®®**: ä¸ç«‹å³é‡æ„ä¸ºå›ºå®šæ•°ç»„ï¼Œè€Œæ˜¯ä¿ç•™ç°æœ‰ HashMap ç»“æ„ï¼Œé€æ­¥æ·»åŠ ç¼ºå¤±åŠŸèƒ½ã€‚

ç†ç”±:
1. å½“å‰å®ç°å·²æœ‰å®Œæ•´æµ‹è¯•è¦†ç›–
2. åŠ¨æ€ç»“æ„åœ¨å®é™…ä½¿ç”¨ä¸­æ›´çµæ´»
3. u8 ç´¢å¼•é™åˆ¶ (255) å¯èƒ½åœ¨æŸäº›åœºæ™¯ä¸å¤Ÿç”¨

**æŠ˜ä¸­æ–¹æ¡ˆ**: 
- ä¿ç•™ `String` ä½œä¸º task_id
- æ·»åŠ  `run_id: ULID` ä½œä¸º DAG å®ä¾‹æ ‡è¯†
- é™åˆ¶æœ€å¤§ task æ•°é‡ï¼ˆå¦‚ 1000ï¼‰è€Œé 255

#### 3.1.2 ä¼˜å…ˆå®ç°å››çº§å†³ç­–æœºåˆ¶

è¿™æ˜¯ CIS-DAG çš„æ ¸å¿ƒå·®å¼‚åŒ–ç‰¹æ€§ï¼Œå¿…é¡»å®ç°ï¼š

```rust
pub enum TaskLevel {
    Mechanical { retry: u8 },
    Recommended { default: Action, timeout: u16 },
    Confirmed,
    Arbitrated { stakeholders: Vec<String> },
}
```

å®ç°è¦ç‚¹:
1. åœ¨ Task ç»“æ„ä¸­æ·»åŠ  `level` å­—æ®µ
2. åœ¨ Task æ‰§è¡Œå‰æ£€æŸ¥ levelï¼Œå†³å®šæ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤
3. GUI å±‚æ ¹æ® level æ˜¾ç¤ºä¸åŒçš„äº¤äº’ç•Œé¢

#### 3.1.3 æ·»åŠ å€ºåŠ¡æœºåˆ¶

ä¿®æ”¹å¤±è´¥å¤„ç†é€»è¾‘ï¼š

```rust
pub enum TaskStatus {
    // ... existing
    Failed(FailureType),  // æ”¹ä¸ºåŒ…å«å¤±è´¥ç±»å‹
}

pub enum FailureType {
    Ignorable,   // å¯å¿½ç•¥å€ºåŠ¡ï¼Œç»§ç»­æ‰§è¡Œä¸‹æ¸¸
    Blocking,    // é˜»å¡æ€§ï¼Œå†»ç»“ DAG
}
```

### 3.2 ä¸­æœŸå®ç°ï¼ˆPhase 2ï¼‰

#### 3.2.1 å›æ»šæœºåˆ¶

åœ¨ Task ç»“æ„ä¸­æ·»åŠ ï¼š
```rust
pub struct Task {
    // ...
    pub rollback: Option<Vec<String>>,
    pub idempotent: bool,
}
```

å®ç° `Undo` è„šæœ¬ç”Ÿæˆï¼š
```rust
impl TaskDag {
    pub fn generate_undo_script(&self, run_id: &str) -> PathBuf {
        // ç”Ÿæˆ /tmp/cis/undo-{run_id}.sh
    }
}
```

#### 3.2.2 çƒ­ä¿®æ”¹ (amend)

```rust
impl TaskDag {
    pub fn amend_task(&mut self, task_id: &str, patch: TaskPatch) -> Result<()> {
        // Pending: ç›´æ¥æ›´æ–°
        // Running: SIGTERM + Checkpoint + é‡å¯
        // Completed: æ ‡è®°ä¸º"éœ€é‡è·‘"ï¼Œä¸è‡ªåŠ¨æ‰§è¡Œ
    }
}
```

#### 3.2.3 Coffee Mode

æ·»åŠ ç½‘ç»œæ£€æµ‹å’Œé™çº§ç­–ç•¥ï¼š
```rust
pub struct CoffeeModeConfig {
    pub ping_threshold_ms: u64,  // é»˜è®¤ 500ms
    pub island_mode_enabled: bool,
    pub auto_detach: bool,
}
```

### 3.3 é•¿æœŸè§„åˆ’ï¼ˆPhase 3ï¼‰

#### 3.3.1 è¿›ç¨‹çº§æ²™ç›’

å®ç°çœŸæ­£çš„è¿›ç¨‹éš”ç¦»ï¼š
- chrootï¼ˆLinuxï¼‰/ chroot + sandboxï¼ˆmacOSï¼‰
- æ¸…ç©ºç¯å¢ƒå˜é‡ï¼Œæ˜¾å¼æ³¨å…¥
- cgroupsï¼ˆLinuxï¼‰/ resource limitsï¼ˆmacOSï¼‰

#### 3.3.2 é€Ÿå†™æ‰§è¡Œ (`cis run`)

åŸºäº Cargo.toml å’Œé¡¹ç›®ç»“æ„è‡ªåŠ¨ç”Ÿæˆ DAGï¼š
```bash
$ cis run "æµ‹è¯•ä½“ç´ ç®—æ³•ï¼Œcudaå’Œmetalå¯¹æ¯”"
â†’ è§£æ Cargo.toml æ‰¾åˆ°ç›¸å…³ targets
â†’ è‡ªåŠ¨ç”Ÿæˆ test-cudaã€test-metal Task
â†’ è®¾ç½®èƒ½åŠ›åŒ¹é…ï¼ˆCapabilities: Cuda/Metalï¼‰
â†’ 10 ç§’å†…å¼€å§‹æ‰§è¡Œ
```

---

## 4. å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒæœºåˆ¶ï¼ˆ2-3 å‘¨ï¼‰

**ç›®æ ‡**: å®ç°å››çº§å†³ç­–å’Œå€ºåŠ¡æœºåˆ¶

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|------|--------|------|
| æ·»åŠ  TaskLevel æšä¸¾ | `types.rs` | 1d | æ—  |
| ä¿®æ”¹ Task ç»“æ„ | `types.rs` | 1d | TaskLevel |
| å®ç°å†³ç­–æ£€æŸ¥é€»è¾‘ | `scheduler/mod.rs` | 3d | Task ä¿®æ”¹ |
| æ·»åŠ å€ºåŠ¡çŠ¶æ€ | `scheduler/mod.rs` | 2d | å†³ç­–æ£€æŸ¥ |
| GUI å››çº§ç•Œé¢ | `cis-gui/` | 5d | å†³ç­–é€»è¾‘ |
| CLI å‘½ä»¤æ›´æ–° | `cis-node/` | 2d | å…¨éƒ¨ |

### Phase 2: å¯é æ€§ï¼ˆ2 å‘¨ï¼‰

**ç›®æ ‡**: å›æ»šã€çƒ­ä¿®æ”¹ã€Coffee Mode

| ä»»åŠ¡ | å·¥ä½œé‡ | ä¾èµ– |
|------|--------|------|
| å›æ»šå‘½ä»¤ç»“æ„ | 2d | Phase 1 |
| Undo è„šæœ¬ç”Ÿæˆ | 2d | å›æ»šç»“æ„ |
| çƒ­ä¿®æ”¹å®ç° | 3d | Phase 1 |
| Coffee Mode åŸºç¡€ | 3d | æ—  |

### Phase 3: æ˜“ç”¨æ€§ï¼ˆ2 å‘¨ï¼‰

**ç›®æ ‡**: é€Ÿå†™æ‰§è¡Œã€å€ºåŠ¡çœ‹æ¿ã€åŒ»ç”Ÿè¯Šæ–­

| ä»»åŠ¡ | å·¥ä½œé‡ | ä¾èµ– |
|------|--------|------|
| DAG è‡ªåŠ¨ç”Ÿæˆ | 5d | æ—  |
| TUI è¿›åº¦æ¡ | 3d | æ—  |
| å€ºåŠ¡çœ‹æ¿ | 2d | Phase 1 |
| Doctor è¯Šæ–­ | 2d | æ—  |

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Task ç»“æ„ä¿®æ”¹å¯¼è‡´ä¸å…¼å®¹ | ğŸ”´ é«˜ | æ·»åŠ  migration é€»è¾‘ï¼Œæ”¯æŒæ—§æ ¼å¼è¯»å– |
| å››çº§å†³ç­–å¼•å…¥ç”¨æˆ·é˜»å¡ | ğŸŸ¡ ä¸­ | é»˜è®¤ Mechanical çº§åˆ«ï¼Œç”¨æˆ·æ˜¾å¼æå‡ |
| å€ºåŠ¡ç´¯ç§¯å¯¼è‡´çŠ¶æ€è†¨èƒ€ | ğŸŸ¡ ä¸­ | å®šæœŸæ¸…ç† Ignorable Debtï¼Œä»…ä¿ç•™æœ€è¿‘ 100 æ¡ |
| è¿›ç¨‹æ²™ç›’è·¨å¹³å°å›°éš¾ | ğŸŸ¢ ä½ | Linux ä¼˜å…ˆï¼ŒmacOS ä½¿ç”¨ limbo æ–¹æ¡ˆ |

---

## 6. ç»“è®º

å½“å‰å®ç°å·²ç»å®Œæˆäº† CIS-DAG çš„åŸºç¡€æ¡†æ¶ï¼ˆçº¦ 40%ï¼‰ï¼Œæ ¸å¿ƒå·®è·åœ¨äºï¼š

1. **å››çº§å†³ç­–æœºåˆ¶** - å¿…é¡»å®ç°ï¼Œæ˜¯ CIS-DAG çš„æ ¸å¿ƒä»·å€¼
2. **å€ºåŠ¡å¤„ç†** - å¿…é¡»å®ç°ï¼Œæ”¯æŒå®¹é”™æ‰§è¡Œ
3. **å›æ»šæœºåˆ¶** - é‡è¦ï¼Œæå‡å¯é æ€§
4. **è¿›ç¨‹æ²™ç›’** - é‡è¦ï¼Œä½†å¯å…ˆç”¨ç°æœ‰è·¯å¾„æ²™ç›’è¿‡æ¸¡
5. **é€Ÿå†™æ‰§è¡Œ** - ä½“éªŒä¼˜åŒ–ï¼Œå¯å»¶å

**å»ºè®®ç«‹å³å¼€å§‹ Phase 1 çš„å®ç°**ï¼Œä¼˜å…ˆå®Œæˆå››çº§å†³ç­–å’Œå€ºåŠ¡æœºåˆ¶ï¼Œè¿™å°†ä½¿ CIS-DAG ä»"å¯ç”¨"å˜ä¸º"å¥½ç”¨"ã€‚
